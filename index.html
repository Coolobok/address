<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ —Å—Ç–µ–Ω–¥–æ–≤ —É –¥–æ–º–æ—Ñ–æ–Ω–æ–≤ - –†—è–∑–∞–Ω—å</title>
    
    <!-- –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã API -->
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>

    <style>
        /* ===== –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f5f5f7;
            position: relative;
        }

        .map-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ===== –ö–û–ú–ü–ê–ö–¢–ù–ê–Ø –®–ê–ü–ö–ê ===== */
        .compact-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            z-index: 900;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .header-title {
            font-size: 16px;
            font-weight: 700;
            color: white;
        }

        .header-subtitle {
            font-size: 12px;
            opacity: 0.9;
            color: rgba(255,255,255,0.95);
        }

        .header-toggle {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .header-toggle:hover {
            background: rgba(255,255,255,0.25);
        }

        .header-toggle svg {
            width: 16px;
            height: 16px;
            stroke: white;
            transition: transform 0.3s ease;
        }

        .header-toggle.active svg {
            transform: rotate(180deg);
        }

        .header-stats-compact {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .stat-compact {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .stat-label-compact {
            font-size: 10px;
            opacity: 0.9;
            color: rgba(255,255,255,0.9);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .stat-value-compact {
            font-size: 14px;
            font-weight: 700;
            color: white;
        }

        /* ===== –ü–õ–ê–í–ê–Æ–©–ê–Ø –ü–ê–ù–ï–õ–¨ ===== */
        .floating-panel {
            position: fixed;
            left: 0;
            right: 0;
            background: white;
            z-index: 1000;
            box-shadow: 0 -4px 24px rgba(0,0,0,0.1);
            border-top: 1px solid rgba(0,0,0,0.08);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            max-height: 75vh;
            overflow: hidden;
        }

        /* –ü–ö –í–ï–†–°–ò–Ø */
        @media (min-width: 769px) {
            .compact-header {
                display: block;
                position: fixed;
                top: 24px;
                left: 48px;
                width: 380px;
                border-radius: 16px;
                padding: 20px 20px 12px 20px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.15);
                z-index: 1000;
            }
            
            .compact-header.alone {
                border-radius: 16px;
            }
            
            .compact-header.with-panel {
                border-radius: 16px 16px 0 0;
                box-shadow: none;
                border-bottom: none;
            }
            
            .floating-panel {
                top: 220px;
                left: 48px;
                width: 380px;
                height: calc(100vh - 255px);
                max-height: calc(100vh - 225px);
                border-radius: 0 0 16px 16px;
                border: 1px solid rgba(0,0,0,0.08);
                border-top: none;
                bottom: auto;
                right: auto;
                transform: none;
                box-shadow: 0 8px 32px rgba(0,0,0,0.15);
                display: none;
                overflow: hidden !important;
            }
            
            .floating-panel.active {
                display: flex;
            }
            
            /* –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è - –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –≤ —à–∞–ø–∫–µ */
            .desktop-header-nav {
                display: flex;
                gap: 4px;
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid rgba(255,255,255,0.1);
            }
            
            .desktop-nav-button {
                flex: 1;
                padding: 8px 4px;
                border: none;
                background: none;
                font-size: 10px;
                color: rgba(255,255,255,0.8);
                cursor: pointer;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                border-radius: 8px;
                transition: all 0.2s ease;
                position: relative;
                min-height: 40px;
            }
            
            .desktop-nav-button:hover {
                background: rgba(255,255,255,0.1);
            }
            
            .desktop-nav-button.active {
                color: white;
                background: rgba(255,255,255,0.15);
            }
            
            .desktop-nav-icon {
                font-size: 16px;
                width: 18px;
                height: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .desktop-nav-label {
                font-weight: 500;
                letter-spacing: 0.2px;
                white-space: nowrap;
                font-size: 9px;
            }
            
            /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é */
            .desktop-nav-bar {
                display: none !important;
            }
            
            .mobile-nav-bar {
                display: none !important;
            }
            
            /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É toggle –Ω–∞ –ü–ö */
            .header-toggle {
                display: flex !important;
                position: absolute;
                right: 20px;
                top: 20px;
            }
            
            /* –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö - —Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –ü–ö */
            .filter-reset-button-container {
                display: none !important;
            }
            
            /* ‚öôÔ∏è –§–ò–õ–¨–¢–†–´ - –ì–†–ò–î –°–ò–°–¢–ï–ú–ê - –í–°–ï–ì–î–ê –û–î–ù–ê –ö–û–õ–û–ù–ö–ê */
            .filters-grid {
                display: flex !important;
                flex-direction: column !important;
                gap: 16px;
                padding: 20px;
                overflow-y: auto;
                flex: 1;
                min-height: 0;
                align-content: start;
            }
            
            .filter-card {
                width: 100% !important;
                min-height: auto;
                flex-shrink: 0;
                padding: 20px;
                margin: 0 !important;
            }
            
            .checkboxes-column {
                max-height: none !important;
                overflow-y: visible !important;
                padding-right: 0;
                min-height: auto;
            }
            
            .filter-card-title {
                font-size: 15px;
                margin-bottom: 16px;
                padding-bottom: 8px;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .filter-card-title::before {
                height: 16px;
                width: 5px;
            }
            
            .checkbox-card {
                padding: 10px 12px;
                margin-bottom: 6px;
                border-radius: 10px;
                transition: all 0.2s ease;
            }
            
            .checkbox-card:last-child {
                margin-bottom: 0;
            }
            
            .checkbox-card label {
                font-size: 14px;
            }
            
            .checkbox-card input {
                width: 20px;
                height: 20px;
                min-width: 20px;
            }
            
            .checkbox-card input:checked::after {
                font-size: 12px;
            }
            
            .checkbox-card:hover {
                background: rgba(102, 126, 234, 0.08);
                transform: translateX(4px);
            }
            
            .range-compact {
                width: 100%;
            }
            
            .range-row {
                width: 100%;
            }
            
            .building-card {
                margin: 8px 20px;
                padding: 18px;
            }
            
            .header-title {
                font-size: 18px;
            }
            
            .header-subtitle {
                font-size: 14px;
            }
            
            .stat-value-compact {
                font-size: 16px;
            }
            
            .map-container {
                padding-top: 0;
            }
            
            /* –û–ß–ï–ù–¨ –í–ê–ñ–ù–û: –æ—Ç–∫–ª—é—á–∞–µ–º –≥—Ä–∏–¥-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —Å—Ç–∏–ª–µ–π –Ω–∞ –ü–ö */
            .filters-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞ –≤ action-buttons */
            .action-buttons {
                display: none !important;
            }
            
            /* –°–ö–†–û–õ–õ–ë–ê–† –î–õ–Ø –ü–ö - –í–ê–ñ–ù–û */
            .floating-panel .scrollable-content {
                overflow-y: scroll !important;
                scrollbar-width: thin !important;
                scrollbar-color: #667eea #f3f4f6 !important;
            }
            
            .floating-panel .scrollable-content::-webkit-scrollbar {
                width: 14px !important;
                height: 14px !important;
            }
            
            .floating-panel .scrollable-content::-webkit-scrollbar-track {
                background: #f3f4f6 !important;
                border-radius: 10px !important;
                margin: 6px !important;
                border: 2px solid #e5e7eb !important;
            }
            
            .floating-panel .scrollable-content::-webkit-scrollbar-thumb {
                background: #667eea !important;
                border-radius: 10px !important;
                border: 4px solid #f3f4f6 !important;
            }
            
            .floating-panel .scrollable-content::-webkit-scrollbar-thumb:hover {
                background: #5a67d8 !important;
            }
            
            /* –°–ø–∏—Å–∫–∏ –Ω–∞ –ü–ö */
            .buildings-list-compact {
                overflow-y: scroll !important;
                scrollbar-width: thin !important;
                scrollbar-color: #667eea #f3f4f6 !important;
            }
            
            .buildings-list-compact::-webkit-scrollbar {
                width: 14px !important;
            }
            
            .buildings-list-compact::-webkit-scrollbar-track {
                background: #f3f4f6 !important;
                border-radius: 10px !important;
                margin: 6px !important;
                border: 2px solid #e5e7eb !important;
            }
            
            .buildings-list-compact::-webkit-scrollbar-thumb {
                background: #667eea !important;
                border-radius: 10px !important;
                border: 4px solid #f3f4f6 !important;
            }
        }
        /* –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø */
        @media (max-width: 768px) {
            .compact-header {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 900;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            
            .floating-panel {
                bottom: 70px;
                transform: translateY(100%);
                border-radius: 24px 24px 0 0;
                max-height: calc(100vh - 250px);
            }
            
            .floating-panel.active {
                transform: translateY(0);
            }
            
            .map-container {
                padding-top: 120px;
                padding-bottom: 70px;
            }
            
            /* –°–∫—Ä—ã–≤–∞–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –≤ —à–∞–ø–∫–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .desktop-header-nav {
                display: none !important;
            }
            
            /* –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö - –≤–æ –≤—Å—é —à–∏—Ä–∏–Ω—É */
            .filter-reset-button-container {
                padding: 16px;
                border-bottom: 1px solid #e5e7eb;
                margin-bottom: 16px;
            }
            
            .filter-reset-button-container button {
                width: 100%;
            }
            
            /* –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—É –±–∞–ª—É–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö - –¥–µ–ª–∞–µ–º –º–µ–Ω—å—à–µ, —á—Ç–æ–±—ã –±—ã–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–∏–¥–µ–Ω */
            .custom-balloon {
                width: calc(100vw - 90px) !important;
                max-width: calc(100vw - 90px) !important;
                margin: 0 auto;
                left: 10px !important;
                right: 10px !important;
            }
            
            /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞ –≤ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ */
            .action-buttons {
                justify-content: center;
            }
            
            .action-button {
                width: 80%;
            }
            
            /* –†–∞–π–æ–Ω—ã –∏ —Å—Ç–∞—Ç—É—Å—ã —Ä–∏—Å—É–µ–º —Å—Ä–∞–∑—É –≤—Å–µ */
            .checkboxes-column {
                max-height: none !important;
                overflow-y: visible !important;
                min-height: auto;
            }
            
            /* –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –º–æ–±–∏–ª—å–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –¥–ª—è 4 –∫–Ω–æ–ø–æ–∫ */
            .mobile-nav-bar {
                gap: 3px;
                padding: 6px 8px;
                height: 70px;
                box-sizing: border-box;
            }
            
            .mobile-nav-bar .nav-button {
                padding: 8px 2px;
                min-height: 48px;
            }
            
            .mobile-nav-bar .nav-label {
                font-size: 10px;
            }
            
            /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞ –≤ action-buttons –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .action-buttons {
                display: none !important;
            }
            
            /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É toggle –≤ header –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .header-toggle {
                display: none;
            }
        }

        /* ===== –ö–û–ù–¢–ï–ù–¢ –ü–ê–ù–ï–õ–ò ===== */
        .panel-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        /* –£–ë–ò–†–ê–ï–ú –í–ö–õ–ê–î–ö–ò */
        .panel-tabs {
            display: none !important;
        }

        /* –ö–û–ù–¢–ï–ô–ù–ï–†–´ */
        .tab-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .tab-pane-content {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .tab-pane-content.active {
            display: flex;
        }

        /* ‚öôÔ∏è –§–ò–õ–¨–¢–†–´ - –í–°–ï–ì–î–ê –û–î–ù–ê –ö–û–õ–û–ù–ö–ê */
        .filters-grid {
            display: flex !important;
            flex-direction: column !important;
            gap: 16px;
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            align-content: start;
        }

        @media (max-width: 480px) {
            .filters-grid {
                gap: 12px;
                padding: 16px;
            }
        }

        @media (min-width: 769px) {
            .filters-grid {
                gap: 20px;
                padding: 24px;
                overflow-y: auto !important;
                scrollbar-width: thin !important;
                scrollbar-color: #667eea #f3f4f6 !important;
            }
        }

        .filter-card {
            background: #f9fafb;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .filter-card:hover {
            border-color: #d1d5db;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .filter-card-title {
            font-weight: 600;
            color: #111827;
            margin-bottom: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-card-title::before {
            content: '';
            width: 4px;
            height: 14px;
            background: #667eea;
            border-radius: 2px;
        }

        .filter-card-title span {
            font-weight: 700;
            color: #667eea;
        }

        @media (max-width: 480px) {
            .filter-card-title {
                margin-bottom: 12px;
                font-size: 13px;
            }
        }

        /* –ß–ï–ö–ë–û–ö–°–´ */
        .checkboxes-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 4px;
        }

        .checkbox-card {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .checkbox-card:hover {
            background: #f3f4f6;
        }

        .checkbox-card input {
            margin-right: 10px;
            cursor: pointer;
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            min-width: 18px;
            border-radius: 5px;
            border: 2px solid #d1d5db;
            appearance: none;
            background: white;
            position: relative;
            transition: all 0.2s ease;
        }

        .checkbox-card input:checked {
            background: #667eea;
            border-color: #667eea;
        }

        .checkbox-card input:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 11px;
            font-weight: bold;
        }

        .checkbox-card label {
            font-size: 13px;
            color: #374151;
            cursor: pointer;
            flex: 1;
            line-height: 1.3;
        }

        /* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
        .range-compact {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .range-row {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .range-button {
            width: 40px;
            height: 44px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 10px;
            font-size: 20px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            padding: 0;
            line-height: 1;
        }

        .range-button:hover {
            border-color: #667eea;
            background: #f3f4f6;
            color: #667eea;
        }

        .range-button:active {
            transform: scale(0.95);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ */
        .range-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .range-button.disabled:hover {
            border-color: #e5e7eb;
            background: white;
            color: #6b7280;
            transform: none;
            box-shadow: none;
        }

        .range-input-compact {
            flex: 1;
            min-width: 0;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            height: 44px;
            box-sizing: border-box;
            background: white;
            color: #111827;
            text-align: center;
            transition: all 0.2s ease;
            -moz-appearance: textfield;
        }

        .range-input-compact::-webkit-outer-spin-button,
        .range-input-compact::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .range-input-compact:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
        @media (max-width: 480px) {
            .range-button {
                width: 36px;
                height: 40px;
                font-size: 18px;
            }
            
            .range-input-compact {
                height: 40px;
                font-size: 13px;
                padding: 8px 10px;
            }
        }

        @media (max-width: 360px) {
            .range-row {
                gap: 6px;
            }
            
            .range-button {
                width: 32px;
                height: 36px;
                font-size: 16px;
            }
            
            .range-input-compact {
                height: 36px;
                font-size: 12px;
            }
            
            .mobile-nav-bar {
                gap: 2px;
                padding: 4px 6px;
            }
            
            .mobile-nav-bar .nav-button {
                padding: 6px 1px;
                min-height: 42px;
            }
            
            .mobile-nav-bar .nav-label {
                font-size: 9px;
            }
            
            .mobile-nav-bar .nav-icon {
                font-size: 16px;
            }
        }

        /* –°–ü–ò–°–û–ö */
        .precise-controls {
            padding: 16px 20px 8px 20px;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .percentage-slider-container {
            margin-bottom: 12px;
        }

        .percentage-header-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .percentage-value-compact {
            font-weight: 700;
            color: #667eea;
            font-size: 14px;
            min-width: 45px;
            text-align: center;
        }

        /* –£–ë–ò–†–ê–ï–ú —Å—á–µ—Ç—á–∏–∫ –∑–¥–∞–Ω–∏–π */
        .percentage-count-compact {
            display: none !important;
        }

        .percentage-slider-compact {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #ef4444, #f59e0b, #10b981);
            outline: none;
            border-radius: 3px;
            margin: 8px 0;
        }

        .percentage-slider-compact::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        /* –ù–û–í–´–ô –°–¢–ò–õ–¨ –î–õ–Ø –ö–ù–û–ü–û–ö –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–û–¶–ï–ù–¢–û–ú */
        .percentage-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .percentage-label {
            font-size: 13px;
            color: #374151;
            font-weight: 500;
            white-space: nowrap;
        }

        .percentage-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .percentage-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
            line-height: 1;
        }

        .percentage-btn:hover {
            border-color: #667eea;
            background: #f3f4f6;
            color: #667eea;
        }

        .percentage-btn:active {
            transform: scale(0.95);
        }

        /* –°–ü–ò–°–û–ö –ó–î–ê–ù–ò–ô */
        .buildings-list-compact {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            padding: 8px 0;
        }

        .building-card {
            position: relative;
            padding: 16px;
            background: white;
            margin: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .building-card:hover {
            transform: translateY(-1px);
            border-color: #d1d5db;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        }

        .building-card.selected {
            border-color: #667eea;
            background: linear-gradient(to right, rgba(102, 126, 234, 0.03), white);
        }

        .building-card.hidden {
            opacity: 0.7;
            background: #f9fafb;
            position: relative;
        }

        .building-card.hidden::before {
            content: '–°–ö–†–´–¢–û';
            position: absolute;
            top: 50%;
            right: 16px;
            transform: translateY(-50%);
            background: #ef4444;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .building-address-compact {
            font-weight: 600;
            margin-bottom: 6px;
            color: #111827;
            font-size: 14px;
            line-height: 1.3;
            padding-right: 40px;
        }

        .building-info-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 12px;
            color: #6b7280;
        }

        .info-chip-compact {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: #f3f4f6;
            border-radius: 16px;
            font-weight: 500;
        }

        .status-chip-compact {
            background: #10b981;
            color: white;
        }

        .status-chip-compact.busy {
            background: #ef4444;
        }

        /* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–∫—Ä—ã—Ç–∏—è (–∫—Ä–µ—Å—Ç–∏–∫) */
        .hide-building-btn-compact {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #e5e7eb;
            background: white;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: normal;
            transition: all 0.2s ease;
            padding: 0;
        }

        .hide-building-btn-compact:hover {
            background: #fef2f2;
            color: #ef4444;
            border-color: #fecaca;
            transform: scale(1.1);
        }

        .hide-building-btn-compact.hidden {
            background: #f0fdf4;
            color: #10b981;
            border-color: #bbf7d0;
        }

        .hide-building-btn-compact.hidden:hover {
            background: #dcfce7;
            color: #059669;
            border-color: #86efac;
        }

        /* –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô */
        .action-buttons {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            background: white;
            flex-shrink: 0;
        }

        .action-button {
            flex: 1;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 44px;
        }

        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .action-button.secondary {
            background: #6b7280;
        }

        .action-button.danger {
            background: #ef4444;
        }

        /* –ú–û–ë–ò–õ–¨–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .mobile-nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            z-index: 1001;
            padding: 8px 12px;
            display: flex;
            gap: 4px;
        }

        .nav-button {
            flex: 1;
            padding: 10px 4px;
            border: none;
            background: none;
            font-size: 11px;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            border-radius: 12px;
            transition: all 0.2s ease;
            position: relative;
            min-height: 48px;
        }

        .nav-button.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-icon {
            font-size: 18px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-label {
            font-weight: 500;
            letter-spacing: 0.2px;
            white-space: nowrap;
        }

        /* –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø */
        .notification-toast {
            position: fixed;
            top: 16px;
            right: 16px;
            left: 16px;
            padding: 12px 16px;
            background: white;
            color: #111827;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            z-index: 10000;
            font-size: 13px;
            font-weight: 500;
            animation: slideInTop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid #10b981;
        }

        @media (min-width: 481px) {
            .notification-toast {
                left: auto;
                max-width: 320px;
            }
        }

        .notification-toast::before {
            content: '‚úì';
            width: 20px;
            height: 20px;
            background: #10b981;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }

        .notification-toast.error {
            border-left-color: #ef4444;
        }

        .notification-toast.error::before {
            content: '!';
            background: #ef4444;
        }

        .notification-toast.info {
            border-left-color: #3b82f6;
        }

        .notification-toast.info::before {
            content: 'i';
            background: #3b82f6;
        }

        @keyframes slideInTop {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideOutTop {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-100%); opacity: 0; }
        }

        /* –ó–ê–ì–†–£–ó–ö–ê */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            gap: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            font-size: 16px;
            color: white;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –ü–£–°–¢–û–ô –°–ü–ò–°–û–ö */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: #6b7280;
            flex: 1;
        }

        .empty-icon {
            font-size: 40px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .empty-subtitle {
            font-size: 13px;
            line-height: 1.4;
            max-width: 240px;
        }

        /* –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ü–†–û–ö–†–£–¢–ö–ò - –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –°–ö–†–û–õ–õ–ê */
        .scrollable-content {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: auto;
            scrollbar-color: #667eea #f3f4f6;
        }

        /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –≤—Å–µ–≥–¥–∞ */
        .scrollable-content {
            overflow-y: scroll !important;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ - –ë–û–õ–ï–ï –Ø–†–ö–ò–ï –ò –ó–ê–ú–ï–¢–ù–´–ï */
        .scrollable-content::-webkit-scrollbar {
            width: 14px !important;
            height: 14px !important;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: #f3f4f6 !important;
            border-radius: 10px !important;
            margin: 6px !important;
            border: 2px solid #e5e7eb !important;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background: #667eea !important;
            border-radius: 10px !important;
            border: 4px solid #f3f4f6 !important;
            background-clip: padding-box !important;
            box-shadow: inset 0 0 6px rgba(0,0,0,0.1) !important;
        }

        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #5a67d8 !important;
            border: 4px solid #f3f4f6 !important;
            box-shadow: inset 0 0 6px rgba(0,0,0,0.2) !important;
        }

        .scrollable-content::-webkit-scrollbar-thumb:active {
            background: #4c51bf !important;
        }

        .scrollable-content::-webkit-scrollbar-corner {
            background: #f3f4f6 !important;
        }

        /* –î–ª—è Firefox */
        @supports (scrollbar-width: auto) {
            .scrollable-content {
                scrollbar-width: auto !important;
                scrollbar-color: #667eea #f3f4f6 !important;
            }
        }

        /* –î–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–∫—Ä—ã–≤–∞—é—Ç —Å–∫—Ä–æ–ª–ª–±–∞—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (macOS) */
        @media screen and (-webkit-min-device-pixel-ratio:0) {
            .scrollable-content {
                overflow-y: scroll !important;
            }
            
            .scrollable-content::-webkit-scrollbar {
                -webkit-appearance: none !important;
                width: 14px !important;
            }
            
            .scrollable-content::-webkit-scrollbar:vertical {
                width: 14px !important;
            }
            
            .scrollable-content::-webkit-scrollbar:horizontal {
                height: 14px !important;
            }
            
            .scrollable-content::-webkit-scrollbar-track {
                background: #f3f4f6 !important;
                border-radius: 10px !important;
                border: 2px solid #e5e7eb !important;
            }
            
            .scrollable-content::-webkit-scrollbar-thumb {
                background-color: #667eea !important;
                border-radius: 10px !important;
                border: 4px solid #f3f4f6 !important;
            }
        }

        /* –ë–ï–ó–û–ü–ê–°–ù–´–ï –ó–û–ù–´ */
        @supports(padding: max(0px)) {
            .compact-header {
                padding-top: max(12px, env(safe-area-inset-top));
            }
            
            .mobile-nav-bar {
                padding-bottom: max(8px, env(safe-area-inset-bottom));
            }
            
            .floating-panel {
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }
        }

        /* –ü–û–ü–ê–ü –î–õ–Ø –í–´–ë–û–†–ê –ó–ù–ê–ß–ï–ù–ò–ô */
        .values-popup {
            position: fixed;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 8px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none;
            animation: slideInTop 0.2s ease;
        }

        .values-popup.show {
            display: block;
        }

        .value-item {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 13px;
            border-radius: 8px;
            transition: all 0.2s ease;
            color: #374151;
            font-weight: 500;
        }

        .value-item:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        /* –ö–ù–û–ü–ö–ê "–ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï" */
        .show-all-button {
            cursor: pointer;
            text-align: center;
            padding: 16px;
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            background: white;
            border-radius: 12px;
            margin: 12px 16px;
            border: 2px dashed #d1d5db;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .show-all-button:hover {
            background: rgba(102, 126, 234, 0.05);
            border-color: #667eea;
            transform: translateY(-1px);
        }

        /* –ë–ê–õ–£–ù–´ */
        .custom-balloon {
            background: white;
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
            padding: 0;
            width: calc(100vw - 32px) !important;
            max-width: 360px;
            min-width: 280px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
            overflow: hidden !important;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 360px) {
            .compact-header {
                padding: 10px 12px;
            }
            
            .header-title {
                font-size: 15px;
            }
            
            .header-subtitle {
                font-size: 11px;
            }
            
            .stat-value-compact {
                font-size: 13px;
            }
            
            .filters-grid {
                padding: 12px;
                gap: 10px;
            }
            
            .filter-card {
                padding: 14px;
            }
            
            .building-card {
                margin: 6px 12px;
                padding: 14px;
            }
            
            .scrollable-content::-webkit-scrollbar {
                width: 12px !important;
            }
            
            .scrollable-content::-webkit-scrollbar-track {
                margin: 4px !important;
            }
        }

        @media (orientation: landscape) and (max-height: 600px) {
            .floating-panel {
                max-height: 85vh;
            }
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –ü–ö */
        @media (min-width: 769px) {
            .info-chip-compact.status-chip-compact {
                position: relative;
                cursor: help;
            }
            
            .info-chip-compact.status-chip-compact:hover::after {
                content: attr(title);
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                background: #374151;
                color: white;
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 11px;
                white-space: nowrap;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                margin-bottom: 6px;
            }
            
            .info-chip-compact.status-chip-compact:hover::before {
                content: '';
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                border: 4px solid transparent;
                border-top-color: #374151;
                margin-bottom: -2px;
            }
            
            .building-address-compact {
                position: relative;
            }
            
            .building-address-compact:hover::after {
                content: attr(title);
                position: absolute;
                bottom: 100%;
                left: 0;
                background: #374151;
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                max-width: 300px;
                white-space: normal;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                margin-bottom: 6px;
            }
            
            .desktop-nav-button {
                position: relative;
            }
            
            .desktop-nav-button:hover::after {
                content: attr(data-tooltip);
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                background: #374151;
                color: white;
                padding: 6px 10px;
                border-radius: 6px;
                font-size: 11px;
                white-space: nowrap;
                z-index: 1000;
                margin-bottom: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            .scrollable-content::-webkit-scrollbar {
                width: 14px !important;
            }
            
            .scrollable-content::-webkit-scrollbar-thumb {
                border: 4px solid #f3f4f6 !important;
            }
        }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ */
        @media (max-width: 768px) {
            .scrollable-content::-webkit-scrollbar {
                width: 12px !important;
            }
            
            .scrollable-content::-webkit-scrollbar-thumb {
                min-height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã -->
    <div class="map-container">
        <div id="map"></div>
        
        <!-- –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —à–∞–ø–∫–∞ -->
        <div class="compact-header alone" id="compact-header">
            <div class="header-top">
                <div>
                    <div class="header-title">PR –ú–ê–†–ö–ï–¢ –†—è–∑–∞–Ω—å</div>
                    <div class="header-subtitle">–ö–∞—Ä—Ç–∞ —Å—Ç–µ–Ω–¥–æ–≤ —É –¥–æ–º–æ—Ñ–æ–Ω–∞: <span id="stats-total-stands">0</span> –≤ –±–∞–∑–µ</div>
                </div>
                <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ (–≤–∏–¥–Ω–∞ –Ω–∞ –ü–ö) -->
                <div class="header-toggle" id="header-toggle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
            </div>
            
            <div class="header-stats-compact">
                <div class="stat-compact">
                    <div class="stat-label-compact">–í—ã–±—Ä–∞–Ω–æ</div>
                    <div class="stat-value-compact" id="stats-compact-selected">0</div>
                </div>
                <div class="stat-compact">
                    <div class="stat-label-compact">–í –º–µ—Å—è—Ü</div>
                    <div class="stat-value-compact" id="stats-compact-price">‚Äî</div>
                </div>
                <div class="stat-compact">
                    <div class="stat-label-compact">–ó–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É</div>
                    <div class="stat-value-compact" id="stats-compact-per-flat">‚Äî</div>
                </div>
            </div>
            
            <!-- –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –≤ —à–∞–ø–∫–µ (—Ç–µ–ø–µ—Ä—å —Å –∫–Ω–æ–ø–∫–æ–π —Å–±—Ä–æ—Å–∞ –≤–º–µ—Å—Ç–æ –ø–∞–Ω–µ–ª–∏) -->
            <div class="desktop-header-nav">
                <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–∑–∞–º–µ–Ω—è–µ—Ç –∫–Ω–æ–ø–∫—É –ø–∞–Ω–µ–ª–∏) -->
                <button class="desktop-nav-button" data-action="reset-filters">
                    <span class="desktop-nav-icon">‚Üª</span>
                    <span class="desktop-nav-label">–°–±—Ä–æ—Å–∏—Ç—å</span>
                </button>
                <button class="desktop-nav-button" data-action="filters">
                    <span class="desktop-nav-icon">‚öôÔ∏è</span>
                    <span class="desktop-nav-label">–§–∏–ª—å—Ç—Ä—ã</span>
                </button>
                <button class="desktop-nav-button" data-action="list">
                    <span class="desktop-nav-icon">üìã</span>
                    <span class="desktop-nav-label">–°–ø–∏—Å–æ–∫</span>
                </button>
                <button class="desktop-nav-button" data-action="report">
                    <span class="desktop-nav-icon">üìÑ</span>
                    <span class="desktop-nav-label">–û—Ç—á—ë—Ç</span>
                </button>
            </div>
        </div>

        <!-- –ü–ª–∞–≤–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="floating-panel" id="floating-panel">
            <div class="panel-content-wrapper">
                <div class="tab-content-wrapper">
                    <!-- –í–∫–ª–∞–¥–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
                    <div class="tab-pane-content active" id="basic-tab-content">
                        <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏) -->
                        <div class="filter-reset-button-container">
                            <button class="action-button secondary" id="reset-filters-btn">
                                <span>‚Üª</span>
                                <span>–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</span>
                            </button>
                        </div>
                        
                        <div class="filters-grid scrollable-content">
                            <!-- –°—Ç–∞—Ç—É—Å -->
                            <div class="filter-card">
                                <div class="filter-card-title">–°—Ç–∞—Ç—É—Å —Å—Ç–µ–Ω–¥–æ–≤</div>
                                <div class="checkboxes-column" id="status-filters-compact">
                                    <!-- –ß–µ–∫–±–æ–∫—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </div>
                            </div>
                            
                            <!-- –†–∞–π–æ–Ω—ã -->
                            <div class="filter-card">
                                <div class="filter-card-title">–†–∞–π–æ–Ω –≥–æ—Ä–æ–¥–∞</div>
                                <div class="checkboxes-column" id="district-filters-compact">
                                    <!-- –ß–µ–∫–±–æ–∫—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </div>
                            </div>
                            
                            <!-- –≠—Ç–∞–∂–Ω–æ—Å—Ç—å –∑–¥–∞–Ω–∏–π -->
                            <div class="filter-card">
                                <div class="filter-card-title" id="floors-title">–≠—Ç–∞–∂–Ω–æ—Å—Ç—å –∑–¥–∞–Ω–∏–π</div>
                                <div class="range-compact">
                                    <div class="range-row">
                                        <button class="range-button minus" type="button" data-target="min-floors-compact">-</button>
                                        <input type="number" id="min-floors-compact" class="range-input-compact" placeholder="–û—Ç" min="1">
                                        <button class="range-button plus" type="button" data-target="min-floors-compact">+</button>
                                    </div>
                                    <div class="range-row">
                                        <button class="range-button minus" type="button" data-target="max-floors-compact">-</button>
                                        <input type="number" id="max-floors-compact" class="range-input-compact" placeholder="–î–æ" min="1">
                                        <button class="range-button plus" type="button" data-target="max-floors-compact">+</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- –ö–≤–∞—Ä—Ç–∏—Ä –≤ –ø–æ–¥—ä–µ–∑–¥–µ -->
                            <div class="filter-card">
                                <div class="filter-card-title" id="flats-title">–ö–≤–∞—Ä—Ç–∏—Ä –≤ –ø–æ–¥—ä–µ–∑–¥–µ</div>
                                <div class="range-compact">
                                    <div class="range-row">
                                        <button class="range-button minus" type="button" data-target="min-flats-compact">-</button>
                                        <input type="number" id="min-flats-compact" class="range-input-compact" placeholder="–û—Ç" min="1">
                                        <button class="range-button plus" type="button" data-target="min-flats-compact">+</button>
                                    </div>
                                    <div class="range-row">
                                        <button class="range-button minus" type="button" data-target="max-flats-compact">-</button>
                                        <input type="number" id="max-flats-compact" class="range-input-compact" placeholder="–î–æ" min="1">
                                        <button class="range-button plus" type="button" data-target="max-flats-compact">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –í–∫–ª–∞–¥–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
                    <div class="tab-pane-content" id="precise-tab-content">
                        <div class="precise-controls">
                            <div class="percentage-slider-container">
                                <!-- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ó–ê–ì–û–õ–û–í–û–ö –° –ö–ù–û–ü–ö–ê–ú–ò -->
                                <div class="percentage-controls">
                                    <span class="percentage-label">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                                    <div class="percentage-buttons">
                                        <button class="percentage-btn" id="percentage-decrease">-</button>
                                        <span class="percentage-value-compact" id="percentage-value-compact">100%</span>
                                        <button class="percentage-btn" id="percentage-increase">+</button>
                                    </div>
                                </div>
                                <input type="range" id="percentage-slider-compact" class="percentage-slider-compact" 
                                       min="1" max="100" step="1" value="100">
                            </div>
                        </div>
                        
                        <div id="buildings-list-compact" class="buildings-list-compact scrollable-content">
                            <!-- –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (4 –∫–Ω–æ–ø–∫–∏) -->
    <div class="mobile-nav-bar" id="mobile-nav-bar">
        <button class="nav-button active" data-action="map">
            <span class="nav-icon">üó∫Ô∏è</span>
            <span class="nav-label">–ö–∞—Ä—Ç–∞</span>
        </button>
        <button class="nav-button" data-action="filters">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span class="nav-label">–§–∏–ª—å—Ç—Ä—ã</span>
        </button>
        <button class="nav-button" data-action="list">
            <span class="nav-icon">üìã</span>
            <span class="nav-label">–°–ø–∏—Å–æ–∫</span>
        </button>
        <button class="nav-button" data-action="report">
            <span class="nav-icon">üìÑ</span>
            <span class="nav-label">–û—Ç—á—ë—Ç</span>
        </button>
    </div>

    <!-- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="notifications-container"></div>

    <!-- –ü–æ–ø–∞–ø –¥–ª—è –≤—ã–±–æ—Ä–∞ –∑–Ω–∞—á–µ–Ω–∏–π -->
    <div id="values-popup" class="values-popup"></div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const CONFIG = {
            SHEET_ID: '1jZsHbNXVmvNRjmh_p1pLFl3G3oLgD0sFas8L4EDexiI',
            SHEET_NAME: 'Filter',
            MAP_CENTER: [54.6416, 39.7126],
            MAP_ZOOM: 11,
            FREE_STATUS: '–°–≤–æ–±–æ–¥–Ω–æ',
            DEBOUNCE_DELAY: 300,
            DEFAULT_CLUSTER_LIMIT: 20,
            LOAD_MORE_STEP: 20,
            DEFAULT_RENDER_LIMIT: 50
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map;
        let objectManager;
        let allBuildings = [];
        let filteredBuildings = [];
        let preciseFilteredBuildings = [];
        let activeFilters = {
            status: new Set(),
            district: new Set()
        };
        let availableValues = {
            floors: [],
            flatsPerEntrance: []
        };
        let isPanelVisible = false;
        let displayPercentage = 100;
        let hiddenInBasicFilters = new Set();
        let hiddenInPreciseSettings = new Set();
        let buildingsByOriginalIndex = {};
        let mapUpdateRafId = null;
        let activeBalloon = null;
        let percentageDebounceTimer = null;
        let currentMode = 'basic';
        let currentRenderLimit = CONFIG.DEFAULT_RENDER_LIMIT;
        let isAppActive = true;
        let isMobile = window.innerWidth <= 768;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const elements = {
            loadingOverlay: document.getElementById('loading-overlay'),
            compactHeader: document.getElementById('compact-header'),
            headerToggle: document.getElementById('header-toggle'),
            floatingPanel: document.getElementById('floating-panel'),
            map: document.getElementById('map'),
            statsCompactSelected: document.getElementById('stats-compact-selected'),
            statsCompactPrice: document.getElementById('stats-compact-price'),
            statsCompactPerFlat: document.getElementById('stats-compact-per-flat'),
            statsTotalStands: document.getElementById('stats-total-stands'),
            statusFiltersCompact: document.getElementById('status-filters-compact'),
            districtFiltersCompact: document.getElementById('district-filters-compact'),
            minFloorsCompact: document.getElementById('min-floors-compact'),
            maxFloorsCompact: document.getElementById('max-floors-compact'),
            minFlatsCompact: document.getElementById('min-flats-compact'),
            maxFlatsCompact: document.getElementById('max-flats-compact'),
            floorsTitle: document.getElementById('floors-title'),
            flatsTitle: document.getElementById('flats-title'),
            percentageSliderCompact: document.getElementById('percentage-slider-compact'),
            percentageValueCompact: document.getElementById('percentage-value-compact'),
            buildingsListCompact: document.getElementById('buildings-list-compact'),
            resetFiltersBtn: document.getElementById('reset-filters-btn'),
            mobileNavBar: document.getElementById('mobile-nav-bar'),
            percentageDecrease: document.getElementById('percentage-decrease'),
            percentageIncrease: document.getElementById('percentage-increase')
        };

        // –£—Ç–∏–ª–∏—Ç—ã
        const Utils = {
            debounce(func, wait) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            },

            escapeHtml(text) {
                if (text === null || text === undefined) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            formatNumber(num) {
                return new Intl.NumberFormat('ru-RU').format(num);
            },

            formatPrice(num) {
                return new Intl.NumberFormat('ru-RU', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(num);
            },

            showNotification(message, type = 'success') {
                if (!isAppActive) return;
                
                const container = document.getElementById('notifications-container') || document.body;
                const notification = document.createElement('div');
                notification.className = `notification-toast ${type}`;
                notification.textContent = message;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    if (!isAppActive) return;
                    notification.style.animation = 'slideOutTop 0.3s ease-out forwards';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            },

            runIdle(callback, timeout = 100) {
                if ('requestIdleCallback' in window) {
                    return requestIdleCallback(callback, { timeout });
                } else {
                    return requestAnimationFrame(callback);
                }
            }
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —ç–º–æ–¥–∑–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–π–æ–Ω–æ–≤
        function getStatusWithEmoji(status) {
            if (status === CONFIG.FREE_STATUS) {
                return 'üü¢ ' + status;
            } else if (status && status.includes('–ó–∞–Ω—è—Ç–æ')) {
                return 'üî¥ ' + status;
            }
            return status;
        }

        function getShortDistrictName(fullDistrict) {
            if (!fullDistrict) return '';
            const bracketIndex = fullDistrict.indexOf('(');
            if (bracketIndex !== -1) {
                return fullDistrict.substring(0, bracketIndex).trim();
            }
            return fullDistrict;
        }

        // =============================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê
        // =============================
        function initInterface() {
            // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ (–¥–ª—è –ü–ö)
            if (!isMobile) {
                elements.headerToggle.addEventListener('click', toggleDesktopPanel);
            } else {
                elements.headerToggle.style.display = 'none';
            }
            
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è (–º–æ–±–∏–ª—å–Ω–∞—è –∏ –¥–µ—Å–∫—Ç–æ–ø–Ω–∞—è)
            setupNavigation();
            
            // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            elements.resetFiltersBtn.addEventListener('click', resetAllFilters);
            
            // –ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π —Å–ª–∞–π–¥–µ—Ä
            elements.percentageSliderCompact.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                displayPercentage = value;
                updatePercentageDisplay();
                
                clearTimeout(percentageDebounceTimer);
                percentageDebounceTimer = setTimeout(() => {
                    applyPreciseFilters();
                }, 100);
            });
            
            // –ù–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º
            elements.percentageDecrease.addEventListener('click', () => {
                let value = parseInt(elements.percentageSliderCompact.value);
                value = Math.max(1, value - 1);
                elements.percentageSliderCompact.value = value;
                displayPercentage = value;
                updatePercentageDisplay();
                
                clearTimeout(percentageDebounceTimer);
                percentageDebounceTimer = setTimeout(() => {
                    applyPreciseFilters();
                }, 100);
            });
            
            elements.percentageIncrease.addEventListener('click', () => {
                let value = parseInt(elements.percentageSliderCompact.value);
                value = Math.min(100, value + 1);
                elements.percentageSliderCompact.value = value;
                displayPercentage = value;
                updatePercentageDisplay();
                
                clearTimeout(percentageDebounceTimer);
                percentageDebounceTimer = setTimeout(() => {
                    applyPreciseFilters();
                }, 100);
            });
            
            // –ù–∞ –ü–ö –ø–∞–Ω–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞
            if (!isMobile) {
                elements.floatingPanel.style.display = 'none';
                elements.floatingPanel.classList.remove('active');
                isPanelVisible = false;
                updateHeaderToggleIcon();
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –Ω–∞ –ü–ö
                setTimeout(() => {
                    const filtersGrid = document.querySelector('.filters-grid');
                    if (filtersGrid) {
                        filtersGrid.style.overflowY = 'scroll';
                        filtersGrid.style.scrollbarWidth = 'thin';
                    }
                    
                    const buildingsList = document.getElementById('buildings-list-compact');
                    if (buildingsList) {
                        buildingsList.style.overflowY = 'scroll';
                        buildingsList.style.scrollbarWidth = 'thin';
                    }
                }, 100);
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            window.addEventListener('resize', handleResize);
        }

        function setupNavigation() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–æ–±—â–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –∏ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π)
            const handleNavClick = (button) => {
                const action = button.dataset.action;
                
                // –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –≤ —à–∞–ø–∫–µ
                if (button.closest('.desktop-header-nav')) {
                    const navBar = button.closest('.desktop-header-nav');
                    navBar.querySelectorAll('.desktop-nav-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');
                    
                    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –º–æ–±–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
                    if (action !== 'reset-filters') {
                        const mobileButton = elements.mobileNavBar.querySelector(`[data-action="${action}"]`);
                        if (mobileButton) {
                            elements.mobileNavBar.querySelectorAll('.nav-button').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            mobileButton.classList.add('active');
                        }
                    }
                } 
                // –î–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                else if (button.closest('.mobile-nav-bar')) {
                    const navBar = button.closest('.mobile-nav-bar');
                    navBar.querySelectorAll('.nav-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');
                    
                    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –≤ —à–∞–ø–∫–µ
                    const desktopButton = document.querySelector(`.desktop-header-nav [data-action="${action}"]`);
                    if (desktopButton) {
                        document.querySelectorAll('.desktop-header-nav .desktop-nav-button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        desktopButton.classList.add('active');
                    }
                }
                
                handleNavigationAction(action, button);
            };
            
            // –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
            if (elements.mobileNavBar) {
                elements.mobileNavBar.querySelectorAll('.nav-button').forEach(button => {
                    button.addEventListener('click', () => handleNavClick(button));
                });
            }
            
            // –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –≤ —à–∞–ø–∫–µ
            const desktopNavButtons = document.querySelectorAll('.desktop-header-nav .desktop-nav-button');
            if (desktopNavButtons.length > 0) {
                desktopNavButtons.forEach(button => {
                    const action = button.dataset.action;
                    let tooltip = '';
                    switch(action) {
                        case 'reset-filters': tooltip = '–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã'; break;
                        case 'filters': tooltip = '–§–∏–ª—å—Ç—Ä—ã –≤—ã–±–æ—Ä–∞ –∑–¥–∞–Ω–∏–π'; break;
                        case 'list': tooltip = '–°–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–¥–∞–Ω–∏–π'; break;
                        case 'report': tooltip = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç –≤ –±—É—Ñ–µ—Ä'; break;
                    }
                    button.setAttribute('data-tooltip', tooltip);
                    button.addEventListener('click', () => handleNavClick(button));
                });
            }
        }

        function handleNavigationAction(action, button) {
            switch(action) {
                case 'map':
                    if (!isMobile) {
                        elements.floatingPanel.style.display = 'none';
                        elements.floatingPanel.classList.remove('active');
                        elements.compactHeader.classList.remove('with-panel');
                        elements.compactHeader.classList.add('alone');
                        isPanelVisible = false;
                        updateHeaderToggleIcon();
                    } else {
                        elements.floatingPanel.classList.remove('active');
                        isPanelVisible = false;
                    }
                    break;
                    
                case 'reset-filters':
                    resetAllFilters();
                    button.classList.add('active');
                    setTimeout(() => {
                        button.classList.remove('active');
                    }, 500);
                    break;
                    
                case 'filters':
                    if (!isMobile) {
                        if (isPanelVisible && currentMode === 'basic') {
                            elements.floatingPanel.style.display = 'none';
                            elements.floatingPanel.classList.remove('active');
                            elements.compactHeader.classList.remove('with-panel');
                            elements.compactHeader.classList.add('alone');
                            isPanelVisible = false;
                            updateHeaderToggleIcon();
                        } else {
                            elements.floatingPanel.style.display = 'flex';
                            elements.floatingPanel.classList.add('active');
                            elements.compactHeader.classList.remove('alone');
                            elements.compactHeader.classList.add('with-panel');
                            isPanelVisible = true;
                            updateHeaderToggleIcon();
                            switchContent('basic');
                            
                            setTimeout(() => {
                                const filtersGrid = document.querySelector('.filters-grid');
                                if (filtersGrid) {
                                    filtersGrid.style.overflowY = 'scroll';
                                    filtersGrid.style.scrollbarWidth = 'thin';
                                }
                            }, 50);
                        }
                    } else {
                        if (isPanelVisible && currentMode === 'basic') {
                            elements.floatingPanel.classList.remove('active');
                            isPanelVisible = false;
                        } else {
                            elements.floatingPanel.classList.add('active');
                            isPanelVisible = true;
                            switchContent('basic');
                        }
                    }
                    break;
                    
                case 'list':
                    if (!isMobile) {
                        if (isPanelVisible && currentMode === 'precise') {
                            elements.floatingPanel.style.display = 'none';
                            elements.floatingPanel.classList.remove('active');
                            elements.compactHeader.classList.remove('with-panel');
                            elements.compactHeader.classList.add('alone');
                            isPanelVisible = false;
                            updateHeaderToggleIcon();
                        } else {
                            elements.floatingPanel.style.display = 'flex';
                            elements.floatingPanel.classList.add('active');
                            elements.compactHeader.classList.remove('alone');
                            elements.compactHeader.classList.add('with-panel');
                            isPanelVisible = true;
                            updateHeaderToggleIcon();
                            switchContent('precise');
                            
                            setTimeout(() => {
                                const buildingsList = document.getElementById('buildings-list-compact');
                                if (buildingsList) {
                                    buildingsList.style.overflowY = 'scroll';
                                    buildingsList.style.scrollbarWidth = 'thin';
                                }
                            }, 50);
                        }
                    } else {
                        if (isPanelVisible && currentMode === 'precise') {
                            elements.floatingPanel.classList.remove('active');
                            isPanelVisible = false;
                        } else {
                            elements.floatingPanel.classList.add('active');
                            isPanelVisible = true;
                            switchContent('precise');
                        }
                    }
                    break;
                    
                case 'report':
                    copyReportToClipboard();
                    break;
            }
        }

        function toggleDesktopPanel() {
            if (!isMobile) {
                isPanelVisible = !isPanelVisible;
                if (isPanelVisible) {
                    elements.floatingPanel.style.display = 'flex';
                    elements.floatingPanel.classList.add('active');
                    elements.compactHeader.classList.remove('alone');
                    elements.compactHeader.classList.add('with-panel');
                    
                    setTimeout(() => {
                        if (currentMode === 'basic') {
                            const filtersGrid = document.querySelector('.filters-grid');
                            if (filtersGrid) {
                                filtersGrid.style.overflowY = 'scroll';
                                filtersGrid.style.scrollbarWidth = 'thin';
                            }
                        } else if (currentMode === 'precise') {
                            const buildingsList = document.getElementById('buildings-list-compact');
                            if (buildingsList) {
                                buildingsList.style.overflowY = 'scroll';
                                buildingsList.style.scrollbarWidth = 'thin';
                            }
                        }
                    }, 50);
                } else {
                    elements.floatingPanel.style.display = 'none';
                    elements.floatingPanel.classList.remove('active');
                    elements.compactHeader.classList.remove('with-panel');
                    elements.compactHeader.classList.add('alone');
                }
                updateHeaderToggleIcon();
            }
        }

        function updateHeaderToggleIcon() {
            if (!isMobile && elements.headerToggle) {
                if (isPanelVisible) {
                    elements.headerToggle.classList.add('active');
                } else {
                    elements.headerToggle.classList.remove('active');
                }
            }
        }

        function switchContent(contentType) {
            document.querySelectorAll('.tab-pane-content').forEach(pane => {
                pane.classList.remove('active');
            });
            
            if (contentType === 'basic') {
                document.getElementById('basic-tab-content').classList.add('active');
                currentMode = 'basic';
            } else if (contentType === 'precise') {
                document.getElementById('precise-tab-content').classList.add('active');
                currentMode = 'precise';
                updateBuildingsList();
            }
        }

        function handleResize() {
            const wasMobile = isMobile;
            isMobile = window.innerWidth <= 768;
            
            if (wasMobile !== isMobile) {
                if (isMobile) {
                    elements.headerToggle.style.display = 'none';
                    elements.floatingPanel.style.display = 'flex';
                    if (isPanelVisible) {
                        elements.floatingPanel.classList.add('active');
                    }
                    elements.compactHeader.classList.remove('with-panel', 'alone');
                } else {
                    elements.headerToggle.style.display = 'flex';
                    elements.floatingPanel.style.display = 'none';
                    elements.floatingPanel.classList.remove('active');
                    isPanelVisible = false;
                    
                    elements.compactHeader.classList.remove('with-panel');
                    elements.compactHeader.classList.add('alone');
                    
                    updateHeaderToggleIcon();
                }
            }
        }

        // =============================
        // –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // =============================

        function calculatePrice(totalStands) {
            if (totalStands < 100) {
                return { 
                    pricePerStand: null, 
                    totalPrice: null, 
                    message: '–í—ã–±–µ—Ä–∏—Ç–µ –±–æ–ª—å—à–µ –∑–¥–∞–Ω–∏–π' 
                };
            } else if (totalStands >= 100 && totalStands <= 299) {
                return { 
                    pricePerStand: 160, 
                    totalPrice: totalStands * 160 
                };
            } else if (totalStands >= 300 && totalStands <= 499) {
                return { 
                    pricePerStand: 140, 
                    totalPrice: totalStands * 140 
                };
            } else {
                return { 
                    pricePerStand: 120, 
                    totalPrice: totalStands * 120 
                };
            }
        }

        function selectByPercentageBresenham(items, percentage) {
            if (percentage >= 100) return [...items];
            if (percentage <= 0 || items.length === 0) return [];
            
            const n = items.length;
            const k = Math.round(n * percentage / 100);
            
            if (k >= n) return [...items];
            if (k <= 0) return [];
            
            const result = [];
            let error = 0;
            const step = n / k;
            
            for (let i = 0; i < n && result.length < k; i++) {
                error += 1;
                if (error >= step) {
                    result.push(items[i]);
                    error -= step;
                }
            }
            
            return result;
        }

        function updatePercentageDisplay() {
            elements.percentageValueCompact.textContent = `${displayPercentage}%`;
            elements.percentageSliderCompact.value = displayPercentage;
        }

        function updateStatistics() {
            Utils.runIdle(() => {
                computeStatistics();
            });
        }

        function computeStatistics() {
            let totalStands = 0;
            let totalFlats = 0;
            let totalStandsAll = 0;
            
            for (let i = 0; i < preciseFilteredBuildings.length; i++) {
                const building = preciseFilteredBuildings[i];
                totalStands += building.entrances || 0;
                totalFlats += building.flats || 0;
            }
            
            for (let i = 0; i < allBuildings.length; i++) {
                const building = allBuildings[i];
                totalStandsAll += building.entrances || 0;
            }
            
            updateStatsDOM(totalStands, totalFlats, totalStandsAll);
        }

        function updateStatsDOM(totalStands, totalFlats, totalStandsAll) {
            elements.statsTotalStands.textContent = Utils.formatNumber(totalStandsAll);
            elements.statsCompactSelected.textContent = Utils.formatNumber(totalStands);
            
            if (totalStands === 0) {
                elements.statsCompactPrice.textContent = '‚Äî';
                elements.statsCompactPerFlat.textContent = '‚Äî';
                return;
            }
            
            const priceInfo = calculatePrice(totalStands);
            
            if (totalStands < 100) {
                elements.statsCompactPrice.textContent = '‚Äî';
                elements.statsCompactPerFlat.textContent = '‚Äî';
            } else {
                elements.statsCompactPrice.textContent = `${Utils.formatNumber(priceInfo.totalPrice)} ‚ÇΩ`;
                
                if (totalFlats > 0) {
                    const pricePerFlat = priceInfo.totalPrice / totalFlats;
                    elements.statsCompactPerFlat.textContent = `${Utils.formatNumber(pricePerFlat.toFixed(2))} ‚ÇΩ`;
                } else {
                    elements.statsCompactPerFlat.textContent = '‚Äî';
                }
            }
        }

        // =============================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´
        // =============================
        function initMap() {
            return new Promise((resolve) => {
                ymaps.ready(() => {
                    const mapOptions = {
                        center: CONFIG.MAP_CENTER,
                        zoom: CONFIG.MAP_ZOOM,
                        controls: isMobile ? ['zoomControl'] : ['zoomControl', 'fullscreenControl'],
                        avoidFractionalZoom: true,
                        suppressMapOpenBlock: true,
                        yandexMapDisablePoiInteractivity: true,
                        suppressObsoleteBrowserNotifier: true,
                        copyrightLogoVisible: false,
                        copyrightUaVisible: false,
                        copyrightProvidersVisible: false
                    };
                    
                    map = new ymaps.Map('map', mapOptions);

                    objectManager = new ymaps.ObjectManager({
                        clusterize: true,
                        gridSize: 64,
                        clusterDisableClickZoom: true,
                        clusterOpenBalloonOnClick: false,
                        geoObjectOpenBalloonOnClick: false
                    });

                    objectManager.clusters.options.set({
                        preset: 'islands#invertedVioletClusterIcons',
                        clusterIconColor: '#667eea',
                        clusterIconPieStrokeWidth: 0,
                        clusterIconPieStrokeColor: '#ffffff'
                    });

                    objectManager.objects.options.set({
                        preset: 'islands#circleDotIcon',
                        iconColor: '#10b981'
                    });

                    map.geoObjects.add(objectManager);
                    
                    setupMapEventHandlers();
                    
                    resolve();
                });
            });
        }

        function setupMapEventHandlers() {
            objectManager.clusters.events.add('click', (e) => {
                const clusterId = e.get('objectId');
                handleClusterClick(clusterId);
            });

            objectManager.objects.events.add('click', (e) => {
                const objectId = e.get('objectId');
                const object = objectManager.objects.getById(objectId);
                
                if (object && object.properties) {
                    const originalIndex = object.properties.originalIndex;
                    if (originalIndex !== undefined) {
                        const building = buildingsByOriginalIndex[originalIndex];
                        if (building) {
                            showBuildingBalloon(building, object.geometry.coordinates);
                        }
                    }
                }
            });
        }

        function handleClusterClick(clusterId) {
            const cluster = objectManager.clusters.getById(clusterId);
            if (!cluster) return;
            
            const geoObjects = cluster.properties?.geoObjects || [];
            const totalCount = cluster.properties?.number || geoObjects.length;
            const clusterBuildings = [];
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–¥–∞–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞
            for (let i = 0; i < geoObjects.length; i++) {
                const geoObject = geoObjects[i];
                const originalIndex = geoObject.properties?.originalIndex;
                if (originalIndex !== undefined) {
                    const building = buildingsByOriginalIndex[originalIndex];
                    if (building) {
                        clusterBuildings.push(building);
                    }
                }
            }
            
            if (clusterBuildings.length > 0) {
                showClusterBalloon(clusterBuildings, cluster.geometry.coordinates, totalCount);
            }
        }

        function showBuildingBalloon(building, coords) {
            const statusEmoji = building.status === CONFIG.FREE_STATUS ? 'üü¢' : 'üî¥';
            const content = `
                <div class="custom-balloon">
                    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                        <div style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;" title="${Utils.escapeHtml(building.status)}">
                                ${statusEmoji}
                            </span>
                            <span>${Utils.escapeHtml(building.address)}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <div>
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">–°—Ç–∞—Ç—É—Å</div>
                                <div style="font-size: 13px; font-weight: 600; color: ${building.status === CONFIG.FREE_STATUS ? '#10b981' : '#ef4444'}">
                                    ${building.status === CONFIG.FREE_STATUS ? '–°–≤–æ–±–æ–¥–Ω–æ' : '–ó–∞–Ω—è—Ç–æ'}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">–†–∞–π–æ–Ω</div>
                                <div style="font-size: 13px; font-weight: 600; color: #111827;">${Utils.escapeHtml(building.district)}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">–°—Ç–µ–Ω–¥–æ–≤</div>
                                <div style="font-size: 13px; font-weight: 600; color: #111827;">${building.entrances || '‚Äî'}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">–ö–≤–∞—Ä—Ç–∏—Ä</div>
                                <div style="font-size: 13px; font-weight: 600; color: #111827;">${Utils.formatNumber(building.flats) || '‚Äî'}</div>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 16px;">
                        <button onclick="window.handleHideSingle(${building.originalIndex})" style="
                            width: 100%;
                            padding: 12px;
                            background: #ef4444;
                            color: white;
                            border: none;
                            border-radius: 10px;
                            font-size: 13px;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 6px;
                            transition: all 0.2s ease;
                        ">
                            <span style="font-size: 16px; font-weight: bold;">√ó</span>
                            <span>–°–∫—Ä—ã—Ç—å –∞–¥—Ä–µ—Å</span>
                        </button>
                    </div>
                </div>
            `;
            
            openCustomBalloon(coords, content, true);
        }

        function showClusterBalloon(buildings, coords, totalCount) {
            const allBuildingIds = buildings.map(b => b.originalIndex).join(',');
            
            let tableRows = '';
            for (let i = 0; i < buildings.length; i++) {
                const building = buildings[i];
                const statusDot = building.status === CONFIG.FREE_STATUS ? 'üü¢' : 'üî¥';
                let address = building.address;
                if (address.length > 30) address = address.substring(0, 28) + '...';
                
                tableRows += `
                    <tr>
                        <td style="padding: 10px 6px; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span title="${Utils.escapeHtml(building.status)}" style="font-size: 16px;">
                                    ${statusDot}
                                </span>
                                <div style="font-size: 12px; font-weight: 500; color: #111827; max-width: 180px; overflow: hidden; text-overflow: ellipsis;">
                                    ${Utils.escapeHtml(address)}
                                </div>
                            </div>
                        </td>
                        <td style="padding: 10px 6px; border-bottom: 1px solid #e5e7eb; text-align: center;">
                            <div style="font-size: 12px; font-weight: 600; color: #111827;">${building.entrances || '‚Äî'}</div>
                        </td>
                    </tr>
                `;
            }
            
            const content = `
                <div class="custom-balloon">
                    <div style="padding: 16px; border-bottom: 1px solid #e5e7eb;">
                        <div style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 12px; display: flex; align-items: center; gap: 4px;">
                            <span>–ö–ª–∞—Å—Ç–µ—Ä:</span>
                            <span>${totalCount}</span>
                            <span>üè†</span>
                        </div>
                        <div style="max-height: 250px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr>
                                        <th style="padding: 10px 6px; text-align: left; font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">–ê–¥—Ä–µ—Å</th>
                                        <th style="padding: 10px 6px; text-align: center; font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">–°—Ç–µ–Ω–¥–æ–≤</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div style="padding: 16px;">
                        <button onclick="window.handleHideAllCluster([${allBuildingIds}])" style="
                            width: 100%;
                            padding: 12px;
                            background: #ef4444;
                            color: white;
                            border: none;
                            border-radius: 10px;
                            font-size: 13px;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 6px;
                            transition: all 0.2s ease;
                        ">
                            <span style="font-size: 16px; font-weight: bold;">√ó</span>
                            <span>–°–∫—Ä—ã—Ç—å –∫–ª–∞—Å—Ç–µ—Ä</span>
                        </button>
                    </div>
                </div>
            `;
            
            openCustomBalloon(coords, content, true);
        }

        function openCustomBalloon(coords, content, shouldCenter = true) {
            try {
                if (map.balloon.isOpen()) {
                    map.balloon.close();
                }
                
                const tempPlacemark = new ymaps.Placemark(coords, {
                    balloonContent: content
                }, {
                    balloonCloseButton: true,
                    balloonPanelMaxMapArea: 0,
                    balloonMaxHeight: 400,
                    balloonMaxWidth: 380,
                    balloonAutoPan: shouldCenter,
                    balloonOffset: [0, 0],
                    visible: false
                });
                
                map.geoObjects.add(tempPlacemark);
                activeBalloon = tempPlacemark;
                tempPlacemark.balloon.open();
                
                tempPlacemark.balloon.events.add('close', () => {
                    setTimeout(() => {
                        map.geoObjects.remove(tempPlacemark);
                        if (activeBalloon === tempPlacemark) {
                            activeBalloon = null;
                        }
                    }, 100);
                });
                
            } catch (error) {
                console.error('Error opening balloon:', error);
            }
        }

        window.handleHideSingle = function(index) {
            if (!isAppActive) return;
            
            hiddenInBasicFilters.add(index);
            
            const building = buildingsByOriginalIndex[index];
            if (building && building.district) {
                checkAndUncheckDistrict(building.district);
            }
            
            if (building && building.status) {
                checkAndUncheckStatus(building.status);
            }
            
            updateFilters();
            Utils.showNotification('–ê–¥—Ä–µ—Å —Å–∫—Ä—ã—Ç');
            
            if (map && map.balloon && map.balloon.isOpen()) {
                map.balloon.close();
            }
        };

        window.handleHideAllCluster = function(buildingIds) {
            if (!isAppActive) return;
            
            const hiddenDistricts = new Set();
            const hiddenStatuses = new Set();
            
            buildingIds.forEach(id => {
                if (id !== undefined && id !== null) {
                    const parsedId = parseInt(id);
                    hiddenInBasicFilters.add(parsedId);
                    
                    const building = buildingsByOriginalIndex[parsedId];
                    if (building) {
                        if (building.district) hiddenDistricts.add(building.district);
                        if (building.status) hiddenStatuses.add(building.status);
                    }
                }
            });
            
            hiddenDistricts.forEach(district => {
                checkAndUncheckDistrict(district);
            });
            
            hiddenStatuses.forEach(status => {
                checkAndUncheckStatus(status);
            });
            
            updateFilters();
            Utils.showNotification(`–°–∫—Ä—ã—Ç–æ ${buildingIds.length} –∞–¥—Ä–µ—Å–æ–≤`);
            
            if (map && map.balloon && map.balloon.isOpen()) {
                map.balloon.close();
            }
        };

        function checkAndUncheckDistrict(districtName) {
            let visibleCount = 0;
            for (let i = 0; i < allBuildings.length; i++) {
                const building = allBuildings[i];
                if (building.district === districtName && 
                    !hiddenInBasicFilters.has(building.originalIndex)) {
                    visibleCount++;
                    if (visibleCount > 0) break;
                }
            }
            
            if (visibleCount === 0) {
                const checkbox = document.querySelector(`#district-filters-compact input[value="${districtName}"]`);
                if (checkbox && checkbox.checked) {
                    checkbox.checked = false;
                    activeFilters.district.delete(districtName);
                }
            }
        }

        function checkAndUncheckStatus(statusName) {
            let visibleCount = 0;
            for (let i = 0; i < allBuildings.length; i++) {
                const building = allBuildings[i];
                if (building.status === statusName && 
                    !hiddenInBasicFilters.has(building.originalIndex)) {
                    visibleCount++;
                    if (visibleCount > 0) break;
                }
            }
            
            if (visibleCount === 0) {
                const checkbox = document.querySelector(`#status-filters-compact input[value="${statusName}"]`);
                if (checkbox && checkbox.checked) {
                    checkbox.checked = false;
                    activeFilters.status.delete(statusName);
                }
            }
        }

        // =============================
        // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–ù–û–ü–ö–ê–ú–ò –î–ò–ê–ü–ê–ó–û–ù–ê
        // =============================
        
        function updateRangeButtonsState() {
            updateSingleRangeButtons(
                'min-floors-compact', 
                'max-floors-compact', 
                availableValues.floors
            );
            
            updateSingleRangeButtons(
                'min-flats-compact', 
                'max-flats-compact', 
                availableValues.flatsPerEntrance
            );
        }

        function updateSingleRangeButtons(minInputId, maxInputId, availableValuesArray) {
            if (availableValuesArray.length === 0) return;
            
            const minInput = document.getElementById(minInputId);
            const maxInput = document.getElementById(maxInputId);
            
            const minMinusBtn = minInput.parentElement.querySelector('.minus[data-target="' + minInputId + '"]');
            const minPlusBtn = minInput.parentElement.querySelector('.plus[data-target="' + minInputId + '"]');
            const maxMinusBtn = maxInput.parentElement.querySelector('.minus[data-target="' + maxInputId + '"]');
            const maxPlusBtn = maxInput.parentElement.querySelector('.plus[data-target="' + maxInputId + '"]');
            
            if (!minMinusBtn || !maxPlusBtn) return;
            
            const minValue = parseInt(minInput.value) || availableValuesArray[0];
            const maxValue = parseInt(maxInput.value) || availableValuesArray[availableValuesArray.length - 1];
            
            if (minValue <= availableValuesArray[0]) {
                minMinusBtn.classList.add('disabled');
                minMinusBtn.style.opacity = '0.5';
                minMinusBtn.style.cursor = 'not-allowed';
            } else {
                minMinusBtn.classList.remove('disabled');
                minMinusBtn.style.opacity = '1';
                minMinusBtn.style.cursor = 'pointer';
            }
            
            if (maxValue >= availableValuesArray[availableValuesArray.length - 1]) {
                maxPlusBtn.classList.add('disabled');
                maxPlusBtn.style.opacity = '0.5';
                maxPlusBtn.style.cursor = 'not-allowed';
            } else {
                maxPlusBtn.classList.remove('disabled');
                maxPlusBtn.style.opacity = '1';
                maxPlusBtn.style.cursor = 'pointer';
            }
        }

        // =============================
        // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
        // =============================
        
        function loadData() {
            return new Promise((resolve, reject) => {
                const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=responseHandler:handleSheetData&sheet=${CONFIG.SHEET_NAME}`;
                
                window.handleSheetData = function(response) {
                    try {
                        Utils.runIdle(() => {
                            const data = parseGoogleSheetResponse(response);
                            allBuildings = data;
                            
                            data.forEach(building => {
                                buildingsByOriginalIndex[building.originalIndex] = building;
                            });
                            
                            resolve(data);
                        }, 1000);
                    } catch (error) {
                        reject(error);
                    }
                };

                const script = document.createElement('script');
                script.src = url;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function parseGoogleSheetResponse(response) {
            const rows = response.table?.rows || [];
            const buildings = [];
            
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].c || [];
                if (cells.length < 9) continue;
                
                const building = {
                    originalIndex: i,
                    address: getCellValue(cells[0]) || '',
                    lat: parseFloat(getCellValue(cells[2])) || 0,
                    lng: parseFloat(getCellValue(cells[1])) || 0,
                    status: getCellValue(cells[3]) || '',
                    district: getCellValue(cells[4]) || '',
                    entrances: getIntValue(cells[5]),
                    floors: getIntValue(cells[6]),
                    flats: getIntValue(cells[7]),
                    flatsPerEntrance: getIntValue(cells[8])
                };
                
                if (building.lat && building.lng) {
                    buildings.push(building);
                }
            }
            
            return buildings;
        }
        
        function getCellValue(cell) {
            if (!cell) return null;
            return cell.v !== undefined ? cell.v : cell.f;
        }

        function getIntValue(cell) {
            if (!cell) return null;
            const value = getCellValue(cell);
            if (value === null || value === undefined || value === '') return null;
            const num = parseInt(value);
            return isNaN(num) ? null : num;
        }

        function collectAvailableValues(buildings) {
            const floorsSet = new Set();
            const flatsSet = new Set();
            const statusSet = new Set();
            const districtSet = new Set();
            
            for (let i = 0; i < buildings.length; i++) {
                const building = buildings[i];
                if (building.floors !== null) floorsSet.add(building.floors);
                if (building.flatsPerEntrance !== null) flatsSet.add(building.flatsPerEntrance);
                if (building.status) statusSet.add(building.status);
                if (building.district) districtSet.add(building.district);
            }
            
            availableValues.floors = Array.from(floorsSet).sort((a, b) => a - b);
            availableValues.flatsPerEntrance = Array.from(flatsSet).sort((a, b) => a - b);
            
            return {
                statuses: Array.from(statusSet).sort(),
                districts: Array.from(districtSet).sort()
            };
        }

        function createCheckboxFilter(containerId, values, label) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            for (let i = 0; i < values.length; i++) {
                const value = values[i];
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-card';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${containerId}-${Utils.escapeHtml(value)}`;
                checkbox.value = value;
                checkbox.checked = true;
                
                const checkboxLabel = document.createElement('label');
                checkboxLabel.htmlFor = checkbox.id;
                checkboxLabel.textContent = getStatusWithEmoji(value);
                
                checkboxItem.appendChild(checkbox);
                checkboxItem.appendChild(checkboxLabel);
                container.appendChild(checkboxItem);
                
                checkbox.addEventListener('change', () => {
                    const filterType = containerId.replace('-filters-compact', '');
                    if (checkbox.checked) {
                        activeFilters[filterType].add(value);
                    } else {
                        activeFilters[filterType].delete(value);
                    }
                    Utils.debounce(applyBaseFilters, 300)();
                });
            }
        }

        function setupNumberInputs() {
            setupRangeInput(elements.minFloorsCompact, elements.maxFloorsCompact, 'floors', false);
            setupRangeInput(elements.maxFloorsCompact, elements.minFloorsCompact, 'floors', true);
            
            setupRangeInput(elements.minFlatsCompact, elements.maxFlatsCompact, 'flatsPerEntrance', false);
            setupRangeInput(elements.maxFlatsCompact, elements.minFlatsCompact, 'flatsPerEntrance', true);
            
            setupRangeButtons();
        }

        function setupRangeButtons() {
            setupRangeButtonHandlers('min-floors-compact', 'floors');
            setupRangeButtonHandlers('max-floors-compact', 'floors');
            
            setupRangeButtonHandlers('min-flats-compact', 'flatsPerEntrance');
            setupRangeButtonHandlers('max-flats-compact', 'flatsPerEntrance');
        }

        function setupRangeButtonHandlers(inputId, fieldType) {
            const input = document.getElementById(inputId);
            const plusBtn = input.parentElement.querySelector('.plus[data-target="' + inputId + '"]');
            const minusBtn = input.parentElement.querySelector('.minus[data-target="' + inputId + '"]');
            
            if (!plusBtn || !minusBtn) return;
            
            plusBtn.addEventListener('click', () => {
                adjustRangeValue(input, fieldType, 1);
            });
            
            minusBtn.addEventListener('click', () => {
                adjustRangeValue(input, fieldType, -1);
            });
        }

        function adjustRangeValue(input, fieldType, direction) {
            const values = availableValues[fieldType];
            if (values.length === 0) return;
            
            let currentValue = parseInt(input.value) || values[0];
            
            let currentIndex = values.indexOf(currentValue);
            if (currentIndex === -1) {
                currentIndex = values.findIndex(v => v >= currentValue);
                if (currentIndex === -1) currentIndex = values.length - 1;
            }
            
            let newIndex = currentIndex + direction;
            newIndex = Math.max(0, Math.min(newIndex, values.length - 1));
            
            const newValue = values[newIndex];
            input.value = newValue;
            
            updateRangeButtonsState();
            
            Utils.debounce(applyBaseFilters, 300)();
        }

        function setupRangeInput(inputElement, oppositeElement, fieldType, isMaxField) {
            const values = availableValues[fieldType];
            if (values.length === 0) return;
            
            const debouncedInputHandler = Utils.debounce(() => {
                if (inputElement.value === '') return;
                
                const value = parseInt(inputElement.value);
                if (isNaN(value)) {
                    inputElement.value = '';
                    return;
                }
                
                let closestValue = values[0];
                if (values.length > 0) {
                    let left = 0;
                    let right = values.length - 1;
                    let minDiff = Math.abs(value - values[0]);
                    
                    while (left <= right) {
                        const mid = Math.floor((left + right) / 2);
                        const diff = Math.abs(value - values[mid]);
                        
                        if (diff < minDiff) {
                            minDiff = diff;
                            closestValue = values[mid];
                        }
                        
                        if (values[mid] < value) {
                            left = mid + 1;
                        } else {
                            right = mid - 1;
                        }
                    }
                }
                
                inputElement.value = closestValue;
                
                if (oppositeElement.value) {
                    const oppositeValue = parseInt(oppositeElement.value);
                    if (isMaxField && closestValue < oppositeValue) {
                        inputElement.value = oppositeValue;
                    } else if (!isMaxField && closestValue > oppositeValue) {
                        inputElement.value = oppositeValue;
                    }
                }
                
                updateRangeButtonsState();
                
                Utils.runIdle(() => {
                    applyBaseFilters();
                }, 100);
            }, 300);
            
            inputElement.addEventListener('input', () => {
                debouncedInputHandler();
                updateRangeButtonsState();
            });
        }

        function setupWheelHandlers() {
            setupWheelHandler('min-floors-compact', availableValues.floors);
            setupWheelHandler('max-floors-compact', availableValues.floors);
            setupWheelHandler('min-flats-compact', availableValues.flatsPerEntrance);
            setupWheelHandler('max-flats-compact', availableValues.flatsPerEntrance);
        }

        function setupWheelHandler(inputId, valuesArray) {
            const input = document.getElementById(inputId);
            if (!input || valuesArray.length === 0) return;

            const handleWheel = (e) => {
                e.preventDefault();
                
                let currentValue = parseInt(input.value) || valuesArray[0];
                let currentIndex = valuesArray.indexOf(currentValue);
                
                if (currentIndex === -1) {
                    currentIndex = valuesArray.findIndex(v => v >= currentValue);
                    if (currentIndex === -1) currentIndex = valuesArray.length - 1;
                }
                
                if (e.deltaY < 0) {
                    currentIndex = Math.min(currentIndex + 1, valuesArray.length - 1);
                } else {
                    currentIndex = Math.max(currentIndex - 1, 0);
                }
                
                const newValue = valuesArray[currentIndex];
                input.value = newValue;
                
                updateRangeButtonsState();
                
                Utils.debounce(applyBaseFilters, 300)();
            };
            
            input.addEventListener('wheel', handleWheel, { passive: false });
        }

        function showAllBuildingsInList() {
            currentRenderLimit = preciseFilteredBuildings.length;
            updateBuildingsList();
            Utils.showNotification(`–ü–æ–∫–∞–∑–∞–Ω–æ –≤—Å–µ ${preciseFilteredBuildings.length} –∑–¥–∞–Ω–∏–π`, 'info');
            elements.buildingsListCompact.scrollTop = 0;
        }

        function applyBaseFilters() {
            const minFloors = parseInt(elements.minFloorsCompact.value) || null;
            const maxFloors = parseInt(elements.maxFloorsCompact.value) || null;
            const minFlats = parseInt(elements.minFlatsCompact.value) || null;
            const maxFlats = parseInt(elements.maxFlatsCompact.value) || null;
            
            filteredBuildings = allBuildings.filter(building => {
                if (hiddenInBasicFilters.has(building.originalIndex)) {
                    return false;
                }
                
                if (activeFilters.status.size === 0) {
                    return false;
                }
                if (!activeFilters.status.has(building.status)) {
                    return false;
                }
                
                if (activeFilters.district.size === 0) {
                    return false;
                }
                if (!activeFilters.district.has(building.district)) {
                    return false;
                }
                
                if (building.floors !== null) {
                    if (minFloors !== null && building.floors < minFloors) return false;
                    if (maxFloors !== null && building.floors > maxFloors) return false;
                }
                
                if (building.flatsPerEntrance !== null) {
                    if (minFlats !== null && building.flatsPerEntrance < minFlats) return false;
                    if (maxFlats !== null && building.flatsPerEntrance > maxFlats) return false;
                }
                
                return true;
            });
            
            updatePercentageDisplay();
            applyPreciseFilters();
        }

        function updateFilters() {
            applyBaseFilters();
        }

        function applyPreciseFilters() {
            Utils.runIdle(() => {
                performPreciseFiltering();
            }, 100);
        }

        function performPreciseFiltering() {
            currentRenderLimit = CONFIG.DEFAULT_RENDER_LIMIT;
            preciseFilteredBuildings = [...filteredBuildings];
            
            if (displayPercentage < 100) {
                preciseFilteredBuildings = selectByPercentageBresenham(preciseFilteredBuildings, displayPercentage);
            }
            
            preciseFilteredBuildings = preciseFilteredBuildings.filter(building => 
                !hiddenInPreciseSettings.has(building.originalIndex)
            );
            
            updateDisplay();
        }

        function updateDisplay() {
            updateStatistics();
            updateMap();
            updateBuildingsList();
        }

        function updateMap() {
            if (!objectManager) return;
            
            if (mapUpdateRafId) {
                cancelAnimationFrame(mapUpdateRafId);
            }
            
            mapUpdateRafId = requestAnimationFrame(() => {
                objectManager.removeAll();
                
                const features = [];
                const buildingsToShow = preciseFilteredBuildings;
                
                for (let i = 0; i < buildingsToShow.length; i++) {
                    const building = buildingsToShow[i];
                    const iconColor = building.status === CONFIG.FREE_STATUS ? '#10b981' : '#ef4444';
                    
                    features.push({
                        type: 'Feature',
                        id: building.originalIndex,
                        geometry: { 
                            type: 'Point', 
                            coordinates: [building.lng, building.lat]
                        },
                        properties: {
                            originalIndex: building.originalIndex,
                            address: building.address,
                            hintContent: building.address,
                            clusterCaption: building.address.substring(0, 30),
                            status: building.status
                        },
                        options: { 
                            iconColor: iconColor,
                            balloonCloseButton: false
                        }
                    });
                }
                
                if (features.length > 0) {
                    objectManager.add(features);
                }
                
                mapUpdateRafId = null;
            });
        }

        function updateBuildingsList() {
            const container = elements.buildingsListCompact;
            
            if (preciseFilteredBuildings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üè¢</div>
                        <div class="empty-title">–ó–¥–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                        <div class="empty-subtitle">–ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>
                    </div>
                `;
                return;
            }
            
            const fragment = document.createDocumentFragment();
            const buildingsToRender = preciseFilteredBuildings.slice(0, currentRenderLimit);
            
            for (let i = 0; i < buildingsToRender.length; i++) {
                const building = buildingsToRender[i];
                const item = document.createElement('div');
                item.className = 'building-card';
                item.dataset.id = building.originalIndex;
                
                const isHiddenInList = hiddenInPreciseSettings.has(building.originalIndex);
                const isHiddenInBasic = hiddenInBasicFilters.has(building.originalIndex);
                
                if (isHiddenInList) item.classList.add('hidden');
                
                let address = building.address;
                if (isMobile && address.length > 60) {
                    address = address.substring(0, 58) + '...';
                }
                
                const statusEmoji = building.status === CONFIG.FREE_STATUS ? 'üü¢' : 'üî¥';
                const shortDistrict = getShortDistrictName(building.district);
                
                item.innerHTML = `
                    <div class="building-address-compact" title="${Utils.escapeHtml(building.address)}">
                        ${statusEmoji} ${Utils.escapeHtml(address)}
                    </div>
                    <div class="building-info-compact">
                        <span class="info-chip-compact">üèòÔ∏è ${Utils.escapeHtml(shortDistrict)}</span>
                        <span class="info-chip-compact">üè¢ ${building.entrances || '‚Äî'} —à—Ç.</span>
                        <span class="info-chip-compact">üè† ${Utils.formatNumber(building.flats) || '‚Äî'} –∫–≤.</span>
                    </div>
                    <button class="hide-building-btn-compact ${isHiddenInList ? 'hidden' : ''}" 
                            data-index="${building.originalIndex}"
                            title="${isHiddenInList ? '–ü–æ–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å' : '–°–∫—Ä—ã—Ç—å –∞–¥—Ä–µ—Å'}">
                    </button>
                `;
                
                const hideBtn = item.querySelector('.hide-building-btn-compact');
                hideBtn.innerHTML = isHiddenInList ? '‚Üª' : '√ó';
                hideBtn.title = isHiddenInList ? '–ü–æ–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å' : '–°–∫—Ä—ã—Ç—å –∞–¥—Ä–µ—Å';
                
                hideBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    if (hiddenInPreciseSettings.has(building.originalIndex)) {
                        hiddenInPreciseSettings.delete(building.originalIndex);
                        hideBtn.classList.remove('hidden');
                        hideBtn.title = '–°–∫—Ä—ã—Ç—å –∞–¥—Ä–µ—Å';
                        hideBtn.innerHTML = '√ó';
                    } else {
                        hiddenInPreciseSettings.add(building.originalIndex);
                        hideBtn.classList.add('hidden');
                        hideBtn.title = '–ü–æ–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å';
                        hideBtn.innerHTML = '‚Üª';
                    }
                    
                    applyPreciseFilters();
                });
                
                item.addEventListener('click', (e) => {
                    if (e.target === hideBtn || e.target.closest('.hide-building-btn-compact')) return;
                    
                    if (building.lng && building.lat) {
                        map.panTo([building.lng, building.lat], {
                            duration: 300,
                            timingFunction: 'ease-in-out'
                        });
                        
                        setTimeout(() => {
                            showBuildingBalloon(building, [building.lng, building.lat]);
                        }, 300);
                    }
                });
                
                fragment.appendChild(item);
            }
            
            if (preciseFilteredBuildings.length > currentRenderLimit) {
                const moreItem = document.createElement('div');
                moreItem.className = 'show-all-button';
                moreItem.innerHTML = `
                    <span>üìã</span>
                    <span>–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ ${preciseFilteredBuildings.length}</span>
                    <span>üè†</span>
                `;
                
                moreItem.addEventListener('click', showAllBuildingsInList);
                fragment.appendChild(moreItem);
            }
            
            container.innerHTML = '';
            container.appendChild(fragment);
            
            setTimeout(() => {
                container.style.overflowY = 'scroll';
                container.style.scrollbarWidth = 'thin';
            }, 10);
        }

        function resetAllFilters() {
            currentRenderLimit = CONFIG.DEFAULT_RENDER_LIMIT;
            
            elements.minFloorsCompact.value = '';
            elements.maxFloorsCompact.value = '';
            elements.minFlatsCompact.value = '';
            elements.maxFlatsCompact.value = '';
            
            hiddenInBasicFilters.clear();
            hiddenInPreciseSettings.clear();
            
            const allStatuses = new Set();
            const allDistricts = new Set();
            
            for (let i = 0; i < allBuildings.length; i++) {
                const building = allBuildings[i];
                if (building.status) allStatuses.add(building.status);
                if (building.district) allDistricts.add(building.district);
            }
            
            document.querySelectorAll('#status-filters-compact input[type="checkbox"]').forEach(checkbox => {
                const status = checkbox.value;
                if (allStatuses.has(status)) {
                    checkbox.checked = true;
                    activeFilters.status.add(status);
                } else {
                    checkbox.checked = false;
                    activeFilters.status.delete(status);
                }
            });
            
            document.querySelectorAll('#district-filters-compact input[type="checkbox"]').forEach(checkbox => {
                const district = checkbox.value;
                if (allDistricts.has(district)) {
                    checkbox.checked = true;
                    activeFilters.district.add(district);
                } else {
                    checkbox.checked = false;
                    activeFilters.district.delete(district);
                }
            });
            
            displayPercentage = 100;
            
            if (elements.percentageSliderCompact) {
                elements.percentageSliderCompact.value = 100;
            }
            
            updatePercentageDisplay();
            updateRangeDisplay();
            applyBaseFilters();
            
            Utils.showNotification('–í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã', 'info');
        }

        function updateRangeDisplay() {
            if (availableValues.floors.length > 0) {
                const minFloor = availableValues.floors[0];
                const maxFloor = availableValues.floors[availableValues.floors.length - 1];
                elements.floorsTitle.textContent = `–≠—Ç–∞–∂–Ω–æ—Å—Ç—å –∑–¥–∞–Ω–∏–π: ${minFloor}-${maxFloor}`;
                
                elements.minFloorsCompact.value = minFloor;
                elements.maxFloorsCompact.value = maxFloor;
            }
            
            if (availableValues.flatsPerEntrance.length > 0) {
                const minFlat = availableValues.flatsPerEntrance[0];
                const maxFlat = availableValues.flatsPerEntrance[availableValues.flatsPerEntrance.length - 1];
                elements.flatsTitle.textContent = `–ö–≤–∞—Ä—Ç–∏—Ä –≤ –ø–æ–¥—ä–µ–∑–¥–µ: ${minFlat}-${maxFlat}`;
                
                elements.minFlatsCompact.value = minFlat;
                elements.maxFlatsCompact.value = maxFlat;
            }
            
            updateRangeButtonsState();
        }

        async function copyReportToClipboard() {
            try {
                const report = generateReport();
                
                await navigator.clipboard.writeText(report);
                
                Utils.showNotification('–û—Ç—á—ë—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
                
                let reportBtn;
                if (isMobile) {
                    reportBtn = elements.mobileNavBar.querySelector('[data-action="report"]');
                } else {
                    reportBtn = document.querySelector('.desktop-header-nav [data-action="report"]');
                }
                
                if (reportBtn) {
                    const originalIcon = reportBtn.querySelector('.nav-icon')?.innerHTML || 
                                      reportBtn.querySelector('.desktop-nav-icon')?.innerHTML;
                    const originalLabel = reportBtn.querySelector('.nav-label')?.textContent || 
                                        reportBtn.querySelector('.desktop-nav-label')?.textContent;
                    
                    if (isMobile) {
                        reportBtn.querySelector('.nav-icon').innerHTML = '‚úì';
                        reportBtn.querySelector('.nav-label').textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    } else {
                        reportBtn.querySelector('.desktop-nav-icon').innerHTML = '‚úì';
                        reportBtn.querySelector('.desktop-nav-label').textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    }
                    
                    setTimeout(() => {
                        if (isMobile) {
                            reportBtn.querySelector('.nav-icon').innerHTML = originalIcon;
                            reportBtn.querySelector('.nav-label').textContent = originalLabel;
                        } else {
                            reportBtn.querySelector('.desktop-nav-icon').innerHTML = originalIcon;
                            reportBtn.querySelector('.desktop-nav-label').textContent = originalLabel;
                        }
                    }, 2000);
                }
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                Utils.showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞', 'error');
            }
        }

        function generateReport() {
            const now = new Date();
            const formattedDate = now.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            let report = `–û–¢–ß–ï–¢ –ü–û –°–¢–ï–ù–î–ê–ú –£ –î–û–ú–û–§–û–ù–û–í - –†–Ø–ó–ê–ù–¨\n`;
            report += `–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω: ${formattedDate}\n\n`;
            
            report += `<=== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===>\n`;
            report += `–ó–¥–∞–Ω–∏–π –Ω–∞ –∫–∞—Ä—Ç–µ: ${preciseFilteredBuildings.length}\n`;
            
            const totalStands = preciseFilteredBuildings.reduce((sum, b) => sum + (b.entrances || 0), 0);
            const totalFlats = preciseFilteredBuildings.reduce((sum, b) => sum + (b.flats || 0), 0);
            
            report += `–°—Ç–µ–Ω–¥–æ–≤ –≤—ã–±—Ä–∞–Ω–æ: ${Utils.formatNumber(totalStands)}\n`;
            report += `–í—Å–µ–≥–æ —Å—Ç–µ–Ω–¥–æ–≤ –≤ –±–∞–∑–µ: ${elements.statsTotalStands.textContent}\n`;
            
            const priceInfo = calculatePrice(totalStands);
            
			if (totalStands >= 100) {
				report += `–°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –º–µ—Å—è—Ü: ${elements.statsCompactPrice.textContent}\n`;
				
				if (totalFlats > 0) {
					const pricePerFlat = priceInfo.totalPrice / totalFlats;
					const formattedPricePerFlat = pricePerFlat.toFixed(2).replace(',', '.');
					report += `–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É: ${formattedPricePerFlat} ‚ÇΩ\n`;
				} else {
					report += `–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É: ‚Äî\n`;
				}
			} else {
				report += `–°—Ç–æ–∏–º–æ—Å—Ç—å: —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª—å—à–µ –∑–¥–∞–Ω–∏–π –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞\n`;
			}
            
            report += `\n<=== –§–ò–õ–¨–¢–†–´ ===>\n`;
            report += `–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${displayPercentage}%\n`;
            
            if (activeFilters.status.size > 0) {
                report += `–°—Ç–∞—Ç—É—Å—ã: ${Array.from(activeFilters.status).join(', ')}\n`;
            }
            
            if (activeFilters.district.size > 0) {
                report += `–†–∞–π–æ–Ω—ã: ${Array.from(activeFilters.district).join(', ')}\n`;
            }
            
            if (elements.minFloorsCompact.value || elements.maxFloorsCompact.value) {
                report += `–≠—Ç–∞–∂–Ω–æ—Å—Ç—å: ${elements.minFloorsCompact.value || '1'} - ${elements.maxFloorsCompact.value || '10'}\n`;
            }
            
            if (elements.minFlatsCompact.value || elements.maxFlatsCompact.value) {
                report += `–ö–≤–∞—Ä—Ç–∏—Ä –≤ –ø–æ–¥—ä–µ–∑–¥–µ: ${elements.minFlatsCompact.value || '1'} - ${elements.maxFlatsCompact.value || '100'}\n`;
            }
            
            report += `\n<=== –°–ü–ò–°–û–ö –ê–î–†–ï–°–û–í ===>\n`;
            report += `–£–ª–∏—Ü–∞, –î–æ–º, –°—Ç–∞—Ç—É—Å, –†–∞–π–æ–Ω, –°—Ç–µ–Ω–¥–æ–≤, –ö–≤–∞—Ä—Ç–∏—Ä\n`;
            if (preciseFilteredBuildings.length > 0) {
                preciseFilteredBuildings.forEach((building, index) => {
                    const statusText = building.status === CONFIG.FREE_STATUS ? '–°–≤–æ–±–æ–¥–Ω–æ' : '–ó–∞–Ω—è—Ç–æ';
                    report += `${building.address}, ${statusText}, ${building.district || '‚Äî'}, ${building.entrances || '‚Äî'}, ${building.flats || '‚Äî'}`;
                    if (index < preciseFilteredBuildings.length - 1) {
                        report += '\n';
                    }
                });
            } else {
                report += `–ù–µ—Ç –∞–¥—Ä–µ—Å–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º\n`;
            }
            
            report += `\n\n<=== –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø ===>\n`;
            report += `–û—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Å–∏—Å—Ç–µ–º–æ–π PR –ú–ê–†–ö–ï–¢ –†—è–∑–∞–Ω—å\n`;
            report += `–î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã –Ω–∞ –º–æ–º–µ–Ω—Ç —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞\n`;
            report += `–î–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º\n\n`;
            report += `¬© PR –ú–ê–†–ö–ï–¢ –†—è–∑–∞–Ω—å - –ö–∞—Ä—Ç–∞ —Å—Ç–µ–Ω–¥–æ–≤ —É –¥–æ–º–æ—Ñ–æ–Ω–æ–≤`;
            
            return report;
        }

        async function initApp() {
            try {
                isMobile = window.innerWidth <= 768;
                
                await initMap();
                
                await loadData();
                
                const { statuses, districts } = collectAvailableValues(allBuildings);
                
                createCheckboxFilter('status-filters-compact', statuses, '–°—Ç–∞—Ç—É—Å');
                createCheckboxFilter('district-filters-compact', districts, '–†–∞–π–æ–Ω');
                
                setupNumberInputs();
                
                setupWheelHandlers();
                
                updateRangeDisplay();
                updateRangeButtonsState();
                
                activeFilters.status = new Set(statuses);
                activeFilters.district = new Set(districts);
                
                initInterface();
                
                applyBaseFilters();
                
                setTimeout(() => {
                    elements.loadingOverlay.style.display = 'none';
                    
                    const filtersGrid = document.querySelector('.filters-grid');
                    if (filtersGrid) {
                        filtersGrid.style.overflowY = 'scroll';
                        filtersGrid.style.scrollbarWidth = 'thin';
                    }
                    
                    const buildingsList = document.getElementById('buildings-list-compact');
                    if (buildingsList) {
                        buildingsList.style.overflowY = 'scroll';
                        buildingsList.style.scrollbarWidth = 'thin';
                    }
                }, 500);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                elements.loadingOverlay.querySelector('.loading-text').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
                
                setTimeout(() => {
                    elements.loadingOverlay.style.display = 'none';
                    Utils.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.', 'error');
                }, 2000);
            }
        }

        window.addEventListener('beforeunload', () => {
            isAppActive = false;
            
            if (mapUpdateRafId) {
                cancelAnimationFrame(mapUpdateRafId);
            }
            
            if (percentageDebounceTimer) {
                clearTimeout(percentageDebounceTimer);
            }
            
            if (map) {
                map.destroy();
            }
        });

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
