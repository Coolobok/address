<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта адресов Рязани</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=e99b0b22-e0ed-4965-89bd-c4ff4a9c1aed&lang=ru_RU"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; font-family: Arial; overflow: hidden; }
        #map-container { width: 100%; height: 100%; position: relative; }
        #map { width: 100%; height: 100%; }
        
        /* Общие стили панелей */
        .panel {
            position: absolute;
            top: 10px;
            width: 300px;
            height: calc(90vh - 20px); /* Уменьшено на 10% */
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: transform 0.3s ease;
            display: flex;
        }
        
        .panel-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Блок фильтров слева */
        #filters-panel {
            left: 10px;
        }
        
        /* Блок адресов справа */
        #address-panel {
            right: 10px;
        }
        
        /* Заголовки панелей */
        .panel-header {
            padding: 15px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }
        
        .panel-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .panel-stats {
            font-size: 12px;
            color: #666;
        }
        
        /* Секции фильтров */
        .filter-section {
            padding: 15px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }
        
        .filter-section h3 {
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .checkbox-item input {
            margin: 0;
        }
        
        .status-free { color: #4CAF50; font-size: 13px; }
        .status-occupied { color: #F44336; font-size: 13px; }
        
        /* Основное содержимое панелей */
        .panel-main-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Список адресов */
        #address-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .address-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .address-item:hover {
            background: #f9f9f9;
        }
        
        .address-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .address-details {
            font-size: 12px;
            color: #666;
        }
        
        /* Кнопки */
        .panel-button {
            width: calc(100% - 30px);
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            margin: 15px;
            flex-shrink: 0;
        }
        
        .panel-button:hover {
            background: #0b7dda;
        }
        
        .empty-list {
            padding: 10px;
            text-align: center;
            color: #666;
        }
        
        /* Кнопки скрытия/показа панелей */
        .panel-toggle {
            width: 30px;
            background: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            transition: background 0.2s;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 10px 5px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        #toggle-filters {
            border-radius: 0 5px 5px 0;
            order: 1;
        }
        
        #toggle-addresses {
            border-radius: 5px 0 0 5px;
        }
        
        .panel-toggle:hover {
            background: #0b7dda;
        }
        
        .hidden-panel {
            transform: translateX(calc(-100% + 30px));
        }
        
        .hidden-address-panel {
            transform: translateX(calc(100% - 30px));
        }
        
        .entrances-count {
            font-size: 12px;
            color: #666;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
        
        <!-- Блок фильтров слева -->
        <div id="filters-panel" class="panel">
            <div class="panel-content">
                <div class="panel-header">
                    <h3>Фильтры</h3>
                </div>
                <div class="panel-main-content">
                    <div class="filter-section">
                        <h3>Статус:</h3>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" class="status-filter" value="free" checked> 
                                <span class="status-free">Свободно</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" class="status-filter" value="occupied" checked> 
                                <span class="status-occupied">Занято</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <h3>Район:</h3>
                        <div class="checkbox-group" id="districts-container">
                            <!-- Районы будут добавлены динамически -->
                        </div>
                    </div>
                </div>
                <div class="panel-footer">
                    <button id="apply-filters" class="panel-button">Применить фильтры</button>
                </div>
            </div>
            <button id="toggle-filters" class="panel-toggle">Скрыть фильтры</button>
        </div>
        
        <!-- Блок адресов справа -->
        <div id="address-panel" class="panel">
            <button id="toggle-addresses" class="panel-toggle">Скрыть адреса</button>
            <div class="panel-content">
                <div class="panel-header">
                    <h3>Адреса (<span id="address-count">0</span>)</h3>
                    <div class="panel-stats">Подъезды: <span id="entrances-count">0</span></div>
                </div>
                <div class="panel-main-content">
                    <div id="address-list" class="empty-list">Загрузка данных...</div>
                </div>
                <div class="panel-footer">
                    <button id="copy-all" class="panel-button">Копировать список адресов</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets JSONP URL
        const SHEET_ID = '16xHTVeuOauyHYLH5RWuj_WzmGYFBYBZ5Uke-Nfeswr8';
        const JSONP_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:handleSheetData&sheet=Filter`;
        
        let map, objectManager, currentAddresses = [];
        let totalEntrances = 0;
        
        // Обработчик данных из Google Sheets
        window.handleSheetData = function(response) {
            if (!response?.table?.rows) {
                console.error('Неверный формат данных:', response);
                document.getElementById('address-list').innerHTML = 
                    '<div class="empty-list">Ошибка загрузки данных</div>';
                return;
            }
            
            processData(response);
        };
        
        // Загрузка данных через JSONP
        function loadData() {
            const script = document.createElement('script');
            script.src = JSONP_URL;
            script.onerror = () => {
                console.error('Ошибка загрузки данных');
                document.getElementById('address-list').innerHTML = 
                    '<div class="empty-list">Ошибка загрузки данных</div>';
            };
            document.body.appendChild(script);
        }
        
        ymaps.ready(() => {
            map = new ymaps.Map('map', {
                center: [54.6294, 39.7417],
                zoom: 12
            });
            
            // Создаем кастомный макет для балуна кластера
            const ClusterBalloonContentLayout = ymaps.templateLayoutFactory.createClass(
                '<h2 style="margin: 0 0 10px 0; font-size: 16px;">Адресов в кластере: {{properties.geoObjects.length}}</h2>' +
                '<div class="cluster-balloon">' +
                '{% for object in properties.geoObjects %}' +
                '<div class="cluster-item">' +
                '<div><strong>{{object.properties.address}}</strong></div>' +
                '<div>Статус: {{object.properties.fullStatus}}</div>' +
                '<div>Район: {{object.properties.district || "не указан"}}</div>' +
                '<div>Подъездов: {{object.properties.entrances || "не указано"}}</div>' +
                '</div>' +
                '{% endfor %}' +
                '</div>'
            );
            
            objectManager = new ymaps.ObjectManager({
                clusterize: true,
                gridSize: 64,
                clusterDisableClickZoom: true,
                clusterBalloonContentLayout: ClusterBalloonContentLayout,
                clusterBalloonPanelMaxMapArea: 0
            });
            
            objectManager.clusters.options.set('preset', 'islands#invertedBlueClusterIcons');
            objectManager.objects.options.set('preset', 'islands#circleDotIcon');
            
            // Обработчик клика по кластеру
            objectManager.clusters.events.add('click', function(e) {
                const cluster = e.get('target');
                cluster.balloon.open();
            });
            
            map.geoObjects.add(objectManager);
            
            // Обработчики событий
            document.getElementById('apply-filters').addEventListener('click', applyFilters);
            document.getElementById('copy-all').addEventListener('click', copyAllAddresses);
            
            // Обработчики для кнопок скрытия/показа панелей
            document.getElementById('toggle-filters').addEventListener('click', function() {
                const panel = document.getElementById('filters-panel');
                panel.classList.toggle('hidden-panel');
                this.textContent = panel.classList.contains('hidden-panel') ? 'Показать фильтры' : 'Скрыть фильтры';
            });
            
            document.getElementById('toggle-addresses').addEventListener('click', function() {
                const panel = document.getElementById('address-panel');
                panel.classList.toggle('hidden-address-panel');
                this.textContent = panel.classList.contains('hidden-address-panel') ? 'Показать адреса' : 'Скрыть адреса';
            });
            
            loadData();
        });
        
        function processData(data) {
            const districts = new Set();
            currentAddresses = [];
            totalEntrances = 0;
            objectManager.removeAll();
            
            resetDistrictFilter();
            
            data.table.rows.forEach((row, i) => {
                if (!row.c) return;
                
                const address = row.c[0]?.v || '';
                const lngStr = row.c[1]?.v || '';
                const latStr = row.c[2]?.v || '';
                const status = row.c[3]?.v || '';
                const district = row.c[4]?.v || '';
                const entrances = row.c[5]?.v ? parseInt(row.c[5].v) || 0 : 0;
                
                if (!latStr || !lngStr) return;
                
                const lat = parseFloat(latStr.toString().replace(',', '.'));
                const lng = parseFloat(lngStr.toString().replace(',', '.'));
                
                if (isNaN(lat) || isNaN(lng)) return;
                
                if (district) districts.add(district);
                
                const isOccupied = status.includes('Занято');
                const iconColor = isOccupied ? '#F44336' : '#4CAF50';
                
                // Добавляем на карту
                objectManager.add({
                    id: i,
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [lng, lat] },
                    properties: {
                        address: address,
                        fullStatus: status,
                        status: isOccupied ? 'occupied' : 'free',
                        district: district,
                        entrances: entrances,
                        hintContent: address,
                        balloonContent: createBalloonContent(address, status, district, isOccupied, entrances)
                    },
                    options: {
                        iconColor: iconColor
                    }
                });
                
                // Добавляем в список
                currentAddresses.push({
                    id: i,
                    address: address,
                    status: status,
                    district: district,
                    coordinates: [lng, lat],
                    isOccupied: isOccupied,
                    entrances: entrances
                });
                
                totalEntrances += entrances;
            });
            
            populateDistrictFilter(districts);
            applyFilters();
            
            if (objectManager.objects.getLength() > 0) {
                map.setBounds(objectManager.getBounds(), { checkZoomRange: true });
            }
        }
        
        function applyFilters() {
            // Получаем выбранные статусы
            const statusCheckboxes = document.querySelectorAll('.status-filter:checked');
            const selectedStatuses = Array.from(statusCheckboxes).map(cb => cb.value);
            
            // Получаем выбранные районы
            const districtCheckboxes = document.querySelectorAll('.district-filter:checked');
            const selectedDistricts = Array.from(districtCheckboxes).map(cb => cb.value);
            
            // Фильтрация карты
            objectManager.setFilter(obj => 
                (selectedStatuses.length === 0 || selectedStatuses.includes(obj.properties.status)) &&
                (selectedDistricts.length === 0 || selectedDistricts.includes(obj.properties.district))
            );
            
            // Фильтрация списка
            const filtered = currentAddresses.filter(addr => 
                (selectedStatuses.length === 0 || selectedStatuses.includes(addr.isOccupied ? 'occupied' : 'free')) &&
                (selectedDistricts.length === 0 || selectedDistricts.includes(addr.district))
            );
            
            updateAddressList(filtered);
        }
        
        function updateAddressList(addresses) {
            const list = document.getElementById('address-list');
            const count = document.getElementById('address-count');
            const entrancesCount = document.getElementById('entrances-count');
            
            count.textContent = addresses.length;
            
            // Подсчет подъездов для отфильтрованных адресов
            const filteredEntrances = addresses.reduce((sum, addr) => sum + (addr.entrances || 0), 0);
            entrancesCount.textContent = filteredEntrances;
            
            if (addresses.length === 0) {
                list.innerHTML = '<div class="empty-list">Нет адресов, соответствующих фильтрам</div>';
                return;
            }
            
            list.innerHTML = '';
            addresses.forEach(addr => {
                const item = document.createElement('div');
                item.className = 'address-item';
                item.innerHTML = `
                    <div class="address-header">
                        <strong>${addr.address}</strong>
                        <span class="${addr.isOccupied ? 'status-occupied' : 'status-free'}">
                            ${addr.status}
                        </span>
                    </div>
                    <div class="address-details">
                        Район: ${addr.district || 'не указан'}
                        ${addr.entrances ? `<span class="entrances-count">Подъездов: ${addr.entrances}</span>` : ''}
                    </div>
                `;
                item.addEventListener('click', () => {
                    // Плавное перемещение к точке с небольшим увеличением
                    map.panTo(addr.coordinates, {
                        flying: true,
                        zoom: 17
                    }).then(function() {
                        // После завершения анимации открываем балун
                        const object = objectManager.objects.getById(addr.id);
                        if (object) {
                            objectManager.objects.balloon.open(addr.id);
                        }
                    });
                });
                list.appendChild(item);
            });
        }
        
        function createBalloonContent(address, status, district, isOccupied, entrances) {
            return `
                <b>Адрес:</b> ${address}<br>
                <b>Статус:</b> <span class="${isOccupied ? 'status-occupied' : 'status-free'}">${status}</span><br>
                <b>Район:</b> ${district || 'не указан'}<br>
                ${entrances ? `<b>Подъездов:</b> ${entrances}<br>` : ''}
            `;
        }
        
        function resetDistrictFilter() {
            document.getElementById('districts-container').innerHTML = '';
            
            // Добавляем опцию "Все районы"
            const allDistrictsItem = document.createElement('label');
            allDistrictsItem.className = 'checkbox-item';
            allDistrictsItem.innerHTML = `
                <input type="checkbox" class="district-filter" value="all" checked>
                <span>Все районы</span>
            `;
            document.getElementById('districts-container').appendChild(allDistrictsItem);
        }
        
        function populateDistrictFilter(districts) {
            const container = document.getElementById('districts-container');
            
            // Добавляем чекбоксы для каждого района
            districts.forEach(district => {
                const item = document.createElement('label');
                item.className = 'checkbox-item';
                item.innerHTML = `
                    <input type="checkbox" class="district-filter" value="${district}" checked>
                    <span>${district}</span>
                `;
                container.appendChild(item);
            });
            
            // Обработчик для чекбокса "Все районы"
            const allDistrictsCheckbox = container.querySelector('.district-filter[value="all"]');
            const districtCheckboxes = container.querySelectorAll('.district-filter:not([value="all"])');
            
            allDistrictsCheckbox.addEventListener('change', function() {
                districtCheckboxes.forEach(cb => {
                    cb.checked = this.checked;
                });
            });
            
            // Обработчики для чекбоксов районов
            districtCheckboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    if (!this.checked) {
                        allDistrictsCheckbox.checked = false;
                    } else {
                        // Проверяем, все ли районы выбраны
                        const allChecked = Array.from(districtCheckboxes).every(c => c.checked);
                        allDistrictsCheckbox.checked = allChecked;
                    }
                });
            });
        }
        
        async function copyAllAddresses() {
            const items = Array.from(document.querySelectorAll('.address-item'));
            if (items.length === 0) return;
            
            // Получаем заголовки с количеством
            const addressCount = document.getElementById('address-count').textContent;
            const entrancesCount = document.getElementById('entrances-count').textContent;
            
            // Формируем чистый текст
            let text = `Адреса (${addressCount})\n`;
            text += `Подъезды (${entrancesCount})\n\n`;
            
            text += items.map(item => {
                const addr = item.querySelector('strong').textContent.trim();
                const status = item.querySelector('span').textContent.trim();
                const district = item.querySelector('.address-details').textContent
                    .replace('Район:', '').replace(/Подъездов: \d+/, '').trim();
                const entrances = item.querySelector('.entrances-count')?.textContent || '';
                
                return `${addr} (${status}${district ? ', ' + district : ''}${entrances ? ', ' + entrances : ''})`;
            }).join('\n');
            
            try {
                await navigator.clipboard.writeText(text);
                alert('Список адресов скопирован в буфер обмена!');
            } catch (err) {
                console.error('Ошибка копирования:', err);
                alert('Не удалось скопировать список адресов');
            }
        }
    </script>
</body>
    </html>
