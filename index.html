<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта адресов Рязани</title>
    <!-- с 18 июня 2025 Яндекс позволяет использовать API карт без ключа с базовыми лимитами -->
	<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; font-family: Arial; overflow: hidden; }
        #map-container { width: 100%; height: 100%; position: relative; }
        #map { width: 100%; height: 100%; }
        
        /* Основная панель */
        #main-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 350px;
            max-width: 90vw;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
            max-height: 95vh;
            border: 1px solid #e1e5e9;
        }
        
        /* Заголовок панели - СИНИЙ КАК МАРКЕРЫ */
        .panel-header {
            padding: 18px 60px 18px 20px;
            background: linear-gradient(135deg, #2196F3, #1976D2);
            border-bottom: 1px solid #1565C0;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        
        .panel-header:hover {
            background: linear-gradient(135deg, #1976D2, #1565C0);
        }
        
        .panel-header h3 {
            margin: 0 0 6px 0;
            font-size: 17px;
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .panel-stats {
            font-size: 13px;
            color: rgba(255,255,255,0.9);
            font-weight: 500;
        }
        
        /* Кнопка сворачивания/разворачивания */
        .toggle-button {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            width: 34px;
            height: 34px;
            background: rgba(255,255,255,0.2);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            transition: all 0.3s ease;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }
        
        .toggle-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) scale(1.05);
        }
        
        .collapsed .toggle-button {
            transform: translateY(-50%) rotate(180deg);
        }
        
        .collapsed .toggle-button:hover {
            transform: translateY(-50%) rotate(180deg) scale(1.05);
        }
        
        /* Основное содержимое панели */
        .panel-content {
            max-height: calc(95vh - 80px);
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
            opacity: 1;
            background: #fafbfc;
        }
        
        .collapsed .panel-content {
            max-height: 0;
            opacity: 0;
        }
        
        /* Вкладки */
        .tabs {
            display: flex;
            background: linear-gradient(to bottom, #f8f9fa, #f1f3f5);
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab {
            flex: 1;
            padding: 14px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }
        
        .tab.active {
            color: #2196F3;
            border-bottom-color: #2196F3;
            background: white;
            box-shadow: 0 -2px 8px rgba(33, 150, 243, 0.1);
        }
        
        .tab:hover {
            background: #e9ecef;
            color: #333;
        }
        
        /* Содержимое вкладок */
        .tab-content {
            display: none;
            flex-direction: column;
            height: calc(95vh - 220px);
            overflow: hidden;
            background: white;
        }
        
        .tab-content.active {
            display: flex;
        }
        
        /* Контент фильтров */
        .filters-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: white;
        }
        
        /* Фиксированные секции фильтров */
        .fixed-filter-section {
            padding: 22px;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
            background: white;
        }
        
        /* Статусы в одну строку */
        .status-filters {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        
        .status-filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-filter-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        
        .status-filter-group label:hover {
            background-color: #f8f9fa;
        }
        
        .status-free { 
            color: #4CAF50; 
            font-weight: 600;
        }
        
        .status-occupied { 
            color: #F44336; 
            font-weight: 600;
        }
        
        /* Прокручиваемая область для фильтров */
        .scrollable-filters {
            flex: 1;
            overflow-y: auto;
            padding: 0 22px;
            background: white;
        }
        
        /* Секции фильтров */
        .filter-section {
            padding: 22px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 0;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        
        .checkbox-item:hover {
            background-color: #f8f9fa;
        }
        
        .checkbox-item input {
            margin: 0;
            transform: scale(1.1);
        }
        
        /* Список адресов */
        .address-list {
            overflow-y: auto;
            padding: 18px;
            height: 100%;
            background: white;
        }
        
        .address-item {
            padding: 14px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 6px;
            border: 1px solid transparent;
        }
        
        .address-item:hover {
            background: #f8f9fa;
            border-color: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .address-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .address-details {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }
        
        /* Кнопка копирования внизу - СИНЯЯ */
        .panel-footer {
            padding: 22px;
            border-top: 2px solid #f0f0f0;
            background: linear-gradient(to bottom, #fafbfc, #f8f9fa);
        }
        
        .copy-button {
            width: 100%;
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .copy-button:hover {
            background: linear-gradient(135deg, #1976D2, #1565C0);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        
        .copy-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
        }
        
        /* Кнопки в балунах - СИНИЕ */
        .balloon-copy-button {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            width: 100%;
            margin-top: 12px;
        }
        
        .balloon-copy-button:hover {
            background: linear-gradient(135deg, #1976D2, #1565C0);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        
        .balloon-copy-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
        }
        
        .empty-list {
            padding: 50px 22px;
            text-align: center;
            color: #888;
            font-size: 14px;
            background: white;
        }
        
        .entrances-count {
            font-size: 12px;
            color: #888;
            margin-left: 6px;
            font-weight: 500;
        }
        
        /* Стили для балуна кластера */
        .cluster-balloon {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
            background: white;
            border-radius: 12px;
            padding: 16px;
        }
        
        .cluster-balloon h2 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }
        
        .cluster-balloon::-webkit-scrollbar {
            width: 8px;
        }
        
        .cluster-balloon::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        
        .cluster-item {
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .cluster-item:last-child {
            border-bottom: none;
        }
        
        /* Стили для уведомления */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 16px 28px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
            z-index: 10000;
            transition: transform 0.4s ease;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }
        
        .notification.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #F44336, #d32f2f);
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.3);
        }
        
        .notification-icon {
            font-size: 20px;
        }
        
        /* Медиа-запросы для мобильных устройств */
        @media (max-width: 768px) {
            #main-panel {
                width: 320px;
                max-height: 90vh;
                border-radius: 10px;
            }
            
            .panel-content {
                max-height: calc(90vh - 80px);
            }
            
            .tab-content {
                height: calc(90vh - 220px);
            }
            
            .scrollable-filters {
                padding: 0 18px;
            }
            
            .notification {
                width: 90%;
                text-align: center;
                padding: 14px 20px;
            }
            
            .status-filters {
                gap: 18px;
            }
            
            .toggle-button {
                width: 30px;
                height: 30px;
                font-size: 18px;
            }
            
            .panel-header {
                padding: 16px 50px 16px 18px;
            }
        }

        /* Для очень маленьких экранов */
        @media (max-height: 600px) {
            #main-panel {
                max-height: 98vh;
            }
            
            .panel-content {
                max-height: calc(98vh - 80px);
            }
            
            .tab-content {
                height: calc(98vh - 220px);
            }
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
        
        <!-- Уведомление -->
        <div id="notification" class="notification">
            <span class="notification-icon">✓</span>
            <span id="notification-text">Данные скопированы в буфер обмена!</span>
        </div>
        
        <!-- Основная панель -->
        <div id="main-panel">
            <!-- Заголовок с кнопкой сворачивания -->
            <div class="panel-header" id="panel-header">
                <h3>Карта адресов Рязани</h3>
                <div class="panel-stats">
                    Адреса: <span id="address-count">0</span> | 
                    Подъезды: <span id="entrances-count">0</span>
                </div>
                <button class="toggle-button" title="Свернуть/развернуть">▼</button>
            </div>
            
            <!-- Основное содержимое -->
            <div class="panel-content">
                <!-- Вкладки -->
                <div class="tabs">
                    <button class="tab active" data-tab="filters">Фильтры</button>
                    <button class="tab" data-tab="addresses">Адреса</button>
                </div>
                
                <!-- Содержимое вкладки фильтров -->
                <div id="filters-tab" class="tab-content active">
                    <div class="filters-content">
                        <!-- Фиксированная секция статуса -->
                        <div class="fixed-filter-section">
                            <div class="status-filters">
                                <div class="status-filter-group">
                                    <label>
                                        <input type="checkbox" class="status-filter" value="free" checked> 
                                        <span class="status-free">Свободно</span>
                                    </label>
                                </div>
                                <div class="status-filter-group">
                                    <label>
                                        <input type="checkbox" class="status-filter" value="occupied" checked> 
                                        <span class="status-occupied">Занято</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Прокручиваемая секция районов -->
                        <div class="scrollable-filters">
                            <div class="filter-section">
                                <div class="checkbox-group" id="districts-container">
                                    <!-- Районы будут добавлены динамически -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Содержимое вкладки адресов -->
                <div id="addresses-tab" class="tab-content">
                    <div class="address-list" id="address-list">
                        <div class="empty-list">Выберите фильтры для отображения адресов</div>
                    </div>
                </div>
                
                <!-- Кнопка копирования -->
                <div class="panel-footer">
                    <button id="copy-all" class="copy-button">Копировать список адресов</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets JSONP URL
        const SHEET_ID = '1jZsHbNXVmvNRjmh_p1pLFl3G3oLgD0sFas8L4EDexiI';
        const JSONP_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:handleSheetData&sheet=Filter`;
        
        let map, objectManager, currentAddresses = [];
        let totalEntrances = 0;
        let currentClusterObjects = [];
        let isPanelCollapsed = false;
        
        // Функция для показа уведомления
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            notificationText.textContent = message;
            notification.className = 'notification' + (isError ? ' error' : '');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Функция для переключения вкладок
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    // Убираем активный класс у всех вкладок и контента
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    // Добавляем активный класс выбранной вкладке и контенту
                    tab.classList.add('active');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });
        }
        
        // Функция для управления панелью
        function setupPanel() {
            const panel = document.getElementById('main-panel');
            const header = document.getElementById('panel-header');
            const toggleButton = document.querySelector('.toggle-button');
            
            // Сворачивание/разворачивание по клику на заголовок или кнопку
            function togglePanel() {
                isPanelCollapsed = !isPanelCollapsed;
                panel.classList.toggle('collapsed', isPanelCollapsed);
                
                // Обновляем текст подсказки
                toggleButton.title = isPanelCollapsed ? 'Развернуть' : 'Свернуть';
            }
            
            header.addEventListener('click', togglePanel);
            toggleButton.addEventListener('click', (e) => {
                e.stopPropagation(); // Предотвращаем срабатывание клика на заголовке
                togglePanel();
            });
        }
        
        // Обработчик данных из Google Sheets
        window.handleSheetData = function(response) {
            if (!response?.table?.rows) {
                console.error('Неверный формат данных:', response);
                document.getElementById('address-list').innerHTML = 
                    '<div class="empty-list">Ошибка загрузки данных</div>';
                return;
            }
            
            processData(response);
        };
        
        // Загрузка данных через JSONP
        function loadData() {
            const script = document.createElement('script');
            script.src = JSONP_URL;
            script.onerror = () => {
                console.error('Ошибка загрузки данных');
                document.getElementById('address-list').innerHTML = 
                    '<div class="empty-list">Ошибка загрузки данных</div>';
            };
            document.body.appendChild(script);
        }
        
        ymaps.ready(() => {
            map = new ymaps.Map('map', {
                center: [54.6294, 39.7417],
                zoom: 12
            });
            
            // Создаем кастомный макет для балуна кластера
            const ClusterBalloonContentLayout = ymaps.templateLayoutFactory.createClass(
                '<div style="padding: 16px;">' +
                '<h2 style="margin: 0 0 12px 0; font-size: 16px; color: #333; font-weight: 600;">Адресов в кластере: {{properties.geoObjects.length}}</h2>' +
                '<div class="cluster-balloon">' +
                '{% for object in properties.geoObjects %}' +
                '<div class="cluster-item">' +
                '<div><strong>{{object.properties.address}}</strong></div>' +
                '<div>Статус: {{object.properties.fullStatus}}</div>' +
                '<div>Район: {{object.properties.district || "не указан"}}</div>' +
                '<div>Подъездов: {{object.properties.entrances || "не указано"}}</div>' +
                '</div>' +
                '{% endfor %}' +
                '</div>' +
                '<button class="balloon-copy-button" onclick="window.copyCurrentClusterAddresses()">Копировать все адреса из кластера</button>' +
                '</div>',
                {
                    // Ограничиваем размер балуна
                    build: function() {
                        ClusterBalloonContentLayout.superclass.build.call(this);
                        this._element.style.maxWidth = '400px';
                        this._element.style.maxHeight = '350px';
                        
                        // Сохраняем объекты кластера в глобальной переменной
                        const clusterObjects = this.getData().object.properties.geoObjects;
                        if (clusterObjects && clusterObjects.length > 0) {
                            window.currentClusterObjects = clusterObjects;
                            console.log('Сохранены объекты кластера:', clusterObjects.length);
                        }
                    },
                    
                    // Очищаем при закрытии балуна
                    clear: function() {
                        window.currentClusterObjects = [];
                        ClusterBalloonContentLayout.superclass.clear.call(this);
                    }
                }
            );
            
            objectManager = new ymaps.ObjectManager({
                clusterize: true,
                gridSize: 64,
                clusterDisableClickZoom: true,
                clusterBalloonContentLayout: ClusterBalloonContentLayout,
                clusterBalloonPanelMaxMapArea: 0
            });
            
            objectManager.clusters.options.set('preset', 'islands#invertedBlueClusterIcons');
            objectManager.objects.options.set('preset', 'islands#circleDotIcon');
            
            // Обработчик клика по кластеру - сохраняем объекты кластера
            objectManager.clusters.events.add('click', function(e) {
                const cluster = e.get('target');
                const clusterObjects = cluster.properties.geoObjects;
                
                if (clusterObjects && clusterObjects.length > 0) {
                    window.currentClusterObjects = clusterObjects;
                    console.log('Объекты кластера сохранены:', clusterObjects.length);
                }
                
                cluster.balloon.open();
            });
            
            map.geoObjects.add(objectManager);
            
            // Настройка интерфейса
            setupTabs();
            setupPanel();
            
            // Обработчики событий
            document.getElementById('copy-all').addEventListener('click', copyAllAddresses);
            
            // Добавляем обработчики для чекбоксов статуса
            document.querySelectorAll('.status-filter').forEach(checkbox => {
                checkbox.addEventListener('change', applyFilters);
            });
            
            loadData();
        });
        
        // Функция для копирования всех адресов из текущего кластера
        window.copyCurrentClusterAddresses = function() {
            console.log('Текущие объекты кластера:', window.currentClusterObjects);
            
            if (!window.currentClusterObjects || window.currentClusterObjects.length === 0) {
                showNotification('Нет адресов для копирования', true);
                return;
            }
            
            let text = '';
            
            // Формируем текст со всеми адресами из кластера
            window.currentClusterObjects.forEach((obj, index) => {
                const address = obj.properties.address;
                const status = obj.properties.fullStatus;
                const district = obj.properties.district;
                const entrances = obj.properties.entrances;
                
                // Добавляем дополнительную информацию, если она есть
                const details = [];
                if (status && status !== 'undefined') details.push(status);
                if (district && district !== 'undefined' && district !== 'не указан') details.push(district);
                if (entrances && entrances !== 'undefined' && entrances !== 'не указано' && entrances !== 0) details.push(`Подъездов: ${entrances}`);
                
                text += `${address}`;
                if (details.length > 0) {
                    text += ` (${details.join(', ')})`;
                }
                text += '\n';
            });
            
            navigator.clipboard.writeText(text).then(() => {
                // Временное изменение текста кнопки для подтверждения
                const buttons = document.querySelectorAll('.balloon-copy-button');
                buttons.forEach(button => {
                    const originalText = button.textContent;
                    button.textContent = '✓ Скопировано!';
                    button.style.background = '#1565C0';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '';
                    }, 2000);
                });
                
                // Показываем уведомление
                showNotification(`Скопировано ${window.currentClusterObjects.length} адресов из кластера`);
            }).catch(err => {
                console.error('Ошибка копирования:', err);
                showNotification('Не удалось скопировать адреса', true);
            });
        };
        
        function processData(data) {
            const districts = new Set();
            currentAddresses = [];
            totalEntrances = 0;
            objectManager.removeAll();
            
            resetDistrictFilter();
            
            data.table.rows.forEach((row, i) => {
                if (!row.c) return;
                
                const address = row.c[0]?.v || '';
                const lngStr = row.c[1]?.v || '';
                const latStr = row.c[2]?.v || '';
                const status = row.c[3]?.v || '';
                const district = row.c[4]?.v || '';
                const entrances = row.c[5]?.v ? parseInt(row.c[5].v) || 0 : 0;
                
                if (!latStr || !lngStr) return;
                
                const lat = parseFloat(latStr.toString().replace(',', '.'));
                const lng = parseFloat(lngStr.toString().replace(',', '.'));
                
                if (isNaN(lat) || isNaN(lng)) return;
                
                if (district) districts.add(district);
                
                const isOccupied = status.includes('Занято');
                const iconColor = isOccupied ? '#F44336' : '#4CAF50';
                
                // Добавляем на карту
                objectManager.add({
                    id: i,
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [lng, lat] },
                    properties: {
                        address: address,
                        fullStatus: status,
                        status: isOccupied ? 'occupied' : 'free',
                        district: district,
                        entrances: entrances,
                        hintContent: address,
                        balloonContent: createBalloonContent(address, status, district, isOccupied, entrances)
                    },
                    options: {
                        iconColor: iconColor
                    }
                });
                
                // Добавляем в список
                currentAddresses.push({
                    id: i,
                    address: address,
                    status: status,
                    district: district,
                    coordinates: [lng, lat],
                    isOccupied: isOccupied,
                    entrances: entrances
                });
                
                totalEntrances += entrances;
            });
            
            populateDistrictFilter(districts);
            applyFilters(); // Применяем фильтры сразу после загрузки данных
            
            if (objectManager.objects.getLength() > 0) {
                map.setBounds(objectManager.getBounds(), { checkZoomRange: true });
            }
        }
        
        function createBalloonContent(address, status, district, isOccupied, entrances) {
            return `
                <div style="padding: 8px 0;">
                    <b>Адрес:</b> ${address}<br>
                    <b>Статус:</b> <span class="${isOccupied ? 'status-occupied' : 'status-free'}">${status}</span><br>
                    <b>Район:</b> ${district || 'не указан'}<br>
                    ${entrances ? `<b>Подъездов:</b> ${entrances}<br>` : ''}
                </div>
                <button class="balloon-copy-button" onclick="copySingleAddress('${address.replace(/'/g, "\\'")}', '${status.replace(/'/g, "\\'")}', '${(district || '').replace(/'/g, "\\'")}', ${entrances || 0})">
                    Копировать адрес
                </button>
            `;
        }
        
        // Функция для копирования одного адреса (для одиночных балунов)
        window.copySingleAddress = function(address, status, district, entrances) {
            let text = address;
            
            // Добавляем дополнительную информацию, если она есть
            const details = [];
            if (status && status !== 'undefined') details.push(status);
            if (district && district !== 'undefined' && district !== 'не указан') details.push(district);
            if (entrances && entrances !== 'undefined' && entrances !== 'не указано' && entrances !== 0) details.push(`Подъездов: ${entrances}`);
            
            if (details.length > 0) {
                text += ` (${details.join(', ')})`;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                // Временное изменение текста кнопки для подтверждения
                const buttons = document.querySelectorAll('.balloon-copy-button');
                buttons.forEach(button => {
                    const originalText = button.textContent;
                    button.textContent = '✓ Скопировано!';
                    button.style.background = '#1565C0';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '';
                    }, 2000);
                });
                
                // Показываем уведомление
                showNotification('Адрес скопирован в буфер обмена');
            }).catch(err => {
                console.error('Ошибка копирования:', err);
                showNotification('Не удалось скопировать адрес', true);
            });
        };
        
        function applyFilters() {
            // Получаем выбранные статусы
            const statusCheckboxes = document.querySelectorAll('.status-filter:checked');
            const selectedStatuses = Array.from(statusCheckboxes).map(cb => cb.value);
            
            // Получаем выбранные районы (исключаем "all")
            const districtCheckboxes = document.querySelectorAll('.district-filter:checked');
            const selectedDistricts = Array.from(districtCheckboxes)
                .map(cb => cb.value)
                .filter(value => value !== 'all');
            
            // Если ни один статус не выбран - ничего не показываем
            if (selectedStatuses.length === 0) {
                objectManager.setFilter(() => false);
                updateAddressList([]);
                return;
            }
            
            // Если ни один район не выбран (и "all" тоже не выбран) - ничего не показываем
            if (selectedDistricts.length === 0 && !document.querySelector('.district-filter[value="all"]').checked) {
                objectManager.setFilter(() => false);
                updateAddressList([]);
                return;
            }
            
            // Фильтрация карты
            objectManager.setFilter(obj => {
                const statusMatch = selectedStatuses.includes(obj.properties.status);
                const districtMatch = selectedDistricts.length === 0 || selectedDistricts.includes(obj.properties.district);
                
                return statusMatch && districtMatch;
            });
            
            // Фильтрация списка
            const filtered = currentAddresses.filter(addr => {
                const statusMatch = selectedStatuses.includes(addr.isOccupied ? 'occupied' : 'free');
                const districtMatch = selectedDistricts.length === 0 || selectedDistricts.includes(addr.district);
                
                return statusMatch && districtMatch;
            });
            
            updateAddressList(filtered);
        }
        
        function updateAddressList(addresses) {
            const list = document.getElementById('address-list');
            const count = document.getElementById('address-count');
            const entrancesCount = document.getElementById('entrances-count');
            
            count.textContent = addresses.length;
            
            // Подсчет подъездов для отфильтрованных адресов
            const filteredEntrances = addresses.reduce((sum, addr) => sum + (addr.entrances || 0), 0);
            entrancesCount.textContent = filteredEntrances;
            
            if (addresses.length === 0) {
                list.innerHTML = '<div class="empty-list">Нет адресов, соответствующих фильтрам</div>';
                return;
            }
            
            list.innerHTML = '';
            addresses.forEach(addr => {
                const item = document.createElement('div');
                item.className = 'address-item';
                item.innerHTML = `
                    <div class="address-header">
                        <strong>${addr.address}</strong>
                        <span class="${addr.isOccupied ? 'status-occupied' : 'status-free'}">
                            ${addr.status}
                        </span>
                    </div>
                    <div class="address-details">
                        Район: ${addr.district || 'не указан'}
                        ${addr.entrances ? `<span class="entrances-count">Подъездов: ${addr.entrances}</span>` : ''}
                    </div>
                `;
                item.addEventListener('click', () => {
                    // Плавное перемещение к точке с небольшим увеличением
                    map.panTo(addr.coordinates, {
                        flying: true,
                        zoom: 17
                    }).then(function() {
                        // После завершения анимации открываем балун
                        const object = objectManager.objects.getById(addr.id);
                        if (object) {
                            objectManager.objects.balloon.open(addr.id);
                        }
                    });
                });
                list.appendChild(item);
            });
        }
        
        function resetDistrictFilter() {
            document.getElementById('districts-container').innerHTML = '';
            
            // Добавляем опцию "Все районы"
            const allDistrictsItem = document.createElement('label');
            allDistrictsItem.className = 'checkbox-item';
            allDistrictsItem.innerHTML = `
                <input type="checkbox" class="district-filter" value="all" checked>
                <span>Все районы</span>
            `;
            document.getElementById('districts-container').appendChild(allDistrictsItem);
            
            // Добавляем обработчик события изменения
            allDistrictsItem.querySelector('input').addEventListener('change', applyFilters);
        }
        
        function populateDistrictFilter(districts) {
            const container = document.getElementById('districts-container');
            
            // Добавляем чекбоксы для каждого района
            districts.forEach(district => {
                const item = document.createElement('label');
                item.className = 'checkbox-item';
                item.innerHTML = `
                    <input type="checkbox" class="district-filter" value="${district}" checked>
                    <span>${district}</span>
                `;
                container.appendChild(item);
                
                // Добавляем обработчик события изменения
                item.querySelector('input').addEventListener('change', applyFilters);
            });
            
            // Обработчик для чекбокса "Все районы"
            const allDistrictsCheckbox = container.querySelector('.district-filter[value="all"]');
            const districtCheckboxes = container.querySelectorAll('.district-filter:not([value="all"])');
            
            allDistrictsCheckbox.addEventListener('change', function() {
                districtCheckboxes.forEach(cb => {
                    cb.checked = this.checked;
                });
                applyFilters(); // Применяем фильтры сразу
            });
            
            // Обработчики для чекбоксов районов
            districtCheckboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    if (!this.checked) {
                        allDistrictsCheckbox.checked = false;
                    } else {
                        // Проверяем, все ли районы выбраны
                        const allChecked = Array.from(districtCheckboxes).every(c => c.checked);
                        allDistrictsCheckbox.checked = allChecked;
                    }
                    applyFilters(); // Применяем фильтры сразу
                });
            });
        }
        
        async function copyAllAddresses() {
            const items = Array.from(document.querySelectorAll('.address-item'));
            if (items.length === 0) return;
            
            // Получаем заголовки с количеством
            const addressCount = document.getElementById('address-count').textContent;
            const entrancesCount = document.getElementById('entrances-count').textContent;
            
            // Формируем чистый текст
            let text = `Адреса (${addressCount})\n`;
            text += `Подъезды (${entrancesCount})\n\n`;
            
            text += items.map(item => {
                const addr = item.querySelector('strong').textContent.trim();
                const status = item.querySelector('span').textContent.trim();
                const district = item.querySelector('.address-details').textContent
                    .replace('Район:', '').replace(/Подъездов: \d+/, '').trim();
                const entrances = item.querySelector('.entrances-count')?.textContent || '';
                
                return `${addr} (${status}${district ? ', ' + district : ''}${entrances ? ', ' + entrances : ''})`;
            }).join('\n');
            
            try {
                await navigator.clipboard.writeText(text);
                showNotification(`Список из ${items.length} адресов скопирован в буфер обмена!`);
            } catch (err) {
                console.error('Ошибка копирования:', err);
                showNotification('Не удалось скопировать список адресов', true);
            }
        }
    </script>
</body>
</html>
