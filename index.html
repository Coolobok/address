<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>PR МАРКЕТ Рязань - стенды у домофонов</title>
    <!-- Подключаем Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
	/* ============================================
	   МОДУЛЬ 1: БАЗОВЫЕ СТИЛИ И СБРОС
	   ============================================ */
	* {
		margin: 0;
		padding: 0;
		box-sizing: border-box;
	}

	:root {
		--color-free: #10b981;
		--color-busy: #ef4444;
		--color-primary: #3b82f6;
		--color-secondary: #6b7280;
		--color-background: #f9fafb;
		--color-surface: #ffffff;
		--color-border: #e5e7eb;
		--brand-color: #475493;
		--brand-light: #5b69b0;
		--brand-dark: #394176;
		--text-on-brand: #ffffff;
		--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
		--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
		--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
		--radius-sm: 0.375rem;
		--radius-md: 0.5rem;
		--radius-lg: 0.75rem;
		--safe-area-inset-top: env(safe-area-inset-top, 0px);
		--safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
	}

	html, body {
		height: 100%;
		width: 100%;
		overflow: hidden;
	}

	body {
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
		line-height: 1.5;
		color: #1f2937;
		background: var(--color-background);
		padding-top: var(--safe-area-inset-top);
		padding-bottom: var(--safe-area-inset-bottom);
	}

	/* Стили для иконок Font Awesome */
	.fas, .far, .fab {
		font-style: normal;
	}
	
	/* Специальные классы для цветов иконок */
	.text-success { color: var(--color-free); }
	.text-danger { color: var(--color-busy); }
	.text-info { color: var(--brand-color); }
	.text-warning { color: #f59e0b; }

	/* Стили для иконок в навигации */
	.nav-icon {
		font-size: 1.25rem;
		filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.2));
	}

	/* Стили для иконок в кнопках */
	.report-action-btn i,
	.marker-action-btn i,
	.markers-control-btn i,
	.nav-button i {
		font-size: 1em;
		margin-right: 0.5rem;
		width: 1.25em;
		text-align: center;
	}

	/* Стили для иконок статуса */
	.status-indicator i {
		font-size: 0.75em;
	}

	/* Стили для иконок в списке зданий */
	.building-details i {
		margin-right: 0.25rem;
		width: 1em;
		text-align: center;
	}

	/* ============================================
	   МОДУЛЬ 2: ЗАГРУЗКА
	   ============================================ */
	#loading-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: var(--color-surface);
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		z-index: 1000;
		transition: opacity 0.3s;
	}

	.spinner {
		width: 50px;
		height: 50px;
		border: 3px solid var(--color-border);
		border-top-color: var(--brand-color);
		border-radius: 50%;
		animation: spin 1s linear infinite;
		margin-bottom: 1rem;
	}

	@keyframes spin {
		to { transform: rotate(360deg); }
	}

	/* ============================================
	   МОДУЛЬ 3: МОДАЛЬНОЕ ОКНО ОТЧЁТА
	   ============================================ */
	.report-modal-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0, 0, 0, 0.5);
		display: flex;
		justify-content: center;
		align-items: center;
		z-index: 2000;
		opacity: 0;
		visibility: hidden;
		transition: all 0.3s;
		backdrop-filter: blur(4px);
	}

	.report-modal-overlay.active {
		opacity: 1;
		visibility: visible;
	}

	.report-modal {
		background: var(--color-surface);
		border-radius: var(--radius-lg);
		box-shadow: var(--shadow-lg);
		width: 90%;
		max-width: 600px;
		max-height: 80vh;
		display: flex;
		flex-direction: column;
		overflow: hidden;
		transform: translateY(20px);
		transition: transform 0.3s;
	}

	.report-modal-overlay.active .report-modal {
		transform: translateY(0);
	}

	.report-modal-header {
		background: linear-gradient(135deg, var(--brand-color), var(--brand-light));
		color: var(--text-on-brand);
		padding: 1.25rem 1.5rem;
		border-bottom: 1px solid rgba(255, 255, 255, 0.1);
		display: flex;
		justify-content: space-between;
		align-items: center;
		flex-shrink: 0;
	}

	.report-modal-title {
		font-size: 1.25rem;
		font-weight: 700;
		text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
	}

	.report-modal-close {
		background: rgba(255, 255, 255, 0.2);
		color: white;
		border: none;
		width: 36px;
		height: 36px;
		border-radius: 50%;
		font-size: 1.25rem;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all 0.2s;
	}

	.report-modal-close:hover {
		background: rgba(255, 255, 255, 0.3);
		transform: scale(1.1);
	}

	.report-modal-close:active {
		transform: scale(0.95);
	}

	.report-modal-content {
		padding: 1.5rem;
		display: flex;
		flex-direction: column;
		flex: 1;
		min-height: 0;
		overflow: hidden;
		gap: 1rem;
	}

	.report-text-container {
		flex: 1;
		display: flex;
		flex-direction: column;
		min-height: 0;
		overflow: hidden;
	}

	.report-textarea {
		width: 100%;
		flex: 1;
		min-height: 150px;
		max-height: none;
		padding: 1rem;
		border: 1px solid var(--color-border);
		border-radius: var(--radius-md);
		font-family: 'Courier New', monospace;
		font-size: 0.875rem;
		line-height: 1.4;
		resize: vertical;
		background: var(--color-background);
		color: var(--brand-dark);
		overflow-y: auto;
		word-wrap: break-word;
		white-space: pre-wrap;
		overflow-wrap: break-word;
	}

	.report-textarea:focus {
		outline: none;
		border-color: var(--brand-color);
		box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
	}

	/* Три кнопки в одну строку */
	.report-actions {
		display: grid;
		grid-template-columns: 1fr 1fr 1fr;
		gap: 0.75rem;
		flex-shrink: 0;
	}

	.report-actions-extended {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 0.75rem;
		flex-shrink: 0;
		padding-top: 1rem;
		border-top: 2px solid var(--color-border);
	}

	.report-action-btn {
		padding: 1rem;
		border: none;
		border-radius: var(--radius-md);
		font-size: 1rem;
		font-weight: 600;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.75rem;
		transition: all 0.2s;
		-webkit-tap-highlight-color: transparent;
	}

	.report-action-btn.copy-btn {
		background: var(--color-primary);
		color: white;
	}

	.report-action-btn.copy-btn:hover {
		background: #2563eb;
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
	}

	.report-action-btn.download-btn {
		background: var(--color-free);
		color: white;
	}

	.report-action-btn.download-btn:hover {
		background: #059669;
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
	}

	.report-action-btn.link-btn {
		background: #f59e0b;
		color: white;
	}

	.report-action-btn.link-btn:hover {
		background: #d97706;
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
	}

	.report-action-btn.telegram-btn {
		background: #0088cc;
		color: white;
	}

	.report-action-btn.telegram-btn:hover {
		background: #0077b5;
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
	}

	.report-action-btn.email-btn {
		background: #ea4335;
		color: white;
	}

	.report-action-btn.email-btn:hover {
		background: #d33426;
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(234, 67, 53, 0.3);
	}

	.report-action-btn:active {
		transform: translateY(0);
	}

	@media (max-width: 768px) {
		.report-modal {
			width: 100%;
			height: 100%;
			max-height: 100vh;
			border-radius: 0;
			margin: 0;
		}
		
		.report-modal-content {
			padding: 1rem;
			gap: 0.75rem;
		}
		
		.report-textarea {
			min-height: 120px;
		}
		
		.report-actions {
			grid-template-columns: 1fr;
			gap: 0.5rem;
		}
		
		.report-actions-extended {
			grid-template-columns: 1fr;
			gap: 0.5rem;
		}
		
		.report-action-btn {
			padding: 0.875rem;
			font-size: 0.9rem;
		}
	}

	/* ============================================
	   МОДУЛЬ 4: ИНДИКАТОРЫ СТАТУСА
	   ============================================ */
	.status-indicator {
		display: inline-block;
		width: 12px;
		height: 12px;
		border-radius: 50%;
		margin-right: 4px;
		flex-shrink: 0;
	}

	.checkbox-item .status-indicator {
		margin-right: 4px !important;
	}

	.building-header .status-indicator {
		margin-right: 0 !important;
	}

	.status-free {
		background-color: var(--color-free);
		border: 2px solid #059669;
	}

	.status-busy {
		background-color: var(--color-busy);
		border: 2px solid #dc2626;
	}

	.building-item .status-indicator {
		width: 16px !important;
		height: 16px !important;
		margin-right: 6px;
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
	}

	.header-stats .status-indicator,
	.sidebar-stats .status-indicator,
	.filter-options .status-indicator {
		width: 12px;
		height: 12px;
	}

	/* ============================================
	   МОДУЛЬ 5: БАЛУНЫ КАРТЫ
	   ============================================ */
	.cluster-balloon,
	.single-balloon,
	.marker-balloon,
	.markers-control-panel,
	.markers-full-list {
		background: white;
		border-radius: 12px;
		box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
		overflow: hidden;
		max-width: 350px;
		min-width: 280px;
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
		position: relative;
	}

	.cluster-header,
	.single-balloon-header,
	.marker-balloon-header,
	.markers-control-header,
	.markers-list-header {
		background: #475493;
		color: white;
		padding: 12px 16px;
		padding-right: 45px;
		border-bottom: 1px solid rgba(255, 255, 255, 0.1);
		position: relative;
	}

	.cluster-close-btn,
	.single-balloon-close-btn,
	.marker-balloon-close-btn,
	.markers-control-close-btn,
	.markers-list-close-btn {
		position: absolute;
		top: 8px;
		right: 8px;
		width: 30px;
		height: 30px;
		background: rgba(255, 255, 255, 0.2);
		color: white;
		border: none;
		border-radius: 50%;
		font-size: 18px;
		font-weight: bold;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all 0.2s;
		z-index: 10;
	}

	.cluster-close-btn:hover,
	.single-balloon-close-btn:hover,
	.marker-balloon-close-btn:hover,
	.markers-control-close-btn:hover,
	.markers-list-close-btn:hover {
		background: rgba(255, 255, 255, 0.3);
		transform: scale(1.1);
	}

	.cluster-close-btn:active,
	.single-balloon-close-btn:active,
	.marker-balloon-close-btn:active,
	.markers-control-close-btn:active,
	.markers-list-close-btn:active {
		transform: scale(0.95);
	}

	.cluster-title {
		font-size: 16px;
		font-weight: 700;
		margin: 0;
		text-align: center;
	}

	.cluster-addresses {
		padding: 0;
		background: white;
		max-height: 300px;
		overflow-y: auto;
	}

	.cluster-table {
		width: 100%;
		border-collapse: collapse;
		background: white;
		font-size: 13px;
	}

	.cluster-table th {
		background: #f8f9fa;
		font-size: 12px;
		font-weight: 600;
		color: #495057;
		text-transform: uppercase;
		letter-spacing: 0.3px;
		padding: 10px 16px;
		text-align: left;
		border-bottom: 1px solid #dee2e6;
	}

	.cluster-table th:first-child {
		width: 70%;
	}

	.cluster-table th:last-child {
		width: 30%;
		text-align: right;
	}

	.cluster-table td {
		padding: 10px 16px;
		border-bottom: 1px solid #f1f3f4;
		vertical-align: middle;
	}

	.cluster-table tr:last-child td {
		border-bottom: none;
	}

	.cluster-table tr:hover td {
		background: #f8f9fa;
	}

	.address-cell {
		display: flex;
		align-items: center;
		gap: 8px;
	}

	.address-status {
		width: 10px;
		height: 10px;
		border-radius: 50%;
		flex-shrink: 0;
		margin-right: 4px;
	}

	.address-status.free {
		background: #10b981;
		box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
	}

	.address-status.busy {
		background: #ef4444;
		box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
	}

	.address-text {
		flex: 1;
		font-size: 13px;
		line-height: 1.4;
		color: #212529;
		word-break: break-word;
	}

	.stands-cell {
		text-align: right;
		font-weight: 700;
		color: #475493;
		font-size: 13px;
		white-space: nowrap;
	}

	.more-buildings {
		text-align: center;
		color: #6c757d;
		font-size: 12px;
		font-style: italic;
		padding: 8px 16px;
		background: #f8f9fa;
	}

	.cluster-footer,
	.single-balloon-content,
	.marker-balloon-content,
	.markers-control-content,
	.markers-list-content {
		padding: 12px 16px;
		background: #f8f9fa;
		border-top: 1px solid #dee2e6;
	}

	.hide-cluster-btn,
	.single-balloon-hide-btn {
		background: #ef4444;
		color: white;
		border: none;
		border-radius: 6px;
		padding: 8px 16px;
		font-size: 13px;
		font-weight: 600;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 6px;
		transition: all 0.2s;
		width: 100%;
	}

	.hide-cluster-btn:hover,
	.single-balloon-hide-btn:hover {
		background: #dc2626;
		transform: translateY(-1px);
		box-shadow: 0 2px 4px rgba(239, 68, 68, 0.25);
	}

	.hide-cluster-btn:active,
	.single-balloon-hide-btn:active {
		transform: translateY(0);
	}

	.single-balloon-title {
		font-size: 14px;
		font-weight: 700;
		margin: 0;
		display: flex;
		align-items: center;
		gap: 8px;
	}

	.single-balloon-stats {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 12px;
		margin-bottom: 16px;
	}

	.single-stat-item {
		background: #f8f9fa;
		padding: 8px 10px;
		border-radius: 6px;
	}

	.single-stat-label {
		font-size: 10px;
		color: #6b7280;
		margin-bottom: 4px;
		text-transform: uppercase;
		letter-spacing: 0.3px;
	}

	.single-stat-value {
		font-weight: 600;
		color: #1f2937;
		font-size: 13px;
	}

	.single-stat-value.stands {
		font-weight: 700;
		color: #475493;
		font-size: 16px;
	}

	.marker-balloon-header h3,
	.markers-control-header h3,
	.markers-list-header h3 {
		font-size: 16px;
		font-weight: 700;
		margin: 0;
		display: flex;
		align-items: center;
		gap: 8px;
	}

	.marker-info {
		margin-bottom: 16px;
		font-size: 14px;
		line-height: 1.5;
		color: #1f2937;
	}

	.marker-info div {
		margin-bottom: 8px;
	}

	.marker-info strong {
		color: #374151;
		font-weight: 600;
	}

	.marker-actions,
	.markers-control-actions {
		display: flex;
		flex-direction: column;
		gap: 8px;
	}

	.marker-action-btn,
	.markers-control-btn {
		padding: 10px 16px;
		border: none;
		border-radius: 8px;
		font-size: 13px;
		font-weight: 600;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 8px;
		transition: all 0.2s;
	}

	.marker-action-btn.edit-btn,
	.markers-control-btn.list-btn {
		background: #3b82f6;
		color: white;
	}

	.marker-action-btn.edit-btn:hover,
	.markers-control-btn.list-btn:hover {
		background: #2563eb;
		transform: translateY(-1px);
		box-shadow: 0 2px 4px rgba(59, 130, 246, 0.25);
	}

	.marker-action-btn.delete-btn,
	.markers-control-btn.delete-all-btn {
		background: #ef4444;
		color: white;
	}

	.marker-action-btn.delete-btn:hover,
	.markers-control-btn.delete-all-btn:hover {
		background: #dc2626;
		transform: translateY(-1px);
		box-shadow: 0 2px 4px rgba(239, 68, 68, 0.25);
	}

	.markers-control-stats {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 12px;
		margin-bottom: 16px;
	}

	.marker-stat {
		background: #f8f9fa;
		padding: 10px;
		border-radius: 6px;
		text-align: center;
	}

	.marker-stat-label {
		font-size: 10px;
		color: #6b7280;
		margin-bottom: 4px;
		text-transform: uppercase;
		letter-spacing: 0.3px;
	}

	.marker-stat-value {
		font-weight: 600;
		color: #1f2937;
		font-size: 13px;
	}

	.markers-control-btn.add-btn {
		background: #10b981;
		color: white;
	}

	.markers-control-btn.add-btn:hover {
		background: #059669;
		transform: translateY(-1px);
		box-shadow: 0 2px 4px rgba(16, 185, 129, 0.25);
	}

	.markers-control-btn.drag-btn {
		background: #f59e0b;
		color: white;
	}

	.markers-control-btn.drag-btn:hover {
		background: #d97706;
		transform: translateY(-1px);
		box-shadow: 0 2px 4px rgba(245, 158, 11, 0.25);
	}

	.markers-control-btn.drag-btn.active {
		background: #dc2626;
		box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
	}

	.markers-list-preview {
		margin-top: 16px;
		border-top: 1px solid #e5e7eb;
		padding-top: 12px;
	}

	.markers-list-preview h4 {
		font-size: 14px;
		font-weight: 600;
		color: #374151;
		margin-bottom: 8px;
	}

	.markers-preview-list {
		list-style: none;
		padding: 0;
		margin: 0;
		max-height: 200px;
		overflow-y: auto;
	}

	.markers-preview-list li {
		padding: 8px 12px;
		background: #f8f9fa;
		border-radius: 6px;
		margin-bottom: 6px;
		cursor: pointer;
		transition: all 0.2s;
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.markers-preview-list li:hover {
		background: #e5e7eb;
		transform: translateY(-1px);
	}

	.marker-preview-text {
		font-size: 13px;
		font-weight: 500;
		color: #1f2937;
		flex: 1;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		max-width: 180px;
	}

	.marker-preview-date {
		font-size: 11px;
		color: #6b7280;
		white-space: nowrap;
	}

	.markers-table {
		width: 100%;
		border-collapse: collapse;
		font-size: 13px;
	}

	.markers-table th {
		background: #f8f9fa;
		font-weight: 600;
		color: #495057;
		text-transform: uppercase;
		letter-spacing: 0.3px;
		padding: 10px 12px;
		text-align: left;
		border-bottom: 1px solid #dee2e6;
		font-size: 12px;
	}

	.markers-table td {
		padding: 10px 12px;
		border-bottom: 1px solid #f1f3f4;
		vertical-align: middle;
	}

	.markers-table tr:hover td {
		background: #f8f9fa;
	}

	.marker-action-small {
		padding: 4px 8px;
		border: none;
		border-radius: 4px;
		font-size: 11px;
		cursor: pointer;
		margin-right: 4px;
		background: #f3f4f6;
		color: #374151;
		transition: all 0.2s;
	}

	.marker-action-small:hover {
		background: #e5e7eb;
		transform: translateY(-1px);
	}

	.markers-list-footer {
		padding: 12px 16px;
		background: #f8f9fa;
		border-top: 1px solid #e5e7eb;
	}

	.map-crosshair-mode,
	.map-crosshair-mode #map-container,
	.map-crosshair-mode #desktop-map-container,
	.map-crosshair-mode #map-container *,
	.map-crosshair-mode #desktop-map-container * {
		cursor: crosshair !important;
	}

	.map-drag-mode,
	.map-drag-mode #map-container,
	.map-drag-mode #desktop-map-container,
	.map-drag-mode #map-container *,
	.map-drag-mode #desktop-map-container * {
		cursor: move !important;
	}

	.user-marker .ymaps-2-1-79-balloon__content {
		padding: 0 !important;
		margin: 0 !important;
	}

	/* ============================================
	   МОДУЛЬ 6: СТРУКТУРА ПРИЛОЖЕНИЯ
	   ============================================ */
	#app-container {
		display: flex;
		flex-direction: column;
		height: 100%;
		width: 100%;
	}

	#compact-header {
		flex-shrink: 0;
		background: var(--brand-color);
		box-shadow: var(--shadow-md);
		padding: 0.875rem 1rem;
		padding-top: calc(0.875rem + var(--safe-area-inset-top));
		z-index: 100;
		display: none;
		position: relative;
	}

	.header-title {
		font-size: 1.375rem;
		font-weight: 700;
		color: var(--text-on-brand);
		text-align: left;
		margin-bottom: 0.25rem;
		text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
		letter-spacing: 0.3px;
		line-height: 1.2;
	}

	.header-subtitle {
		font-size: 1rem;
		color: rgba(255, 255, 255, 0.9);
		text-align: left;
		margin-top: 0.25rem;
		font-weight: 400;
	}

	.header-stats {
		display: grid;
		grid-template-columns: repeat(4, 1fr);
		gap: 0.5rem;
		margin-top: 0.75rem;
	}

	.stat-item {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 0.375rem 0.25rem;
		background: rgba(255, 255, 255, 0.1);
		border-radius: var(--radius-md);
		backdrop-filter: blur(10px);
		text-align: center;
		min-height: 40px;
	}

	.stat-value {
		font-size: 0.875rem;
		font-weight: 700;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		width: 100%;
		text-align: center;
		color: var(--text-on-brand);
		text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
		margin-top: 0.125rem;
	}

	.stat-label {
		font-size: 0.65rem;
		color: rgba(255, 255, 255, 0.9);
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		width: 100%;
		text-align: center;
		line-height: 1;
		margin-bottom: 0.125rem;
	}

	#main-content {
		flex: 1;
		position: relative;
		overflow: hidden;
		min-height: 0;
		display: none;
	}

	#map-container {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		display: none;
	}

	#map-container > ymaps,
	#desktop-map-container > ymaps {
		width: 100% !important;
		height: 100% !important;
	}

	#mobile-panel {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: var(--color-surface);
		display: none;
		flex-direction: column;
		z-index: 50;
	}

	.mobile-panel-inner {
		flex: 1;
		display: flex;
		flex-direction: column;
		overflow: hidden;
	}

	.mobile-panel-header {
		flex-shrink: 0;
		background: var(--color-surface);
		border-bottom: 1px solid var(--color-border);
		padding: 1rem;
		z-index: 10;
	}

	.mobile-panel-content {
		flex: 1;
		overflow-y: auto;
		padding: 1rem;
		padding-bottom: calc(1rem + var(--safe-area-inset-bottom));
		-webkit-overflow-scrolling: touch;
	}

	#mobile-nav {
		flex-shrink: 0;
		background: var(--brand-color);
		box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
		z-index: 100;
		padding-bottom: var(--safe-area-inset-bottom);
		display: none;
	}

	.nav-buttons {
		display: flex;
		justify-content: space-around;
		padding: 0.5rem 0;
	}

	.nav-button {
		display: flex;
		flex-direction: column;
		align-items: center;
		background: none;
		border: none;
		padding: 0.5rem;
		color: rgba(255, 255, 255, 0.8);
		cursor: pointer;
		font-size: 0.75rem;
		gap: 0.25rem;
		flex: 1;
		-webkit-tap-highlight-color: transparent;
		transition: all 0.2s;
		border-radius: 6px;
		margin: 0 0.25rem;
	}

	.nav-button:hover {
		color: #ffffff;
		background: rgba(255, 255, 255, 0.1);
	}

	.nav-button.active {
		color: #ffffff;
		font-weight: 500;
		position: relative;
	}

	.nav-button.active::after {
		content: '';
		position: absolute;
		bottom: 0;
		left: 50%;
		transform: translateX(-50%);
		width: 30%;
		height: 2px;
		background: #ffffff;
		border-radius: 1px;
	}

	.nav-button:active {
		background: rgba(255, 255, 255, 0.15);
		transition: background 0.1s;
	}

	.nav-icon {
		font-size: 1.25rem;
		filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.2));
	}

	.nav-button.active .nav-icon {
		filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
	}

	#desktop-layout {
		display: none;
		flex: 1;
		overflow: hidden;
		position: relative;
	}

	#desktop-sidebar {
		width: 400px;
		min-width: 350px;
		max-width: 450px;
		background: var(--color-surface);
		border-right: 1px solid var(--color-border);
		display: flex;
		flex-direction: column;
		box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
		z-index: 10;
	}

	.sidebar-header {
		background: linear-gradient(135deg, var(--brand-color), var(--brand-light));
		color: var(--text-on-brand);
		padding: 1.25rem 1.5rem;
		flex-shrink: 0;
		border-bottom: 1px solid rgba(255, 255, 255, 0.1);
		position: relative;
	}

	.sidebar-title {
		font-size: 1.5rem;
		font-weight: 700;
		text-align: left;
		text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
		line-height: 1.2;
	}

	.sidebar-subtitle {
		font-size: 0.9rem;
		color: rgba(255, 255, 255, 0.9);
		text-align: left;
		margin: 0.5rem 0 1rem 0;
		font-weight: 400;
	}

	.sidebar-stats {
		display: grid;
		grid-template-columns: repeat(4, 1fr);
		gap: 0.5rem;
	}

	.sidebar-stat-item {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 0.375rem 0.25rem;
		background: rgba(255, 255, 255, 0.1);
		border-radius: var(--radius-md);
		backdrop-filter: blur(10px);
	}

	.sidebar-stat-value {
		font-weight: 700;
		color: #ffffff;
		margin-top: 0.125rem;
		font-size: 1rem;
	}

	.sidebar-stat-label {
		font-size: 0.7rem;
		color: rgba(255, 255, 255, 0.9);
		text-align: center;
		line-height: 1;
		margin-bottom: 0.125rem;
	}

	.sidebar-tabs {
		display: flex;
		background: linear-gradient(to right, var(--brand-color), var(--brand-light));
		border-bottom: 1px solid var(--color-border);
	}

	.sidebar-tab {
		flex: 1;
		padding: 0.875rem;
		background: none;
		border: none;
		font-size: 0.9rem;
		font-weight: 500;
		color: rgba(255, 255, 255, 0.85);
		cursor: pointer;
		transition: all 0.2s;
		border-bottom: 3px solid transparent;
	}

	.sidebar-tab:hover {
		color: #ffffff;
		background: rgba(255, 255, 255, 0.1);
	}

	.sidebar-tab.active {
		color: #ffffff;
		background: rgba(255, 255, 255, 0.2);
		border-bottom-color: #ffffff;
	}

	.sidebar-content {
		flex: 1;
		display: flex;
		flex-direction: column;
		overflow: hidden;
	}

	.tab-content {
		flex: 1;
		display: none;
		flex-direction: column;
		overflow: hidden;
	}

	.tab-content.active {
		display: flex;
	}

	.tab-content-inner {
		flex: 1;
		overflow-y: auto;
		padding: 1.25rem;
		padding-bottom: 0;
	}

	.tab-footer {
		flex-shrink: 0;
		padding: 1rem 1.25rem;
		padding-top: 0.75rem;
		border-top: 1px solid var(--color-border);
		background: var(--color-surface);
	}

	#desktop-map-container {
		flex: 1;
		position: relative;
		background: #f0f0f0;
		display: none;
	}

	#fullscreen-header {
		position: absolute;
		top: 1rem;
		left: 1rem;
		background: linear-gradient(135deg, var(--brand-color), var(--brand-light));
		color: var(--text-on-brand);
		padding: 1rem 1.5rem;
		border-radius: var(--radius-lg);
		box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
		z-index: 1000;
		display: none;
		min-width: 600px;
		max-width: 800px;
		backdrop-filter: blur(10px);
		cursor: move;
		user-select: none;
		border: 1px solid rgba(255, 255, 255, 0.2);
	}

	.fullscreen-header-title {
		font-size: 1.25rem;
		font-weight: 700;
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 0.5rem;
		text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
	}

	.fullscreen-header-subtitle {
		font-size: 0.9rem;
		color: rgba(255, 255, 255, 0.9);
		margin-bottom: 1rem;
		font-weight: 400;
	}

	.fullscreen-stats-grid {
		display: grid;
		grid-template-columns: repeat(4, 1fr);
		gap: 0.75rem;
		margin-top: 0.5rem;
	}

	.fullscreen-stat-item {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 0.5rem;
		background: rgba(255, 255, 255, 0.1);
		border-radius: var(--radius-md);
		backdrop-filter: blur(5px);
		min-width: 120px;
	}

	.fullscreen-stat-label {
		font-size: 0.7rem;
		color: rgba(255, 255, 255, 0.9);
		text-align: center;
		line-height: 1;
		margin-bottom: 0.25rem;
		white-space: nowrap;
	}

	.fullscreen-stat-value {
		font-weight: 700;
		color: #ffffff;
		font-size: 0.95rem;
		text-align: center;
		text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
	}

	/* Кнопки управления */
	.sidebar-fullscreen-btn {
		background: rgba(255, 255, 255, 0.2);
		color: white;
		border: 1px solid rgba(255, 255, 255, 0.3);
		border-radius: var(--radius-md);
		font-size: 1.25rem;
		font-weight: 700;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all 0.3s;
		position: absolute;
		top: 1.25rem;
		right: 1.5rem;
		width: 40px;
		height: 40px;
		z-index: 20;
	}

	.fullscreen-close-btn {
		background: rgba(255, 255, 255, 0.2);
		color: white;
		border: 1px solid rgba(255, 255, 255, 0.3);
		border-radius: var(--radius-md);
		font-size: 1.25rem;
		font-weight: 700;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all 0.3s;
		position: absolute;
		top: 1rem;
		right: 1rem;
		width: 32px;
		height: 32px;
		z-index: 20;
	}

	.desktop-undo-button {
		background: rgba(255, 255, 255, 0.2);
		color: white;
		border: 1px solid rgba(255, 255, 255, 0.3);
		border-radius: var(--radius-md);
		font-size: 1.25rem;
		font-weight: 700;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all 0.3s;
		position: absolute;
		top: 1.25rem;
		right: 4.5rem;
		width: 40px;
		height: 40px;
		z-index: 15;
	}

	.fullscreen-undo-button {
		background: rgba(255, 255, 255, 0.2);
		color: white;
		border: 1px solid rgba(255, 255, 255, 0.3);
		border-radius: var(--radius-md);
		font-size: 1.25rem;
		font-weight: 700;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all 0.3s;
		position: absolute;
		top: 1rem;
		right: 4rem;
		width: 32px;
		height: 32px;
		z-index: 15;
	}

	.sidebar-fullscreen-btn:hover,
	.fullscreen-close-btn:hover,
	.desktop-undo-button:hover,
	.fullscreen-undo-button:hover {
		background: rgba(255, 255, 255, 0.3);
		transform: scale(1.1);
	}

	.sidebar-fullscreen-btn:active,
	.fullscreen-close-btn:active,
	.desktop-undo-button:active,
	.fullscreen-undo-button:active {
		transform: scale(0.95);
	}

	.mobile-undo-button {
		background: rgba(255, 255, 255, 0.2);
		color: white;
		border: 1px solid rgba(255, 255, 255, 0.3);
		border-radius: var(--radius-md);
		font-size: 1.25rem;
		font-weight: 700;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all 0.3s;
		position: absolute;
		top: 0.875rem;
		right: 0.875rem;
		width: 36px;
		height: 36px;
		z-index: 1001;
	}

	.mobile-undo-button:hover {
		background: rgba(255, 255, 255, 0.3);
		transform: scale(1.1);
	}

	.mobile-undo-button:active {
		transform: scale(0.95);
	}

	.mobile-undo-button:disabled,
	.desktop-undo-button:disabled,
	.fullscreen-undo-button:disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}

	#desktop-sidebar.hidden {
		display: none;
	}

	#desktop-map-container.fullscreen {
		width: 100% !important;
	}

	/* ============================================
	   МОДУЛЬ 7: КОНТРОЛЫ И ФИЛЬТРЫ
	   ============================================ */
	.range-control {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		margin-top: 0.5rem;
		width: 100%;
	}

	.range-control-label {
		font-size: 0.875rem;
		color: var(--color-secondary);
		white-space: nowrap;
		min-width: 30px;
		text-align: left;
	}

	.range-control-input-wrapper {
		display: flex;
		align-items: center;
		gap: 0.25rem;
		flex: 1;
		min-width: 0;
	}

	.range-control-button {
		width: 2rem;
		height: 2rem;
		display: flex;
		align-items: center;
		justify-content: center;
		background: var(--color-surface);
		border: 1px solid var(--color-border);
		border-radius: var(--radius-sm);
		color: var(--brand-color);
		font-size: 1.125rem;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s;
		flex-shrink: 0;
		-webkit-tap-highlight-color: transparent;
		user-select: none;
	}

	.range-control-button:hover {
		background: var(--brand-color);
		color: white;
		border-color: var(--brand-color);
	}

	.range-control-button:active {
		transform: scale(0.95);
	}

	.range-control-button:disabled {
		opacity: 0.5;
		cursor: not-allowed;
		background: var(--color-background);
		color: var(--color-secondary);
	}

	.range-control-button:disabled:hover {
		background: var(--color-background);
		color: var(--color-secondary);
		border-color: var(--color-border);
	}

	.range-control-input {
		flex: 1;
		min-width: 60px;
		padding: 0.5rem;
		border: 1px solid var(--color-border);
		border-radius: var(--radius-sm);
		font-size: 0.875rem;
		text-align: center;
		background: var(--color-surface);
		transition: border-color 0.2s;
		font-variant-numeric: tabular-nums;
		width: 100%;
	}

	.range-control-input:focus {
		outline: none;
		border-color: var(--brand-color);
		box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
	}

	.range-control-input::-webkit-inner-spin-button,
	.range-control-input::-webkit-outer-spin-button {
		-webkit-appearance: none;
		margin: 0;
	}

	.range-control-input[type=number] {
		-moz-appearance: textfield;
	}

	.mobile-reset-button {
		padding: 0.75rem;
		background: #f3f4f6;
		color: var(--color-secondary);
		border: 1px solid var(--color-border);
		border-radius: var(--radius-md);
		cursor: pointer;
		font-weight: 500;
		transition: all 0.2s;
		width: 100%;
		font-size: 0.9rem;
		-webkit-tap-highlight-color: transparent;
	}

	.mobile-reset-button:hover {
		background: #e5e7eb;
		color: var(--brand-dark);
	}

	.mobile-reset-button:active {
		transform: scale(0.98);
	}

	.filter-section {
		margin-bottom: 1.5rem;
	}

	.filter-title {
		font-size: 0.875rem;
		font-weight: 600;
		margin-bottom: 0.5rem;
		display: flex;
		justify-content: space-between;
		align-items: center;
		color: var(--brand-dark);
	}

	.filter-options {
		display: flex;
		flex-direction: column;
		gap: 0.375rem;
	}

	.checkbox-item {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		cursor: pointer;
		padding: 0.25rem 0;
	}

	.checkbox-item input[type="checkbox"] {
		width: 1rem;
		height: 1rem;
		accent-color: var(--brand-color);
	}

	.range-row {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 0.75rem;
		margin-top: 0.5rem;
	}

	.range-input-group {
		display: flex;
		flex-direction: column;
	}

	.percentage-selector {
		background: var(--color-surface);
		border: 1px solid #e9ecef;
		border-radius: var(--radius-md);
		padding: 0.75rem;
	}

	.percentage-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 0.75rem;
	}

	.percentage-title {
		font-size: 0.9rem;
		font-weight: 600;
		color: #495057;
		white-space: nowrap;
	}

	.percentage-controls {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.percentage-button {
		width: 32px;
		height: 32px;
		display: flex;
		align-items: center;
		justify-content: center;
		background: #6c757d;
		color: white;
		border: none;
		border-radius: var(--radius-sm);
		cursor: pointer;
		font-size: 1rem;
		font-weight: 600;
		transition: all 0.2s;
	}

	.percentage-button:hover {
		background: #5a6268;
	}

	.percentage-button:active {
		transform: scale(0.95);
	}

	.percentage-value-display {
		min-width: 50px;
		text-align: center;
		font-size: 1rem;
		font-weight: 600;
		color: #495057;
		background: white;
		padding: 0.25rem 0.5rem;
		border-radius: var(--radius-sm);
		border: 1px solid #dee2e6;
	}

	.slider-container {
		margin: 0;
	}

	.slider {
		width: 100%;
		height: 6px;
		border-radius: 3px;
		background: #dee2e6;
		outline: none;
		-webkit-appearance: none;
	}

	.slider::-webkit-slider-thumb {
		-webkit-appearance: none;
		width: 20px;
		height: 20px;
		border-radius: 50%;
		background: white;
		border: 2px solid #6c757d;
		box-shadow: var(--shadow-sm);
		cursor: pointer;
		transition: all 0.2s;
	}

	.slider::-webkit-slider-thumb:hover {
		border-color: #495057;
	}

	/* ============================================
	   МОДУЛЬ 8: СПИСОК ЗДАНИЙ
	   ============================================ */
	#building-list, #desktop-building-list {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.building-item {
		padding: 0.75rem;
		border: 1px solid var(--color-border);
		border-radius: var(--radius-md);
		background: var(--color-surface);
		cursor: pointer;
		transition: all 0.2s;
		-webkit-tap-highlight-color: transparent;
	}

	.building-item:hover {
		border-color: var(--brand-color);
		box-shadow: var(--shadow-sm);
		transform: translateY(-1px);
	}

	.building-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 0.5rem;
		min-height: 32px;
		flex-wrap: nowrap;
		gap: 6px;
	}

	.building-status {
		display: flex;
		align-items: center;
		margin-right: 10px;
		flex-shrink: 0;
	}

	.building-address {
		font-weight: 500;
		flex: 1;
		margin: 0 10px;
		font-size: 0.95rem;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		line-height: 1.3;
		text-align: left;
	}

	.building-hide {
		color: var(--color-secondary);
		background: none;
		border: none;
		cursor: pointer;
		font-size: 1.5rem;
		padding: 0;
		width: 24px;
		height: 24px;
		display: flex;
		align-items: center;
		justify-content: center;
		border-radius: 50%;
		transition: all 0.2s;
		flex-shrink: 0;
		margin-left: 5px;
	}

	.building-hide:hover {
		background: rgba(239, 68, 68, 0.1);
		color: var(--color-busy);
		transform: scale(1.1);
	}

	.building-details {
		display: flex;
		gap: 0.75rem;
		font-size: 0.875rem;
		color: var(--color-secondary);
		flex-wrap: wrap;
	}

	.reset-button {
		margin-top: 0.5rem;
		padding: 0.75rem;
		background: var(--brand-color);
		color: white;
		border: none;
		border-radius: var(--radius-md);
		cursor: pointer;
		font-weight: 500;
		transition: all 0.2s;
		width: 100%;
	}

	.reset-button:hover {
		background: var(--brand-light);
		transform: translateY(-1px);
		box-shadow: var(--shadow-md);
	}

	.load-more {
		margin-top: 1rem;
		padding: 0.75rem;
		background: var(--color-surface);
		color: var(--brand-color);
		border: 1px solid var(--brand-color);
		border-radius: var(--radius-md);
		cursor: pointer;
		font-weight: 500;
		transition: all 0.2s;
		width: 100%;
		-webkit-tap-highlight-color: transparent;
	}

	.load-more:hover {
		background: var(--brand-color);
		color: white;
		transform: translateY(-1px);
		box-shadow: var(--shadow-md);
	}

	.action-button {
		padding: 0.75rem;
		background: var(--brand-color);
		color: white;
		border: none;
		border-radius: var(--radius-md);
		cursor: pointer;
		font-weight: 500;
		transition: all 0.2s;
		width: 100%;
		-webkit-tap-highlight-color: transparent;
	}

	.action-button:hover {
		background: var(--brand-light);
		transform: translateY(-1px);
		box-shadow: var(--shadow-md);
	}

	/* ============================================
	   МОДУЛЬ 9: ПЛАВАЮЩАЯ ПАНЕЛЬ МЕТОК
	   ============================================ */
	.markers-floating-panel {
		position: absolute;
		top: 20px;
		right: 20px;
		background: white;
		border-radius: 12px;
		box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
		overflow: hidden;
		width: 350px;
		max-width: 350px;
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
		z-index: 1000;
		display: flex;
		flex-direction: column;
		cursor: move;
		user-select: none;
	}

	.markers-floating-panel .markers-control-header {
		background: #475493;
		color: white;
		padding: 12px 16px;
		padding-right: 45px;
		border-bottom: 1px solid rgba(255, 255, 255, 0.1);
		position: relative;
		cursor: move;
	}

	.markers-floating-panel .markers-control-close-btn {
		position: absolute;
		top: 8px;
		right: 8px;
		width: 30px;
		height: 30px;
		background: rgba(255, 255, 255, 0.2);
		color: white;
		border: none;
		border-radius: 50%;
		font-size: 18px;
		font-weight: bold;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all 0.2s;
		z-index: 10;
	}

	.markers-floating-panel .markers-control-content {
		padding: 16px;
		max-height: 500px;
		overflow-y: auto;
	}

	/* ============================================
	   МОДУЛЬ 10: УВЕДОМЛЕНИЯ
	   ============================================ */
	.notification-container {
		position: fixed;
		top: 1rem;
		right: 1rem;
		z-index: 1001;
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
		align-items: center;
		left: 0;
		right: 0;
	}

	.notification {
		padding: 1rem 1.25rem;
		border-radius: 12px;
		background: var(--color-surface);
		box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
		display: flex;
		align-items: center;
		gap: 0.75rem;
		max-width: 320px;
		border: 1px solid var(--color-border);
		position: relative;
		overflow: hidden;
	}

	.notification::before {
		content: '';
		position: absolute;
		left: 0;
		top: 0;
		bottom: 0;
		width: 4px;
	}

	.notification.success::before {
		background: var(--color-free);
	}

	.notification.error::before {
		background: var(--color-busy);
	}

	.notification.info::before {
		background: var(--brand-color);
	}

	.notification-icon {
		font-size: 1.25rem;
		width: 24px;
		height: 24px;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.notification-content {
		flex: 1;
		font-size: 0.9rem;
		line-height: 1.4;
	}

	.mobile-bottom-notification {
		position: fixed;
		bottom: calc(60px + var(--safe-area-inset-bottom) + 32px);
		left: 0.5rem;
		right: auto;
		top: auto;
		z-index: 9999;
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
		align-items: flex-start;
		pointer-events: none;
		width: calc(100% - 2rem);
		max-width: 320px;
	}

	.mobile-bottom-notification.show {
		display: flex;
	}

	.mobile-bottom-notification .notification {
		padding: 0.75rem 1rem;
		border-radius: 8px;
		background: var(--color-surface);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
		display: flex;
		align-items: center;
		gap: 0.5rem;
		width: 100%;
		max-width: 320px;
		border: 1px solid var(--color-border);
		position: relative;
		overflow: hidden;
		pointer-events: auto;
		backdrop-filter: blur(10px);
		animation: slideUpBottom 0.3s ease-out;
	}

	@keyframes slideUpBottom {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.mobile-bottom-notification .notification::before {
		content: '';
		position: absolute;
		left: 0;
		top: 0;
		bottom: 0;
		width: 4px;
	}

	.mobile-bottom-notification .notification.success::before {
		background: var(--color-free);
	}

	.mobile-bottom-notification .notification.error::before {
		background: var(--color-busy);
	}

	.mobile-bottom-notification .notification.info::before {
		background: var(--brand-color);
	}

	.mobile-bottom-notification .notification-icon {
		font-size: 1.1rem;
		width: 20px;
		height: 20px;
		display: flex;
		align-items: center;
		justify-content: center;
		flex-shrink: 0;
	}

	.mobile-bottom-notification .notification-content {
		flex: 1;
		font-size: 0.85rem;
		line-height: 1.3;
	}

	/* ============================================
	   МОДУЛЬ 11: АДАПТИВНОСТЬ
	   ============================================ */
	@media (min-width: 769px) {
		#compact-header,
		#mobile-nav,
		#mobile-panel,
		#main-content {
			display: none !important;
		}
		
		#desktop-layout {
			display: flex;
		}
		
		#desktop-map-container {
			display: block;
		}
		
		.sidebar-content {
			padding: 0;
		}
		
		.filter-section {
			margin-bottom: 1.25rem;
		}
		
		.building-item {
			padding: 0.875rem;
		}
		
		#desktop-list-tab {
			display: flex;
			flex-direction: column;
		}
		
		#desktop-list-tab .percentage-selector {
			flex-shrink: 0;
			border-bottom: 1px solid var(--color-border);
			border-radius: 0;
			padding: 1rem 1.25rem;
			background: var(--color-surface);
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
		}
		
		#desktop-list-tab .tab-content-inner {
			flex: 1;
			overflow-y: auto;
			padding: 1.25rem;
			padding-bottom: 0;
		}
		
		#desktop-filters-tab {
			display: flex;
			flex-direction: column;
		}
		
		#desktop-filters-tab .tab-content-inner {
			flex: 1;
			overflow-y: auto;
			padding: 1.25rem;
			padding-bottom: 0;
		}
		
		.tab-content {
			display: none !important;
		}
		
		.tab-content.active {
			display: flex !important;
		}
		
		.marker-balloon,
		.markers-control-panel,
		.markers-full-list {
			max-width: 400px;
		}
		
		.markers-table {
			font-size: 13px;
		}
	}

	@media (max-width: 768px) {
		.notification-container {
			display: none !important;
		}
		
		#desktop-layout {
			display: none;
		}
		
		#compact-header,
		#mobile-nav,
		#main-content {
			display: block;
		}
		
		#map-container {
			display: block;
		}
		
		.header-title {
			font-size: 1.125rem;
			padding-right: 50px;
		}
		
		.header-subtitle {
			font-size: 0.875rem;
		}
		
		.stat-value {
			font-size: 0.875rem;
		}
		
		.stat-label {
			font-size: 0.65rem;
		}
		
		.building-details {
			font-size: 0.8rem;
		}
		
		#mobile-panel .panel-tabs {
			display: none;
		}
		
		#mobile-filters-tab,
		#mobile-list-tab {
			display: none;
		}
		
		#mobile-filters-tab.active,
		#mobile-list-tab.active {
			display: flex;
			flex-direction: column;
			height: 100%;
		}
		
		button, .checkbox-item, .building-item {
			touch-action: manipulation;
		}
		
		.nav-button {
			padding: 0.75rem 0.5rem;
			min-height: 48px;
		}
		
		.building-item {
			padding: 1rem;
		}
		
		.building-header {
			min-height: 28px;
			margin-bottom: 0.4rem;
		}
		
		.building-address {
			font-size: 0.9rem;
			margin: 0 8px;
		}
		
		.building-hide {
			width: 22px;
			height: 22px;
			font-size: 1.4rem;
		}
		
		.mobile-reset-button {
			padding: 1rem;
			font-size: 1rem;
		}
		
		.percentage-button {
			width: 36px;
			height: 36px;
			font-size: 1.1rem;
		}
		
		.percentage-value-display {
			min-width: 60px;
			font-size: 1.2rem;
		}
		
		.mobile-panel-header {
			padding: 1rem;
			border-bottom: 1px solid var(--color-border);
			background: var(--color-surface);
		}
		
		.mobile-panel-content {
			padding: 1rem;
			overflow-y: auto;
			-webkit-overflow-scrolling: touch;
		}
		
		#mobile-list-tab {
			display: flex;
			flex-direction: column;
		}
		
		#mobile-list-tab .percentage-selector {
			flex-shrink: 0;
			border-bottom: 1px solid var(--color-border);
			border-radius: 0;
			padding: 1rem;
			background: var(--color-surface);
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
		}
		
		#mobile-list-tab .mobile-panel-content {
			flex: 1;
			overflow-y: auto;
			padding: 1rem;
			padding-bottom: calc(1rem + var(--safe-area-inset-bottom));
		}
		
		.range-row {
			grid-template-columns: 1fr;
			gap: 0.75rem;
		}
		
		.report-actions {
			grid-template-columns: 1fr !important;
		}
		
		.mobile-undo-button {
			top: 10px;
			right: 10px !important;
			left: auto !important;
			width: 32px;
			height: 32px;
			font-size: 18px;
			z-index: 1001 !important;
		}
		
		.marker-balloon,
		.markers-control-panel,
		.markers-full-list {
			max-width: 320px;
			min-width: 280px;
		}
		
		.marker-actions {
			flex-direction: column;
		}
		
		.markers-control-actions {
			flex-direction: column;
		}
		
		.markers-table {
			font-size: 12px;
		}
		
		.markers-table th,
		.markers-table td {
			padding: 8px;
		}
		
		.marker-action-small {
			font-size: 10px;
			padding: 3px 6px;
			margin-right: 3px;
		}
	}

	@media (max-width: 360px) {
		.mobile-bottom-notification {
			bottom: calc(55px + var(--safe-area-inset-bottom) + 10px);
			left: 0.5rem;
			right: 0.5rem;
			width: calc(100% - 1rem);
		}
		
		.mobile-bottom-notification .notification {
			max-width: 100%;
			min-width: 180px;
			padding: 0.6rem 0.8rem;
		}
		
		.header-title {
			font-size: 1rem;
		}
		
		.header-subtitle {
			font-size: 0.8rem;
		}
		
		.stat-value {
			font-size: 0.8rem;
		}
		
		.stat-label {
			font-size: 0.6rem;
		}
		
		.header-stats {
			gap: 0.375rem;
		}
		
		.stat-item {
			padding: 0.25rem 0.125rem;
			min-height: 36px;
		}
		
		.nav-button span:not(.nav-icon) {
			font-size: 0.7rem;
		}
		
		.range-control-button {
			width: 1.75rem;
			height: 1.75rem;
			font-size: 1rem;
		}
		
		.range-control-input {
			min-width: 50px;
			padding: 0.375rem;
			font-size: 0.8rem;
		}
		
		.building-address {
			font-size: 0.85rem;
			margin: 0 6px;
		}
		
		.building-hide {
			width: 20px;
			height: 20px;
			font-size: 1.3rem;
		}
		
		.mobile-undo-button {
			top: 8px;
			right: 8px !important;
			left: auto !important;
			width: 28px;
			height: 28px;
			font-size: 16px;
		}
		
		.marker-balloon,
		.markers-control-panel,
		.markers-full-list {
			max-width: 280px;
			min-width: 250px;
		}
		
		.marker-balloon-header,
		.markers-control-header,
		.markers-list-header {
			padding: 10px 12px;
			padding-right: 40px;
		}
		
		.marker-balloon-close-btn,
		.markers-control-close-btn,
		.markers-list-close-btn {
			width: 26px;
			height: 26px;
			font-size: 16px;
			top: 6px;
			right: 6px;
		}
		
		.marker-balloon-content,
		.markers-control-content,
		.markers-list-content {
			padding: 12px;
		}
		
		.marker-action-btn {
			padding: 8px 12px;
			font-size: 12px;
		}
	}
    </style>
</head>
<body>
    <!-- HTML структура остается такой же -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div>Загрузка карты...</div>
    </div>

    <!-- Модальное окно отчёта -->
    <div class="report-modal-overlay" id="report-modal">
        <div class="report-modal">
            <div class="report-modal-header">
                <div class="report-modal-title"><i class="fas fa-file-alt"></i> Отчёт по стендам</div>
                <button class="report-modal-close" id="report-modal-close">×</button>
            </div>
            <div class="report-modal-content">
                <div class="report-text-container">
                    <textarea class="report-textarea" id="report-textarea" readonly></textarea>
                </div>
                <div class="report-actions-extended" id="report-share-actions" style="display: none;">
                    <button class="report-action-btn telegram-btn" id="report-telegram-btn">
                        <i class="fas fa-paper-plane"></i> Отправить в Telegram
                    </button>
                    <button class="report-action-btn email-btn" id="report-email-btn">
                        <i class="fas fa-envelope"></i> Отправить на Email
                    </button>
                </div>
                <div class="report-actions">
                    <button class="report-action-btn copy-btn" id="report-copy-btn">
                        <i class="fas fa-copy"></i> Копировать
                    </button>
                    <button class="report-action-btn link-btn" id="report-link-btn">
                        <i class="fas fa-link"></i> Ссылка на настройки
                    </button>
                    <button class="report-action-btn download-btn" id="report-download-btn">
                        <i class="fas fa-download"></i> Скачать TXT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container">
        <!-- МОБИЛЬНАЯ ВЕРСИЯ -->
        <div id="compact-header">
            <div class="header-title">
                PR МАРКЕТ Рязань
                <div class="header-subtitle">Стенды у домофонов: <span id="total-in-base">0</span> в базе</div>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-label">Выбрано стендов</span>
                    <span class="stat-value" id="selected-stands">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Охват квартир</span>
                    <span class="stat-value" id="coverage-flats">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">В месяц</span>
                    <span class="stat-value" id="monthly-price">—</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">За квартиру</span>
                    <span class="stat-value" id="per-flat-price">—</span>
                </div>
            </div>
        </div>

        <div id="main-content">
            <div id="map-container"></div>

            <!-- Мобильные нотификации внизу слева -->
            <div class="mobile-bottom-notification" id="mobile-bottom-notification"></div>

            <div id="mobile-panel">
                <div id="mobile-filters-tab" class="mobile-panel-inner" style="display: none;">
                    <div class="mobile-panel-header">
                        <button class="mobile-reset-button" id="mobile-reset-filters"><i class="fas fa-redo"></i> Сбросить фильтры</button>
                    </div>
                    <div class="mobile-panel-content">
                        <div class="filter-section">
                            <div class="filter-title">Статус</div>
                            <div class="filter-options" id="status-filter"></div>
                        </div>
                        <div class="filter-section">
                            <div class="filter-title">Район</div>
                            <div class="filter-options" id="district-filter"></div>
                        </div>
                        <div class="filter-section">
                            <div class="filter-title">Этажность</div>
                            <div class="range-row">
                                <div class="range-control">
                                    <span class="range-control-label">От</span>
                                    <div class="range-control-input-wrapper">
                                        <button class="range-control-button minus" data-target="floors-min" type="button">-</button>
                                        <input type="number" class="range-control-input" id="floors-min" placeholder="Мин" min="1">
                                        <button class="range-control-button plus" data-target="floors-min" type="button">+</button>
                                    </div>
                                </div>
                                <div class="range-control">
                                    <span class="range-control-label">До</span>
                                    <div class="range-control-input-wrapper">
                                        <button class="range-control-button minus" data-target="floors-max" type="button">-</button>
                                        <input type="number" class="range-control-input" id="floors-max" placeholder="Макс" min="1">
                                        <button class="range-control-button plus" data-target="floors-max" type="button">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-section">
                            <div class="filter-title">Квартир в подъезде</div>
                            <div class="range-row">
                                <div class="range-control">
                                    <span class="range-control-label">От</span>
                                    <div class="range-control-input-wrapper">
                                        <button class="range-control-button minus" data-target="flats-min" type="button">-</button>
                                        <input type="number" class="range-control-input" id="flats-min" placeholder="Мин" min="1">
                                        <button class="range-control-button plus" data-target="flats-min" type="button">+</button>
                                    </div>
                                </div>
                                <div class="range-control">
                                    <span class="range-control-label">До</span>
                                    <div class="range-control-input-wrapper">
                                        <button class="range-control-button minus" data-target="flats-max" type="button">-</button>
                                        <input type="number" class="range-control-input" id="flats-max" placeholder="Макс" min="1">
                                        <button class="range-control-button plus" data-target="flats-max" type="button">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="mobile-list-tab" class="mobile-panel-inner" style="display: none;">
                    <div class="percentage-selector">
                        <div class="percentage-header">
                            <div class="percentage-title">ПРОЦЕНТ ПОКАЗА <i class="fas fa-building"></i></div>
                            <div class="percentage-controls">
                                <button class="percentage-button" id="mobile-percentage-decrease">-</button>
                                <span class="percentage-value-display" id="mobile-percentage-value">100%</span>
                                <button class="percentage-button" id="mobile-percentage-increase">+</button>
                            </div>
                        </div>
                        <div class="slider-container">
                            <input type="range" class="slider" id="mobile-percentage-slider" min="1" max="100" value="100">
                        </div>
                    </div>
                    
                    <div class="mobile-panel-content">
                        <div id="building-list"></div>
                        <button class="load-more" id="load-more">Показать еще</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="mobile-nav">
            <div class="nav-buttons">
                <button class="nav-button active" data-view="map">
                    <i class="nav-icon fas fa-map"></i>
                    <span>Карта</span>
                </button>
                <button class="nav-button" data-view="filters">
                    <i class="nav-icon fas fa-filter"></i>
                    <span>Фильтры</span>
                </button>
                <button class="nav-button" data-view="list">
                    <i class="nav-icon fas fa-list"></i>
                    <span>Список</span>
                </button>
                <button class="nav-button" id="mobile-report-button">
                    <i class="nav-icon fas fa-file-alt"></i>
                    <span>Отчёт</span>
                </button>
            </div>
        </div>

        <!-- ДЕСКТОПНАЯ ВЕРСИЯ -->
        <div id="desktop-layout">
            <!-- Плавающая шапка для полноэкранного режима -->
            <div id="fullscreen-header">
                <div class="fullscreen-header-title">
                    <span>PR МАРКЕТ Рязань</span>
                    <button class="fullscreen-close-btn" id="fullscreen-close-btn"><i class="fas fa-arrow-left"></i></button>
                </div>
                <div class="fullscreen-header-subtitle">
                    Стенды у домофонов: <span id="fullscreen-total-in-base">0</span> в базе
                </div>
                <div class="fullscreen-stats-grid">
                    <div class="fullscreen-stat-item">
                        <span class="fullscreen-stat-label">ВЫБРАНО СТЕНДОВ</span>
                        <span class="fullscreen-stat-value" id="fullscreen-selected-stands">0</span>
                    </div>
                    <div class="fullscreen-stat-item">
                        <span class="fullscreen-stat-label">ОХВАТ КВАРТИР</span>
                        <span class="fullscreen-stat-value" id="fullscreen-coverage-flats">0</span>
                    </div>
                    <div class="fullscreen-stat-item">
                        <span class="fullscreen-stat-label">СТОИМОСТЬ В МЕСЯЦ</span>
                        <span class="fullscreen-stat-value" id="fullscreen-monthly-price">—</span>
                    </div>
                    <div class="fullscreen-stat-item">
                        <span class="fullscreen-stat-label">В ПЕРЕСЧЁТЕ НА КВАРТИРУ</span>
                        <span class="fullscreen-stat-value" id="fullscreen-per-flat-price">—</span>
                    </div>
                </div>
            </div>
            
            <div id="desktop-sidebar">
                <div class="sidebar-header">
                    <button class="sidebar-fullscreen-btn" id="sidebar-fullscreen-btn" title="Развернуть на весь экран"><i class="fas fa-arrow-left"></i></button>
                    
                    <div class="sidebar-title">
                        PR МАРКЕТ Рязань
                        <div class="sidebar-subtitle">Стенды у домофонов: <span id="desktop-total-in-base">0</span> в базе</div>
                    </div>
                    <div class="sidebar-stats">
                        <div class="sidebar-stat-item">
                            <span class="sidebar-stat-label">ВЫБРАНО СТЕНДОВ</span>
                            <span class="sidebar-stat-value" id="desktop-selected-stands">0</span>
                        </div>
                        <div class="sidebar-stat-item">
                            <span class="sidebar-stat-label">ОХВАТ КВАРТИР</span>
                            <span class="sidebar-stat-value" id="desktop-coverage-flats">0</span>
                        </div>
                        <div class="sidebar-stat-item">
                            <span class="sidebar-stat-label">СТОИМОСТЬ В МЕСЯЦ</span>
                            <span class="sidebar-stat-value" id="desktop-monthly-price">—</span>
                        </div>
                        <div class="sidebar-stat-item">
                            <span class="sidebar-stat-label">В ПЕРЕСЧЁТЕ НА КВАРТИРУ</span>
                            <span class="sidebar-stat-value" id="desktop-per-flat-price">—</span>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="filters"><i class="fas fa-filter"></i> Фильтры</button>
                    <button class="sidebar-tab" data-tab="list"><i class="fas fa-list"></i> Список</button>
                </div>
                
                <div class="sidebar-content">
                    <div class="tab-content active" id="desktop-filters-tab">
                        <div class="tab-content-inner">
                            <div class="filter-section">
                                <div class="filter-title">Статус</div>
                                <div class="filter-options" id="desktop-status-filter"></div>
                            </div>
                            <div class="filter-section">
                                <div class="filter-title">Район</div>
                                <div class="filter-options" id="desktop-district-filter"></div>
                            </div>
                            <div class="filter-section">
                                <div class="filter-title">Этажность</div>
                                <div class="range-row">
                                    <div class="range-control">
                                        <span class="range-control-label">От</span>
                                        <div class="range-control-input-wrapper">
                                            <button class="range-control-button minus" data-target="desktop-floors-min" type="button">-</button>
                                            <input type="number" class="range-control-input" id="desktop-floors-min" placeholder="Мин" min="1">
                                            <button class="range-control-button plus" data-target="desktop-floors-min" type="button">+</button>
                                        </div>
                                    </div>
                                    <div class="range-control">
                                        <span class="range-control-label">До</span>
                                        <div class="range-control-input-wrapper">
                                            <button class="range-control-button minus" data-target="desktop-floors-max" type="button">-</button>
                                            <input type="number" class="range-control-input" id="desktop-floors-max" placeholder="Макс" min="1">
                                            <button class="range-control-button plus" data-target="desktop-floors-max" type="button">+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="filter-section">
                                <div class="filter-title">Квартир в подъезде</div>
                                <div class="range-row">
                                    <div class="range-control">
                                        <span class="range-control-label">От</span>
                                        <div class="range-control-input-wrapper">
                                            <button class="range-control-button minus" data-target="desktop-flats-min" type="button">-</button>
                                            <input type="number" class="range-control-input" id="desktop-flats-min" placeholder="Мин" min="1">
                                            <button class="range-control-button plus" data-target="desktop-flats-min" type="button">+</button>
                                        </div>
                                    </div>
                                    <div class="range-control">
                                        <span class="range-control-label">До</span>
                                        <div class="range-control-input-wrapper">
                                            <button class="range-control-button minus" data-target="desktop-flats-max" type="button">-</button>
                                            <input type="number" class="range-control-input" id="desktop-flats-max" placeholder="Макс" min="1">
                                            <button class="range-control-button plus" data-target="desktop-flats-max" type="button">+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-footer">
                            <button class="reset-button" id="desktop-reset-filters"><i class="fas fa-redo"></i> Сбросить фильтры</button>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="desktop-list-tab">
                        <div class="percentage-selector">
                            <div class="percentage-header">
                                <div class="percentage-title">ПРОЦЕНТ ПОКАЗА <i class="fas fa-building"></i></div>
                                <div class="percentage-controls">
                                    <button class="percentage-button" id="desktop-percentage-decrease">-</button>
                                    <span class="percentage-value-display" id="desktop-percentage-value">100%</span>
                                    <button class="percentage-button" id="desktop-percentage-increase">+</button>
                                </div>
                            </div>
                            <div class="slider-container">
                                <input type="range" class="slider" id="desktop-percentage-slider" min="1" max="100" value="100">
                            </div>
                        </div>
                        
                        <div class="tab-content-inner">
                            <div id="desktop-building-list"></div>
                            <button class="load-more" id="desktop-load-more">Показать еще</button>
                        </div>
                        <div class="tab-footer">
                            <button class="action-button" id="desktop-generate-report"><i class="fas fa-file-alt"></i> Сформировать отчёт</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="desktop-map-container"></div>
        </div>
    </div>

    <div class="notification-container" id="notification-container"></div>

    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>

    <script>
        // ============================================================================
        // КОНФИГУРАЦИЯ И ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
        // ============================================================================
        const CONFIG = {
            GOOGLE_SHEETS: {
                SHEET_ID: "16xHTVeuOauyHYLH5RWuj_WzmGYFBYBZ5Uke-Nfeswr8",
                SHEET_NAME: "Filter",
                CONTACTS_SHEET_NAME: "Contacts"
            },
            
            MAP: {
                CENTER: [54.6416, 39.7126],
                ZOOM: 11
            },
            
            PRICING_RULES: {
                MIN_STANDS: 100,
                TIERS: [
                    { from: 100, to: 299, price: 160 },
                    { from: 300, to: 499, price: 140 },
                    { from: 500, to: Infinity, price: 120 }
                ]
            }
        };

        // Глобальные переменные
        let map = null;
        let objectManager = null;
        let allBuildings = [];
        let filteredBuildings = [];
        let displayedBuildings = [];
        let hiddenBuildings = new Set();
        let activeFilters = {
            status: new Set(),
            district: new Set(),
            floors: { min: null, max: null },
            flatsPerEntrance: { min: null, max: null }
        };
        let currentPercentage = 100;
        let listLimit = 50;
        let isMobile = window.innerWidth <= 768;
        let currentView = 'map';
        let currentDesktopTab = 'filters';
        let isGeneratingReport = false;
        let currentNotification = null;
        let appInitialized = false;
        let availableValues = {
            floors: [],
            flatsPerEntrance: []
        };
        let isFullscreen = false;
        let dragData = null;
        
        // Контакты из листа Contacts - ТОЛЬКО из Google Sheets
        let contacts = {
            telegram: null,
            email: null
        };

        // ============================================================================
        // УТИЛИТАРНЫЕ ФУНКЦИИ
        // ============================================================================
        const Utils = {
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            formatNumber(num) {
                if (num === null || num === undefined) return '—';
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            },

            formatPrice(amount) {
                if (amount === null || amount === undefined) return '—';
                if (Number.isInteger(amount)) {
                    return `${this.formatNumber(amount)} ₽`;
                }
                return `${amount.toFixed(2)} ₽`;
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            showNotification(message, type = 'info') {
                // Для мобильных устройств всегда используем нижний контейнер
                const containerId = isMobile ? 'mobile-bottom-notification' : 'notification-container';
                const container = document.getElementById(containerId);
                if (!container) return;
                
                // Удаляем предыдущую нотификацию
                if (currentNotification) {
                    currentNotification.remove();
                    currentNotification = null;
                }
                
                // Создаем новую нотификацию
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                let icon = '<i class="fas fa-info-circle text-info"></i>';
                if (type === 'success') icon = '<i class="fas fa-check-circle text-success"></i>';
                if (type === 'error') icon = '<i class="fas fa-times-circle text-danger"></i>';
                
                notification.innerHTML = `
                    <div class="notification-icon">${icon}</div>
                    <div class="notification-content">${message}</div>
                `;
                
                container.appendChild(notification);
                currentNotification = notification;
                
                // Всегда показываем контейнер для мобильных
                if (isMobile) {
                    container.classList.add('show');
                    
                    // Автоудаление через 3 секунды
                    setTimeout(() => {
                        if (notification.parentNode === container) {
                            notification.style.opacity = '0';
                            notification.style.transform = 'translateY(20px)';
                            notification.style.transition = 'opacity 0.3s, transform 0.3s';
                            
                            setTimeout(() => {
                                if (notification.parentNode === container) {
                                    notification.remove();
                                    currentNotification = null;
                                    
                                    // Скрываем контейнер, если нет нотификаций
                                    if (container.children.length === 0) {
                                        container.classList.remove('show');
                                    }
                                }
                            }, 300);
                        }
                    }, 3000);
                } else {
                    // Для десктопа используем обычную логику
                    setTimeout(() => {
                        if (notification.parentNode === container) {
                            notification.remove();
                            currentNotification = null;
                        }
                    }, 3000);
                }
            },
            
            setMobileView(view) {
                if (!isMobile) return;
                
                if (currentView === view && view !== 'map') {
                    view = 'map';
                }
                
                currentView = view;
                
                document.querySelectorAll('.nav-button').forEach(button => {
                    button.classList.remove('active');
                    if (button.dataset.view === view) {
                        button.classList.add('active');
                    }
                });
                
                const mapContainer = document.getElementById('map-container');
                const mobilePanel = document.getElementById('mobile-panel');
                const filtersTab = document.getElementById('mobile-filters-tab');
                const listTab = document.getElementById('mobile-list-tab');
                const notificationContainer = document.getElementById('mobile-bottom-notification');
                const desktopNotificationContainer = document.getElementById('notification-container');
                
                // Скрываем десктопные нотификации на мобильных
                if (desktopNotificationContainer) {
                    desktopNotificationContainer.style.display = 'none';
                }
                
                switch(view) {
                    case 'map':
                        mapContainer.style.display = 'block';
                        mobilePanel.style.display = 'none';
                        if (notificationContainer) {
                            notificationContainer.classList.add('show');
                        }
                        if (map) {
                            setTimeout(() => map.container.fitToViewport(), 100);
                        }
                        break;
                        
                    case 'filters':
                        mapContainer.style.display = 'none';
                        mobilePanel.style.display = 'flex';
                        filtersTab.classList.add('active');
                        listTab.classList.remove('active');
                        filtersTab.style.display = 'flex';
                        listTab.style.display = 'none';
                        if (notificationContainer) {
                            notificationContainer.classList.remove('show');
                            notificationContainer.innerHTML = '';
                            currentNotification = null;
                        }
                        break;
                        
                    case 'list':
                        mapContainer.style.display = 'none';
                        mobilePanel.style.display = 'flex';
                        filtersTab.classList.remove('active');
                        listTab.classList.add('active');
                        filtersTab.style.display = 'none';
                        listTab.style.display = 'flex';
                        if (notificationContainer) {
                            notificationContainer.classList.remove('show');
                            notificationContainer.innerHTML = '';
                            currentNotification = null;
                        }
                        break;
                }
            },
            
            setDesktopTab(tab) {
                currentDesktopTab = tab;
                
                document.querySelectorAll('.sidebar-tab').forEach(tabEl => {
                    tabEl.classList.remove('active');
                    if (tabEl.dataset.tab === tab) {
                        tabEl.classList.add('active');
                    }
                });
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`desktop-${tab}-tab`).classList.add('active');
            },

            calculateAvailableHeight() {
                const header = document.getElementById('compact-header');
                const nav = document.getElementById('mobile-nav');
                
                if (!header || !nav) return '100%';
                
                const headerHeight = header.offsetHeight;
                const navHeight = nav.offsetHeight;
                
                return `calc(100% - ${headerHeight + navHeight}px)`;
            },

            updateMainContentHeight() {
                if (!isMobile) return;
                
                const mainContent = document.getElementById('main-content');
                if (mainContent) {
                    mainContent.style.height = this.calculateAvailableHeight();
                }
            },
            
            shortenDistrictName(district) {
                if (!district) return '';
                const match = district.match(/^([^(]+)/);
                return match ? match[0].trim() : district;
            },
            
            getNearestValue(value, valuesArray, direction = 0) {
                if (!valuesArray || valuesArray.length === 0) return value;
                
                let nearest = valuesArray[0];
                let minDiff = Math.abs(value - nearest);
                
                for (const val of valuesArray) {
                    const diff = Math.abs(value - val);
                    if (diff < minDiff) {
                        minDiff = diff;
                        nearest = val;
                    }
                }
                
                if (direction > 0) {
                    const greaterValues = valuesArray.filter(v => v > value);
                    return greaterValues.length > 0 ? Math.min(...greaterValues) : nearest;
                } else if (direction < 0) {
                    const lesserValues = valuesArray.filter(v => v < value);
                    return lesserValues.length > 0 ? Math.max(...lesserValues) : nearest;
                }
                
                return nearest;
            }
        };

        // ============================================================================
        // МОДУЛЬ 1: ЗАГРУЗКА ДАННЫХ
        // ============================================================================
        const DataModule = {
            async loadData() {
                return new Promise((resolve, reject) => {
                    const { SHEET_ID, SHEET_NAME } = CONFIG.GOOGLE_SHEETS;
                    const callbackName = `handleSheetData_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:${callbackName}&sheet=${SHEET_NAME}`;
                    
                    window[callbackName] = function(response) {
                        try {
                            delete window[callbackName];
                            document.getElementById('jsonp-script')?.remove();
                            
                            const data = this.parseGoogleSheetsResponse(response);
                            
                            Utils.showNotification(`Загружено зданий: ${data.length}`, 'success');
                            
                            resolve(data);
                        } catch (error) {
                            console.error('Ошибка обработки данных:', error);
                            Utils.showNotification('Ошибка обработки данных', 'error');
                            reject(error);
                        }
                    }.bind(this);

                    const script = document.createElement('script');
                    script.id = 'jsonp-script';
                    script.src = url;
                    script.onerror = () => {
                        script.remove();
                        Utils.showNotification('Ошибка загрузки данных', 'error');
                        reject(new Error('Ошибка загрузки данных'));
                    };
                    
                    document.head.appendChild(script);
                });
            },

            async loadContacts() {
                return new Promise((resolve, reject) => {
                    const { SHEET_ID, CONTACTS_SHEET_NAME } = CONFIG.GOOGLE_SHEETS;
                    const callbackName = `handleContactsData_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:${callbackName}&sheet=${CONTACTS_SHEET_NAME}`;
                    
                    window[callbackName] = function(response) {
                        try {
                            delete window[callbackName];
                            document.getElementById('jsonp-contacts-script')?.remove();
                            
                            const data = this.parseContactsResponse(response);
                            
                            // console.log('Контакты загружены из Google Sheets:', data);
                            
                            // Проверяем, есть ли хотя бы один контакт
                            if (!data.telegram && !data.email) {
                                console.log('Контакты не найдены в Google Sheets');
                                Utils.showNotification('Контакты не найдены в таблице', 'warning');
                            } else {
                                Utils.showNotification('Контакты загружены', 'success');
                            }
                            
                            resolve(data);
                        } catch (error) {
                            console.error('Ошибка обработки контактов:', error);
                            // Возвращаем пустые контакты - ТОЛЬКО из Google Sheets
                            resolve({
                                telegram: null,
                                email: null
                            });
                        }
                    }.bind(this);

                    const script = document.createElement('script');
                    script.id = 'jsonp-contacts-script';
                    script.src = url;
                    script.onerror = () => {
                        script.remove();
                        // Если не удалось загрузить, возвращаем пустые контакты
                        console.log('Не удалось загрузить контакты из Google Sheets');
                        resolve({
                            telegram: null,
                            email: null
                        });
                    };
                    
                    document.head.appendChild(script);
                });
            },

            parseGoogleSheetsResponse(response) {
                try {
                    const data = response;
                    const rows = data.table.rows || [];
                    const buildings = [];
                    
                    const floorsSet = new Set();
                    const flatsPerEntranceSet = new Set();
                    
                    rows.forEach((row, index) => {
                        const cells = row.c;
                        
                        const latStr = cells[1]?.v;
                        const lngStr = cells[2]?.v;
                        
                        const lat = latStr ? parseFloat(latStr.toString().replace(',', '.')) : 0;
                        const lng = lngStr ? parseFloat(lngStr.toString().replace(',', '.')) : 0;
                        
                        const building = {
                            originalIndex: index,
                            address: cells[0]?.v || '',
                            lat: lat,
                            lng: lng,
                            status: cells[3]?.v || '',
                            district: cells[4]?.v || '',
                            entrances: parseInt(cells[5]?.v) || 0,
                            floors: parseInt(cells[6]?.v) || 0,
                            flats: parseInt(cells[7]?.v) || 0,
                            flatsPerEntrance: parseInt(cells[8]?.v) || 0
                        };
                        
                        if (building.lat && building.lng && building.address) {
                            buildings.push(building);
                            
                            if (building.floors > 0) floorsSet.add(building.floors);
                            if (building.flatsPerEntrance > 0) flatsPerEntranceSet.add(building.flatsPerEntrance);
                        }
                    });
                    
                    availableValues.floors = Array.from(floorsSet).sort((a, b) => a - b);
                    availableValues.flatsPerEntrance = Array.from(flatsPerEntranceSet).sort((a, b) => a - b);
                    
                    return buildings;
                    
                } catch (error) {
                    console.error('Ошибка парсинга:', error);
                    throw error;
                }
            },

            parseContactsResponse(response) {
                try {
                    const data = response;
                    const rows = data.table.rows || [];
                    const contactsData = {
                        telegram: null,
                        email: null
                    };
                    
                    // console.log('Парсим контакты из Google Sheets, строк:', rows.length);
                    
                    rows.forEach((row, index) => {
                        const cells = row.c;
                        if (cells && cells.length >= 2) {
                            const label = cells[0]?.v?.toString().toLowerCase().trim();
                            const value = cells[1]?.v?.toString().trim();
                            
                            // console.log(`Строка ${index}: label="${label}", value="${value}"`);
                            
                            if (label && value) {
                                if (label.includes('telegram') || label.includes('телеграм')) {
                                    contactsData.telegram = value;
                                    // console.log('Найден Telegram:', value);
                                } else if (label.includes('email') || label.includes('почта') || label.includes('e-mail')) {
                                    contactsData.email = value;
                                    // console.log('Найден Email:', value);
                                }
                            }
                        }
                    });
                    
                    // НИКАКИХ значений по умолчанию! Только из Google Sheets
                    // console.log('Итоговые контакты из Google Sheets:', contactsData);
                    return contactsData;
                    
                } catch (error) {
                    console.error('Ошибка парсинга контактов:', error);
                    // Возвращаем пустые контакты
                    return {
                        telegram: null,
                        email: null
                    };
                }
            }
        };

        // ============================================================================
        // МОДУЛЬ 2: КАРТА
        // ============================================================================
        const MapModule = {
            markerModeActive: false,
            dragModeActive: false,
            newMarkerPlacemark: null,
            currentClickHandler: null,
            currentEscHandler: null,
            userMarkers: [],
            userMarkersCollection: null,
            
            initUserMarkers: function() {
                if (!map) return;
                
                this.userMarkersCollection = new ymaps.GeoObjectCollection(null, {
                    preset: 'islands#redStretchyIcon',
                    draggable: false,
                    balloonOffset: [0, -40],
                    zIndex: 2000,
                    clusterize: false,
                    cursor: 'pointer'
                });
                
                map.geoObjects.add(this.userMarkersCollection);
                this.loadUserMarkers();
                this.bringUserMarkersToFront();
            },

            loadUserMarkers: function() {
                try {
                    const savedMarkers = localStorage.getItem('pr-market-user-markers');
                    if (savedMarkers) {
                        this.userMarkers = JSON.parse(savedMarkers);
                        this.renderUserMarkers();
                    }
                } catch (e) {
                    console.error('Ошибка загрузки меток:', e);
                    this.userMarkers = [];
                }
            },
            
            saveUserMarkers: function() {
                try {
                    localStorage.setItem('pr-market-user-markers', JSON.stringify(this.userMarkers));
                } catch (e) {
                    console.error('Ошибка сохранения меток:', e);
                }
            },
            
            closeCurrentMarkerBalloon: function() {
                if (map && map.balloon && map.balloon.isOpen()) {
                    map.balloon.close();
                }
            },

            renderUserMarkers: function() {
                if (!this.userMarkersCollection || !map) return;
                
                this.userMarkersCollection.removeAll();
                
                this.userMarkers.forEach((marker, index) => {
                    const placemark = this.createPlacemark(marker, index);
                    this.userMarkersCollection.add(placemark);
                });
                
                this.bringUserMarkersToFront();
            },

            createPlacemark: function(marker, index) {
                const iconText = marker.text ? 
                    (marker.text.length > 6 ? marker.text.substring(0, 6) + '..' : marker.text) : 
                    '★';
                
                const placemark = new ymaps.Placemark(
                    [marker.lat, marker.lng],
                    {
                        iconContent: iconText,
                        hintContent: `Метка: ${marker.text || 'Без названия'}`,
                        balloonContent: this.createMarkerBalloonContent(marker, index)
                    },
                    {
                        preset: "islands#redStretchyIcon",
                        draggable: this.dragModeActive,
                        openBalloonOnClick: true,
                        hideIconOnBalloonOpen: false,
                        balloonOffset: [0, -40],
                        zIndex: 2000 + index,
                        cursor: this.dragModeActive ? 'move' : 'pointer',
                        hasBalloon: true,
                        hasHint: true,
                        balloonAutoPan: true,
                        balloonPanelMaxMapArea: 0,
                        balloonCloseButton: false
                    }
                );
                
                placemark.options.set({
                    className: 'user-marker'
                });
                
                placemark.events.add('dragend', (e) => {
                    if (!this.dragModeActive) return;
                    
                    const coords = placemark.geometry.getCoordinates();
                    this.userMarkers[index] = {
                        ...this.userMarkers[index],
                        lat: coords[0],
                        lng: coords[1]
                    };
                    this.saveUserMarkers();
                    Utils.showNotification('Метка перемещена', 'info');
                });
                
                placemark.events.add('balloonopen', () => {
                    placemark.options.set('zIndex', 3000);
                });
                
                placemark.events.add('balloonclose', () => {
                    placemark.options.set('zIndex', 2000 + index);
                });
                
                return placemark;
            },

            createMarkerBalloonContent: function(marker, index) {
                return `
                    <div class="marker-balloon">
                        <div class="marker-balloon-header">
                            <span><i class="fas fa-map-marker-alt"></i> Пользовательская метка</span>
                            <button class="marker-balloon-close-btn" title="Закрыть" onclick="MapModule.closeCurrentMarkerBalloon()">×</button>
                        </div>
                        <div class="marker-balloon-content">
                            <div class="marker-info">
                                <div><strong>Текст:</strong> ${Utils.escapeHtml(marker.text || 'Не указан')}</div>
                                <div><strong>Координаты:</strong> ${marker.lat.toFixed(6)}, ${marker.lng.toFixed(6)}</div>
                                <div><strong>Дата создания:</strong> ${new Date(marker.createdAt).toLocaleString()}</div>
                            </div>
                            <div class="marker-actions">
                                <button class="marker-action-btn edit-btn" onclick="MapModule.editMarker(${index})">
                                    <i class="fas fa-edit"></i> Переименовать
                                </button>
                                <button class="marker-action-btn delete-btn" onclick="MapModule.deleteMarker(${index})">
                                    <i class="fas fa-trash-alt"></i> Удалить метку
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            editMarker: function(index) {
                const marker = this.userMarkers[index];
                const newText = prompt('Введите новый текст для метки:', marker.text || '');
                
                if (newText !== null) {
                    this.userMarkers[index] = {
                        ...marker,
                        text: newText
                    };
                    this.saveUserMarkers();
                    this.renderUserMarkers();
                    Utils.showNotification('Метка обновлена', 'success');
                    this.closeCurrentMarkerBalloon();
                }
            },
            
            deleteMarker: function(index) {
                if (confirm('Удалить эту метку?')) {
                    this.userMarkers.splice(index, 1);
                    this.saveUserMarkers();
                    this.renderUserMarkers();
                    this.closeCurrentMarkerBalloon();
                    Utils.showNotification('Метка удалена', 'success');
                }
            },
            
            deleteAllMarkers: function() {
                if (this.userMarkers.length === 0) {
                    Utils.showNotification('Нет меток для удаления', 'info');
                    return;
                }
                
                if (confirm(`Удалить все метки (${this.userMarkers.length})?`)) {
                    this.userMarkers = [];
                    this.saveUserMarkers();
                    this.renderUserMarkers();
                    Utils.showNotification('Все метки удалены', 'success');
                }
            },
            
            enterAddMarkerMode: function() {
                if (this.markerModeActive || this.dragModeActive) return;

                // Очистка старых обработчиков
                if (this.currentClickHandler) {
                    map.events.remove('click', this.currentClickHandler);
                    this.currentClickHandler = null;
                }
                if (this.currentEscHandler) {
                    document.removeEventListener('keydown', this.currentEscHandler);
                    this.currentEscHandler = null;
                }

                this.markerModeActive = true;
                Utils.showNotification('Кликните на карту, чтобы добавить метку. ESC для отмены.', 'info');

                const mapContainerId = isMobile ? 'map-container' : 'desktop-map-container';
                const mapContainer = document.getElementById(mapContainerId);
                
                if (!mapContainer || !map) {
                    this.exitAddMarkerMode();
                    return;
                }

                setTimeout(() => {
                    const allMapElements = mapContainer.querySelectorAll('*');
                    allMapElements.forEach(el => {
                        el.style.cursor = 'crosshair';
                    });
                    mapContainer.style.cursor = 'crosshair';
                    document.body.classList.add('map-crosshair-mode');
                }, 100);

                const clickHandler = (e) => {
                    const coords = e.get('coords');
                    this.createNewMarker(coords);
                    this.exitAddMarkerMode();
                };
                
                this.currentClickHandler = clickHandler;
                map.events.add('click', clickHandler);

                const escHandler = (e) => {
                    if (e.keyCode === 27) {
                        this.exitAddMarkerMode();
                        Utils.showNotification('Режим добавления метки отменен', 'info');
                    }
                };
                document.addEventListener('keydown', escHandler);
                this.currentEscHandler = escHandler;
            },

            exitAddMarkerMode: function() {
                if (!this.markerModeActive) return;
                
                this.markerModeActive = false;
                
                const mapContainerId = isMobile ? 'map-container' : 'desktop-map-container';
                const mapContainer = document.getElementById(mapContainerId);
                if (mapContainer) {
                    const allMapElements = mapContainer.querySelectorAll('*');
                    allMapElements.forEach(el => {
                        el.style.cursor = '';
                    });
                    mapContainer.style.cursor = '';
                    document.body.classList.remove('map-crosshair-mode');
                }
                
                if (this.currentClickHandler) {
                    map.events.remove('click', this.currentClickHandler);
                    this.currentClickHandler = null;
                }
                
                if (this.currentEscHandler) {
                    document.removeEventListener('keydown', this.currentEscHandler);
                    this.currentEscHandler = null;
                }
            },

            toggleDragMode: function() {
                this.dragModeActive = !this.dragModeActive;
                
                if (this.dragModeActive) {
                    Utils.showNotification('Режим перетаскивания включен. Перетаскивайте метки мышью.', 'info');
                    document.body.classList.add('map-drag-mode');
                } else {
                    Utils.showNotification('Режим перетаскивания выключен.', 'info');
                    document.body.classList.remove('map-drag-mode');
                }
                
                // Обновляем все метки
                this.userMarkersCollection.each((placemark) => {
                    placemark.options.set('draggable', this.dragModeActive);
                    placemark.options.set('cursor', this.dragModeActive ? 'move' : 'pointer');
                });
                
                // Обновляем кнопку в панели управления
                const dragBtn = document.querySelector('#markers-control-drag-btn');
                if (dragBtn) {
                    if (this.dragModeActive) {
                        dragBtn.classList.add('active');
                        dragBtn.innerHTML = '<i class="fas fa-hand-paper"></i> Выкл. перетаскивание';
                    } else {
                        dragBtn.classList.remove('active');
                        dragBtn.innerHTML = '<i class="fas fa-hand-point-up"></i> Вкл. перетаскивание';
                    }
                }
            },

            createNewMarker: function(coords) {
                const markerText = prompt('Введите текст для метки:', 'Новая метка');
                if (markerText === null) return;
                
                const newMarker = {
                    id: Date.now(),
                    lat: coords[0],
                    lng: coords[1],
                    text: markerText,
                    createdAt: new Date().toISOString()
                };
                
                this.userMarkers.push(newMarker);
                this.saveUserMarkers();
                this.renderUserMarkers();
                
                Utils.showNotification(`Метка "${markerText}" добавлена`, 'success');
            },

            bringUserMarkersToFront: function() {
                if (!map || !this.userMarkersCollection) return;
                map.geoObjects.remove(this.userMarkersCollection);
                map.geoObjects.add(this.userMarkersCollection);
                map.container.fitToViewport();
            },

            showMarkersControlPanel: function() {
                // console.log('showMarkersControlPanel вызвана');
                
                if (!map) {
                    console.error('Карта не инициализирована');
                    return;
                }
                
                const markerCount = this.userMarkers.length;
                
                // Проверяем, существует ли уже панель
                let panel = document.getElementById('markers-floating-panel');
                
                if (panel) {
                    // Если панель существует, переключаем видимость
                    panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
                    
                    // Если показываем панель, обновляем ее содержимое
                    if (panel.style.display !== 'none') {
                        this.updateMarkersPanelContent(panel);
                    }
                    return;
                }
                
                // Создаем новую панель
                panel = document.createElement('div');
                panel.id = 'markers-floating-panel';
                panel.className = 'markers-floating-panel';
                panel.style.cssText = `
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                    overflow: hidden;
                    width: 350px;
                    max-width: 350px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    z-index: 1000;
                    display: flex;
                    flex-direction: column;
                    cursor: move;
                    user-select: none;
                `;
                
                const panelContent = `
                    <div class="markers-control-header">
                        <h3><i class="fas fa-map-marker-alt"></i> Управление метками</h3>
                        <button class="markers-control-close-btn" title="Закрыть">×</button>
                    </div>
                    <div class="markers-control-content">
                        <div class="markers-control-stats">
                            <div class="marker-stat">
                                <span class="marker-stat-label">Всего меток:</span>
                                <span class="marker-stat-value" id="marker-total-count">${markerCount}</span>
                            </div>
                            <div class="marker-stat">
                                <span class="marker-stat-label">Последняя:</span>
                                <span class="marker-stat-value" id="marker-last-date">${markerCount > 0 ? 
                                    new Date(this.userMarkers[markerCount-1].createdAt).toLocaleDateString() : 
                                    '—'}</span>
                            </div>
                        </div>
                        <div class="markers-control-actions">
                            <button class="markers-control-btn add-btn" id="markers-control-add-btn">
                                <i class="fas fa-plus"></i> Добавить новую метку
                            </button>
                            <button class="markers-control-btn drag-btn ${this.dragModeActive ? 'active' : ''}" id="markers-control-drag-btn">
                                ${this.dragModeActive ? '<i class="fas fa-hand-paper"></i> Выкл. перетаскивание' : '<i class="fas fa-hand-point-up"></i> Вкл. перетаскивание'}
                            </button>
                            ${markerCount > 0 ? `
                                <button class="markers-control-btn delete-all-btn" id="markers-control-delete-all-btn">
                                    <i class="fas fa-trash-alt"></i> Удалить все метки
                                </button>
                            ` : ''}
                        </div>
                        ${markerCount > 0 ? `
                            <div class="markers-list-preview">
                                <h4>Последние метки:</h4>
                                <ul class="markers-preview-list" id="markers-preview-list">
                                    ${this.userMarkers.slice().reverse().map((marker, i) => `
                                        <li onclick="MapModule.focusOnMarker(${this.userMarkers.indexOf(marker)})">
                                            <span class="marker-preview-text" title="${Utils.escapeHtml(marker.text || 'Без названия')}">
                                                ${Utils.escapeHtml(marker.text || 'Без названия')}
                                            </span>
                                            <span class="marker-preview-date">${new Date(marker.createdAt).toLocaleDateString()}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                panel.innerHTML = panelContent;
                
                // Добавляем панель в body
                document.body.appendChild(panel);
                
                // Настраиваем обработчики событий
                const closeBtn = panel.querySelector('.markers-control-close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        panel.style.display = 'none';
                    });
                }
                
                const addBtn = panel.querySelector('#markers-control-add-btn');
                if (addBtn) {
                    addBtn.addEventListener('click', () => {
                        this.enterAddMarkerMode();
                        panel.style.display = 'none';
                    });
                }
                
                const dragBtn = panel.querySelector('#markers-control-drag-btn');
                if (dragBtn) {
                    dragBtn.addEventListener('click', () => {
                        this.toggleDragMode();
                        this.updateMarkersPanelContent(panel);
                    });
                }
                
                const deleteAllBtn = panel.querySelector('#markers-control-delete-all-btn');
                if (deleteAllBtn) {
                    deleteAllBtn.addEventListener('click', () => {
                        this.deleteAllMarkers();
                        panel.style.display = 'none';
                    });
                }
                
                // Делаем панель перетаскиваемой
                this.makePanelDraggable(panel);
                
                // console.log('Панель управления метками создана');
            },

            updateMarkersPanelContent: function(panel) {
                const markerCount = this.userMarkers.length;
                
                // Обновляем статистику
                const totalCount = panel.querySelector('#marker-total-count');
                const lastDate = panel.querySelector('#marker-last-date');
                const previewList = panel.querySelector('#markers-preview-list');
                const dragBtn = panel.querySelector('#markers-control-drag-btn');
                
                if (totalCount) totalCount.textContent = markerCount;
                if (lastDate) {
                    lastDate.textContent = markerCount > 0 ? 
                        new Date(this.userMarkers[markerCount-1].createdAt).toLocaleDateString() : 
                        '—';
                }
                
                if (dragBtn) {
                    if (this.dragModeActive) {
                        dragBtn.classList.add('active');
                        dragBtn.innerHTML = '<i class="fas fa-hand-paper"></i> Выкл. перетаскивание';
                    } else {
                        dragBtn.classList.remove('active');
                        dragBtn.innerHTML = '<i class="fas fa-hand-point-up"></i> Вкл. перетаскивание';
                    }
                }
                
                // Обновляем список превью
                if (previewList) {
                    if (markerCount > 0) {
                        previewList.innerHTML = this.userMarkers.slice().reverse().map((marker, i) => `
                            <li onclick="MapModule.focusOnMarker(${this.userMarkers.indexOf(marker)})">
                                <span class="marker-preview-text" title="${Utils.escapeHtml(marker.text || 'Без названия')}">
                                    ${Utils.escapeHtml(marker.text || 'Без названия')}
                                </span>
                                <span class="marker-preview-date">${new Date(marker.createdAt).toLocaleDateString()}</span>
                            </li>
                        `).join('');
                    } else {
                        previewList.innerHTML = '<li style="color: #6b7280; font-style: italic;">Нет меток</li>';
                    }
                }
            },

            makePanelDraggable: function(panel) {
                const header = panel.querySelector('.markers-control-header');
                if (!header) return;
                
                let isDragging = false;
                let startX, startY, initialLeft, initialTop;
                
                const mouseDownHandler = (e) => {
                    // Не начинаем перетаскивание, если кликнули на кнопку закрытия
                    if (e.target.classList.contains('markers-control-close-btn')) {
                        return;
                    }
                    
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    
                    // Получаем текущие координаты панели
                    const rect = panel.getBoundingClientRect();
                    initialLeft = rect.left;
                    initialTop = rect.top;
                    
                    panel.style.cursor = 'grabbing';
                    panel.style.userSelect = 'none';
                    
                    // Добавляем обработчики для движения и отпускания
                    document.addEventListener('mousemove', mouseMoveHandler);
                    document.addEventListener('mouseup', mouseUpHandler);
                };
                
                const mouseMoveHandler = (e) => {
                    if (!isDragging) return;
                    
                    e.preventDefault();
                    
                    // Вычисляем смещение
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    // Вычисляем новые координаты
                    let newLeft = initialLeft + deltaX;
                    let newTop = initialTop + deltaY;
                    
                    // Ограничиваем перемещение в пределах окна
                    const maxX = window.innerWidth - panel.offsetWidth;
                    const maxY = window.innerHeight - panel.offsetHeight;
                    
                    newLeft = Math.max(0, Math.min(newLeft, maxX));
                    newTop = Math.max(0, Math.min(newTop, maxY));
                    
                    // Применяем новые координаты
                    panel.style.left = newLeft + 'px';
                    panel.style.top = newTop + 'px';
                    panel.style.right = 'auto';
                    panel.style.bottom = 'auto';
                };
                
                const mouseUpHandler = () => {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    panel.style.cursor = 'move';
                    panel.style.userSelect = 'auto';
                    
                    // Удаляем обработчики
                    document.removeEventListener('mousemove', mouseMoveHandler);
                    document.removeEventListener('mouseup', mouseUpHandler);
                };
                
                // Добавляем обработчик для мыши
                header.addEventListener('mousedown', mouseDownHandler);
                
                // Для тач-устройств
                header.addEventListener('touchstart', (e) => {
                    if (e.target.classList.contains('markers-control-close-btn')) return;
                    
                    isDragging = true;
                    const touch = e.touches[0];
                    startX = touch.clientX;
                    startY = touch.clientY;
                    
                    const rect = panel.getBoundingClientRect();
                    initialLeft = rect.left;
                    initialTop = rect.top;
                    
                    panel.style.cursor = 'grabbing';
                    panel.style.userSelect = 'none';
                    
                    e.preventDefault();
                }, { passive: false });
                
                header.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - startX;
                    const deltaY = touch.clientY - startY;
                    
                    let newLeft = initialLeft + deltaX;
                    let newTop = initialTop + deltaY;
                    
                    const maxX = window.innerWidth - panel.offsetWidth;
                    const maxY = window.innerHeight - panel.offsetHeight;
                    
                    newLeft = Math.max(0, Math.min(newLeft, maxX));
                    newTop = Math.max(0, Math.min(newTop, maxY));
                    
                    panel.style.left = newLeft + 'px';
                    panel.style.top = newTop + 'px';
                    panel.style.right = 'auto';
                    panel.style.bottom = 'auto';
                    
                    e.preventDefault();
                }, { passive: false });
                
                header.addEventListener('touchend', () => {
                    isDragging = false;
                    panel.style.cursor = 'move';
                    panel.style.userSelect = 'auto';
                });
            },

            focusOnMarker: function(index) {
                const marker = this.userMarkers[index];
                if (!marker) return;
                
                if (map) {
                    map.setCenter([marker.lat, marker.lng], 17);
                    
                    if (map.balloon && map.balloon.isOpen()) {
                        map.balloon.close();
                    }
                    
                    setTimeout(() => {
                        const placemarks = this.userMarkersCollection.getObjects();
                        if (placemarks[index]) {
                            placemarks[index].balloon.open({
                                closeButton: false
                            });
                        }
                    }, 300);
                }
            },
            
            async initMap() {
                if (map && map.destroy) {
                    try {
                        map.destroy();
                    } catch (e) {
                        // console.log('Карта уже уничтожена');
                    }
                    map = null;
                    objectManager = null;
                    this.userMarkersCollection = null;
                }
                
                return new Promise((resolve, reject) => {
                    ymaps.ready(() => {
                        try {
                            const mapContainerId = isMobile ? 'map-container' : 'desktop-map-container';
                            const container = document.getElementById(mapContainerId);
                            if (container) {
                                container.innerHTML = '';
                            }
                            
                            map = new ymaps.Map(mapContainerId, {
                                center: CONFIG.MAP.CENTER,
                                zoom: CONFIG.MAP.ZOOM,
                                controls: ['zoomControl', 'trafficControl']
                            });
                            
                            const ClusterBalloonLayout = ymaps.templateLayoutFactory.createClass(
                                '<div class="cluster-balloon">' +
                                    '<div class="cluster-balloon__content"></div>' +
                                '</div>',
                                {
                                    build: function() {
                                        ClusterBalloonLayout.superclass.build.call(this);
                                        
                                        const cluster = this.getData().object;
                                        const geoObjects = cluster.properties.geoObjects || [];
                                        const clusterPosition = cluster.geometry.coordinates;
                                        
                                        const sortedObjects = geoObjects.sort((a, b) => {
                                            if (a.properties.status === 'Свободно' && b.properties.status !== 'Свободно') return -1;
                                            if (a.properties.status !== 'Свободно' && b.properties.status === 'Свободно') return 1;
                                            return (a.properties.address || '').localeCompare(b.properties.address || '');
                                        });
                                        
                                        const maxRows = 4;
                                        const displayedObjects = sortedObjects.slice(0, maxRows);
                                        const hasMore = geoObjects.length > maxRows;
                                        const remainingCount = geoObjects.length - maxRows;
                                        
                                        let tableHtml = '';
                                        
                                        displayedObjects.forEach((obj) => {
                                            const address = obj.properties.address || '';
                                            const entrances = obj.properties.entrances || 0;
                                            const status = obj.properties.status || '';
                                            const statusClass = status === 'Свободно' ? 'free' : 'busy';
                                            
                                            tableHtml += `
                                                <tr>
                                                    <td class="address-cell">
                                                        <span class="address-status ${statusClass}"></span>
                                                        <span class="address-text">${Utils.escapeHtml(address)}</span>
                                                    </td>
                                                    <td class="stands-cell">
                                                        ${entrances}
                                                    </td>
                                                </tr>
                                            `;
                                        });
                                        
                                        if (hasMore) {
                                            tableHtml += `
                                                <tr>
                                                    <td colspan="2" class="more-buildings">
                                                        ...и ещё зданий: ${remainingCount}
                                                    </td>
                                                </tr>
                                            `;
                                        }
                                        
                                        const balloonHtml = `
                                            <div class="cluster-balloon-inner">
                                                <div class="cluster-header">
                                                    <div class="cluster-title">
                                                        Кластер: ${geoObjects.length} <i class="fas fa-building"></i>
                                                    </div>
                                                    <button class="cluster-close-btn" title="Закрыть">×</button>
                                                </div>
                                                <div class="cluster-addresses">
                                                    <table class="cluster-table">
                                                        <thead>
                                                            <tr>
                                                                <th>Адрес</th>
                                                                <th>Стендов</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>${tableHtml}</tbody>
                                                    </table>
                                                </div>
                                                <div class="cluster-footer">
                                                    <button class="hide-cluster-btn" id="cluster-hide-button">
                                                        <i class="fas fa-times"></i> Скрыть кластер
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                        
                                        const container = this.getElement().querySelector('.cluster-balloon__content');
                                        if (container) {
                                            container.innerHTML = balloonHtml;
                                            
                                            const closeButton = container.querySelector('.cluster-close-btn');
                                            if (closeButton) {
                                                closeButton.addEventListener('click', (e) => {
                                                    e.stopPropagation();
                                                    e.preventDefault();
                                                    const balloon = map.balloon;
                                                    if (balloon && balloon.isOpen()) {
                                                        balloon.close();
                                                    }
                                                });
                                            }
                                            
                                            const hideButton = container.querySelector('.hide-cluster-btn');
                                            if (hideButton) {
                                                hideButton.addEventListener('click', (e) => {
                                                    e.stopPropagation();
                                                    e.preventDefault();
                                                    const ids = geoObjects.map(obj => obj.properties.originalIndex).join(',');
                                                    handleHideCluster(ids);
                                                    const balloon = map.balloon;
                                                    if (balloon && balloon.isOpen()) {
                                                        balloon.close();
                                                    }
                                                    Utils.showNotification(`Скрыт кластер из ${geoObjects.length} объектов`, 'success');
                                                });
                                            }
                                        }
                                    },
                                    
                                    clear: function() {
                                        ClusterBalloonLayout.superclass.clear.call(this);
                                    }
                                }
                            );

                            objectManager = new ymaps.ObjectManager({
                                clusterize: true,
                                gridSize: 64,
                                clusterDisableClickZoom: true,
                                clusterBalloonContentLayout: ClusterBalloonLayout,
                                clusterBalloonPanelMaxMapArea: 0,
                                clusterBalloonAutoPan: true,
                                clusterBalloonOffset: [0, -20],
                                clusterBalloonShadow: false,
                                clusterBalloonMaxHeight: 500,
                                clusterBalloonMaxWidth: 400,
                                zIndex: 100
                            });
                            
                            objectManager.clusters.options.set({
                                preset: 'islands#invertedBlueClusterIcons',
                                clusterNumbers: [10, 30, 100],
                                balloonPane: 'balloon',
                                balloonPanelMaxMapArea: 0,
                                balloonOffset: [0, -20],
                                balloonShadow: false,
                                balloonAutoPan: true,
                                balloonAutoPanMargin: [80, 80, 80, 80],
                                balloonCloseButton: false,
                                zoomOnClick: false,
                                hideIconOnBalloonOpen: false,
                                zIndex: 100
                            });
                            
                            objectManager.objects.options.set({
                                preset: 'islands#circleIcon',
                                iconColor: '#FFFFFF',
                                balloonOffset: [0, -15],
                                zIndex: 100
                            });
                            
                            objectManager.objects.events.add('click', (e) => {
                                const objectId = e.get('objectId');
                                const object = objectManager.objects.getById(objectId);
                                if (object) {
                                    const building = object.properties;
                                    const statusClass = building.status === 'Свободно' ? 'status-free' : 'status-busy';
                                    const shortDistrict = Utils.shortenDistrictName(building.district);
                                    
                                    const balloonContent = `
                                        <div class="single-balloon">
                                            <div class="single-balloon-header">
                                                <div class="single-balloon-title">
                                                    <span class="status-indicator ${statusClass}" style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin: 0;"></span>
                                                    <span>${Utils.escapeHtml(building.address)}</span>
                                                </div>
                                                <button class="single-balloon-close-btn" title="Закрыть">×</button>
                                            </div>
                                            <div class="single-balloon-content">
                                                <div class="single-balloon-stats">
                                                    <div class="single-stat-item">
                                                        <div class="single-stat-label">РАЙОН</div>
                                                        <div class="single-stat-value"><i class="fas fa-city"></i> ${Utils.escapeHtml(shortDistrict)}</div>
                                                    </div>
                                                    <div class="single-stat-item">
                                                        <div class="single-stat-label">СТЕНДОВ</div>
                                                        <div class="single-stat-value stands"><i class="fas fa-columns"></i> ${building.entrances}</div>
                                                    </div>
                                                    <div class="single-stat-item">
                                                        <div class="single-stat-label">КВАРТИР</div>
                                                        <div class="single-stat-value"><i class="fas fa-door-closed"></i> ${building.flats}</div>
                                                    </div>
                                                    <div class="single-stat-item">
                                                        <div class="single-stat-label">ЭТАЖЕЙ</div>
                                                        <div class="single-stat-value"><i class="fas fa-building"></i> ${building.floors}</div>
                                                    </div>
                                                </div>
                                                <button class="single-balloon-hide-btn" onclick="handleHideBuilding(${building.originalIndex})">
                                                    <i class="fas fa-times"></i> Скрыть адрес
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                    
                                    const [lat, lng] = object.geometry.coordinates;
                                    map.balloon.open([lat, lng], balloonContent, {
                                        closeButton: false,
                                        autoPan: true,
                                        autoPanMargin: [80, 80, 80, 80],
                                        offset: [0, -15]
                                    });

                                    setTimeout(() => {
                                        const closeBtn = document.querySelector('.single-balloon-close-btn');
                                        if (closeBtn) {
                                            closeBtn.addEventListener('click', (e) => {
                                                e.stopPropagation();
                                                e.preventDefault();
                                                map.balloon.close();
                                            });
                                        }
                                    }, 50);
                                }
                            });
                            
                            objectManager.clusters.events.add('balloonopen', (e) => {
                                const cluster = e.get('target');
                                if (cluster && map) {
                                    setTimeout(() => {
                                        map.container.fitToViewport();
                                    }, 50);
                                }
                            });
                            
                            // Инициализация кнопки управления метками
                            const markersControl = new ymaps.control.Button({
                                data: {
                                    content: "<i class='fas fa-map-marker-alt'></i> Метки",
                                    title: "Управление пользовательскими метками"
                                },
                                options: {
                                    selectOnClick: false,
                                    maxWidth: 120,
                                    float: 'right',
                                    floatIndex: 200
                                }
                            });

                            markersControl.events.add('click', () => {
                                // console.log('Кнопка "<i class="fas fa-map-marker-alt"></i> Метки" нажата');
                                
                                if (!map) {
                                    console.error('Карта не инициализирована');
                                    return;
                                }
                                
                                // Закрываем все открытые балуны
                                if (map.balloon && map.balloon.isOpen()) {
                                    map.balloon.close();
                                }
                                
                                // Показываем плавающую панель
                                this.showMarkersControlPanel();
                            });

                            const addMarkerButton = new ymaps.control.Button({
                                data: {
                                    content: "<i class='fas fa-plus'></i> Метка",
                                    title: "Добавить метку на карту"
                                },
                                options: {
                                    selectOnClick: false,
                                    maxWidth: 100,
                                    float: 'right',
                                    floatIndex: 190,
                                    right: 120
                                }
                            });
                            
                            addMarkerButton.events.add('click', () => {
                                this.enterAddMarkerMode();
                            });
                            
                            map.controls.add(markersControl);
                            map.controls.add(addMarkerButton);
                            
                            map.geoObjects.add(objectManager);
                            
                            this.initUserMarkers();
                            
                            map.events.add('sizechange', () => {
                                if (map.balloon && map.balloon.isOpen()) {
                                    map.container.fitToViewport();
                                }
                            });
                            
                            resolve(map);
                            
                        } catch (error) {
                            reject(error);
                        }
                    });
                });
            },

            renderBuildings(buildings) {
                if (!objectManager) return;
                
                objectManager.removeAll();
                
                const features = buildings.map(building => {
                    const lat = building.lat;
                    const lng = building.lng;
                    
                    return {
                        id: building.originalIndex,
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [lat, lng]
                        },
                        properties: {
                            ...building
                        },
                        options: {
                            preset: building.status === 'Свободно' ? 
                                'islands#greenCircleIcon' : 'islands#redCircleIcon',
                            iconColor: building.status === 'Свободно' ? '#10b981' : '#ef4444',
                            balloonAutoPan: true,
                            balloonOffset: [0, -20],
                            zIndex: 100
                        }
                    };
                });
                
                objectManager.add(features);
            }
        };

        // ============================================================================
        // МОДУЛЬ 3: ИСТОРИЯ ДЕЙСТВИЙ (UNDO)
        // ============================================================================
        const HistoryModule = {
            MAX_HISTORY_SIZE: 20,
            MIN_ACTION_INTERVAL: 500,
            
            history: [],
            currentIndex: -1,
            lastActionTime: 0,
            
            ACTION_TYPES: {
                FILTER_CHANGE: 'filter_change',
                HIDE_BUILDING: 'hide_building',
                HIDE_CLUSTER: 'hide_cluster',
                STATUS_FILTER: 'status_filter',
                DISTRICT_FILTER: 'district_filter',
                PERCENTAGE_CHANGE: 'percentage_change'
            },
            
            init() {
                this.saveInitialState();
                this.createUndoButton();
            },
            
            saveInitialState() {
                const initialState = this.captureState('initial', this.ACTION_TYPES.FILTER_CHANGE);
                this.history = [initialState];
                this.currentIndex = 0;
                this.updateUndoButton();
            },
            
            captureState(description, type) {
                return {
                    timestamp: Date.now(),
                    description: description,
                    type: type,
                    data: {
                        filters: {
                            status: Array.from(activeFilters.status),
                            district: Array.from(activeFilters.district),
                            floors: {...activeFilters.floors},
                            flatsPerEntrance: {...activeFilters.flatsPerEntrance}
                        },
                        percentage: currentPercentage,
                        hiddenBuildings: Array.from(hiddenBuildings)
                    }
                };
            },
            
            saveFilterChange(description, filterType) {
                const now = Date.now();
                
                if (now - this.lastActionTime < this.MIN_ACTION_INTERVAL) {
                    return;
                }
                
                this.lastActionTime = now;
                
                const state = this.captureState(description, filterType || this.ACTION_TYPES.FILTER_CHANGE);
                this.addToHistory(state);
            },
            
            saveHideBuilding(buildingId, buildingAddress) {
                const state = this.captureState(`Скрыт: ${buildingAddress}`, this.ACTION_TYPES.HIDE_BUILDING);
                this.addToHistory(state);
            },
            
            saveHideCluster(buildingIds, count) {
                const state = this.captureState(`Скрыт кластер (${count} зданий)`, this.ACTION_TYPES.HIDE_CLUSTER);
                this.addToHistory(state);
            },
            
            addToHistory(state) {
                if (this.currentIndex < this.history.length - 1) {
                    this.history = this.history.slice(0, this.currentIndex + 1);
                }
                
                this.history.push(state);
                this.currentIndex++;
                
                if (this.history.length > this.MAX_HISTORY_SIZE) {
                    this.history.shift();
                    this.currentIndex--;
                }
                
                this.updateUndoButton();
            },
            
            undo() {
                if (this.currentIndex <= 0) {
                    Utils.showNotification('Нет действий для отмены', 'info');
                    return false;
                }
                
                const stateToUndo = this.history[this.currentIndex];
                const previousState = this.history[this.currentIndex - 1];
                
                this.restoreState(previousState, stateToUndo);
                
                this.currentIndex--;
                this.updateUndoButton();
                
                Utils.showNotification(`Отменено: ${stateToUndo.description}`, 'success');
                return true;
            },
            
            restoreState(targetState, stateToUndo) {
                if (targetState.data.filters) {
                    activeFilters.status = new Set(targetState.data.filters.status);
                    activeFilters.district = new Set(targetState.data.filters.district);
                    activeFilters.floors = {...targetState.data.filters.floors};
                    activeFilters.flatsPerEntrance = {...targetState.data.filters.flatsPerEntrance};
                }
                
                if (targetState.data.percentage !== undefined) {
                    currentPercentage = targetState.data.percentage;
                }
                
                if (targetState.data.hiddenBuildings) {
                    hiddenBuildings = new Set(targetState.data.hiddenBuildings);
                }
                
                this.updateUIFromState(targetState);
                
                FilterModule.applyFilters();
            },
            
            updateUIFromState(state) {
                this.updateFilterCheckboxes('status-filter', state.data.filters.status);
                this.updateFilterCheckboxes('desktop-status-filter', state.data.filters.status);
                this.updateFilterCheckboxes('district-filter', state.data.filters.district);
                this.updateFilterCheckboxes('desktop-district-filter', state.data.filters.district);
                
                this.updateRangeInputs(state.data.filters.floors, state.data.filters.flatsPerEntrance);
                
                this.updatePercentage(state.data.percentage);
            },
            
            updateFilterCheckboxes(containerId, filterValues) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = filterValues.includes(checkbox.value);
                });
            },
            
            updateRangeInputs(floors, flats) {
                const ids = [
                    ['floors-min', 'desktop-floors-min'],
                    ['floors-max', 'desktop-floors-max'],
                    ['flats-min', 'desktop-flats-min'],
                    ['flats-max', 'desktop-flats-max']
                ];
                
                const values = [floors.min, floors.max, flats.min, flats.max];
                
                ids.forEach((idGroup, index) => {
                    idGroup.forEach(id => {
                        const input = document.getElementById(id);
                        if (input) {
                            input.value = values[index] || '';
                        }
                    });
                });
            },
            
            updatePercentage(percentage) {
                const elements = [
                    { slider: 'mobile-percentage-slider', value: 'mobile-percentage-value' },
                    { slider: 'desktop-percentage-slider', value: 'desktop-percentage-value' }
                ];
                
                elements.forEach(el => {
                    const slider = document.getElementById(el.slider);
                    const valueDisplay = document.getElementById(el.value);
                    
                    if (slider) slider.value = percentage;
                    if (valueDisplay) valueDisplay.textContent = `${percentage}%`;
                });
            },
            
            createUndoButton() {
                const mobileHeader = document.getElementById('compact-header');
                if (mobileHeader) {
                    const undoBtn = document.createElement('button');
                    undoBtn.id = 'mobile-undo-btn';
                    undoBtn.className = 'mobile-undo-button';
                    undoBtn.innerHTML = '<i class="fas fa-undo"></i>';
                    undoBtn.title = 'Отменить последнее действие (Ctrl+Z)';
                    undoBtn.style.cssText = `
                        position: absolute;
                        right: 10px;
                        top: 10px;
                        width: 36px;
                        height: 36px;
                    `;
                    
                    undoBtn.addEventListener('click', () => this.undo());
                    mobileHeader.appendChild(undoBtn);
                }
                
                const desktopSidebar = document.getElementById('desktop-sidebar');
                if (desktopSidebar) {
                    const undoBtn = document.createElement('button');
                    undoBtn.id = 'desktop-undo-btn';
                    undoBtn.className = 'desktop-undo-button';
                    undoBtn.innerHTML = '<i class="fas fa-undo"></i>';
                    undoBtn.title = 'Отменить последнее действие (Ctrl+Z)';
                    undoBtn.style.cssText = `
                        position: absolute;
                        top: 1.25rem;
                        right: 4.5rem;
                        width: 40px;
                        height: 40px;
                    `;
                    
                    undoBtn.addEventListener('click', () => this.undo());
                    desktopSidebar.querySelector('.sidebar-header').appendChild(undoBtn);
                }
                
                const fullscreenHeader = document.getElementById('fullscreen-header');
                if (fullscreenHeader) {
                    const undoBtn = document.createElement('button');
                    undoBtn.id = 'fullscreen-undo-btn';
                    undoBtn.className = 'fullscreen-undo-button';
                    undoBtn.innerHTML = '<i class="fas fa-undo"></i>';
                    undoBtn.title = 'Отменить последнее действие (Ctrl+Z)';
                    undoBtn.style.cssText = `
                        position: absolute;
                        top: 1rem;
                        right: 4rem;
                        width: 32px;
                        height: 32px;
                    `;
                    
                    undoBtn.addEventListener('click', () => this.undo());
                    fullscreenHeader.querySelector('.fullscreen-header-title').appendChild(undoBtn);
                }
            },
            
            updateUndoButton() {
                const canUndo = this.currentIndex > 0;
                const buttons = [
                    'mobile-undo-btn',
                    'desktop-undo-btn',
                    'fullscreen-undo-btn'
                ];
                
                buttons.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.disabled = !canUndo;
                        btn.style.opacity = canUndo ? '1' : '0.5';
                        btn.style.cursor = canUndo ? 'pointer' : 'not-allowed';
                    }
                });
            }
        };

        // ============================================================================
        // МОДУЛЬ 4: ФИЛЬТРЫ
        // ============================================================================
        const FilterModule = {
            initFilters(buildings) {
                this.populateFilter('status-filter', buildings, 'status');
                this.populateFilter('district-filter', buildings, 'district');
                this.populateFilter('desktop-status-filter', buildings, 'status');
                this.populateFilter('desktop-district-filter', buildings, 'district');
                
                this.setupRangeControls();
                this.setupEventListeners();
                this.updateRangePlaceholders();
            },

            populateFilter(containerId, buildings, type) {
                const items = [...new Set(buildings.map(b => b[type]).filter(Boolean))];
                const container = document.getElementById(containerId);
                if (!container) return;
                
                container.innerHTML = '';
                
                items.forEach(item => {
                    const checkboxId = `checkbox-${containerId}-${item.replace(/\s+/g, '-')}`;
                    const statusClass = item === 'Свободно' ? 'status-free' : 'status-busy';
                    const statusHtml = type === 'status' 
                        ? `<span class="status-indicator ${statusClass}"></span>`
                        : '';
                    
                    const label = document.createElement('label');
                    label.className = 'checkbox-item';
                    label.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" value="${item}" checked>
                        ${statusHtml}
                        <span>${item}</span>
                    `;
                    container.appendChild(label);
                    activeFilters[type].add(item);
                });
            },

            setupRangeControls() {
                document.querySelectorAll('.range-control-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const targetId = button.dataset.target;
                        const input = document.getElementById(targetId);
                        if (!input) return;
                        
                        const isPlus = button.classList.contains('plus');
                        const currentValue = input.value ? parseInt(input.value) : null;
                        const fieldType = targetId.includes('floors') ? 'floors' : 'flatsPerEntrance';
                        const values = availableValues[fieldType];
                        
                        let newValue;
                        if (currentValue === null || currentValue === '') {
                            newValue = isPlus ? 
                                (values.length > 0 ? values[0] : 1) : 
                                (values.length > 0 ? values[values.length - 1] : 1);
                        } else {
                            const currentIndex = values.indexOf(currentValue);
                            
                            if (currentIndex !== -1) {
                                const newIndex = isPlus ? 
                                    Math.min(currentIndex + 1, values.length - 1) : 
                                    Math.max(currentIndex - 1, 0);
                                newValue = values[newIndex];
                            } else {
                                newValue = Utils.getNearestValue(currentValue, values, isPlus ? 1 : -1);
                            }
                        }
                        
                        input.value = newValue;
                        this.updateFilterFromInput(input);
                        
                        button.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            button.style.transform = '';
                        }, 150);
                    });
                });
                
                document.querySelectorAll('.range-control-input').forEach(input => {
                    input.addEventListener('wheel', (e) => {
                        e.preventDefault();
                        
                        const isPlus = e.deltaY < 0;
                        const fieldType = input.id.includes('floors') ? 'floors' : 'flatsPerEntrance';
                        const values = availableValues[fieldType];
                        
                        const currentValue = parseInt(input.value) || null;
                        let newValue;
                        
                        if (currentValue === null || currentValue === '') {
                            newValue = isPlus ? 
                                (values.length > 0 ? values[0] : 1) : 
                                (values.length > 0 ? values[values.length - 1] : 1);
                        } else {
                            const currentIndex = values.indexOf(currentValue);
                            
                            if (currentIndex !== -1) {
                                const newIndex = isPlus ? 
                                    Math.min(currentIndex + 1, values.length - 1) : 
                                    Math.max(currentIndex - 1, 0);
                                newValue = values[newIndex];
                            } else {
                                newValue = Utils.getNearestValue(currentValue, values, isPlus ? 1 : -1);
                            }
                        }
                        
                        input.value = newValue;
                        this.updateFilterFromInput(input);
                        
                        input.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.3)';
                        setTimeout(() => {
                            input.style.boxShadow = '';
                        }, 300);
                    }, { passive: false });                
                    
                    input.addEventListener('input', Utils.debounce(() => {
                        this.updateFilterFromInput(input);
                    }, 500));
                    
                    input.addEventListener('change', () => {
                        HistoryModule.saveFilterChange(
                            `Изменен диапазон: ${input.id}`,
                            HistoryModule.ACTION_TYPES.FILTER_CHANGE
                        );
                    });
                    
                    input.addEventListener('blur', () => {
                        this.validateInputValue(input);
                    });
                });
            },

            updateFilterFromInput(input) {
                const id = input.id;
                const value = input.value ? parseInt(input.value) : null;
                
                let filterType, minMax;
                if (id.includes('floors')) {
                    filterType = 'floors';
                    minMax = id.includes('min') ? 'min' : 'max';
                } else if (id.includes('flats')) {
                    filterType = 'flatsPerEntrance';
                    minMax = id.includes('min') ? 'min' : 'max';
                } else {
                    return;
                }
                
                activeFilters[filterType][minMax] = value;
                
                const otherInputId = id.startsWith('desktop-') ? 
                    id.replace('desktop-', '') : 
                    `desktop-${id}`;
                const otherInput = document.getElementById(otherInputId);
                if (otherInput && otherInput.value !== input.value) {
                    otherInput.value = input.value;
                }
                
                this.applyFiltersDebounced();
            },

            validateInputValue(input) {
                const id = input.id;
                const value = input.value ? parseInt(input.value) : null;
                
                if (value === null || value === '') return;
                
                const fieldType = id.includes('floors') ? 'floors' : 'flatsPerEntrance';
                const values = availableValues[fieldType];
                
                if (!values.includes(value)) {
                    const nearest = Utils.getNearestValue(value, values);
                    input.value = nearest;
                    
                    this.updateFilterFromInput(input);
                    
                    if (Math.abs(value - nearest) > 1) {
                        Utils.showNotification(`Значение ${value} не найдено. Установлено ${nearest}`, 'info');
                    }
                }
                
                this.validateRangePair(id);
            },

            validateRangePair(changedInputId) {
                let minInput, maxInput;
                
                if (changedInputId.includes('floors')) {
                    minInput = document.getElementById(changedInputId.includes('desktop-') ? 'desktop-floors-min' : 'floors-min');
                    maxInput = document.getElementById(changedInputId.includes('desktop-') ? 'desktop-floors-max' : 'floors-max');
                } else if (changedInputId.includes('flats')) {
                    minInput = document.getElementById(changedInputId.includes('desktop-') ? 'desktop-flats-min' : 'flats-min');
                    maxInput = document.getElementById(changedInputId.includes('desktop-') ? 'desktop-flats-max' : 'flats-max');
                } else {
                    return;
                }
                
                const minValue = minInput.value ? parseInt(minInput.value) : null;
                const maxValue = maxInput.value ? parseInt(maxInput.value) : null;
                
                if (minValue !== null && maxValue !== null && minValue > maxValue) {
                    minInput.value = maxValue;
                    maxInput.value = minValue;
                    
                    this.updateFilterFromInput(minInput);
                    this.updateFilterFromInput(maxInput);
                    
                    Utils.showNotification('Минимальное значение не может быть больше максимального. Значения поменяны местами.', 'info');
                }
            },

            updateRangePlaceholders() {
                const floorsMin = availableValues.floors[0] || 1;
                const floorsMax = availableValues.floors[availableValues.floors.length - 1] || 1;
                const flatsMin = availableValues.flatsPerEntrance[0] || 1;
                const flatsMax = availableValues.flatsPerEntrance[availableValues.flatsPerEntrance.length - 1] || 1;
                
                document.getElementById('floors-min').placeholder = `${floorsMin}`;
                document.getElementById('floors-max').placeholder = `${floorsMax}`;
                document.getElementById('flats-min').placeholder = `${flatsMin}`;
                document.getElementById('flats-max').placeholder = `${flatsMax}`;
                document.getElementById('desktop-floors-min').placeholder = `${floorsMin}`;
                document.getElementById('desktop-floors-max').placeholder = `${floorsMax}`;
                document.getElementById('desktop-flats-min').placeholder = `${flatsMin}`;
                document.getElementById('desktop-flats-max').placeholder = `${flatsMax}`;
                
                const setMinMax = (input, min, max) => {
                    if (input) {
                        input.min = min;
                        input.max = max;
                    }
                };
                
                setMinMax(document.getElementById('floors-min'), floorsMin, floorsMax);
                setMinMax(document.getElementById('floors-max'), floorsMin, floorsMax);
                setMinMax(document.getElementById('flats-min'), flatsMin, flatsMax);
                setMinMax(document.getElementById('flats-max'), flatsMin, flatsMax);
                setMinMax(document.getElementById('desktop-floors-min'), floorsMin, floorsMax);
                setMinMax(document.getElementById('desktop-floors-max'), floorsMin, floorsMax);
                setMinMax(document.getElementById('desktop-flats-min'), flatsMin, flatsMax);
                setMinMax(document.getElementById('desktop-flats-max'), flatsMin, flatsMax);
            },

            setupEventListeners() {
                this.setupFilterListeners('status-filter', 'status');
                this.setupFilterListeners('district-filter', 'district');
                this.setupFilterListeners('desktop-status-filter', 'status');
                this.setupFilterListeners('desktop-district-filter', 'district');
                
                document.getElementById('desktop-reset-filters')?.addEventListener('click', () => {
                    this.resetFilters();
                });
                
                document.getElementById('mobile-reset-filters')?.addEventListener('click', () => {
                    this.resetFilters();
                });
            },

            setupFilterListeners(containerId, filterType) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                container.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        const value = e.target.value;
                        e.target.checked ? activeFilters[filterType].add(value) : activeFilters[filterType].delete(value);
                        this.syncCheckboxes(containerId, filterType, value, e.target.checked);
                        this.applyFiltersDebounced();
                        
                        HistoryModule.saveFilterChange(
                            `Изменен фильтр: ${filterType} = ${value}`,
                            filterType === 'status' ? 
                                HistoryModule.ACTION_TYPES.STATUS_FILTER : 
                                HistoryModule.ACTION_TYPES.DISTRICT_FILTER
                        );
                    }
                });
            },

            syncCheckboxes(sourceContainerId, filterType, value, checked) {
                const targetContainerId = sourceContainerId.startsWith('desktop-') 
                    ? sourceContainerId.replace('desktop-', '')
                    : `desktop-${sourceContainerId}`;
                
                const checkbox = document.querySelector(`#${targetContainerId} input[value="${value}"]`);
                if (checkbox) {
                    checkbox.checked = checked;
                }
            },

            applyFilters() {
                filteredBuildings = allBuildings.filter(building => {
                    if (hiddenBuildings.has(building.originalIndex)) return false;
                    if (activeFilters.status.size > 0 && !activeFilters.status.has(building.status)) return false;
                    if (activeFilters.district.size > 0 && !activeFilters.district.has(building.district)) return false;
                    if (activeFilters.floors.min !== null && building.floors < activeFilters.floors.min) return false;
                    if (activeFilters.floors.max !== null && building.floors > activeFilters.floors.max) return false;
                    if (activeFilters.flatsPerEntrance.min !== null && building.flatsPerEntrance < activeFilters.flatsPerEntrance.min) return false;
                    if (activeFilters.flatsPerEntrance.max !== null && building.flatsPerEntrance > activeFilters.flatsPerEntrance.max) return false;
                    return true;
                });
                
                displayedBuildings = this.selectByPercentage(filteredBuildings, currentPercentage);
                this.updateUI();
            },

            selectByPercentage(items, percentage) {
                if (percentage >= 100) return [...items];
                if (percentage <= 0 || items.length === 0) return [];
                
                const n = items.length;
                const k = Math.round(n * percentage / 100);
                if (k >= n) return [...items];
                if (k <= 0) return [];
                
                const result = [];
                let step = n / k;
                let current = 0;
                
                for (let i = 0; i < k; i++) {
                    const index = Math.floor(current);
                    if (index < n) {
                        result.push(items[index]);
                    }
                    current += step;
                }
                
                return result;
            },

            updateUI() {
                MapModule.renderBuildings(displayedBuildings);
                ListModule.renderBuildingsList('building-list', displayedBuildings.slice(0, listLimit));
                ListModule.renderBuildingsList('desktop-building-list', displayedBuildings.slice(0, listLimit));
                this.updateStatistics();
                this.updateFilterCheckboxesStates();
            },
            
            updateFilterCheckboxesStates() {
                const visibleDistricts = [...new Set(displayedBuildings.map(b => b.district).filter(Boolean))];
                const visibleStatuses = [...new Set(displayedBuildings.map(b => b.status).filter(Boolean))];
                
                this.updateDistrictCheckboxesStates(visibleDistricts);
                this.updateStatusCheckboxesStates(visibleStatuses);
            },

            updateDistrictCheckboxesStates(visibleDistricts) {
                ['district-filter', 'desktop-district-filter'].forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        const district = checkbox.value;
                        if (!visibleDistricts.includes(district)) {
                            checkbox.checked = false;
                            activeFilters.district.delete(district);
                        }
                    });
                });
            },
            
            updateStatusCheckboxesStates(visibleStatuses) {
                ['status-filter', 'desktop-status-filter'].forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        const status = checkbox.value;
                        if (!visibleStatuses.includes(status)) {
                            checkbox.checked = false;
                            activeFilters.status.delete(status);
                        }
                    });
                });
            },

            updateStatistics() {
                const selectedCount = displayedBuildings.length;
                const totalInBase = allBuildings.reduce((sum, b) => sum + (b.entrances || 0), 0);
                const totalStands = displayedBuildings.reduce((sum, b) => sum + (b.entrances || 0), 0);
                const totalFlats = displayedBuildings.reduce((sum, b) => sum + (b.flats || 0), 0);
                
                let totalPrice = null;
                if (totalStands >= 100) {
                    if (totalStands >= 100 && totalStands <= 299) {
                        totalPrice = totalStands * 160;
                    } else if (totalStands >= 300 && totalStands <= 499) {
                        totalPrice = totalStands * 140;
                    } else if (totalStands >= 500) {
                        totalPrice = totalStands * 120;
                    }
                }
                
                const perFlatPrice = totalPrice && totalFlats > 0 ? totalPrice / totalFlats : null;
                
                document.getElementById('selected-stands').textContent = Utils.formatNumber(totalStands);
                document.getElementById('coverage-flats').textContent = Utils.formatNumber(totalFlats);
                document.getElementById('monthly-price').textContent = Utils.formatPrice(totalPrice);
                document.getElementById('per-flat-price').textContent = Utils.formatPrice(perFlatPrice);
                document.getElementById('total-in-base').textContent = Utils.formatNumber(totalInBase);
                
                document.getElementById('desktop-selected-stands').textContent = Utils.formatNumber(totalStands);
                document.getElementById('desktop-coverage-flats').textContent = Utils.formatNumber(totalFlats);
                document.getElementById('desktop-monthly-price').textContent = Utils.formatPrice(totalPrice);
                document.getElementById('desktop-per-flat-price').textContent = Utils.formatPrice(perFlatPrice);
                document.getElementById('desktop-total-in-base').textContent = Utils.formatNumber(totalInBase);
                
                document.getElementById('fullscreen-selected-stands').textContent = Utils.formatNumber(totalStands);
                document.getElementById('fullscreen-coverage-flats').textContent = Utils.formatNumber(totalFlats);
                document.getElementById('fullscreen-monthly-price').textContent = Utils.formatPrice(totalPrice);
                document.getElementById('fullscreen-per-flat-price').textContent = Utils.formatPrice(perFlatPrice);
                document.getElementById('fullscreen-total-in-base').textContent = Utils.formatNumber(totalInBase);
            },

            resetFilters() {
                hiddenBuildings.clear();
                
                activeFilters.status.clear();
                activeFilters.district.clear();
                
                document.querySelectorAll('#status-filter input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = true;
                    activeFilters.status.add(checkbox.value);
                });
                
                document.querySelectorAll('#district-filter input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = true;
                    activeFilters.district.add(checkbox.value);
                });
                
                activeFilters.floors.min = null;
                activeFilters.floors.max = null;
                activeFilters.flatsPerEntrance.min = null;
                activeFilters.flatsPerEntrance.max = null;
                
                document.querySelectorAll('.range-control-input').forEach(input => {
                    input.value = '';
                });
                
                currentPercentage = 100;
                
                const mobileSlider = document.getElementById('mobile-percentage-slider');
                const mobileValue = document.getElementById('mobile-percentage-value');
                const desktopSlider = document.getElementById('desktop-percentage-slider');
                const desktopValue = document.getElementById('desktop-percentage-value');
                
                if (mobileSlider) mobileSlider.value = 100;
                if (mobileValue) mobileValue.textContent = '100%';
                if (desktopSlider) desktopSlider.value = 100;
                if (desktopValue) desktopValue.textContent = '100%';
                
                document.querySelectorAll('#desktop-status-filter input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
                
                document.querySelectorAll('#desktop-district-filter input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
                
                this.applyFiltersDebounced();
                Utils.showNotification('Все фильтры сброшены', 'success');
                
                HistoryModule.saveFilterChange('Сброс всех фильтров', HistoryModule.ACTION_TYPES.FILTER_CHANGE);
            },
            
            applyFiltersDebounced: Utils.debounce(function() {
                FilterModule.applyFilters();
            }, 300)
        };

        // ============================================================================
        // МОДУЛЬ 5: ПРОЦЕНТНЫЙ ОТБОР
        // ============================================================================
        const PercentageModule = {
            initPercentageSelector() {
                this.setupPercentageControls(
                    'desktop-percentage-slider',
                    'desktop-percentage-value',
                    'desktop-percentage-decrease',
                    'desktop-percentage-increase'
                );
                
                this.setupPercentageControls(
                    'mobile-percentage-slider',
                    'mobile-percentage-value',
                    'mobile-percentage-decrease',
                    'mobile-percentage-increase'
                );
            },

            setupPercentageControls(sliderId, valueId, decreaseId, increaseId) {
                const slider = document.getElementById(sliderId);
                const valueDisplay = document.getElementById(valueId);
                const decreaseBtn = document.getElementById(decreaseId);
                const increaseBtn = document.getElementById(increaseId);
                
                if (!slider || !valueDisplay) return;
                
                const updateSlider = Utils.debounce((value) => {
                    currentPercentage = value;
                    valueDisplay.textContent = `${value}%`;
                    
                    let targetSliderId, targetValueId;
                    
                    if (sliderId.includes('mobile')) {
                        targetSliderId = 'desktop-percentage-slider';
                        targetValueId = 'desktop-percentage-value';
                    } else {
                        targetSliderId = 'mobile-percentage-slider';
                        targetValueId = 'mobile-percentage-value';
                    }
                    
                    const targetSlider = document.getElementById(targetSliderId);
                    const targetValueDisplay = document.getElementById(targetValueId);
                    
                    if (targetSlider) targetSlider.value = value;
                    if (targetValueDisplay) targetValueDisplay.textContent = `${value}%`;
                    
                    FilterModule.applyFiltersDebounced();
                    
                    HistoryModule.saveFilterChange(
                        `Изменен процент: ${value}%`,
                        HistoryModule.ACTION_TYPES.PERCENTAGE_CHANGE
                    );
                }, 300);
                
                slider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    valueDisplay.textContent = `${value}%`;
                });
                
                slider.addEventListener('change', (e) => {
                    const value = parseInt(e.target.value);
                    updateSlider(value);
                });
                
                slider.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const currentValue = parseInt(slider.value);
                    const newValue = e.deltaY < 0 ? 
                        Math.min(100, currentValue + 1) : 
                        Math.max(1, currentValue - 1);
                    
                    slider.value = newValue;
                    valueDisplay.textContent = `${newValue}%`;
                    updateSlider(newValue);
                }, { passive: false });
                
                if (decreaseBtn) {
                    decreaseBtn.addEventListener('click', () => {
                        const newValue = Math.max(1, currentPercentage - 1);
                        slider.value = newValue;
                        valueDisplay.textContent = `${newValue}%`;
                        updateSlider(newValue);
                    });
                }
                
                if (increaseBtn) {
                    increaseBtn.addEventListener('click', () => {
                        const newValue = Math.min(100, currentPercentage + 1);
                        slider.value = newValue;
                        valueDisplay.textContent = `${newValue}%`;
                        updateSlider(newValue);
                    });
                }
            }
        };

        // ============================================================================
        // МОДУЛЬ 6: СПИСОК ОБЪЕКТОВ
        // ============================================================================
        const ListModule = {
            getStandsText(count) {
                const lastDigit = count % 10;
                const lastTwoDigits = count % 100;
                
                if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
                    return 'стендов';
                }
                
                if (lastDigit === 1) {
                    return 'стенд';
                } else if (lastDigit >= 2 && lastDigit <= 4) {
                    return 'стенда';
                } else {
                    return 'стендов';
                }
            },

            getFlatsText(count) {
                const lastDigit = count % 10;
                const lastTwoDigits = count % 100;
                
                if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
                    return 'кв.';
                }
                
                if (lastDigit === 1) {
                    return 'кв.';
                } else if (lastDigit >= 2 && lastDigit <= 4) {
                    return 'кв.';
                } else {
                    return 'кв.';
                }
            },

            renderBuildingsList(containerId, buildings, append = false) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                if (!append) container.innerHTML = '';
                
                buildings.forEach(building => {
                    const item = document.createElement('div');
                    item.className = 'building-item';
                    item.dataset.id = building.originalIndex;
                    
                    const shortDistrict = Utils.shortenDistrictName(building.district);
                    const statusClass = building.status === 'Свободно' ? 'status-free' : 'status-busy';
                    
                    item.innerHTML = `
                        <div class="building-header">
                            <span class="building-status">
                                <span class="status-indicator ${statusClass}"></span>
                            </span>
                            <span class="building-address">${Utils.escapeHtml(building.address)}</span>
                            <button class="building-hide" onclick="handleHideBuilding(${building.originalIndex}, event)">×</button>
                        </div>
                        <div class="building-details">
                            <span><i class="fas fa-city"></i> ${Utils.escapeHtml(shortDistrict)}</span>
                            <span><i class="fas fa-columns"></i> ${building.entrances} ${this.getStandsText(building.entrances)}</span>
                            <span><i class="fas fa-door-closed"></i> ${building.flats} ${this.getFlatsText(building.flats)}</span>
                        </div>
                    `;
                    
                    item.addEventListener('click', (e) => {
                        if (e.target.classList.contains('building-hide') || e.target.closest('.building-hide')) {
                            return;
                        }
                            
                        if (!map) return;
                        const lat = building.lat;
                        const lng = building.lng;
                            
                        const statusClass = building.status === 'Свободно' ? 'status-free' : 'status-busy';
                        const shortDistrict = Utils.shortenDistrictName(building.district);
                            
                        const balloonContent = `
                            <div class="single-balloon">
                                <div class="single-balloon-header">
                                    <div class="single-balloon-title">
                                        <span class="status-indicator ${statusClass}"></span>
                                        <span>${Utils.escapeHtml(building.address)}</span>
                                    </div>
                                    <button class="single-balloon-close-btn" title="Закрыть">×</button>
                                </div>
                                <div class="single-balloon-content">
                                    <div class="single-balloon-stats">
                                        <div class="single-stat-item">
                                            <div class="single-stat-label">РАЙОН</div>
                                            <div class="single-stat-value"><i class="fas fa-city"></i> ${Utils.escapeHtml(shortDistrict)}</div>
                                        </div>
                                        <div class="single-stat-item">
                                            <div class="single-stat-label">СТЕНДОВ</div>
                                            <div class="single-stat-value stands"><i class="fas fa-columns"></i> ${building.entrances}</div>
                                        </div>
                                        <div class="single-stat-item">
                                            <div class="single-stat-label">КВАРТИР</div>
                                            <div class="single-stat-value"><i class="fas fa-door-closed"></i> ${building.flats}</div>
                                        </div>
                                        <div class="single-stat-item">
                                            <div class="single-stat-label">ЭТАЖЕЙ</div>
                                            <div class="single-stat-value"><i class="fas fa-building"></i> ${building.floors}</div>
                                        </div>
                                    </div>
                                    <button class="single-balloon-hide-btn" onclick="handleHideBuilding(${building.originalIndex})">
                                        <i class="fas fa-times"></i> Скрыть адрес
                                    </button>
                                </div>
                            </div>
                        `;
                            
                        map.setCenter([lat, lng], 17);
                        map.balloon.open([lat, lng], balloonContent, {
                            closeButton: false,
                            autoPan: true,
                            autoPanMargin: [80, 80, 80, 80],
                            offset: [0, -15]
                        });

                        setTimeout(() => {
                            const closeBtn = document.querySelector('.single-balloon-close-btn');
                            if (closeBtn) {
                                closeBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                    map.balloon.close();
                                });
                            }
                        }, 50);
                            
                        if (isMobile) {
                            Utils.setMobileView('map');
                        }
                    });                
                    container.appendChild(item);
                });
                    
                this.updateLoadMoreButton(containerId);
            },

            updateLoadMoreButton(containerId) {
                const loadMoreBtnId = containerId.startsWith('desktop-') 
                    ? 'desktop-load-more' 
                    : 'load-more';
                const loadMoreBtn = document.getElementById(loadMoreBtnId);
                    
                if (!loadMoreBtn) return;
                    
                const container = document.getElementById(containerId);
                const currentCount = container ? container.children.length : 0;
                const hasMore = currentCount < displayedBuildings.length;
                    
                loadMoreBtn.style.display = hasMore ? 'block' : 'none';
                loadMoreBtn.textContent = `Показать еще (${Math.min(20, displayedBuildings.length - currentCount)})`;
            },

            loadMoreBuildings(isDesktop = false) {
                const containerId = isDesktop ? 'desktop-building-list' : 'building-list';
                const container = document.getElementById(containerId);
                if (!container) return;
                    
                const currentCount = container.children.length;
                const nextBuildings = displayedBuildings.slice(currentCount, currentCount + 20);
                    
                if (nextBuildings.length > 0) {
                    this.renderBuildingsList(containerId, nextBuildings, true);
                }
            }
        };

        // ============================================================================
        // МОДУЛЬ 7: ФОРМИРОВАНИЕ ОТЧЁТА (ИСПРАВЛЕННЫЙ)
        // ============================================================================
        const ReportModule = {
            currentReportText: null,
            
            getStandsText(count) {
                const lastDigit = count % 10;
                const lastTwoDigits = count % 100;
                
                if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
                    return 'стендов';
                }
                
                if (lastDigit === 1) {
                    return 'стенд';
                } else if (lastDigit >= 2 && lastDigit <= 4) {
                    return 'стенда';
                } else {
                    return 'стендов';
                }
            },
            
            getFlatsText(count) {
                const lastDigit = count % 10;
                const lastTwoDigits = count % 100;
                
                if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
                    return 'квартир';
                }
                
                if (lastDigit === 1) {
                    return 'квартира';
                } else if (lastDigit >= 2 && lastDigit <= 4) {
                    return 'квартиры';
                } else {
                    return 'квартир';
                }
            },
            
            getObjectsText(count) {
                const lastDigit = count % 10;
                const lastTwoDigits = count % 100;
                
                if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
                    return 'объектов';
                }
                
                if (lastDigit === 1) {
                    return 'объект';
                } else if (lastDigit >= 2 && lastDigit <= 4) {
                    return 'объекта';
                } else {
                    return 'объектов';
                }
            },

            generateReportText() {
                const now = new Date();
                const dateStr = now.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const selectedCount = displayedBuildings.length;
                const totalStands = displayedBuildings.reduce((sum, b) => sum + (b.entrances || 0), 0);
                const totalFlats = displayedBuildings.reduce((sum, b) => sum + (b.flats || 0), 0);
                
                let totalPrice = null;
                if (totalStands >= 100) {
                    if (totalStands >= 100 && totalStands <= 299) {
                        totalPrice = totalStands * 160;
                    } else if (totalStands >= 300 && totalStands <= 499) {
                        totalPrice = totalStands * 140;
                    } else if (totalStands >= 500) {
                        totalPrice = totalStands * 120;
                    }
                }
                
                let report = `ОТЧЁТ ПО СТЕНДАМ У ДОМОФОНОВ\r\n`;
                report += `Дата формирования: ${dateStr}\r\n`;
                report += `========================================\r\n\r\n`;
                
                report += `СТАТИСТИКА:\r\n`;
                report += `• Выбрано ${this.getObjectsText(selectedCount)}: ${selectedCount}\r\n`;
                report += `• Всего ${this.getStandsText(totalStands)}: ${totalStands}\r\n`;
                report += `• Всего ${this.getFlatsText(totalFlats)}: ${totalFlats}\r\n`;
                
                if (totalStands >= 100) {
                    report += `• Стоимость в месяц: ${Utils.formatPrice(totalPrice)}\r\n`;
                    if (totalFlats > 0) {
                        report += `• Стоимость на квартиру: ${Utils.formatPrice(totalPrice / totalFlats)}\r\n`;
                    }
                } else {
                    report += `• Стоимость: требуется больше зданий для расчёта\r\n`;
                }
                
                report += `\r\nПАРАМЕТРЫ ФИЛЬТРАЦИИ:\r\n`;
                report += `• Статусы: ${Array.from(activeFilters.status).join(', ') || 'Все'}\r\n`;
                report += `• Районы: ${Array.from(activeFilters.district).join(', ') || 'Все'}\r\n`;
                report += `• Этажность: ${activeFilters.floors.min || 'мин'} - ${activeFilters.floors.max || 'макс'}\r\n`;
                report += `• Квартир в подъезде: ${activeFilters.flatsPerEntrance.min || 'мин'} - ${activeFilters.flatsPerEntrance.max || 'макс'}\r\n`;
                report += `• Процентный отбор: ${currentPercentage}%\r\n\r\n`;
                
                report += `СПИСОК АДРЕСОВ:\r\n`;
                displayedBuildings.forEach((building, index) => {
                    const shortDistrict = Utils.shortenDistrictName(building.district);
                    const statusIcon = building.status === 'Свободно' ? '<i class="fas fa-circle text-success"></i>' : '<i class="fas fa-circle text-danger"></i>';
                    const standsText = this.getStandsText(building.entrances);
                    const flatsText = this.getFlatsText(building.flats);
                    report += `${index + 1}. ${statusIcon} ${building.address} | ${shortDistrict} | ${building.status} | ${building.entrances} ${standsText} | ${building.flats} ${flatsText}\r\n`;
                });
                
                report += `\r\n\r\n<i class="fas fa-link"></i> ВРЕМЕННАЯ ССЫЛКА НА ТЕКУЩИЕ НАСТРОЙКИ:\r\n`;
                
                const shareableURL = StateModule.generateShareableURL();
                if (shareableURL) {
                    report += `${shareableURL}\r\n\r\n`;
                    report += `<i class="fas fa-exclamation-triangle text-warning"></i> Эта ссылка сохраняет ВСЕ текущие настройки: фильтры, проценты, скрытые здания\r\n`;
                    report += `• Ссылка корректна ПОКА ДАННЫЕ В БАЗЕ НЕ ИЗМЕНИЛИСЬ\r\n`;
                } else {
                    report += `Не удалось сгенерировать ссылку\r\n`;
                }
                
                report += `\r\nПРИМЕЧАНИЕ:\r\n`;
                report += `• Минимальное количество для расчета: 100 стендов\r\n`;
                report += `• Отчёт сформирован автоматически в системе PR МАРКЕТ Рязань`;
                
                // Заменяем HTML теги на символы для текстового файла
                report = report.replace(/<i class="fas fa-circle text-success"><\/i>/g, '🟢');
                report = report.replace(/<i class="fas fa-circle text-danger"><\/i>/g, '🔴');
                report = report.replace(/<i class="fas fa-link"><\/i>/g, '🔗');
                report = report.replace(/<i class="fas fa-exclamation-triangle text-warning"><\/i>/g, '⚠️');
                
                return report;
            },

            showReportModal() {
                if (isGeneratingReport) return;
                isGeneratingReport = true;
                
                try {
                    this.currentReportText = this.generateReportText();
                    
                    const textarea = document.getElementById('report-textarea');
                    textarea.value = this.currentReportText.replace(/\r\n/g, '\n');
                    
                    this.updateShareButtonsUI();
                    
                    const modal = document.getElementById('report-modal');
                    modal.classList.add('active');
                    
                    setTimeout(() => {
                        textarea.focus();
                        textarea.select();
                    }, 300);
                    
                } catch (error) {
                    console.error('Ошибка формирования отчёта:', error);
                    Utils.showNotification('Ошибка формирования отчёта', 'error');
                } finally {
                    setTimeout(() => {
                        isGeneratingReport = false;
                    }, 1000);
                }
            },
            
            updateShareButtonsUI() {
                const shareActions = document.getElementById('report-share-actions');
                
                if (!shareActions) return;
                
                // Проверяем наличие контактов ТОЛЬКО из Google Sheets
                const hasTelegram = contacts.telegram && contacts.telegram.trim() !== '';
                const hasEmail = contacts.email && contacts.email.trim() !== '';
                
                // Показываем кнопки, только если есть хотя бы один контакт
                if (hasTelegram || hasEmail) {
                    shareActions.style.display = 'grid';
                    
                    const telegramBtn = document.getElementById('report-telegram-btn');
                    const emailBtn = document.getElementById('report-email-btn');
                    
                    if (telegramBtn) {
                        telegramBtn.style.display = hasTelegram ? 'flex' : 'none';
                        telegramBtn.onclick = null; // Сначала удаляем старый обработчик
                        telegramBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.shareViaTelegram();
                        });
                    }
                    
                    if (emailBtn) {
                        emailBtn.style.display = hasEmail ? 'flex' : 'none';
                        emailBtn.onclick = null; // Сначала удаляем старый обработчик
                        emailBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.shareViaEmail();
                        });
                    }
                } else {
                    // Если нет контактов - скрываем панель
                    shareActions.style.display = 'none';
                }
            },
            
            async copyToClipboard() {
                const textToCopy = this.currentReportText || this.generateReportText();
                
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(textToCopy);
                        Utils.showNotification('Отчёт скопирован в буфер обмена', 'success');
                        return;
                    }
                } catch (error) {
                    console.log('Clipboard API не доступен, используем fallback:', error);
                }
                
                return new Promise((resolve, reject) => {
                    try {
                        const textArea = document.createElement('textarea');
                        textArea.value = textToCopy;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        if (successful) {
                            Utils.showNotification('Отчёт скопирован в буфер обмена', 'success');
                            resolve();
                        } else {
                            Utils.showNotification('Не удалось скопировать отчёт', 'error');
                            reject(new Error('Не удалось скопировать'));
                        }
                    } catch (error) {
                        Utils.showNotification('Ошибка копирования', 'error');
                        reject(error);
                    }
                });
            },

            downloadReport() {
                const reportText = this.currentReportText || this.generateReportText();
                
                if (!reportText) {
                    Utils.showNotification('Нет данных для скачивания', 'error');
                    return;
                }
                
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
                const filename = `otchet-stendy-${dateStr}_${timeStr}.txt`;
                
                const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    Utils.showNotification('Отчёт скачан', 'success');
                }, 100);
            },
            
            shareViaTelegram: function() {
                // 1. Проверяем, есть ли контакт Telegram в Google Sheets
                if (!contacts.telegram || contacts.telegram.trim() === '') {
                    Utils.showNotification('Telegram контакт не найден в таблице', 'error');
                    return;
                }

                // 2. Получаем ссылку на текущие настройки
                const shareableURL = StateModule.generateShareableURL();
                if (!shareableURL) {
                    Utils.showNotification('Не удалось создать ссылку на настройки', 'error');
                    return;
                }

                // 3. Извлекаем username из формата
                let username = this.extractTelegramUsername(contacts.telegram);
                
                // 4. Проверяем результат
                if (!username) {
                    Utils.showNotification('Не удалось распознать Telegram username в таблице', 'error');
                    return;
                }
                
                // console.log('Извлеченный username из Google Sheets:', username);

                // 5. Формируем сообщение
                const messageText = `Отчёт по стендам у домофонов\n\n🔗 Ссылка на текущие настройки и фильтры:\n${shareableURL}\n\n⚠️ Ссылка временная. Она сохраняет все текущие настройки, но станет некорректной при обновлении данных в базе.`;
                const encodedMessage = encodeURIComponent(messageText);
                
                // 6. Открываем диалог с пользователем из Google Sheets
                const telegramUrl = `https://t.me/${username}?text=${encodedMessage}`;
                
                window.open(telegramUrl, '_blank');
                Utils.showNotification(`Открываю чат с @${username} в Telegram...`, 'info');
            },

            extractTelegramUsername: function(input) {
                if (!input || typeof input !== 'string') return null;
                
                // Убираем пробелы
                input = input.trim();
                
                // Извлекаем username из различных форматов
                let match = input.match(/(?:https?:\/\/)?(?:t\.me\/|@)?([a-zA-Z0-9_]+)/);
                return match ? match[1] : null;
            },
            
            shareViaEmail: function() {
                // Проверяем, есть ли email в Google Sheets
                if (!contacts.email || contacts.email.trim() === '') {
                    Utils.showNotification('Email адрес не найден в таблице', 'error');
                    return;
                }

                // Получаем ссылку на текущие настройки
                const shareableURL = StateModule.generateShareableURL();
                if (!shareableURL) {
                    Utils.showNotification('Не удалось создать ссылку на настройки', 'error');
                    return;
                }

                // Формируем email
                const now = new Date();
                const dateStr = now.toLocaleDateString('ru-RU');
                
                // Текст письма
                const subject = `Отчёт по стендам у домофонов (${dateStr})`;
                const body = `Отчёт по стендам у домофонов\n\n🔗 Ссылка на текущие настройки и фильтры:\n${shareableURL}\n\n⚠️ Ссылка временная. Она сохраняет все текущие настройки, но станет некорректной при обновлении данных в базе.\n\n---\nС уважением,\nPR МАРКЕТ Рязань`;
                
                // Правильное кодирование для mailto
                try {
                    // Используем encodeURIComponent для правильного кодирования
                    const encodedSubject = encodeURIComponent(subject);
                    const encodedBody = encodeURIComponent(body);
                    
                    // Формируем mailto ссылку
                    const mailtoUrl = `mailto:${contacts.email}?subject=${encodedSubject}&body=${encodedBody}`;
                    
                    // console.log('Email ссылка:', mailtoUrl);
                    
                    // Создаем временную ссылку и кликаем по ней
                    const link = document.createElement('a');
                    link.href = mailtoUrl;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    
                    try {
                        link.click();
                        Utils.showNotification('Открываю почтовый клиент...', 'info');
                    } catch (error) {
                        console.error('Ошибка при открытии почтового клиента:', error);
                        
                        // Резервный метод: открываем в новом окне
                        window.open(mailtoUrl, '_blank');
                        Utils.showNotification('Пожалуйста, отправьте письмо вручную', 'info');
                    } finally {
                        // Убираем ссылку из DOM
                        setTimeout(() => {
                            if (link.parentNode) {
                                link.parentNode.removeChild(link);
                            }
                        }, 100);
                    }
                    
                } catch (error) {
                    console.error('Ошибка формирования email:', error);
                    Utils.showNotification('Ошибка при формировании письма', 'error');
                }
                
                // Закрываем модальное окно через некоторое время
                setTimeout(() => {
                    const modal = document.getElementById('report-modal');
                    if (modal) {
                        modal.classList.remove('active');
                    }
                }, 500);
            }
        };

        // ============================================================================
        // МОДУЛЬ 8: ПОЛНОЭКРАННЫЙ РЕЖИМ
        // ============================================================================
        const FullscreenModule = {
            init() {
                const sidebarBtn = document.getElementById('sidebar-fullscreen-btn');
                const fullscreenBtn = document.getElementById('fullscreen-close-btn');
                
                if (sidebarBtn) {
                    sidebarBtn.addEventListener('click', () => {
                        this.toggleFullscreen();
                    });
                }
                
                if (fullscreenBtn) {
                    fullscreenBtn.addEventListener('click', () => {
                        this.toggleFullscreen();
                    });
                }
                
                this.initDragAndDrop();
            },
            
            initDragAndDrop() {
                const fullscreenHeader = document.getElementById('fullscreen-header');
                if (!fullscreenHeader) return;
                
                fullscreenHeader.addEventListener('mousedown', this.startDrag.bind(this));
                document.addEventListener('mousemove', this.drag.bind(this));
                document.addEventListener('mouseup', this.stopDrag.bind(this));
                
                this.dragBound = this.drag.bind(this);
                this.stopDragBound = this.stopDrag.bind(this);
                
                fullscreenHeader.addEventListener('touchstart', (e) => {
                    const touch = e.touches[0];
                    this.startDrag({
                        clientX: touch.clientX,
                        clientY: touch.clientY,
                        target: e.target
                    });
                    e.preventDefault();
                }, { passive: false });
                
                document.addEventListener('touchmove', (e) => {
                    if (!dragData) return;
                    const touch = e.touches[0];
                    this.drag({
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    e.preventDefault();
                }, { passive: false });
                
                document.addEventListener('touchend', () => {
                    this.stopDrag();
                });
            },
            
            startDrag(e) {
                const fullscreenHeader = document.getElementById('fullscreen-header');
                if (!fullscreenHeader || !isFullscreen || e.target.closest('.fullscreen-close-btn')) return;
                
                dragData = {
                    element: fullscreenHeader,
                    startX: e.clientX - fullscreenHeader.offsetLeft,
                    startY: e.clientY - fullscreenHeader.offsetTop,
                    offsetX: e.clientX,
                    offsetY: e.clientY
                };
                
                fullscreenHeader.style.cursor = 'grabbing';
                fullscreenHeader.style.transition = 'none';
            },
            
            drag(e) {
                if (!dragData) return;
                
                const newX = e.clientX - dragData.startX;
                const newY = e.clientY - dragData.startY;
                
                dragData.element.style.left = Math.max(10, Math.min(newX, window.innerWidth - dragData.element.offsetWidth - 10)) + 'px';
                dragData.element.style.top = Math.max(10, Math.min(newY, window.innerHeight - dragData.element.offsetHeight - 10)) + 'px';
            },
            
            stopDrag() {
                if (!dragData) return;
                
                dragData.element.style.cursor = 'move';
                dragData.element.style.transition = 'all 0.3s';
                dragData = null;
            },
            
            toggleFullscreen() {
                const sidebar = document.getElementById('desktop-sidebar');
                const mapContainer = document.getElementById('desktop-map-container');
                const fullscreenHeader = document.getElementById('fullscreen-header');
                const sidebarBtn = document.getElementById('sidebar-fullscreen-btn');
                const fullscreenBtn = document.getElementById('fullscreen-close-btn');
                
                if (!isFullscreen) {
                    isFullscreen = true;
                    sidebar.classList.add('hidden');
                    mapContainer.classList.add('fullscreen');
                    fullscreenHeader.style.display = 'block';
                    sidebarBtn.innerHTML = '<i class="fas fa-arrow-right"></i>';
                    sidebarBtn.title = 'Вернуться к обычному виду';
                    fullscreenBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
                    
                    Utils.showNotification('Включен полноэкранный режим', 'success');
                } else {
                    isFullscreen = false;
                    sidebar.classList.remove('hidden');
                    mapContainer.classList.remove('fullscreen');
                    fullscreenHeader.style.display = 'none';
                    sidebarBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
                    sidebarBtn.title = 'Развернуть на весь экран';
                    
                    Utils.showNotification('Обычный режим', 'info');
                }
                
                if (map) {
                    setTimeout(() => {
                        map.container.fitToViewport();
                    }, 100);
                }
            }
        };

        // ============================================================================
        // МОДУЛЬ 9: СОХРАНЕНИЕ И ВОССТАНОВЛЕНИЕ СОСТОЯНИЯ
        // ============================================================================
        const StateModule = {
            currentDataHash: null,
            stateVersion: 1,
            
            init: function(buildings) {
                this.currentDataHash = this.computeDataHash(buildings);
                this.checkAndApplyURLState();
            },
            
            computeDataHash: function(buildings) {
                try {
                    const dataString = buildings
                        .map(b => `${b.address}|${b.lat}|${b.lng}|${b.status}|${b.district}|${b.entrances}|${b.floors}|${b.flats}|${b.flatsPerEntrance}`)
                        .sort()
                        .join(';');
                    
                    let hash = 0;
                    for (let i = 0; i < dataString.length; i++) {
                        const char = dataString.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }
                    
                    return Math.abs(hash).toString(36).substring(0, 8);
                } catch (error) {
                    console.error('Ошибка вычисления хэша:', error);
                    return 'error';
                }
            },
            
            collectCurrentState: function() {
                return {
                    version: this.stateVersion,
                    dataHash: this.currentDataHash,
                    filters: {
                        status: Array.from(activeFilters.status),
                        district: Array.from(activeFilters.district),
                        floors: { ...activeFilters.floors },
                        flatsPerEntrance: { ...activeFilters.flatsPerEntrance }
                    },
                    percentage: currentPercentage,
                    hiddenBuildings: Array.from(hiddenBuildings),
                    userMarkers: MapModule.userMarkers || []
                };
            },
            
            encodeState: function(state) {
                try {
                    const compactState = {
                        v: state.version,
                        h: state.dataHash,
                        f: {
                            s: state.filters.status,
                            d: state.filters.district,
                            fl: [state.filters.floors.min, state.filters.floors.max],
                            fa: [state.filters.flatsPerEntrance.min, state.filters.flatsPerEntrance.max]
                        },
                        p: state.percentage,
                        hb: state.hiddenBuildings,
                        m: state.userMarkers.map(marker => ({
                            t: marker.text,
                            lat: marker.lat,
                            lng: marker.lng,
                            c: marker.createdAt
                        }))
                    };
                    
                    const jsonString = JSON.stringify(compactState);
                    const base64 = btoa(encodeURIComponent(jsonString))
                        .replace(/\+/g, '-')
                        .replace(/\//g, '_')
                        .replace(/=+$/, '');
                    
                    return base64;
                } catch (error) {
                    console.error('Ошибка кодирования состояния:', error);
                    return null;
                }
            },
            
            decodeState: function(encodedString) {
                try {
                    let base64 = encodedString.replace(/-/g, '+').replace(/_/g, '/');
                    while (base64.length % 4) {
                        base64 += '=';
                    }
                    
                    const jsonString = decodeURIComponent(atob(base64));
                    const compactState = JSON.parse(jsonString);
                    
                    const state = {
                        version: compactState.v,
                        dataHash: compactState.h,
                        filters: {
                            status: compactState.f.s || [],
                            district: compactState.f.d || [],
                            floors: {
                                min: compactState.f.fl?.[0] || null,
                                max: compactState.f.fl?.[1] || null
                            },
                            flatsPerEntrance: {
                                min: compactState.f.fa?.[0] || null,
                                max: compactState.f.fa?.[1] || null
                            }
                        },
                        percentage: compactState.p || 100,
                        hiddenBuildings: compactState.hb || [],
                        userMarkers: (compactState.m || []).map(marker => ({
                            text: marker.t,
                            lat: marker.lat,
                            lng: marker.lng,
                            createdAt: marker.c || new Date().toISOString()
                        }))
                    };
                    
                    return state;
                } catch (error) {
                    console.error('Ошибка декодирования состояния:', error);
                    return null;
                }
            },
            
            generateShareableURL: function() {
                const state = this.collectCurrentState();
                const encoded = this.encodeState(state);
                
                if (!encoded) {
                    return null;
                }
                
                const baseURL = window.location.origin + window.location.pathname;
                return `${baseURL}?state=${encoded}`;
            },
            
            checkAndApplyURLState: function() {
                const urlParams = new URLSearchParams(window.location.search);
                const stateParam = urlParams.get('state');
                
                if (!stateParam) {
                    return;
                }
                
                Utils.showNotification('Загрузка настроек из ссылки...', 'info');
                
                setTimeout(() => {
                    this.applyStateFromURL(stateParam);
                }, 500);
            },
            
            applyStateFromURL: function(encodedState) {
                try {
                    const state = this.decodeState(encodedState);
                    
                    if (!state) {
                        Utils.showNotification('Ошибка загрузки настроек', 'error');
                        return;
                    }
                    
                    if (state.version !== this.stateVersion) {
                        Utils.showNotification('Устаревший формат ссылки. Сброс настроек.', 'warning');
                        FilterModule.resetFilters();
                        return;
                    }
                    
                    if (state.dataHash !== this.currentDataHash) {
                        const userConfirmed = confirm(
                            'Данные в базе обновились с момента создания ссылки.\n' +
                            'Настройки фильтров будут сброшены.\n' +
                            'Пользовательские метки будут восстановлены.\n\n' +
                            'Хотите продолжить?'
                        );
                        
                        if (!userConfirmed) {
                            Utils.showNotification('Загрузка настроек отменена', 'info');
                            return;
                        }
                        
                        if (state.userMarkers && state.userMarkers.length > 0) {
                            MapModule.userMarkers = state.userMarkers;
                            MapModule.saveUserMarkers();
                            MapModule.renderUserMarkers();
                            Utils.showNotification(`Восстановлено ${state.userMarkers.length} меток`, 'success');
                        }
                        
                        Utils.showNotification('Данные обновлены. Фильтры сброшены.', 'warning');
                        return;
                    }
                    
                    this.applyState(state);
                    Utils.showNotification('Настройки восстановлены из ссылки', 'success');
                    
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                } catch (error) {
                    console.error('Ошибка применения состояния:', error);
                    Utils.showNotification('Ошибка загрузки настроек', 'error');
                }
            },
            
            applyState: function(state) {
                activeFilters.status = new Set(state.filters.status);
                activeFilters.district = new Set(state.filters.district);
                activeFilters.floors = { ...state.filters.floors };
                activeFilters.flatsPerEntrance = { ...state.filters.flatsPerEntrance };
                
                currentPercentage = state.percentage;
                
                hiddenBuildings = new Set(state.hiddenBuildings);
                
                if (state.userMarkers && state.userMarkers.length > 0) {
                    MapModule.userMarkers = state.userMarkers;
                    MapModule.saveUserMarkers();
                    MapModule.renderUserMarkers();
                }
                
                this.updateUIFromState(state);
                
                FilterModule.applyFiltersDebounced();
            },
            
            updateUIFromState: function(state) {
                this.updateFilterCheckboxes('status-filter', state.filters.status);
                this.updateFilterCheckboxes('desktop-status-filter', state.filters.status);
                
                this.updateFilterCheckboxes('district-filter', state.filters.district);
                this.updateFilterCheckboxes('desktop-district-filter', state.filters.district);
                
                this.updateRangeInput('floors-min', state.filters.floors.min);
                this.updateRangeInput('floors-max', state.filters.floors.max);
                this.updateRangeInput('desktop-floors-min', state.filters.floors.min);
                this.updateRangeInput('desktop-floors-max', state.filters.floors.max);
                
                this.updateRangeInput('flats-min', state.filters.flatsPerEntrance.min);
                this.updateRangeInput('flats-max', state.filters.flatsPerEntrance.max);
                this.updateRangeInput('desktop-flats-min', state.filters.flatsPerEntrance.min);
                this.updateRangeInput('desktop-flats-max', state.filters.flatsPerEntrance.max);
                
                const percentageSliders = [
                    'mobile-percentage-slider',
                    'desktop-percentage-slider'
                ];
                const percentageValues = [
                    'mobile-percentage-value',
                    'desktop-percentage-value'
                ];
                
                percentageSliders.forEach(sliderId => {
                    const slider = document.getElementById(sliderId);
                    if (slider) slider.value = state.percentage;
                });
                
                percentageValues.forEach(valueId => {
                    const value = document.getElementById(valueId);
                    if (value) value.textContent = `${state.percentage}%`;
                });
            },
            
            updateFilterCheckboxes: function(containerId, selectedValues) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectedValues.includes(checkbox.value);
                });
            },
            
            updateRangeInput: function(inputId, value) {
                const input = document.getElementById(inputId);
                if (input) {
                    input.value = value || '';
                }
            },
            
            copyShareableURL: async function() {
                const url = this.generateShareableURL();
                
                if (!url) {
                    Utils.showNotification('Не удалось создать ссылку', 'error');
                    return;
                }
                
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(url);
                    } else {
                        const textArea = document.createElement('textarea');
                        textArea.value = url;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                    }
                    
                    const message = `✅ Ссылка скопирована!\n\n⚠️ Внимание: ссылка временная.\nОна станет некорректной при обновлении данных в базе.`;
                    
                    if (isMobile) {
                        Utils.showNotification('Ссылка скопирована! (Временная)', 'success');
                    } else {
                        alert(message);
                    }
                    
                } catch (error) {
                    console.error('Ошибка копирования:', error);
                    Utils.showNotification('Ошибка копирования ссылки', 'error');
                }
            }
        };

        // ============================================================================
        // ГЛОБАЛЬНЫЕ ОБРАБОТЧИКИ
        // ============================================================================
        function handleHideCluster(buildingIds) {
            const ids = buildingIds.split(',').map(id => parseInt(id.trim()));
            ids.forEach(id => hiddenBuildings.add(id));
            HistoryModule.saveHideCluster(ids, ids.length);
            FilterModule.applyFiltersDebounced();
            if (map && map.balloon && map.balloon.isOpen()) map.balloon.close();
        }

        function handleHideBuilding(buildingId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const building = allBuildings.find(b => b.originalIndex === buildingId);
            if (building) {
                hiddenBuildings.add(buildingId);
                HistoryModule.saveHideBuilding(buildingId, building.address);
                FilterModule.applyFiltersDebounced();
                Utils.showNotification('Адрес скрыт', 'success');
                if (map && map.balloon && map.balloon.isOpen()) map.balloon.close();
            }
        }

        // ============================================================================
        // ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
        // ============================================================================
        async function initApp() {
            try {
                Utils.updateMainContentHeight();
                
                await MapModule.initMap();

                Utils.showNotification('Загрузка данных...', 'info');
                allBuildings = await DataModule.loadData();
                
                Utils.showNotification('Загрузка контактов...', 'info');
                // Загружаем контакты ТОЛЬКО из Google Sheets
                contacts = await DataModule.loadContacts();
                // console.log('Контакты после загрузки (ТОЛЬКО из Google Sheets):', contacts);
                
                StateModule.init(allBuildings);
                
                FilterModule.initFilters(allBuildings);
                PercentageModule.initPercentageSelector();
                
                HistoryModule.init();
                
                FilterModule.applyFilters();
                
                setupUIEvents();
                setupResponsive();
                
                if (!isMobile) {
                    Utils.setDesktopTab('filters');
                    FullscreenModule.init();
                } else {
                    Utils.setMobileView('map');
                }
                
                document.getElementById('loading-overlay').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                }, 300);
                
                appInitialized = true;
                
                Utils.showNotification('Приложение готово к работе', 'success');
            } catch (error) {
                console.error('Ошибка инициализации:', error);
                Utils.showNotification('Ошибка загрузки приложения', 'error');
                document.getElementById('loading-overview').style.display = 'none';
            }
        }

        function setupUIEvents() {
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabName = tab.dataset.tab;
                    Utils.setDesktopTab(tabName);
                });
            });
            
            document.querySelectorAll('.nav-button[data-view]').forEach(button => {
                button.addEventListener('click', () => {
                    const view = button.dataset.view;
                    Utils.setMobileView(view);
                });
            });
            
            const mobileReportBtn = document.getElementById('mobile-report-button');
            if (mobileReportBtn) {
                mobileReportBtn.addEventListener('click', () => {
                    if (isGeneratingReport) return;
                    ReportModule.showReportModal();
                });
            }
            
            document.getElementById('load-more')?.addEventListener('click', () => {
                ListModule.loadMoreBuildings(false);
            });
            
            document.getElementById('desktop-load-more')?.addEventListener('click', () => {
                ListModule.loadMoreBuildings(true);
            });
            
            const desktopReportBtn = document.getElementById('desktop-generate-report');
            if (desktopReportBtn) {
                desktopReportBtn.addEventListener('click', () => {
                    if (isGeneratingReport) return;
                    ReportModule.showReportModal();
                });
            }
            
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault();
                    HistoryModule.undo();
                }
            });
            
			const reportModal = document.getElementById('report-modal');
			const reportModalClose = document.getElementById('report-modal-close');
			const reportCopyBtn = document.getElementById('report-copy-btn');
			const reportDownloadBtn = document.getElementById('report-download-btn');
			const reportLinkBtn = document.getElementById('report-link-btn');
			const reportTelegramBtn = document.getElementById('report-telegram-btn');
			const reportEmailBtn = document.getElementById('report-email-btn');

			if (reportModalClose) {
				reportModalClose.addEventListener('click', () => {
					reportModal.classList.remove('active');
					document.getElementById('report-textarea').value = '';
				});
			}

			if (reportModal) {
				reportModal.addEventListener('click', (e) => {
					if (e.target === reportModal) {
						reportModal.classList.remove('active');
						document.getElementById('report-textarea').value = '';
					}
				});
			}

			if (reportCopyBtn) {
				reportCopyBtn.addEventListener('click', (e) => {
					e.stopPropagation();
					ReportModule.copyToClipboard();
				});
			}

			if (reportDownloadBtn) {
				reportDownloadBtn.addEventListener('click', (e) => {
					e.stopPropagation();
					ReportModule.downloadReport();
				});
			}
			
			if (reportLinkBtn) {
				reportLinkBtn.addEventListener('click', async (e) => {
					e.stopPropagation();
					try {
						await StateModule.copyShareableURL();
						document.getElementById('report-modal').classList.remove('active');
						document.getElementById('report-textarea').value = '';
					} catch (error) {
						console.error('Ошибка копирования ссылки:', error);
					}
				});
			}
			
			// Установка обработчиков для кнопок Telegram и Email
			// Они также устанавливаются в updateShareButtonsUI, но для надежности установим здесь тоже
			if (reportTelegramBtn) {
				reportTelegramBtn.addEventListener('click', (e) => {
					e.stopPropagation();
					ReportModule.shareViaTelegram();
				});
			}
			
			if (reportEmailBtn) {
				// Удаляем все старые обработчики
				const newEmailBtn = reportEmailBtn.cloneNode(true);
				reportEmailBtn.parentNode.replaceChild(newEmailBtn, reportEmailBtn);
				
				newEmailBtn.addEventListener('click', (e) => {
					e.preventDefault();
					e.stopPropagation();
					// console.log('Кнопка Email нажата');
					ReportModule.shareViaEmail();
				});
				// Также добавляем обработчик для touch устройств
				newEmailBtn.addEventListener('touchend', (e) => {
					e.preventDefault();
					e.stopPropagation();
					// console.log('Кнопка Email нажата (touch)');
					ReportModule.shareViaEmail();
				});
			}
	
			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape' && document.getElementById('report-modal').classList.contains('active')) {
					document.getElementById('report-modal').classList.remove('active');
					document.getElementById('report-textarea').value = '';
				}
			});
		}

        function updateResponsive() {
            const nowIsMobile = window.innerWidth <= 768;
            
            if (nowIsMobile !== isMobile) {
                let oldCenter, oldZoom;
                if (map) {
                    oldCenter = map.getCenter();
                    oldZoom = map.getZoom();
                }
                
                isMobile = nowIsMobile;
                
                MapModule.initMap().then(() => {
                    if (oldCenter && oldZoom) {
                        map.setCenter(oldCenter, oldZoom);
                    }
                    
                    if (displayedBuildings.length > 0) {
                        MapModule.renderBuildings(displayedBuildings);
                    }
                });
                
                if (isMobile) {
                    if (!currentView) {
                        currentView = 'map';
                    }
                    Utils.setMobileView(currentView);
                } else {
                    if (appInitialized) {
                        Utils.setDesktopTab(currentDesktopTab);
                        FullscreenModule.init();
                    }
                }
            }
            
            if (isMobile) {
                Utils.updateMainContentHeight();
                
                if (currentView === 'map') {
                    document.getElementById('map-container').style.display = 'block';
                    document.getElementById('mobile-panel').style.display = 'none';
                    if (map) {
                        setTimeout(() => map.container.fitToViewport(), 100);
                    }
                } else {
                    document.getElementById('map-container').style.display = 'none';
                    document.getElementById('mobile-panel').style.display = 'flex';
                    
                    const filtersTab = document.getElementById('mobile-filters-tab');
                    const listTab = document.getElementById('mobile-list-tab');
                    if (currentView === 'filters') {
                        filtersTab.style.display = 'flex';
                        listTab.style.display = 'none';
                    } else if (currentView === 'list') {
                        filtersTab.style.display = 'none';
                        listTab.style.display = 'flex';
                    }
                }
            }
            
            if (map) {
                setTimeout(() => map.container.fitToViewport(), 100);
            }
        }

        function setupResponsive() {
            let resizeTimeout;
            
            function handleResize() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(updateResponsive, 250);
            }
            
            window.addEventListener('resize', handleResize);
            window.addEventListener('orientationchange', () => {
                setTimeout(updateResponsive, 300);
            });
            
            window.addEventListener('load', () => {
                setTimeout(updateResponsive, 100);
            });
            
            document.querySelectorAll('input[type="number"], input[type="text"], textarea').forEach(input => {
                input.addEventListener('focus', () => {
                    clearTimeout(resizeTimeout);
                });
                
                input.addEventListener('blur', () => {
                    resizeTimeout = setTimeout(updateResponsive, 300);
                });
            });
            
            updateResponsive();
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
