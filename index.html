<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ —Å—Ç–µ–Ω–¥–æ–≤ —É –¥–æ–º–æ—Ñ–æ–Ω–æ–≤ - –†—è–∑–∞–Ω—å</title>
    
    <!-- –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã API -->
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .map-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .floating-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 450px;
            max-width: calc(100vw - 40px);
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 40px);
        }

        .panel-header {
            padding: 20px;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            cursor: pointer;
            user-select: none;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .panel-header:hover {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
        }

        .header-title {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            position: relative;
            min-height: 50px;
        }

        .header-main {
            flex: 1;
        }

        .header-title-main {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 5px;
            line-height: 1.2;
            color: white;
        }

        .header-title-sub {
            font-size: 15px;
            opacity: 0.95;
            line-height: 1.3;
            color: rgba(255, 255, 255, 0.95);
        }

        .toggle-icon {
            position: absolute;
            top: 0;
            right: 0;
            transition: transform 0.3s ease;
            font-size: 14px;
            opacity: 0.9;
            background: rgba(255, 255, 255, 0.2);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-stats {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .stat-line {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
            line-height: 1.4;
            font-size: 14px;
            color: white;
        }

        .stat-label {
            font-size: 13px;
            opacity: 1;
            white-space: nowrap;
            font-weight: 500;
            color: white;
        }

        .stat-label.stat-label-dim {
            opacity: 0.7;
            font-weight: 400;
        }

        .stat-value {
            font-size: 15px;
            font-weight: 700;
            white-space: nowrap;
            color: white;
        }

        .stat-value.stat-value-dim {
            opacity: 0.7;
            font-weight: 500;
        }

        .stat-value.price-value {
            font-weight: 800;
            color: white;
        }

        .stat-separator {
            margin: 0 8px;
            opacity: 0.5;
            font-size: 13px;
            font-weight: 300;
            color: white;
        }

        .stat-or {
            margin: 0 8px;
            font-size: 12px;
            opacity: 0.8;
            font-weight: 400;
            color: white;
        }

        .price-message {
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #FFEB3B;
            text-align: center;
            width: 100%;
        }

        .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
        }

        .panel-content.collapsed {
            display: none;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
            min-height: 48px;
        }

        .tab-button {
            flex: 1;
            padding: 14px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-button:hover {
            background: #f0f0f0;
            color: #333;
        }

        .tab-button.active {
            border-bottom-color: #2196F3;
            color: #2196F3;
            background: white;
            font-weight: bold;
        }

        .tab-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-pane {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-pane.active {
            display: flex;
        }

        .filters-container {
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .filter-group {
            margin-bottom: 5px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .filter-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            height: 42px;
            box-sizing: border-box;
        }

        #status-filters.checkbox-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            padding-right: 5px;
        }

        #district-filters.checkbox-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: none;
            overflow-y: visible;
            padding-right: 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 6px 0;
        }

        .checkbox-item input {
            margin-right: 10px;
            cursor: pointer;
            flex-shrink: 0;
            width: 18px;
            height: 18px;
        }

        .checkbox-item label {
            font-weight: normal;
            margin-bottom: 0;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }

        .range-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .range-input-group {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .range-button {
            display: none;
            width: 36px;
            height: 42px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            color: #333;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .range-button:hover {
            background: #e9ecef;
            border-color: #ccc;
        }

        .range-button:active {
            background: #dee2e6;
            transform: translateY(1px);
        }

        .range-inputs input {
            flex: 1;
            min-width: 0;
            padding: 10px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            height: 42px;
            box-sizing: border-box;
            text-align: center;
        }

        .range-info {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .available-values {
            cursor: pointer;
            color: #2196F3;
            text-decoration: underline;
            font-size: 12px;
            background: none;
            border: none;
            padding: 2px 4px;
        }

        .filter-button {
            padding: 12px;
            background: #757575;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
            margin-top: 5px;
            height: 44px;
        }

        .filter-button:hover {
            background: #666;
        }

        .precise-settings-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .precise-settings-controls {
            padding: 15px 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* –ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä */
        .percentage-filter {
            margin-bottom: 5px;
        }

        .percentage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        #percentage-value {
            font-weight: bold;
            color: #2196F3;
            min-width: 45px;
            display: inline-block;
        }

        .percentage-info {
            font-size: 12px;
            color: #666;
        }

        .percentage-slider {
            --thumb-color: #2196F3;
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #f44336, #FF9800, #4CAF50);
            outline: none;
            border-radius: 3px;
            margin: 15px 0;
        }

        .percentage-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--thumb-color);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }

        .percentage-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .percentage-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--thumb-color);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .slider-ticks {
            display: flex;
            justify-content: space-between;
            margin-top: -5px;
            font-size: 11px;
            color: #666;
        }

        .slider-ticks span {
            position: relative;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .slider-ticks span:hover {
            background: #f0f0f0;
            color: #2196F3;
        }

        .building-item {
            position: relative;
            padding: 15px 20px;
            padding-right: 60px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .building-item:hover {
            background: #f5f5f5;
        }

        .building-item.selected {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
        }

        .building-item.hidden {
            background-color: #fafafa;
            opacity: 0.7;
            position: relative;
        }

        .building-item.hidden::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 49%, rgba(244, 67, 54, 0.1) 50%, transparent 51%);
            pointer-events: none;
        }

        .building-item.hidden .building-address {
            text-decoration: line-through;
            color: #999;
        }

        .building-item.hidden .building-info {
            color: #999;
        }

        .building-address {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
            line-height: 1.3;
        }

        .building-info {
            font-size: 12px;
            color: #666;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-free {
            color: #4CAF50;
            font-weight: bold;
        }

        .status-busy {
            color: #f44336;
            font-weight: bold;
        }

        .hide-building-btn {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .hide-building-btn:hover {
            background: #ffebee;
            color: #f44336;
            border-color: #f44336;
            transform: translateY(-50%) scale(1.05);
        }

        .hide-building-btn.hidden {
            background: #e8f5e9;
            color: #4CAF50;
            border-color: #4CAF50;
        }

        .hide-building-btn.hidden:hover {
            background: #c8e6c9;
            color: #2e7d32;
            border-color: #2e7d32;
        }

        .hide-building-btn::after {
            content: '‚úï';
            font-size: 16px;
        }

        .hide-building-btn.hidden::after {
            content: '‚Üª';
            font-size: 18px;
        }

        .hide-building-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        #buildings-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .values-popup {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none;
        }

        .values-popup.show {
            display: block;
        }

        .value-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .value-item:hover {
            background: #f0f0f0;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            gap: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –±–∞–ª—É–Ω–æ–≤ */
        .custom-balloon {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 0;
            width: 450px;
            max-width: calc(100vw - 60px);
            min-width: 320px;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            max-height: 500px;
            overflow: hidden !important;
            height: auto !important;
        }

        .balloon-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            flex-shrink: 0;
        }

        .balloon-title {
            font-size: 18px;
            font-weight: 700;
            color: #2196F3;
            line-height: 1.2;
            word-break: break-word;
        }

        .balloon-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            max-height: 400px;
        }

        .balloon-actions {
            padding: 12px 15px;
            border-top: 1px solid #e0e0e0;
            background: white;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .balloon-button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            height: 40px;
        }

        .balloon-button.hide {
            background: #f44336;
            color: white;
            border: 1px solid #d32f2f;
        }

        .balloon-button.hide:hover {
            background: #d32f2f;
            border-color: #c62828;
            transform: translateY(-1px);
        }

        .single-building-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
            padding: 15px;
        }

        .info-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .info-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .info-value.status {
            font-weight: bold;
        }

        .info-value.status-free {
            color: #4CAF50;
        }

        .info-value.status-busy {
            color: #f44336;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #4CAF50;
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-size: 14px;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
        }

        .notification.error {
            background: #f44336;
        }

        .notification.info {
            background: #2196F3;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–Ω–æ–≥–æ –±–∞–ª—É–Ω–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø */
        .cluster-balloon {
            display: flex !important;
            flex-direction: column !important;
            height: auto !important;
            min-height: 200px !important;
            max-height: 500px !important;
            padding: 0 !important;
            overflow: hidden !important;
            width: 450px !important;
            max-width: 450px !important;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å–æ —Å–∫—Ä–æ–ª–ª–æ–º */
        .cluster-table-container {
            flex: 1 !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            min-height: 100px !important;
            max-height: 400px !important;
            padding: 0 !important;
            background: white !important;
        }

        .cluster-table {
            width: 100% !important;
            border-collapse: collapse !important;
            font-size: 13px !important;
            table-layout: fixed !important;
        }

        .cluster-table thead {
            position: sticky !important;
            top: 0 !important;
            background: #f8f9fa !important;
            z-index: 10 !important;
            height: 40px !important;
        }

        .cluster-table th {
            padding: 10px 8px !important;
            text-align: left !important;
            border-bottom: 2px solid #e0e0e0 !important;
            font-weight: 600 !important;
            color: #333 !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        .cluster-table td {
            padding: 10px 8px !important;
            border-bottom: 1px solid #f0f0f0 !important;
            vertical-align: middle !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            height: 42px !important;
            line-height: 1.4 !important;
        }

        .cluster-table tr:last-child td {
            border-bottom: none !important;
        }

        .cluster-table tr:hover {
            background: #f5f5f5 !important;
        }

        /* –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –ö–û–õ–û–ù–ö–ò –¢–ê–ë–õ–ò–¶–´ */
        .cluster-table .address-cell {
            width: 60% !important;
            max-width: none !important;
            min-width: 200px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            padding-right: 15px !important;
        }

        .cluster-table .stands-cell {
            width: 20% !important;
            min-width: 40px !important;
            max-width: 50px !important;
            text-align: center !important;
            font-weight: 600 !important;
            font-size: 13px !important;
            color: #333 !important;
            padding: 0 4px !important;
        }

        .cluster-table .status-cell {
            width: 20% !important;
            min-width: 30px !important;
            max-width: 40px !important;
            text-align: center !important;
            padding: 0 4px !important;
        }

        /* –¶–≤–µ—Ç–Ω—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ */
        .status-dot {
            display: inline-block !important;
            width: 12px !important;
            height: 12px !important;
            border-radius: 50% !important;
            vertical-align: middle !important;
            border: 1.5px solid rgba(0,0,0,0.1) !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
        }

        .status-dot.free {
            background-color: #4CAF50 !important;
            border-color: #2e7d32 !important;
        }

        .status-dot.busy {
            background-color: #f44336 !important;
            border-color: #c62828 !important;
        }

        /* –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã—Ç–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ */
        .cluster-actions {
            padding: 12px 15px !important;
            border-top: 1px solid #e0e0e0 !important;
            background: #f8f9fa !important;
            flex-shrink: 0 !important;
            text-align: center !important;
        }

        .cluster-hide-btn {
            background: #f44336 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 12px 16px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            width: 100% !important;
            transition: all 0.2s ease !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 8px !important;
            box-sizing: border-box !important;
            text-align: center !important;
        }

        .cluster-hide-btn:hover {
            background: #d32f2f !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
        }

        .cluster-hide-btn:active {
            transform: translateY(0) !important;
        }

        /* –ë–ª–æ–∫ –ø–æ–¥–≥—Ä—É–∑–∫–∏ –∞–¥—Ä–µ—Å–æ–≤ - –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ô */
        .cluster-more-info {
            position: sticky !important;
            bottom: 0 !important;
            background: white !important;
            z-index: 20 !important;
            border-top: 1px solid #e0e0e0 !important;
            padding: 10px 15px !important;
            text-align: center !important;
            margin-top: auto !important;
        }

        /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç –¥–ª—è –±–∞–ª—É–Ω–æ–≤ */
        .ymaps-balloon__content,
        .ymaps-balloon__layout,
        .ymaps-balloon__content ymaps {
            overflow: hidden !important;
            height: auto !important;
            width: auto !important;
            max-height: none !important;
            max-width: none !important;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞ */
        .copy-report-button {
            background: #4CAF50 !important;
            color: white !important;
            border: none !important;
            margin-top: 5px !important;
        }

        .copy-report-button:hover {
            background: #388E3C !important;
        }

        .copy-report-button:active {
            background: #2E7D32 !important;
            transform: translateY(1px);
        }

        .copy-report-button.copying {
            background: #2196F3 !important;
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —Ç–æ—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */
        .precise-button-container {
            padding: 0 20px 15px 20px;
        }

        /* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 480px) {
            .custom-balloon {
                width: calc(100vw - 40px) !important;
                max-width: calc(100vw - 40px) !important;
                min-width: 280px !important;
            }
            
            .cluster-balloon {
                width: calc(100vw - 40px) !important;
                max-width: calc(100vw - 40px) !important;
            }
            
            .cluster-table .address-cell {
                width: 70% !important;
                min-width: 150px !important;
            }
            
            .cluster-table .stands-cell {
                width: 20% !important;
                min-width: 35px !important;
            }
            
            .cluster-table .status-cell {
                width: 10% !important;
                min-width: 25px !important;
            }
            
            .cluster-hide-btn {
                padding: 10px 12px !important;
                font-size: 13px !important;
            }
        }

        /* –§–∏–∫—Å –¥–ª—è overflow –±–∞–ª—É–Ω–æ–≤ */
        .ymaps-balloon__close {
            z-index: 1000 !important;
        }
		
		/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —Ç–æ—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */
		.precise-buttons-wrapper {
			padding: 15px 20px;
			display: flex;
			flex-direction: column;
			gap: 10px;
			border-top: 1px solid #e0e0e0;
			background: white;
		}

		.precise-buttons-wrapper .filter-button {
			width: 100%;
			margin-top: 0;
		}
		
		/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ */
		.mode-indicator {
			padding: 8px 12px;
			background: #f8f9fa;
			border-radius: 6px;
			font-size: 12px;
			color: #666;
			text-align: center;
			margin: 10px 15px 15px 15px;
			border: 1px solid #e0e0e0;
			font-weight: 500;
		}

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ" */
        .show-all-button {
            cursor: pointer;
            text-align: center;
            padding: 15px;
            color: #2196F3;
            font-size: 13px;
            font-weight: 500;
            background: #f8f9fa;
            border-radius: 6px;
            margin: 10px 15px;
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .show-all-button:hover {
            background: #e3f2fd;
            border-color: #2196F3;
        }

    </style>
</head>
<body>
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã -->
    <div class="map-container">
        <div id="map"></div>
        
        <!-- –ü–∞–Ω–µ–ª—å –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç—ã -->
        <div class="floating-panel" id="floating-panel">
            <!-- –®–∞–ø–∫–∞ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π -->
            <div class="panel-header" id="panel-header">
                <div class="header-title">
                    <div class="header-main">
                        <div class="header-title-main">PR –ú–ê–†–ö–ï–¢ –†—è–∑–∞–Ω—å</div>
                        <div class="header-title-sub">–ö–∞—Ä—Ç–∞ —Å—Ç–µ–Ω–¥–æ–≤ —É –¥–æ–º–æ—Ñ–æ–Ω–æ–≤</div>
                    </div>
                    <span class="toggle-icon" id="toggle-icon">‚ñº</span>
                </div>
                <div class="header-stats">
                    <!-- –°—Ç—Ä–æ–∫–∞ 3: –ó–¥–∞–Ω–∏–π –Ω–∞ –∫–∞—Ä—Ç–µ -->
                    <div class="stat-line">
                        <span class="stat-label">–ó–¥–∞–Ω–∏–π –Ω–∞ –∫–∞—Ä—Ç–µ: </span>
                        <span class="stat-value" id="stats-filtered">0</span>
                        <span class="stat-label stat-label-dim"> –∏–∑ </span>
                        <span class="stat-value stat-value-dim" id="stats-total">0</span>
                    </div>
                    
                    <!-- –°—Ç—Ä–æ–∫–∞ 4: –ö–≤–∞—Ä—Ç–∏—Ä –∏ —Å—Ç–µ–Ω–¥–æ–≤ -->
                    <div class="stat-line">
                        <span class="stat-label">–ö–≤–∞—Ä—Ç–∏—Ä: </span>
                        <span class="stat-value" id="stats-flats">0</span>
                        <span class="stat-label stat-label-dim"> –∏–∑ </span>
                        <span class="stat-value stat-value-dim" id="stats-flats-all">0</span>
                        <span class="stat-separator">|</span>
                        <span class="stat-label">–°—Ç–µ–Ω–¥–æ–≤: </span>
                        <span class="stat-value" id="stats-stands">0</span>
                        <span class="stat-label stat-label-dim"> –∏–∑ </span>
                        <span class="stat-value stat-value-dim" id="stats-stands-all">0</span>
                    </div>
                    
                    <!-- –°—Ç—Ä–æ–∫–∞ 5: –°—Ç–æ–∏–º–æ—Å—Ç—å –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
                    <div class="stat-line" id="price-line">
                        <span class="stat-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –º–µ—Å—è—Ü: </span>
                        <span class="stat-value price-value" id="stats-price">0 000</span>
                        <span class="stat-currency">—Ä.</span>
                        <span class="stat-or">–∏–ª–∏</span>
                        <span class="stat-value price-value" id="stats-price-per-flat">0.00</span>
                        <span class="stat-label"> —Ä. –∑–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É</span>
                    </div>
                    <div class="stat-line" id="message-line" style="display: none;">
                        <span class="price-message">–í–´–ë–ï–†–ò–¢–ï –ë–û–õ–¨–®–ï –ó–î–ê–ù–ò–ô –î–õ–Ø –†–ê–°–ß–Å–¢–ê</span>
                    </div>
                </div>
            </div>

            <!-- –†–∞—Å–∫—Ä—ã–≤–∞—é—â–∞—è—Å—è —á–∞—Å—Ç—å —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ -->
            <div class="panel-content collapsed" id="panel-content">
                <!-- –í–∫–ª–∞–¥–∫–∏ -->
                <div class="tabs">
                    <button class="tab-button active" data-tab="basic">–ë–∞–∑–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</button>
                    <button class="tab-button" data-tab="precise">–¢–æ—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                </div>

                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
                <div class="tab-content">
                    <!-- –í–∫–ª–∞–¥–∫–∞ –±–∞–∑–æ–≤—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
                    <div class="tab-pane active" id="basic-tab">
                        <div class="filters-container">
                            <!-- –°—Ç–∞—Ç—É—Å -->
                            <div class="filter-group">
                                <label>–°—Ç–∞—Ç—É—Å</label>
                                <div class="checkbox-container" id="status-filters">
                                    <!-- –ß–µ–∫–±–æ–∫—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </div>
                            </div>

                            <!-- –†–∞–π–æ–Ω—ã -->
                            <div class="filter-group">
                                <label>–†–∞–π–æ–Ω</label>
                                <div class="checkbox-container" id="district-filters">
                                    <!-- –ß–µ–∫–±–æ–∫—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </div>
                            </div>

                            <!-- –≠—Ç–∞–∂–Ω–æ—Å—Ç—å –∑–¥–∞–Ω–∏–π -->
                            <div class="filter-group">
                                <label>–≠—Ç–∞–∂–Ω–æ—Å—Ç—å –∑–¥–∞–Ω–∏–π</label>
                                <div class="range-inputs">
                                    <div class="range-input-group">
                                        <button type="button" class="range-button minus" data-target="min-floors">-</button>
                                        <input type="number" id="min-floors" placeholder="–û—Ç" min="1">
                                        <button type="button" class="range-button plus" data-target="min-floors">+</button>
                                    </div>
                                    <div class="range-input-group">
                                        <button type="button" class="range-button minus" data-target="max-floors">-</button>
                                        <input type="number" id="max-floors" placeholder="–î–æ" min="1">
                                        <button type="button" class="range-button plus" data-target="max-floors">+</button>
                                    </div>
                                </div>
                                <div class="range-info">
                                    <span id="floors-range">–î–æ—Å—Ç—É–ø–Ω–æ: 1-10</span>
                                    <button class="available-values" data-field="floors">–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è</button>
                                </div>
                            </div>

                            <!-- –ö–≤–∞—Ä—Ç–∏—Ä –≤ –ø–æ–¥—ä–µ–∑–¥–µ -->
                            <div class="filter-group">
                                <label>–ö–≤–∞—Ä—Ç–∏—Ä –≤ –ø–æ–¥—ä–µ–∑–¥–µ</label>
                                <div class="range-inputs">
                                    <div class="range-input-group">
                                        <button type="button" class="range-button minus" data-target="min-flats-per-entrance">-</button>
                                        <input type="number" id="min-flats-per-entrance" placeholder="–û—Ç" min="1">
                                        <button type="button" class="range-button plus" data-target="min-flats-per-entrance">+</button>
                                    </div>
                                    <div class="range-input-group">
                                        <button type="button" class="range-button minus" data-target="max-flats-per-entrance">-</button>
                                        <input type="number" id="max-flats-per-entrance" placeholder="–î–æ" min="1">
                                        <button type="button" class="range-button plus" data-target="max-flats-per-entrance">+</button>
                                    </div>
                                </div>
                                <div class="range-info">
                                    <span id="flats-range">–î–æ—Å—Ç—É–ø–Ω–æ: 1-100</span>
                                    <button class="available-values" data-field="flatsPerEntrance">–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è</button>
                                </div>
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ -->
                            <button id="reset-all-filters" class="filter-button">–°–±—Ä–æ—Å–∏—Ç—å –±–∞–∑–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ —Ç–æ—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                            
                            <!-- –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞ -->
                            <button id="copy-report-basic" class="filter-button copy-report-button">
                                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—á—ë—Ç
                            </button>
                        </div>
                    </div>

                    <!-- –í–∫–ª–∞–¥–∫–∞ —Ç–æ—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
                    <div class="tab-pane" id="precise-tab">
                        <div class="precise-settings-container">
                            <div class="precise-settings-controls">
                                <!-- –ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä -->
                                <div class="percentage-filter">
                                    <div class="percentage-header">
                                        <label for="percentage-slider">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–¥–∞–Ω–∏–π: <span id="percentage-value">100%</span></label>
                                        <div class="percentage-info">
                                            <span id="percentage-count">0/0</span>
                                        </div>
                                    </div>
                                    <input type="range" id="percentage-slider" class="percentage-slider" 
                                           min="1" max="100" step="1" value="100">
                                    <div class="slider-ticks">
                                        <span>1%</span>
                                        <span>25%</span>
                                        <span>50%</span>
                                        <span>75%</span>
                                        <span>100%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- –°–ø–∏—Å–æ–∫ –∑–¥–∞–Ω–∏–π -->
                            <div id="buildings-list">
                                <!-- –°–ø–∏—Å–æ–∫ –∑–¥–∞–Ω–∏–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </div>
                            
							<!-- –ö–Ω–æ–ø–∫–∏ –≤ —Ç–æ—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö -->
							<div class="precise-buttons-wrapper">
								<button id="reset-precise-settings" class="filter-button">
									–°–±—Ä–æ—Å–∏—Ç—å —Ç–æ—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
								</button>
								<button id="copy-report-precise" class="filter-button copy-report-button">
									üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—á—ë—Ç
								</button>
							</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="notifications-container"></div>

    <!-- –ü–æ–ø–∞–ø –¥–ª—è –≤—ã–±–æ—Ä–∞ –∑–Ω–∞—á–µ–Ω–∏–π -->
    <div id="values-popup" class="values-popup"></div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const CONFIG = {
            SHEET_ID: '1jZsHbNXVmvNRjmh_p1pLFl3G3oLgD0sFas8L4EDexiI',
            SHEET_NAME: 'Filter',
            MAP_CENTER: [54.6416, 39.7126],
            MAP_ZOOM: 11,
            FREE_STATUS: '–°–≤–æ–±–æ–¥–Ω–æ',
            DEBOUNCE_DELAY: 500,
            DEFAULT_CLUSTER_LIMIT: 20,
            LOAD_MORE_STEP: 20,
            DEFAULT_RENDER_LIMIT: 100
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map;
        let objectManager;
        let allBuildings = [];
        let filteredBuildings = [];
        let preciseFilteredBuildings = [];
        let activeFilters = {
            status: new Set(),
            district: new Set()
        };
        let availableValues = {
            floors: [],
            flatsPerEntrance: []
        };
        let isPanelExpanded = false;
        let displayPercentage = 100;
        let hiddenInBasicFilters = new Set();
        let hiddenInPreciseSettings = new Set();
        let selectedBuildings = new Set();
        let lastOpenedClusterId = null;
        let lastOpenedObjectId = null;
        let currentClusterObjects = [];
        let buildingsByOriginalIndex = {};
        let mapUpdateRafId = null;
        let currentClusterState = {
            clusterId: null,
            allBuildings: [],
            displayedBuildings: [],
            offset: 0,
            limit: CONFIG.DEFAULT_CLUSTER_LIMIT
        };
        let activeBalloon = null;
        let percentageDebounceTimer = null;
        let currentMode = 'basic';
        let currentRenderLimit = CONFIG.DEFAULT_RENDER_LIMIT;
        let isAppActive = true;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const elements = {
            loadingOverlay: document.getElementById('loading-overlay'),
            floatingPanel: document.getElementById('floating-panel'),
            map: document.getElementById('map'),
            panelHeader: document.getElementById('panel-header'),
            panelContent: document.getElementById('panel-content'),
            toggleIcon: document.getElementById('toggle-icon'),
            tabButtons: document.querySelectorAll('.tab-button'),
            tabPanes: document.querySelectorAll('.tab-pane'),
            buildingsList: document.getElementById('buildings-list'),
            statusFilters: document.getElementById('status-filters'),
            districtFilters: document.getElementById('district-filters'),
            minFloors: document.getElementById('min-floors'),
            maxFloors: document.getElementById('max-floors'),
            minFlatsPerEntrance: document.getElementById('min-flats-per-entrance'),
            maxFlatsPerEntrance: document.getElementById('max-flats-per-entrance'),
            resetAllFilters: document.getElementById('reset-all-filters'),
            percentageSlider: document.getElementById('percentage-slider'),
            percentageValue: document.getElementById('percentage-value'),
            percentageCount: document.getElementById('percentage-count'),
            resetPreciseSettings: document.getElementById('reset-precise-settings'),
            statsTotal: document.getElementById('stats-total'),
            statsFiltered: document.getElementById('stats-filtered'),
            statsStands: document.getElementById('stats-stands'),
            statsFlats: document.getElementById('stats-flats'),
            statsFlatsAll: document.getElementById('stats-flats-all'),
            statsStandsAll: document.getElementById('stats-stands-all'),
            statsPrice: document.getElementById('stats-price'),
            statsPricePerFlat: document.getElementById('stats-price-per-flat'),
            priceLine: document.getElementById('price-line'),
            messageLine: document.getElementById('message-line'),
            floorsRange: document.getElementById('floors-range'),
            flatsRange: document.getElementById('flats-range'),
            valuesPopup: document.getElementById('values-popup'),
            copyReportBasic: document.getElementById('copy-report-basic'),
            copyReportPrecise: document.getElementById('copy-report-precise')
        };

        // –£—Ç–∏–ª–∏—Ç—ã —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏
        const Utils = {
            debounce(func, wait) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            },

            optimizedDebounce(func, wait) {
                let timeout;
                let animationFrame;
                
                return function(...args) {
                    const context = this;
                    
                    const later = () => {
                        timeout = null;
                        animationFrame = requestAnimationFrame(() => func.apply(context, args));
                    };
                    
                    clearTimeout(timeout);
                    cancelAnimationFrame(animationFrame);
                    timeout = setTimeout(later, wait);
                };
            },

            escapeHtml(text) {
                if (text === null || text === undefined) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            formatNumber(num) {
                return new Intl.NumberFormat('ru-RU').format(num);
            },

            formatPrice(num) {
                return new Intl.NumberFormat('ru-RU', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(num);
            },

            showNotification(message, type = 'success') {
                if (!isAppActive) return;
                
                const container = document.getElementById('notifications-container') || document.body;
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    if (!isAppActive) return;
                    notification.style.animation = 'slideOut 0.3s ease-out forwards';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            },

            runIdle(callback, timeout = 100) {
                if ('requestIdleCallback' in window) {
                    return requestIdleCallback(callback, { timeout });
                } else {
                    return requestAnimationFrame(callback);
                }
            },

            batchDOMUpdates(elements, container, renderFunction) {
                const fragment = document.createDocumentFragment();
                const batchSize = 50;
                let processed = 0;
                
                function processBatch() {
                    const end = Math.min(processed + batchSize, elements.length);
                    
                    for (let i = processed; i < end; i++) {
                        const element = renderFunction(elements[i], i);
                        if (element) fragment.appendChild(element);
                    }
                    processed = end;
                    
                    if (processed < elements.length) {
                        requestAnimationFrame(() => {
                            processBatch();
                        });
                    } else {
                        container.appendChild(fragment);
                    }
                }
                
                processBatch();
            }
        };

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞
        function generateReport() {
            const now = new Date();
            const formattedDate = now.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            let report = `–û–¢–ß–ï–¢ –ü–û –°–¢–ï–ù–î–ê–ú –£ –î–û–ú–û–§–û–ù–û–í - –†–Ø–ó–ê–ù–¨\n`;
            report += `–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω: ${formattedDate}\n\n`;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            report += `=== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===\n`;
            report += `–ó–¥–∞–Ω–∏–π –Ω–∞ –∫–∞—Ä—Ç–µ: ${elements.statsFiltered.textContent} –∏–∑ ${elements.statsTotal.textContent}\n`;
            report += `–ö–≤–∞—Ä—Ç–∏—Ä: ${elements.statsFlats.textContent} –∏–∑ ${elements.statsFlatsAll.textContent}\n`;
            report += `–°—Ç–µ–Ω–¥–æ–≤: ${elements.statsStands.textContent} –∏–∑ ${elements.statsStandsAll.textContent}\n`;
            
            // –°—Ç–æ–∏–º–æ—Å—Ç—å
            const totalStands = parseInt(elements.statsStands.textContent.replace(/\s/g, ''));
            if (totalStands >= 100) {
                report += `–°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –º–µ—Å—è—Ü: ${elements.statsPrice.textContent} —Ä.\n`;
                report += `–ò–ª–∏ ${elements.statsPricePerFlat.textContent} —Ä. –∑–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É\n`;
            } else {
                report += `–°—Ç–æ–∏–º–æ—Å—Ç—å: —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª—å—à–µ –∑–¥–∞–Ω–∏–π –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞\n`;
            }
            
            // –§–∏–ª—å—Ç—Ä—ã
            report += `\n=== –§–ò–õ–¨–¢–†–´ ===\n`;
            report += `–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${displayPercentage}%\n`;
            
            if (activeFilters.status.size > 0) {
                report += `–°—Ç–∞—Ç—É—Å—ã: ${Array.from(activeFilters.status).join(', ')}\n`;
            }
            
            if (activeFilters.district.size > 0) {
                report += `–†–∞–π–æ–Ω—ã: ${Array.from(activeFilters.district).join(', ')}\n`;
            }
            
            if (elements.minFloors.value || elements.maxFloors.value) {
                report += `–≠—Ç–∞–∂–Ω–æ—Å—Ç—å: ${elements.minFloors.value || '1'} - ${elements.maxFloors.value || '10'}\n`;
            }
            
            if (elements.minFlatsPerEntrance.value || elements.maxFlatsPerEntrance.value) {
                report += `–ö–≤–∞—Ä—Ç–∏—Ä –≤ –ø–æ–¥—ä–µ–∑–¥–µ: ${elements.minFlatsPerEntrance.value || '1'} - ${elements.maxFlatsPerEntrance.value || '100'}\n`;
            }
            
            // –°–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
            report += `\n=== –°–ü–ò–°–û–ö –ê–î–†–ï–°–û–í ===\n`;
            if (preciseFilteredBuildings.length > 0) {
                preciseFilteredBuildings.forEach((building, index) => {
                    const statusText = building.status === CONFIG.FREE_STATUS ? '–°–≤–æ–±–æ–¥–Ω–æ' : '–ó–∞–Ω—è—Ç–æ';
                    report += `${building.address}, ${statusText}, ${building.district || '‚Äî'}, ${building.entrances || '‚Äî'}, ${building.flats || '‚Äî'}`;
                    if (index < preciseFilteredBuildings.length - 1) {
                        report += '\n';
                    }
                });
            } else {
                report += `–ù–µ—Ç –∞–¥—Ä–µ—Å–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º\n`;
            }
            
            report += `\n\n=== –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø ===\n`;
            report += `1. –û—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Å–∏—Å—Ç–µ–º–æ–π PR –ú–ê–†–ö–ï–¢ –†—è–∑–∞–Ω—å\n`;
            report += `2. –î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã –Ω–∞ –º–æ–º–µ–Ω—Ç —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞\n`;
            report += `3. –î–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º\n\n`;
            report += `¬© PR –ú–ê–†–ö–ï–¢ –†—è–∑–∞–Ω—å - –ö–∞—Ä—Ç–∞ —Å—Ç–µ–Ω–¥–æ–≤ —É –¥–æ–º–æ—Ñ–æ–Ω–æ–≤`;
            
            return report;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        async function copyReportToClipboard() {
            try {
                const report = generateReport();
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π Clipboard API
                await navigator.clipboard.writeText(report);
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                const buttons = document.querySelectorAll('.copy-report-button');
                buttons.forEach(btn => {
                    btn.classList.add('copying');
                    btn.innerHTML = '‚úì –û—Ç—á—ë—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!';
                    
                    setTimeout(() => {
                        btn.classList.remove('copying');
                        btn.innerHTML = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—á—ë—Ç';
                    }, 2000);
                });
                
                Utils.showNotification('–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                
                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                try {
                    const report = generateReport();
                    const textArea = document.createElement('textarea');
                    textArea.value = report;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        Utils.showNotification('–†–∞—Å—á—ë—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥)', 'info');
                    } else {
                        Utils.showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—á—ë—Ç', 'error');
                    }
                } catch (fallbackErr) {
                    Utils.showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—Å—á—ë—Ç–∞', 'error');
                }
            }
        }

        // –ê–ª–≥–æ—Ä–∏—Ç–º –ë—Ä–µ–∑–µ–Ω—Ö—ç–º–∞ –¥–ª—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–π –≤—ã–±–æ—Ä–∫–∏
        function selectByPercentageBresenham(items, percentage) {
            if (percentage >= 100) return [...items];
            if (percentage <= 0 || items.length === 0) return [];
            
            const n = items.length;
            const k = Math.round(n * percentage / 100);
            
            if (k >= n) return [...items];
            if (k <= 0) return [];
            
            const result = [];
            let error = 0;
            const step = n / k;
            
            for (let i = 0; i < n && result.length < k; i++) {
                error += 1;
                if (error >= step) {
                    result.push(items[i]);
                    error -= step;
                }
            }
            
            return result;
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–∞
        function updatePercentageDisplay() {
            const total = filteredBuildings.length;
            const displayed = Math.round(total * displayPercentage / 100);
            
            elements.percentageValue.textContent = `${displayPercentage}%`;
            elements.percentageCount.textContent = 
                `${Utils.formatNumber(displayed)}/${Utils.formatNumber(total)}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –ø–æ–ª–∑—É–Ω–∫–∞
            const thumb = elements.percentageSlider;
            if (displayPercentage <= 25) {
                thumb.style.setProperty('--thumb-color', '#f44336');
            } else if (displayPercentage <= 50) {
                thumb.style.setProperty('--thumb-color', '#FF9800');
            } else {
                thumb.style.setProperty('--thumb-color', '#4CAF50');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∏–¥–∏–º—ã—Ö –∑–¥–∞–Ω–∏–π
        function updateCheckboxesFromVisibleBuildings() {
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ —Ä–∞–π–æ–Ω–æ–≤ –∏–∑ –≤–∏–¥–∏–º—ã—Ö –∑–¥–∞–Ω–∏–π
            const visibleStatuses = new Set();
            const visibleDistricts = new Set();
            
            const buildingsToCheck = currentMode === 'basic' ? filteredBuildings : preciseFilteredBuildings;
            
            for (let i = 0; i < buildingsToCheck.length; i++) {
                const building = buildingsToCheck[i];
                if (building.status) visibleStatuses.add(building.status);
                if (building.district) visibleDistricts.add(building.district);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã —Å—Ç–∞—Ç—É—Å–æ–≤
            document.querySelectorAll('#status-filters input[type="checkbox"]').forEach(checkbox => {
                const status = checkbox.value;
                const isVisible = visibleStatuses.has(status);
                
                if (!isVisible) {
                    checkbox.checked = false;
                    activeFilters.status.delete(status);
                } else {
                    if (!checkbox.checked) {
                        checkbox.checked = true;
                        activeFilters.status.add(status);
                    }
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã —Ä–∞–π–æ–Ω–æ–≤
            document.querySelectorAll('#district-filters input[type="checkbox"]').forEach(checkbox => {
                const district = checkbox.value;
                const isVisible = visibleDistricts.has(district);
                
                if (!isVisible) {
                    checkbox.checked = false;
                    activeFilters.district.delete(district);
                } else {
                    if (!checkbox.checked) {
                        checkbox.checked = true;
                        activeFilters.district.add(district);
                    }
                }
            });
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π BalloonManager
        const BalloonManager = {
            // –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–ª—É–Ω–∞ –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –∑–¥–∞–Ω–∏—è
            createSingleBalloon(building) {
                const modeLabel = currentMode === 'basic' ? '–ë–ê–ó–û–í–´–ï –§–ò–õ–¨–¢–†–´' : '–¢–û–ß–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò';
                return `
                    <div class="custom-balloon">
                        <div class="balloon-header">
                            <div class="balloon-title">${Utils.escapeHtml(building.address)}</div>
                        </div>
                        <div class="balloon-content">
                            <div class="single-building-info">
                                <div class="info-row">
                                    <span class="info-label">–°—Ç–∞—Ç—É—Å:</span>
                                    <span class="info-value ${building.status === CONFIG.FREE_STATUS ? 'status-free' : 'status-busy'}">
                                        ${building.status === CONFIG.FREE_STATUS ? '–°–≤–æ–±–æ–¥–Ω–æ' : '–ó–∞–Ω—è—Ç–æ'}
                                    </span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–†–∞–π–æ–Ω:</span>
                                    <span class="info-value">${Utils.escapeHtml(building.district)}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–°—Ç–µ–Ω–¥–æ–≤:</span>
                                    <span class="info-value">${building.entrances || '‚Äî'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–ö–≤–∞—Ä—Ç–∏—Ä:</span>
                                    <span class="info-value">${Utils.formatNumber(building.flats) || '‚Äî'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="balloon-actions">
                            <button class="balloon-button hide" onclick="window.handleHideSingle(${building.originalIndex})">
                                ‚úï ${modeLabel}: –°–ö–†–´–¢–¨ –ê–î–†–ï–°
                            </button>
                        </div>
                    </div>
                `;
            },
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–ª—É–Ω–∞ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ —Å –ø–æ–¥–≥—Ä—É–∑–∫–æ–π
            createClusterBalloon(buildings, offset = 0, limit = CONFIG.DEFAULT_CLUSTER_LIMIT) {
                currentClusterState.allBuildings = buildings;
                currentClusterState.displayedBuildings = buildings.slice(offset, offset + limit);
                currentClusterState.offset = offset;
                currentClusterState.limit = limit;
                
                const displayBuildings = currentClusterState.displayedBuildings;
                const hasMore = buildings.length > offset + limit;
                const modeLabel = currentMode === 'basic' ? '–ë–ê–ó–û–í–´–ï –§–ò–õ–¨–¢–†–´' : '–¢–û–ß–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò';
                
                let tableRows = '';
                
                for (let i = 0; i < displayBuildings.length; i++) {
                    const building = displayBuildings[i];
                    const statusDotClass = building.status === CONFIG.FREE_STATUS ? 'free' : 'busy';
                    const statusTooltip = building.status || '‚Äî';
                    
                    let address = building.address || '';
                    if (address.length > 40) {
                        address = address.substring(0, 38) + '...';
                    }
                    
                    tableRows += `
                        <tr>
                            <td class="address-cell" title="${Utils.escapeHtml(building.address)}">
                                ${Utils.escapeHtml(address)}
                            </td>
                            <td class="stands-cell">${building.entrances || '‚Äî'}</td>
                            <td class="status-cell">
                                <span class="status-dot ${statusDotClass}" title="${Utils.escapeHtml(statusTooltip)}"></span>
                            </td>
                        </tr>
                    `;
                }
                
                const allBuildingIds = buildings.map(b => b.originalIndex).join(',');
                
                return `
                    <div class="custom-balloon cluster-balloon">
                        <div class="cluster-table-container">
                            <table class="cluster-table">
                                <thead>
                                    <tr>
                                        <th class="address-cell">–ê–¥—Ä–µ—Å</th>
                                        <th class="stands-cell">–°—Ç–µ–Ω–¥–æ–≤</th>
                                        <th class="status-cell">–°—Ç–∞—Ç—É—Å</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                        
                        ${hasMore ? 
                            `<div class="cluster-more-info" id="cluster-more-info">
                                <button onclick="window.showAllBuildings()" 
                                        style="
                                            background: #2196F3;
                                            color: white;
                                            border: none;
                                            padding: 8px 20px;
                                            border-radius: 4px;
                                            cursor: pointer;
                                            font-size: 13px;
                                            font-weight: 500;
                                            transition: all 0.2s;
                                            width: 100%;
                                        ">
                                    –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∞–¥—Ä–µ—Å–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞
                                </button>
                            </div>` 
                            : ''
                        }
                        
                        <div class="cluster-actions">
                            <button class="cluster-hide-btn" onclick="window.handleHideAllCluster([${allBuildingIds}])">
                                ‚ùå ${modeLabel}: –°–ö–†–´–¢–¨ –ö–õ–ê–°–¢–ï–†
                            </button>
                        </div>
                    </div>
                `;
            },

            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–¥–∞–Ω–∏—è –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
            showAllBuildings() {
                const { allBuildings } = currentClusterState;
                const balloonContent = this.createClusterBalloon(allBuildings, 0, allBuildings.length);
                
                if (map.balloon.isOpen()) {
                    map.balloon.close();
                }
                
                if (allBuildings.length > 0) {
                    const firstBuilding = allBuildings[0];
                    this.openCustomBalloon([firstBuilding.lng, firstBuilding.lat], balloonContent, false);
                }
            },

            // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º
            handleClusterClick(clusterId) {
                Utils.runIdle(() => {
                    try {
                        const cluster = objectManager.clusters.getById(clusterId);
                        if (!cluster) return;
                        
                        const coords = cluster.geometry.coordinates;
                        const geoObjects = cluster.properties?.geoObjects || [];
                        const clusterBuildings = [];
                        
                        const maxObjects = 1000;
                        const processLimit = Math.min(geoObjects.length, maxObjects);
                        
                        for (let i = 0; i < processLimit; i++) {
                            const geoObject = geoObjects[i];
                            const originalIndex = geoObject.properties?.originalIndex;
                            if (originalIndex !== undefined && originalIndex !== null) {
                                const building = buildingsByOriginalIndex[originalIndex];
                                if (building) {
                                    clusterBuildings.push(building);
                                }
                            }
                        }
                        
                        if (clusterBuildings.length > 0) {
                            const balloonContent = this.createClusterBalloon(clusterBuildings);
                            this.openCustomBalloon(coords, balloonContent, true);
                        }
                        
                    } catch (error) {
                        console.error('Error handling cluster click:', error);
                    }
                }, 500);
            },

            // –£–ü–†–û–©–ï–ù–ù–û–ï –æ—Ç–∫—Ä—ã—Ç–∏–µ –±–∞–ª—É–Ω–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            openCustomBalloon(coords, content, shouldCenter = true) {
                try {
                    if (map.balloon.isOpen()) {
                        map.balloon.close();
                    }
                    
                    const tempPlacemark = new ymaps.Placemark(coords, {
                        balloonContent: content
                    }, {
                        preset: 'islands#grayDotIcon',
                        balloonCloseButton: true,
                        balloonPanelMaxMapArea: 0,
                        balloonMaxHeight: 500,
                        balloonMaxWidth: 450,
                        balloonAutoPan: shouldCenter,
                        balloonOffset: [0, 0],
                        hideIconOnBalloonOpen: false,
                        visible: false
                    });
                    
                    map.geoObjects.add(tempPlacemark);
                    activeBalloon = tempPlacemark;
                    tempPlacemark.balloon.open();
                    
                    tempPlacemark.balloon.events.add('close', () => {
                        setTimeout(() => {
                            map.geoObjects.remove(tempPlacemark);
                            if (activeBalloon === tempPlacemark) {
                                activeBalloon = null;
                            }
                        }, 100);
                    });
                    
                } catch (error) {
                    console.error('Error opening balloon:', error);
                }
            }
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –∏–∑ –±–∞–ª—É–Ω–æ–≤
        window.handleHideSingle = function(index) {
            if (!isAppActive) return;
            
            if (currentMode === 'basic') {
                hiddenInBasicFilters.add(index);
            } else {
                hiddenInPreciseSettings.add(index);
            }
            
            updateFilters();
            updateCheckboxesFromVisibleBuildings();
            Utils.showNotification('–ê–¥—Ä–µ—Å —Å–∫—Ä—ã—Ç', 'success');
            
            if (map && map.balloon && map.balloon.isOpen()) {
                map.balloon.close();
            }
        };

        window.handleHideAllCluster = function(buildingIds) {
            if (!isAppActive) return;
            
            const targetSet = currentMode === 'basic' ? hiddenInBasicFilters : hiddenInPreciseSettings;
            
            buildingIds.forEach(id => {
                if (id !== undefined && id !== null) {
                    targetSet.add(parseInt(id));
                }
            });
            
            updateFilters();
            updateCheckboxesFromVisibleBuildings();
            Utils.showNotification(`–°–∫—Ä—ã—Ç–æ ${buildingIds.length} –∞–¥—Ä–µ—Å–æ–≤`, 'success');
            
            if (map && map.balloon && map.balloon.isOpen()) {
                map.balloon.close();
            }
        };

        window.showAllBuildings = function() {
            if (!isAppActive) return;
            BalloonManager.showAllBuildings();
        };

        // =============================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´
        // =============================
        function initMap() {
            return new Promise((resolve) => {
                ymaps.ready(() => {
                    const mapOptions = {
                        center: CONFIG.MAP_CENTER,
                        zoom: CONFIG.MAP_ZOOM,
                        controls: ['zoomControl', 'fullscreenControl'],
                        avoidFractionalZoom: true,
                        suppressMapOpenBlock: true,
                        yandexMapDisablePoiInteractivity: true,
                        suppressObsoleteBrowserNotifier: true,
                        copyrightLogoVisible: false,
                        copyrightUaVisible: false,
                        copyrightProvidersVisible: false
                    };
                    
                    map = new ymaps.Map('map', mapOptions);

                    objectManager = new ymaps.ObjectManager({
                        clusterize: true,
                        gridSize: 64,
                        clusterDisableClickZoom: true,
                        clusterOpenBalloonOnClick: false,
                        geoObjectOpenBalloonOnClick: false
                    });

                    objectManager.clusters.options.set({
                        preset: 'islands#invertedVioletClusterIcons',
                        clusterIconColor: '#2196F3'
                    });

                    objectManager.objects.options.set({
                        preset: 'islands#dotIcon',
                        iconColor: '#4CAF50'
                    });

                    map.geoObjects.add(objectManager);
                    
                    setupMapEventHandlers();
                    
                    resolve();
                });
            });
        }

        // –ù–ê–°–¢–†–û–ô–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –°–û–ë–´–¢–ò–ô –ö–ê–†–¢–´
        function setupMapEventHandlers() {
            objectManager.clusters.events.add('click', (e) => {
                const clusterId = e.get('objectId');
                BalloonManager.handleClusterClick(clusterId);
                lastOpenedClusterId = clusterId;
                lastOpenedObjectId = null;
            });

            objectManager.objects.events.add('click', (e) => {
                const objectId = e.get('objectId');
                const object = objectManager.objects.getById(objectId);
                
                if (object && object.properties) {
                    const originalIndex = object.properties.originalIndex;
                    if (originalIndex !== undefined) {
                        const building = buildingsByOriginalIndex[originalIndex];
                        if (building) {
                            const balloonContent = BalloonManager.createSingleBalloon(building);
                            lastOpenedObjectId = objectId;
                            lastOpenedClusterId = null;
                            BalloonManager.openCustomBalloon(object.geometry.coordinates, balloonContent, true);
                        }
                    }
                }
            });
        }

        // =============================
        // –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // =============================
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        function loadData() {
            return new Promise((resolve, reject) => {
                const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=responseHandler:handleSheetData&sheet=${CONFIG.SHEET_NAME}`;
                
                window.handleSheetData = function(response) {
                    try {
                        Utils.runIdle(() => {
                            const data = parseGoogleSheetResponse(response);
                            allBuildings = data;
                            
                            data.forEach(building => {
                                buildingsByOriginalIndex[building.originalIndex] = building;
                            });
                            
                            resolve(data);
                        }, 1000);
                    } catch (error) {
                        reject(error);
                    }
                };

                const script = document.createElement('script');
                script.src = url;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å—Ç–µ–Ω–¥–æ–≤
        function calculatePrice(totalStands) {
            if (totalStands < 100) {
                return { 
                    pricePerStand: null, 
                    totalPrice: null, 
                    message: '–í–´–ë–ï–†–ò–¢–ï –ë–û–õ–¨–®–ï –ó–î–ê–ù–ò–ô –î–õ–Ø –†–ê–°–ß–Å–¢–ê' 
                };
            } else if (totalStands >= 100 && totalStands <= 299) {
                return { 
                    pricePerStand: 160, 
                    totalPrice: totalStands * 160 
                };
            } else if (totalStands >= 300 && totalStands <= 499) {
                return { 
                    pricePerStand: 140, 
                    totalPrice: totalStands * 140 
                };
            } else {
                return { 
                    pricePerStand: 120, 
                    totalPrice: totalStands * 120 
                };
            }
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets
        function parseGoogleSheetResponse(response) {
            const rows = response.table?.rows || [];
            const buildings = [];
            
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].c || [];
                if (cells.length < 9) continue;
                
                const building = {
                    originalIndex: i,
                    address: getCellValue(cells[0]) || '',
                    lat: parseFloat(getCellValue(cells[2])) || 0,
                    lng: parseFloat(getCellValue(cells[1])) || 0,
                    status: getCellValue(cells[3]) || '',
                    district: getCellValue(cells[4]) || '',
                    entrances: getIntValue(cells[5]),
                    floors: getIntValue(cells[6]),
                    flats: getIntValue(cells[7]),
                    flatsPerEntrance: getIntValue(cells[8])
                };
                
                if (building.lat && building.lng) {
                    buildings.push(building);
                }
            }
            
            return buildings;
        }
        
        function getCellValue(cell) {
            if (!cell) return null;
            return cell.v !== undefined ? cell.v : cell.f;
        }

        function getIntValue(cell) {
            if (!cell) return null;
            const value = getCellValue(cell);
            if (value === null || value === undefined || value === '') return null;
            const num = parseInt(value);
            return isNaN(num) ? null : num;
        }

        // –°–±–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        function collectAvailableValues(buildings) {
            const floorsSet = new Set();
            const flatsSet = new Set();
            const statusSet = new Set();
            const districtSet = new Set();
            
            for (let i = 0; i < buildings.length; i++) {
                const building = buildings[i];
                if (building.floors !== null) floorsSet.add(building.floors);
                if (building.flatsPerEntrance !== null) flatsSet.add(building.flatsPerEntrance);
                if (building.status) statusSet.add(building.status);
                if (building.district) districtSet.add(building.district);
            }
            
            availableValues.floors = Array.from(floorsSet).sort((a, b) => a - b);
            availableValues.flatsPerEntrance = Array.from(flatsSet).sort((a, b) => a - b);
            
            return {
                statuses: Array.from(statusSet).sort(),
                districts: Array.from(districtSet).sort()
            };
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤
        function createCheckboxFilter(containerId, values, label) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            for (let i = 0; i < values.length; i++) {
                const value = values[i];
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${containerId}-${Utils.escapeHtml(value)}`;
                checkbox.value = value;
                checkbox.checked = true;
                
                const checkboxLabel = document.createElement('label');
                checkboxLabel.htmlFor = checkbox.id;
                checkboxLabel.textContent = value;
                
                checkboxItem.appendChild(checkbox);
                checkboxItem.appendChild(checkboxLabel);
                container.appendChild(checkboxItem);
                
                checkbox.addEventListener('change', () => {
                    const filterType = containerId.replace('-filters', '');
                    if (checkbox.checked) {
                        activeFilters[filterType].add(value);
                    } else {
                        activeFilters[filterType].delete(value);
                    }
                    applyBaseFilters();
                });
            }
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è
        function setupNumberInputs() {
            setupRangeInputWithLogic(elements.minFloors, elements.maxFloors, 'floors', false);
            setupRangeInputWithLogic(elements.maxFloors, elements.minFloors, 'floors', true);
            
            setupRangeInputWithLogic(elements.minFlatsPerEntrance, elements.maxFlatsPerEntrance, 'flatsPerEntrance', false);
            setupRangeInputWithLogic(elements.maxFlatsPerEntrance, elements.minFlatsPerEntrance, 'flatsPerEntrance', true);
            
            setupMobileRangeButtons();
        }

        function setupRangeInputWithLogic(inputElement, oppositeElement, fieldType, isMaxField) {
            const values = availableValues[fieldType];
            if (values.length === 0) return;
            
            inputElement.addEventListener('focus', () => {
                if (inputElement.value === '') {
                    inputElement.value = isMaxField ? values[values.length - 1] : values[0];
                    Utils.runIdle(() => {
                        applyBaseFilters();
                    });
                }
            });
            
            inputElement.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    adjustRangeValue(inputElement, e.key === 'ArrowUp' ? 1 : -1, fieldType, isMaxField, oppositeElement);
                }
            });
            
            inputElement.addEventListener('wheel', (e) => {
                e.preventDefault();
                adjustRangeValue(inputElement, e.deltaY < 0 ? 1 : -1, fieldType, isMaxField, oppositeElement);
            }, { passive: false });
            
            const debouncedInputHandler = Utils.debounce(() => {
                if (inputElement.value === '') return;
                
                const value = parseInt(inputElement.value);
                if (isNaN(value)) {
                    inputElement.value = '';
                    return;
                }
                
                let closestValue = values[0];
                if (values.length > 0) {
                    let left = 0;
                    let right = values.length - 1;
                    let minDiff = Math.abs(value - values[0]);
                    
                    while (left <= right) {
                        const mid = Math.floor((left + right) / 2);
                        const diff = Math.abs(value - values[mid]);
                        
                        if (diff < minDiff) {
                            minDiff = diff;
                            closestValue = values[mid];
                        }
                        
                        if (values[mid] < value) {
                            left = mid + 1;
                        } else {
                            right = mid - 1;
                        }
                    }
                }
                
                inputElement.value = closestValue;
                
                if (oppositeElement.value) {
                    const oppositeValue = parseInt(oppositeElement.value);
                    if (isMaxField && closestValue < oppositeValue) {
                        inputElement.value = oppositeValue;
                    } else if (!isMaxField && closestValue > oppositeValue) {
                        inputElement.value = oppositeValue;
                    }
                }
                
                Utils.runIdle(() => {
                    applyBaseFilters();
                }, 100);
            }, 350);
            
            inputElement.addEventListener('input', debouncedInputHandler);
            
            inputElement.addEventListener('blur', () => {
                if (inputElement.value !== '' && oppositeElement.value) {
                    const value = parseInt(inputElement.value);
                    const oppositeValue = parseInt(oppositeElement.value);
                    
                    if (isMaxField && value < oppositeValue) {
                        inputElement.value = oppositeValue;
                        Utils.runIdle(() => {
                            applyBaseFilters();
                        });
                    } else if (!isMaxField && value > oppositeValue) {
                        inputElement.value = oppositeValue;
                        Utils.runIdle(() => {
                            applyBaseFilters();
                        });
                    }
                }
            });
        }
        
        function adjustRangeValue(inputElement, direction, fieldType, isMaxField, oppositeElement) {
            const values = availableValues[fieldType];
            if (values.length === 0) return;
            
            let currentValue = parseInt(inputElement.value);
            let currentIndex = -1;
            
            if (isNaN(currentValue)) {
                currentValue = isMaxField ? values[values.length - 1] : values[0];
                inputElement.value = currentValue;
                applyBaseFilters();
                return;
            }
            
            currentIndex = values.indexOf(currentValue);
            if (currentIndex === -1) {
                currentValue = isMaxField ? values[values.length - 1] : values[0];
                inputElement.value = currentValue;
                applyBaseFilters();
                return;
            }
            
            currentIndex += direction;
            if (currentIndex < 0) currentIndex = 0;
            if (currentIndex >= values.length) currentIndex = values.length - 1;
            
            const newValue = values[currentIndex];
            
            if (oppositeElement.value) {
                const oppositeValue = parseInt(oppositeElement.value);
                if (isMaxField && newValue < oppositeValue) {
                    inputElement.value = oppositeValue;
                } else if (!isMaxField && newValue > oppositeValue) {
                    inputElement.value = oppositeValue;
                } else {
                    inputElement.value = newValue;
                }
            } else {
                inputElement.value = newValue;
            }
            
            applyBaseFilters();
        }

        function setupMobileRangeButtons() {
            const rangeButtons = document.querySelectorAll('.range-button');
            
            rangeButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetId = button.getAttribute('data-target');
                    const inputElement = document.getElementById(targetId);
                    const isMaxField = targetId.includes('max');
                    const fieldType = targetId.includes('floors') ? 'floors' : 'flatsPerEntrance';
                    const oppositeElement = isMaxField ? 
                        document.getElementById(targetId.replace('max', 'min')) : 
                        document.getElementById(targetId.replace('min', 'max'));
                    const direction = button.classList.contains('plus') ? 1 : -1;
                    
                    adjustRangeValue(inputElement, direction, fieldType, isMaxField, oppositeElement);
                });
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–≥–æ —Å–ª–∞–π–¥–µ—Ä–∞
        function setupPercentageSlider() {
            if (!elements.percentageSlider) return;
            
            elements.percentageSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                displayPercentage = value;
                updatePercentageDisplay();
                
                clearTimeout(percentageDebounceTimer);
                
                percentageDebounceTimer = setTimeout(() => {
                    applyPreciseFilters();
                }, 100);
            });
            
            document.querySelectorAll('.slider-ticks span').forEach(span => {
                span.addEventListener('click', (e) => {
                    const text = e.target.textContent;
                    const value = parseInt(text);
                    if (!isNaN(value)) {
                        setPercentage(value);
                    }
                });
            });
            
            elements.percentageSlider.addEventListener('keydown', (e) => {
                let step = 1;
                if (e.shiftKey) step = 10;
                if (e.altKey) step = 5;
                
                if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    let newValue = parseInt(elements.percentageSlider.value) + step;
                    if (newValue > 100) newValue = 100;
                    elements.percentageSlider.value = newValue;
                    displayPercentage = newValue;
                    updatePercentageDisplay();
                    applyPreciseFilters();
                } else if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    let newValue = parseInt(elements.percentageSlider.value) - step;
                    if (newValue < 1) newValue = 1;
                    elements.percentageSlider.value = newValue;
                    displayPercentage = newValue;
                    updatePercentageDisplay();
                    applyPreciseFilters();
                }
            });
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–∞
        function setPercentage(value) {
            displayPercentage = value;
            elements.percentageSlider.value = value;
            updatePercentageDisplay();
            
            clearTimeout(percentageDebounceTimer);
            percentageDebounceTimer = setTimeout(() => {
                applyPreciseFilters();
            }, 200);
        }

        function toggleBuildingHiddenState(originalIndex, forceState = null) {
            const targetSet = currentMode === 'basic' ? hiddenInBasicFilters : hiddenInPreciseSettings;
            const shouldHide = forceState !== null ? forceState : !targetSet.has(originalIndex);
            
            if (shouldHide) {
                targetSet.add(originalIndex);
            } else {
                targetSet.delete(originalIndex);
            }
            
            selectedBuildings.delete(originalIndex);
            updateFilters();
            updateCheckboxesFromVisibleBuildings();
            
            return shouldHide;
        }

        function showValuesPopup(fieldType, clickEvent) {
            const values = availableValues[fieldType];
            if (values.length === 0) return;
            
            const popup = elements.valuesPopup;
            popup.innerHTML = '';
            
            for (let i = 0; i < values.length; i++) {
                const value = values[i];
                const item = document.createElement('div');
                item.className = 'value-item';
                item.textContent = value;
                item.addEventListener('click', () => {
                    const targetField = fieldType === 'floors' ? 
                        (clickEvent.target.textContent.includes('–û—Ç') ? elements.minFloors : elements.maxFloors) :
                        (clickEvent.target.textContent.includes('–û—Ç') ? elements.minFlatsPerEntrance : elements.maxFlatsPerEntrance);
                    
                    targetField.value = value;
                    applyBaseFilters();
                    popup.classList.remove('show');
                });
                popup.appendChild(item);
            }
            
            const rect = clickEvent.target.getBoundingClientRect();
            popup.style.left = `${rect.left}px`;
            popup.style.top = `${rect.bottom + 5}px`;
            popup.style.width = `${rect.width}px`;
            popup.classList.add('show');
            
            const closePopup = (e) => {
                if (!popup.contains(e.target) && e.target !== clickEvent.target) {
                    popup.classList.remove('show');
                    document.removeEventListener('click', closePopup);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', closePopup);
            }, 0);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö –∑–¥–∞–Ω–∏–π –≤ —Å–ø–∏—Å–∫–µ
        function showAllBuildingsInList() {
            currentRenderLimit = preciseFilteredBuildings.length;
            updateBuildingsList();
            Utils.showNotification(`–ü–æ–∫–∞–∑–∞–Ω–æ –≤—Å–µ ${preciseFilteredBuildings.length} –∑–¥–∞–Ω–∏–π`, 'info');
            elements.buildingsList.scrollTop = 0;
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        function applyBaseFilters() {
            const minFloors = parseInt(elements.minFloors.value) || null;
            const maxFloors = parseInt(elements.maxFloors.value) || null;
            const minFlats = parseInt(elements.minFlatsPerEntrance.value) || null;
            const maxFlats = parseInt(elements.maxFlatsPerEntrance.value) || null;
            
            filteredBuildings = allBuildings.filter(building => {
                if (activeFilters.status.size > 0 && !activeFilters.status.has(building.status)) {
                    return false;
                }
                
                if (activeFilters.district.size > 0 && !activeFilters.district.has(building.district)) {
                    return false;
                }
                
                if (building.floors !== null) {
                    if (minFloors !== null && building.floors < minFloors) return false;
                    if (maxFloors !== null && building.floors > maxFloors) return false;
                }
                
                if (building.flatsPerEntrance !== null) {
                    if (minFlats !== null && building.flatsPerEntrance < minFlats) return false;
                    if (maxFlats !== null && building.flatsPerEntrance > maxFlats) return false;
                }
                
                if (hiddenInBasicFilters.has(building.originalIndex)) {
                    return false;
                }
                
                return true;
            });
            
            updatePercentageDisplay();
            applyPreciseFilters();
        }

        // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function updateFilters() {
            applyBaseFilters();
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–æ—á–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        function applyPreciseFilters() {
            Utils.runIdle(() => {
                performPreciseFiltering();
            }, 100);
        }

        function performPreciseFiltering() {
            currentRenderLimit = CONFIG.DEFAULT_RENDER_LIMIT;
            preciseFilteredBuildings = [...filteredBuildings];
            
            if (displayPercentage < 100) {
                preciseFilteredBuildings = selectByPercentageBresenham(preciseFilteredBuildings, displayPercentage);
            }
            
            preciseFilteredBuildings = preciseFilteredBuildings.filter(building => 
                !hiddenInPreciseSettings.has(building.originalIndex)
            );
            
            // –£–î–ê–õ–ï–ù –ü–û–ò–°–ö
            updateDisplay();
        }

        function updateDisplay() {
            updateStatistics();
            updateMap();
            updateBuildingsList();
            updateCheckboxesFromVisibleBuildings();
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStatistics() {
            requestAnimationFrame(() => {
                computeStatistics();
            });
        }

        function computeStatistics() {
            let totalStands = 0;
            let totalFlats = 0;
            let totalStandsAll = 0;
            let totalFlatsAll = 0;
            
            for (let i = 0; i < preciseFilteredBuildings.length; i++) {
                const building = preciseFilteredBuildings[i];
                totalStands += building.entrances || 0;
                totalFlats += building.flats || 0;
            }
            
            for (let i = 0; i < allBuildings.length; i++) {
                const building = allBuildings[i];
                totalStandsAll += building.entrances || 0;
                totalFlatsAll += building.flats || 0;
            }
            
            updateStatsDOM(totalStands, totalFlats, totalStandsAll, totalFlatsAll);
        }

        function updateStatsDOM(totalStands, totalFlats, totalStandsAll, totalFlatsAll) {
            const total = allBuildings.length;
            const filtered = preciseFilteredBuildings.length;
            
            elements.statsTotal.textContent = Utils.formatNumber(total);
            elements.statsFiltered.textContent = Utils.formatNumber(filtered);
            elements.statsStands.textContent = Utils.formatNumber(totalStands);
            elements.statsStandsAll.textContent = Utils.formatNumber(totalStandsAll);
            elements.statsFlats.textContent = Utils.formatNumber(totalFlats);
            elements.statsFlatsAll.textContent = Utils.formatNumber(totalFlatsAll);
            
            const priceInfo = calculatePrice(totalStands);
            
            if (totalStands < 100) {
                elements.priceLine.style.display = 'none';
                elements.messageLine.style.display = 'flex';
            } else {
                elements.priceLine.style.display = 'flex';
                elements.messageLine.style.display = 'none';
                
                elements.statsPrice.textContent = Utils.formatNumber(priceInfo.totalPrice);
                
                if (totalFlats > 0) {
                    const pricePerFlat = priceInfo.totalPrice / totalFlats;
                    elements.statsPricePerFlat.textContent = Utils.formatPrice(pricePerFlat);
                } else {
                    elements.statsPricePerFlat.textContent = '0.00';
                }
            }
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
        function updateMap() {
            if (!objectManager) return;
            
            if (mapUpdateRafId) {
                cancelAnimationFrame(mapUpdateRafId);
            }
            
            mapUpdateRafId = requestAnimationFrame(() => {
                objectManager.removeAll();
                
                const features = [];
                const buildingsToShow = preciseFilteredBuildings;
                const freeIconColor = '#4CAF50';
                const busyIconColor = '#f44336';
                
                for (let i = 0; i < buildingsToShow.length; i++) {
                    const building = buildingsToShow[i];
                    const iconColor = building.status === CONFIG.FREE_STATUS ? freeIconColor : busyIconColor;
                    
                    features.push({
                        type: 'Feature',
                        id: building.originalIndex,
                        geometry: { 
                            type: 'Point', 
                            coordinates: [building.lng, building.lat]
                        },
                        properties: {
                            originalIndex: building.originalIndex,
                            address: building.address,
                            hintContent: building.address,
                            clusterCaption: building.address.substring(0, 30),
                            status: building.status
                        },
                        options: { 
                            iconColor: iconColor,
                            balloonCloseButton: false
                        }
                    });
                }
                
                if (features.length > 0) {
                    objectManager.add(features);
                }
                
                mapUpdateRafId = null;
            });
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∑–¥–∞–Ω–∏–π
        function updateBuildingsList() {
            const container = elements.buildingsList;
            
            if (preciseFilteredBuildings.length === 0) {
                container.innerHTML = '';
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'empty-list-message';
                emptyMessage.innerHTML = `
                    <div style="
                        padding: 40px 20px;
                        text-align: center;
                        color: #666;
                        font-size: 14px;
                        background: #fafafa;
                        border-radius: 6px;
                        margin: 20px;
                    ">
                        –ù–µ—Ç –∑–¥–∞–Ω–∏–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º
                    </div>
                `;
                container.appendChild(emptyMessage);
                return;
            }
            
            const fragment = document.createDocumentFragment();
            const buildingsToRender = preciseFilteredBuildings.slice(0, currentRenderLimit);
            
            for (let i = 0; i < buildingsToRender.length; i++) {
                const building = buildingsToRender[i];
                const item = document.createElement('div');
                item.className = 'building-item';
                item.dataset.id = building.originalIndex;
                
                const isHidden = currentMode === 'basic' ? 
                    hiddenInBasicFilters.has(building.originalIndex) : 
                    hiddenInPreciseSettings.has(building.originalIndex);
                const isSelected = selectedBuildings.has(building.originalIndex);
                
                if (isHidden) item.classList.add('hidden');
                if (isSelected) item.classList.add('selected');
                
                const statusClass = building.status === CONFIG.FREE_STATUS ? 'status-free' : 'status-busy';
                
                item.innerHTML = `
                    <div class="building-address">${Utils.escapeHtml(building.address)}</div>
                    <div class="building-info">
                        <span class="${statusClass}">${Utils.escapeHtml(building.status)}</span>
                        <span>–†–∞–π–æ–Ω: ${Utils.escapeHtml(building.district)}</span>
                        <span>–°—Ç–µ–Ω–¥–æ–≤: ${building.entrances || '‚Äî'}</span>
                        <span>–ö–≤–∞—Ä—Ç–∏—Ä: ${Utils.formatNumber(building.flats) || '‚Äî'}</span>
                    </div>
                    <button class="hide-building-btn ${isHidden ? 'hidden' : ''}" 
                            data-index="${building.originalIndex}"
                            title="${isHidden ? '–ü–æ–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å' : '–°–∫—Ä—ã—Ç—å –∞–¥—Ä–µ—Å'}">
                    </button>
                `;
                
                const hideBtn = item.querySelector('.hide-building-btn');
                hideBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleBuildingHiddenState(building.originalIndex);
                });
                
                fragment.appendChild(item);
            }
            
            if (preciseFilteredBuildings.length > currentRenderLimit) {
                const moreItem = document.createElement('div');
                moreItem.className = 'show-all-button';
                moreItem.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span>üìã</span>
                        <span>–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ ${preciseFilteredBuildings.length} –∑–¥–∞–Ω–∏–π</span>
                    </div>
                `;
                
                moreItem.addEventListener('click', showAllBuildingsInList);
                fragment.appendChild(moreItem);
            }
            
            container.innerHTML = '';
            container.appendChild(fragment);
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –í–°–ï–• —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–±–∞–∑–æ–≤—ã–µ + —Ç–æ—á–Ω—ã–µ)
        function resetAllFilters() {
            currentRenderLimit = CONFIG.DEFAULT_RENDER_LIMIT;
            
            elements.minFloors.value = '';
            elements.maxFloors.value = '';
            elements.minFlatsPerEntrance.value = '';
            elements.maxFlatsPerEntrance.value = '';
            
            hiddenInBasicFilters.clear();
            hiddenInPreciseSettings.clear();
            
            const allStatuses = new Set();
            const allDistricts = new Set();
            
            for (let i = 0; i < allBuildings.length; i++) {
                const building = allBuildings[i];
                if (building.status) allStatuses.add(building.status);
                if (building.district) allDistricts.add(building.district);
            }
            
            document.querySelectorAll('#status-filters input[type="checkbox"]').forEach(checkbox => {
                const status = checkbox.value;
                if (allStatuses.has(status)) {
                    checkbox.checked = true;
                    activeFilters.status.add(status);
                } else {
                    checkbox.checked = false;
                    activeFilters.status.delete(status);
                }
            });
            
            document.querySelectorAll('#district-filters input[type="checkbox"]').forEach(checkbox => {
                const district = checkbox.value;
                if (allDistricts.has(district)) {
                    checkbox.checked = true;
                    activeFilters.district.add(district);
                } else {
                    checkbox.checked = false;
                    activeFilters.district.delete(district);
                }
            });
            
            displayPercentage = 100;
            
            if (elements.percentageSlider) {
                elements.percentageSlider.value = 100;
            }
            
            updatePercentageDisplay();
            applyBaseFilters();
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ç–æ–ª—å–∫–æ —Ç–æ—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function resetPreciseSettings() {
            currentRenderLimit = CONFIG.DEFAULT_RENDER_LIMIT;
            hiddenInPreciseSettings.clear();
            selectedBuildings.clear();
            displayPercentage = 100;
            
            if (elements.percentageSlider) {
                elements.percentageSlider.value = 100;
            }
            
            updatePercentageDisplay();
            applyPreciseFilters();
        }

        function switchTab(tabName) {
            currentMode = tabName;
            
            elements.tabButtons.forEach(button => {
                button.classList.toggle('active', button.dataset.tab === tabName);
            });
            
            elements.tabPanes.forEach(pane => {
                pane.classList.toggle('active', pane.id === `${tabName}-tab`);
            });
            
            if (tabName === 'precise') {
                updateBuildingsList();
            }
        }

        function togglePanel() {
            isPanelExpanded = !isPanelExpanded;
            
            if (isPanelExpanded) {
                elements.panelContent.classList.remove('collapsed');
                elements.toggleIcon.textContent = '‚ñ≤';
                elements.floatingPanel.style.height = 'calc(100vh - 40px)';
            } else {
                elements.panelContent.classList.add('collapsed');
                elements.toggleIcon.textContent = '‚ñº';
                elements.floatingPanel.style.height = 'auto';
            }
        }

        function setupEventListeners() {
            elements.panelHeader.addEventListener('click', togglePanel);
            
            elements.tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    switchTab(button.dataset.tab);
                });
            });
            
            elements.resetAllFilters.addEventListener('click', resetAllFilters);
            
            const debouncedApplyFilters = Utils.debounce(applyBaseFilters, CONFIG.DEBOUNCE_DELAY);
            
            document.querySelectorAll('#status-filters input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', debouncedApplyFilters);
            });
            
            document.querySelectorAll('#district-filters input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', debouncedApplyFilters);
            });
            
            [elements.minFloors, elements.maxFloors, 
             elements.minFlatsPerEntrance, elements.maxFlatsPerEntrance].forEach(input => {
                input.addEventListener('input', debouncedApplyFilters);
            });
            
            elements.resetPreciseSettings.addEventListener('click', resetPreciseSettings);
            
            document.querySelectorAll('.available-values').forEach(button => {
                button.addEventListener('click', (e) => {
                    showValuesPopup(e.target.dataset.field, e);
                });
            });
            
            elements.buildingsList.addEventListener('click', (e) => {
                const buildingItem = e.target.closest('.building-item');
                if (!buildingItem) return;
                
                if (e.target.closest('.hide-building-btn')) return;
                
                const originalIndex = parseInt(buildingItem.dataset.id);
                const building = buildingsByOriginalIndex[originalIndex];
                
                if (building && building.lng && building.lat) {
                    map.panTo([building.lng, building.lat], {
                        duration: 300,
                        timingFunction: 'ease-in-out'
                    });
                    
                    setTimeout(() => {
                        const balloonContent = BalloonManager.createSingleBalloon(building);
                        BalloonManager.openCustomBalloon([building.lng, building.lat], balloonContent, true);
                    }, 300);
                }
                
                document.querySelectorAll('.building-item').forEach(el => {
                    el.classList.remove('selected');
                });
                buildingItem.classList.add('selected');
            });
            
            setupPercentageSlider();
            
            if (elements.copyReportBasic) {
                elements.copyReportBasic.addEventListener('click', copyReportToClipboard);
            }
            
            if (elements.copyReportPrecise) {
                elements.copyReportPrecise.addEventListener('click', copyReportToClipboard);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initApp() {
            try {
                await initMap();
                await loadData();
                
                const { statuses, districts } = collectAvailableValues(allBuildings);
                
                if (availableValues.floors.length > 0) {
                    elements.floorsRange.textContent = 
                        `–î–æ—Å—Ç—É–ø–Ω–æ: ${availableValues.floors[0]}-${availableValues.floors[availableValues.floors.length - 1]}`;
                }
                
                if (availableValues.flatsPerEntrance.length > 0) {
                    elements.flatsRange.textContent = 
                        `–î–æ—Å—Ç—É–ø–Ω–æ: ${availableValues.flatsPerEntrance[0]}-${availableValues.flatsPerEntrance[availableValues.flatsPerEntrance.length - 1]}`;
                }
                
                createCheckboxFilter('status-filters', statuses, '–°—Ç–∞—Ç—É—Å');
                createCheckboxFilter('district-filters', districts, '–†–∞–π–æ–Ω');
                
                setupNumberInputs();
                
                activeFilters.status = new Set(statuses);
                activeFilters.district = new Set(districts);
                
                if (availableValues.floors.length > 0) {
                    elements.minFloors.value = availableValues.floors[0];
                    elements.maxFloors.value = availableValues.floors[availableValues.floors.length - 1];
                }
                
                if (availableValues.flatsPerEntrance.length > 0) {
                    elements.minFlatsPerEntrance.value = availableValues.flatsPerEntrance[0];
                    elements.maxFlatsPerEntrance.value = availableValues.flatsPerEntrance[availableValues.flatsPerEntrance.length - 1];
                }
                
                applyBaseFilters();
                
                setupEventListeners();
                
                requestAnimationFrame(() => {
                    elements.loadingOverlay.style.display = 'none';
                });
                
            } catch (error) {
                elements.loadingOverlay.querySelector('.loading-text').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
                
                setTimeout(() => {
                    elements.loadingOverlay.style.display = 'none';
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
                }, 2000);
            }
        }

        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è HTML-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        window.toggleBuildingHiddenState = toggleBuildingHiddenState;
        window.applyPreciseFilters = applyPreciseFilters;
        window.resetPreciseSettings = resetPreciseSettings;
        window.setPercentage = setPercentage;

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            isAppActive = false;
            
            if (mapUpdateRafId) {
                cancelAnimationFrame(mapUpdateRafId);
            }
            
            if (percentageDebounceTimer) {
                clearTimeout(percentageDebounceTimer);
            }
            
            if (map) {
                map.destroy();
            }
        });

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
