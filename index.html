<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>PR МАРКЕТ Рязань - стенды у домофонов</title>
    <style>
        /* RESET & BASE STYLES */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-free: #10b981;
            --color-busy: #ef4444;
            --color-primary: #3b82f6;
            --color-secondary: #6b7280;
            --color-background: #f9fafb;
            --color-surface: #ffffff;
            --color-border: #e5e7eb;
            --brand-color: #475493;
            --brand-light: #5b69b0;
            --brand-dark: #394176;
            --text-on-brand: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.5;
            color: #1f2937;
            background: var(--color-background);
            padding-top: var(--safe-area-inset-top);
            padding-bottom: var(--safe-area-inset-bottom);
        }

        /* ЗАГЛУШКА ДЛЯ ЛАНДШАФТНОГО РЕЖИМА */
        #landscape-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--brand-color), var(--brand-light));
            color: var(--text-on-brand);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(10px);
        }

        #landscape-warning.active {
            display: flex;
            opacity: 1;
            animation: fadeIn 0.3s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .landscape-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
            animation: rotateIcon 3s ease-in-out infinite;
        }

        @keyframes rotateIcon {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(90deg); }
            75% { transform: rotate(0deg); }
        }

        .landscape-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            line-height: 1.3;
        }

        .landscape-message {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            max-width: 500px;
            line-height: 1.5;
            opacity: 0.9;
        }

        .landscape-hint {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            max-width: 400px;
            line-height: 1.4;
        }

        .landscape-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-lg);
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            backdrop-filter: blur(10px);
        }

        .landscape-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .landscape-button:active {
            transform: translateY(0);
        }

        /* LOADING OVERLAY */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--color-surface);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--color-border);
            border-top-color: var(--brand-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Стили для индикаторов статуса - ОБЩИЕ */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 4px;
            flex-shrink: 0;
        }

        /* Переопределяем для индикаторов в фильтрах (чекбоксах) */
        .checkbox-item .status-indicator {
            margin-right: 4px !important;
        }

        /* Переопределяем для индикаторов в списке зданий */
        .building-header .status-indicator {
            margin-right: 0 !important;
        }

        .status-free {
            background-color: var(--color-free);
            border: 2px solid #059669;
        }

        .status-busy {
            background-color: var(--color-busy);
            border: 2px solid #dc2626;
        }

        /* ОТДЕЛЬНО для списка зданий - увеличиваем размер */
        .building-item .status-indicator {
            width: 16px !important;
            height: 16px !important;
            margin-right: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Для индикаторов в заголовках и фильтрах сохраняем старый размер */
        .header-stats .status-indicator,
        .sidebar-stats .status-indicator,
        .filter-options .status-indicator {
            width: 12px;
            height: 12px;
        }

        /* КЛАСТЕРНЫЙ БАЛУН - УЛУЧШЕННЫЙ ДИЗАЙН */
        .cluster-balloon {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            max-width: 350px;
            min-width: 280px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            position: relative;
        }

        .cluster-header {
            background: #475493;
            color: white;
            padding: 16px 20px;
            padding-right: 45px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .cluster-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .cluster-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .cluster-close-btn:active {
            transform: scale(0.95);
        }

        .cluster-title {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            text-align: center;
        }

        .cluster-addresses {
            padding: 0;
            background: white;
            max-height: 300px;
            overflow-y: auto;
        }

        .cluster-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 13px;
        }

        .cluster-table th {
            background: #f8f9fa;
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            padding: 10px 16px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .cluster-table th:first-child {
            width: 70%;
        }

        .cluster-table th:last-child {
            width: 30%;
            text-align: right;
        }

        .cluster-table td {
            padding: 10px 16px;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }

        .cluster-table tr:last-child td {
            border-bottom: none;
        }

        .cluster-table tr:hover td {
            background: #f8f9fa;
        }

        .address-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .address-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-right: 4px;
        }

        .address-status.free {
            background: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        .address-status.busy {
            background: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }

        .address-text {
            flex: 1;
            font-size: 13px;
            line-height: 1.4;
            color: #212529;
            word-break: break-word;
        }

        .stands-cell {
            text-align: right;
            font-weight: 700;
            color: #475493;
            font-size: 13px;
            white-space: nowrap;
        }

        .more-buildings {
            text-align: center;
            color: #6c757d;
            font-size: 12px;
            font-style: italic;
            padding: 8px 16px;
            background: #f8f9fa;
        }

        .cluster-footer {
            padding: 12px 16px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .hide-cluster-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
            width: 100%;
        }

        .hide-cluster-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.25);
        }

        .hide-cluster-btn:active {
            transform: translateY(0);
        }

        /* Стили для обычного балуна (отдельный объект) */
        .single-balloon {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            max-width: 320px;
            min-width: 280px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            position: relative;
        }

        .single-balloon-header {
            background: #475493;
            color: white;
            padding: 12px 16px;
            padding-right: 45px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .single-balloon-title {
            font-size: 14px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .single-balloon-close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .single-balloon-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .single-balloon-close-btn:active {
            transform: scale(0.95);
        }

        .single-balloon-content {
            padding: 16px;
        }

        .single-balloon-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .single-stat-item {
            background: #f8f9fa;
            padding: 8px 10px;
            border-radius: 6px;
        }

        .single-stat-label {
            font-size: 10px;
            color: #6b7280;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .single-stat-value {
            font-weight: 600;
            color: #1f2937;
            font-size: 13px;
        }

        .single-stat-value.stands {
            font-weight: 700;
            color: #475493;
            font-size: 16px;
        }

        .single-balloon-hide-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
            width: 100%;
        }

        .single-balloon-hide-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.25);
        }

        .single-balloon-hide-btn:active {
            transform: translateY(0);
        }

        /* Стили для балунов пользовательских меток */
        .marker-balloon,
        .markers-control-panel,
        .markers-full-list {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            max-width: 400px;
            min-width: 300px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            position: relative;
        }

        .marker-balloon-header,
        .markers-control-header,
        .markers-list-header {
            background: #475493;
            color: white;
            padding: 12px 16px;
            padding-right: 45px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .marker-balloon-header h3,
        .markers-control-header h3,
        .markers-list-header h3 {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .marker-balloon-close-btn,
        .markers-control-close-btn,
        .markers-list-close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .marker-balloon-close-btn:hover,
        .markers-control-close-btn:hover,
        .markers-list-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .marker-balloon-close-btn:active,
        .markers-control-close-btn:active,
        .markers-list-close-btn:active {
            transform: scale(0.95);
        }

        .marker-balloon-content,
        .markers-control-content,
        .markers-list-content {
            padding: 16px;
        }

        /* Стили для информации о метке */
        .marker-info {
            margin-bottom: 16px;
            font-size: 14px;
            line-height: 1.5;
            color: #1f2937;
        }

        .marker-info div {
            margin-bottom: 8px;
        }

        .marker-info strong {
            color: #374151;
            font-weight: 600;
        }

        /* Стили для действий с меткой */
        .marker-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .marker-action-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .marker-action-btn.edit-btn {
            background: #3b82f6;
            color: white;
        }

        .marker-action-btn.edit-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.25);
        }

        .marker-action-btn.delete-btn {
            background: #ef4444;
            color: white;
        }

        .marker-action-btn.delete-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.25);
        }

        /* Стили для панели управления метками */
        .markers-control-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .marker-stat {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .marker-stat-label {
            font-size: 10px;
            color: #6b7280;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .marker-stat-value {
            font-weight: 600;
            color: #1f2937;
            font-size: 13px;
        }

        .markers-control-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .markers-control-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .markers-control-btn.add-btn {
            background: #10b981;
            color: white;
        }

        .markers-control-btn.add-btn:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.25);
        }

        .markers-control-btn.list-btn {
            background: #3b82f6;
            color: white;
        }

        .markers-control-btn.list-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.25);
        }

        .markers-control-btn.delete-all-btn {
            background: #ef4444;
            color: white;
        }

        .markers-control-btn.delete-all-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.25);
        }

        /* Стили для превью списка меток */
        .markers-list-preview {
            margin-top: 16px;
            border-top: 1px solid #e5e7eb;
            padding-top: 12px;
        }

        .markers-list-preview h4 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .markers-preview-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .markers-preview-list li {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .markers-preview-list li:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .marker-preview-text {
            font-size: 13px;
            font-weight: 500;
            color: #1f2937;
        }

        .marker-preview-date {
            font-size: 11px;
            color: #6b7280;
        }

        /* Стили для полного списка меток */
        .markers-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .markers-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            font-size: 12px;
        }

        .markers-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }

        .markers-table tr:hover td {
            background: #f8f9fa;
        }

        .marker-action-small {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-right: 4px;
            background: #f3f4f6;
            color: #374151;
            transition: all 0.2s;
        }

        .marker-action-small:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        /* Кнопки в футере списка меток */
        .markers-list-footer {
            padding: 12px 16px;
            background: #f8f9fa;
            border-top: 1px solid #e5e7eb;
        }

        /* Класс для режима добавления метки */
        .map-crosshair-mode {
            cursor: crosshair !important;
        }

        /* Стиль для пользовательской метки на карте */
        .user-marker .ymaps-2-1-79-balloon__content {
            padding: 0 !important;
            margin: 0 !important;
        }

        /* =============== ОБЩАЯ СТРУКТУРА =============== */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        /* =============== СТРУКТУРА ДЛЯ МОБИЛЬНЫХ =============== */
        #compact-header {
            flex-shrink: 0;
            background: var(--brand-color);
            box-shadow: var(--shadow-md);
            padding: 0.875rem 1rem;
            padding-top: calc(0.875rem + var(--safe-area-inset-top));
            z-index: 100;
            display: none;
        }

        .header-title {
            font-size: 1.375rem;
            font-weight: 700;
            color: var(--text-on-brand);
            text-align: left;
            margin-bottom: 0.25rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.3px;
            line-height: 1.2;
        }

        .header-subtitle {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            text-align: left;
            margin-top: 0.25rem;
            font-weight: 400;
        }

        .header-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.375rem 0.25rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            backdrop-filter: blur(10px);
            text-align: center;
            min-height: 40px;
        }

        .stat-value {
            font-size: 0.875rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            text-align: center;
            color: var(--text-on-brand);
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
            margin-top: 0.125rem;
        }

        .stat-label {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            text-align: center;
            line-height: 1;
            margin-bottom: 0.125rem;
        }

        /* НОВЫЕ СТИЛИ ДЛЯ ЧИСЛОВЫХ КОНТРОЛОВ В ОДНУ СТРОКУ */
        .range-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            width: 100%;
        }

        .range-control-label {
            font-size: 0.875rem;
            color: var(--color-secondary);
            white-space: nowrap;
            min-width: 30px;
            text-align: left;
        }

        .range-control-input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex: 1;
            min-width: 0;
        }

        .range-control-button {
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--brand-color);
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .range-control-button:hover {
            background: var(--brand-color);
            color: white;
            border-color: var(--brand-color);
        }

        .range-control-button:active {
            transform: scale(0.95);
        }

        .range-control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--color-background);
            color: var(--color-secondary);
        }

        .range-control-button:disabled:hover {
            background: var(--color-background);
            color: var(--color-secondary);
            border-color: var(--color-border);
        }

        .range-control-input {
            flex: 1;
            min-width: 60px;
            padding: 0.5rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            text-align: center;
            background: var(--color-surface);
            transition: border-color 0.2s;
            font-variant-numeric: tabular-nums;
            width: 100%;
        }

        .range-control-input:focus {
            outline: none;
            border-color: var(--brand-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .range-control-input::-webkit-inner-spin-button,
        .range-control-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .range-control-input[type=number] {
            -moz-appearance: textfield;
        }

        /* ЦЕНТРАЛЬНАЯ ОБЛАСТЬ ДЛЯ МОБИЛЬНЫХ */
        #main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 0;
            display: none;
        }

        /* Карта */
        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
        }

        #map-container > ymaps,
        #desktop-map-container > ymaps {
            width: 100% !important;
            height: 100% !important;
        }

        /* Панель фильтров/списка */
        #mobile-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--color-surface);
            display: none;
            flex-direction: column;
            z-index: 50;
        }

        .mobile-panel-inner {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .mobile-panel-header {
            flex-shrink: 0;
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: 1rem;
            z-index: 10;
        }

        .mobile-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: calc(1rem + var(--safe-area-inset-bottom));
            -webkit-overflow-scrolling: touch;
        }

        /* МОБИЛЬНАЯ НАВИГАЦИЯ */
        #mobile-nav {
            flex-shrink: 0;
            background: var(--brand-color);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            padding-bottom: var(--safe-area-inset-bottom);
            display: none;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
        }

        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            padding: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            font-size: 0.75rem;
            gap: 0.25rem;
            flex: 1;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s;
            border-radius: 6px;
            margin: 0 0.25rem;
        }

        .nav-button:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-button.active {
            color: #ffffff;
            font-weight: 500;
            position: relative;
        }

        .nav-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30%;
            height: 2px;
            background: #ffffff;
            border-radius: 1px;
        }

        .nav-button:active {
            background: rgba(255, 255, 255, 0.15);
            transition: background 0.1s;
        }

        .nav-icon {
            font-size: 1.25rem;
            filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.2));
        }

        .nav-button.active .nav-icon {
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }

        /* =============== СТРУКТУРА ДЛЯ ДЕСКТОПА =============== */
        #desktop-layout {
            display: none;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* НОВЫЕ СТИЛИ ДЛЯ КНОПКИ В ШАПКЕ */
        .sidebar-fullscreen-btn {
            position: absolute;
            top: 1.25rem;
            right: 1.5rem;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-md);
            font-size: 1.25rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }

        .sidebar-fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .sidebar-fullscreen-btn:active {
            transform: scale(0.95);
        }

        /* ПЛАВАЮЩАЯ ШАПКА ДЛЯ ПОЛНОЭКРАННОГО РЕЖИМА */
        #fullscreen-header {
            touch-action: none;
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: linear-gradient(135deg, var(--brand-color), var(--brand-light));
            color: var(--text-on-brand);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            display: none;
            min-width: 600px;
            max-width: 800px;
            backdrop-filter: blur(10px);
            cursor: move;
            user-select: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .fullscreen-header-title {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .fullscreen-header-subtitle {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 1rem;
            font-weight: 400;
        }

        .fullscreen-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .fullscreen-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            backdrop-filter: blur(5px);
            min-width: 120px;
        }

        .fullscreen-stat-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            line-height: 1;
            margin-bottom: 0.25rem;
            white-space: nowrap;
        }

        .fullscreen-stat-value {
            font-weight: 700;
            color: #ffffff;
            font-size: 0.95rem;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .fullscreen-close-btn {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.25rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .fullscreen-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* КНОПКА ОТМЕНЫ */
        .mobile-undo-button,
        .desktop-undo-button,
        .fullscreen-undo-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-md);
            font-size: 1.25rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }

        .mobile-undo-button:hover,
        .desktop-undo-button:hover,
        .fullscreen-undo-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .mobile-undo-button:active,
        .desktop-undo-button:active,
        .fullscreen-undo-button:active {
            transform: scale(0.95);
        }

        .mobile-undo-button:disabled,
        .desktop-undo-button:disabled,
        .fullscreen-undo-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Стиль для скрытого сайдбара */
        #desktop-sidebar.hidden {
            display: none;
        }

        #desktop-map-container.fullscreen {
            width: 100% !important;
        }

        #desktop-sidebar {
            width: 400px;
            min-width: 350px;
            max-width: 450px;
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }

        .sidebar-header {
            background: linear-gradient(135deg, var(--brand-color), var(--brand-light));
            color: var(--text-on-brand);
            padding: 1.25rem 1.5rem;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .sidebar-title {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: left;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            line-height: 1.2;
            padding-right: 60px;
        }

        .sidebar-subtitle {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            text-align: left;
            margin: 0.5rem 0 1rem 0;
            font-weight: 400;
        }

        .sidebar-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        /* Обновляем отступы для десктопной версии */
        .sidebar-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.375rem 0.25rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            backdrop-filter: blur(10px);
        }

        .sidebar-stat-value {
            font-weight: 700;
            color: #ffffff;
            margin-top: 0.125rem;
            font-size: 1rem;
        }

        .sidebar-stat-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            line-height: 1;
            margin-bottom: 0.125rem;
        }

        .sidebar-tabs {
            display: flex;
            background: linear-gradient(to right, var(--brand-color), var(--brand-light));
            border-bottom: 1px solid var(--color-border);
        }

        .sidebar-tab {
            flex: 1;
            padding: 0.875rem;
            background: none;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.85);
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .sidebar-tab:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-tab.active {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.2);
            border-bottom-color: #ffffff;
        }

        .sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
        }

        .tab-content-inner {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
            padding-bottom: 0;
        }

        .tab-footer {
            flex-shrink: 0;
            padding: 1rem 1.25rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--color-border);
            background: var(--color-surface);
        }

        #desktop-map-container {
            flex: 1;
            position: relative;
            background: #f0f0f0;
            display: none;
        }

        /* =============== ОБЩИЕ СТИЛИ ДЛЯ КОНТЕНТА =============== */
        .mobile-reset-button {
            padding: 0.75rem;
            background: #f3f4f6;
            color: var(--color-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
            font-size: 0.9rem;
            -webkit-tap-highlight-color: transparent;
        }

        .mobile-reset-button:hover {
            background: #e5e7eb;
            color: var(--brand-dark);
        }

        .mobile-reset-button:active {
            transform: scale(0.98);
        }

        /* FILTERS */
        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-title {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--brand-dark);
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.25rem 0;
        }

        .checkbox-item input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            accent-color: var(--brand-color);
        }

        /* Обновленные стили для range-row */
        .range-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .range-input-group {
            display: flex;
            flex-direction: column;
        }

        /* ПРОЦЕНТНЫЙ ОТБОР */
        .percentage-selector {
            background: var(--color-surface);
            border: 1px solid #e9ecef;
            border-radius: var(--radius-md);
            padding: 0.75rem;
        }

        .percentage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .percentage-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
        }

        .percentage-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .percentage-button {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .percentage-button:hover {
            background: #5a6268;
        }

        .percentage-button:active {
            transform: scale(0.95);
        }

        .percentage-value-display {
            min-width: 50px;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: #495057;
            background: white;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            border: 1px solid #dee2e6;
        }

        .slider-container {
            margin: 0;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #dee2e6;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 2px solid #6c757d;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .slider::-webkit-slider-thumb:hover {
            border-color: #495057;
        }

        /* СПИСОК ЗДАНИЙ */
        #building-list, #desktop-building-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .building-item {
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-surface);
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .building-item:hover {
            border-color: var(--brand-color);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        /* =============== КОРРЕКЦИИ ДЛЯ ПАНЕЛИ СПИСКА =============== */

        /* Обновляем контейнер заголовка здания для выравнивания в одну строку */
        .building-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            min-height: 32px;
            flex-wrap: nowrap;
            gap: 6px;
        }

        /* Статус - кружочек слева */
        .building-status {
            display: flex;
            align-items: center;
            margin-right: 10px;
            flex-shrink: 0;
        }

        /* Адрес - занимает всё доступное пространство */
        .building-address {
            font-weight: 500;
            flex: 1;
            margin: 0 10px;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
            text-align: left;
        }

        /* Крестик справа - компактный */
        .building-hide {
            color: var(--color-secondary);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-left: 5px;
        }

        .building-hide:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--color-busy);
            transform: scale(1.1);
        }

        .building-details {
            display: flex;
            gap: 0.75rem;
            font-size: 0.875rem;
            color: var(--color-secondary);
            flex-wrap: wrap;
        }

        /* КНОПКИ */
        .reset-button {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: var(--brand-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
        }

        .reset-button:hover {
            background: var(--brand-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .load-more {
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--color-surface);
            color: var(--brand-color);
            border: 1px solid var(--brand-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        .load-more:hover {
            background: var(--brand-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .action-button {
            padding: 0.75rem;
            background: var(--brand-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        .action-button:hover {
            background: var(--brand-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* NOTIFICATIONS */
        .notification-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .notification {
            padding: 1rem 1.25rem;
            border-radius: 12px;
            background: var(--color-surface);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            max-width: 320px;
            border: 1px solid var(--color-border);
            position: relative;
            overflow: hidden;
        }

        .notification::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        .notification.success::before {
            background: var(--color-free);
        }

        .notification.error::before {
            background: var(--color-busy);
        }

        .notification.info::before {
            background: var(--brand-color);
        }

        .notification-icon {
            font-size: 1.25rem;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-content {
            flex: 1;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* =============== АДАПТИВНОСТЬ =============== */
        @media (min-width: 769px) {
            #compact-header,
            #mobile-nav,
            #mobile-panel,
            #main-content {
                display: none !important;
            }
            
            #desktop-layout {
                display: flex;
            }
            
            #desktop-map-container {
                display: block;
            }
            
            #app-container {
                flex-direction: column;
            }
            
            .sidebar-content {
                padding: 0;
            }
            
            .filter-section {
                margin-bottom: 1.25rem;
            }
            
            .building-item {
                padding: 0.875rem;
            }
            
            #desktop-list-tab {
                display: flex;
                flex-direction: column;
            }
            
            #desktop-list-tab .percentage-selector {
                flex-shrink: 0;
                border-bottom: 1px solid var(--color-border);
                border-radius: 0;
                padding: 1rem 1.25rem;
                background: var(--color-surface);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }
            
            #desktop-list-tab .tab-content-inner {
                flex: 1;
                overflow-y: auto;
                padding: 1.25rem;
                padding-bottom: 0;
            }
            
            #desktop-filters-tab {
                display: flex;
                flex-direction: column;
            }
            
            #desktop-filters-tab .tab-content-inner {
                flex: 1;
                overflow-y: auto;
                padding: 1.25rem;
                padding-bottom: 0;
            }
            
            .tab-content {
                display: none !important;
            }
            
            .tab-content.active {
                display: flex !important;
            }
            
            /* Десктопные стили для балунов меток */
            .marker-balloon,
            .markers-control-panel,
            .markers-full-list {
                max-width: 400px;
            }
            
            .markers-table {
                font-size: 13px;
            }
        }

        @media (max-width: 768px) {
            #desktop-layout {
                display: none;
            }
            
            #compact-header,
            #mobile-nav,
            #main-content {
                display: block;
            }
            
            #map-container {
                display: block;
            }
            
            .header-title {
                font-size: 1.125rem;
                padding-right: 50px;
            }
            
            .header-subtitle {
                font-size: 0.875rem;
            }
            
            .stat-value {
                font-size: 0.875rem;
            }
            
            .stat-label {
                font-size: 0.65rem;
            }
            
            .notification-container {
                top: calc(7.2rem + var(--safe-area-inset-top));
                bottom: auto;
                right: auto;
                left: auto;
            }
            
            .notification {
                width: 100%;
            }
            
            .building-details {
                font-size: 0.8rem;
            }
            
            #mobile-panel .panel-tabs {
                display: none;
            }
            
            #mobile-filters-tab,
            #mobile-list-tab {
                display: none;
            }
            
            #mobile-filters-tab.active,
            #mobile-list-tab.active {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            
            button, .checkbox-item, .building-item {
                touch-action: manipulation;
            }
            
            .nav-button {
                padding: 0.75rem 0.5rem;
                min-height: 48px;
            }
            
            .building-item {
                padding: 1rem;
            }
            
            /* Для мобильных устройств - дополнительная адаптация */
            .building-header {
                min-height: 28px;
                margin-bottom: 0.4rem;
            }
            
            .building-address {
                font-size: 0.9rem;
                margin: 0 8px;
            }
            
            .building-hide {
                width: 22px;
                height: 22px;
                font-size: 1.4rem;
            }
            
            .mobile-reset-button {
                padding: 1rem;
                font-size: 1rem;
            }
            
            .percentage-button {
                width: 36px;
                height: 36px;
                font-size: 1.1rem;
            }
            
            .percentage-value-display {
                min-width: 60px;
                font-size: 1.2rem;
            }
            
            .mobile-panel-header {
                padding: 1rem;
                border-bottom: 1px solid var(--color-border);
                background: var(--color-surface);
            }
            
            .mobile-panel-content {
                padding: 1rem;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            #mobile-list-tab {
                display: flex;
                flex-direction: column;
            }
            
            #mobile-list-tab .percentage-selector {
                flex-shrink: 0;
                border-bottom: 1px solid var(--color-border);
                border-radius: 0;
                padding: 1rem;
                background: var(--color-surface);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }
            
            #mobile-list-tab .mobile-panel-content {
                flex: 1;
                overflow-y: auto;
                padding: 1rem;
                padding-bottom: calc(1rem + var(--safe-area-inset-bottom));
            }
            
            /* На мобильных делаем контролы в колонку */
            .range-row {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            /* Кнопка отмены на мобильных */
            .mobile-undo-button {
                position: absolute;
                top: 10px;
                right: 10px !important;
                left: auto !important;
                width: 32px;
                height: 32px;
                font-size: 18px;
                z-index: 1001 !important;
            }
            
            /* Мобильные стили для балунов меток */
            .marker-balloon,
            .markers-control-panel,
            .markers-full-list {
                max-width: 320px;
                min-width: 280px;
            }
            
            .marker-actions {
                flex-direction: column;
            }
            
            .markers-control-actions {
                flex-direction: column;
            }
            
            .markers-table {
                font-size: 12px;
            }
            
            .markers-table th,
            .markers-table td {
                padding: 8px;
            }
            
            .marker-action-small {
                font-size: 10px;
                padding: 3px 6px;
                margin-right: 3px;
            }
            
            /* Стили для заглушки ландшафтного режима на мобильных */
            @media (max-height: 500px) and (orientation: landscape) {
                #landscape-warning {
                    display: flex !important;
                    opacity: 1 !important;
                }
                
                #compact-header,
                #mobile-nav,
                #main-content {
                    display: none !important;
                }
            }
            
            @media (max-height: 400px) {
                .landscape-title {
                    font-size: 1.5rem;
                }
                
                .landscape-message {
                    font-size: 1rem;
                    margin-bottom: 1.5rem;
                }
                
                .landscape-icon {
                    font-size: 3rem;
                    margin-bottom: 1rem;
                }
                
                .landscape-hint {
                    margin-top: 1rem;
                    padding: 0.75rem;
                    font-size: 0.85rem;
                }
            }
        }

        @media (max-width: 360px) {
            .header-title {
                font-size: 1rem;
            }
            
            .header-subtitle {
                font-size: 0.8rem;
            }
            
            .stat-value {
                font-size: 0.8rem;
            }
            
            .stat-label {
                font-size: 0.6rem;
            }
            
            .header-stats {
                gap: 0.375rem;
            }
            
            .stat-item {
                padding: 0.25rem 0.125rem;
                min-height: 36px;
            }
            
            .nav-button span:not(.nav-icon) {
                font-size: 0.7rem;
            }
            
            .notification-container {
                top: calc(0.75rem + var(--safe-area-inset-top));
            }
            
            /* На очень маленьких экранах уменьшаем кнопки */
            .range-control-button {
                width: 1.75rem;
                height: 1.75rem;
                font-size: 1rem;
            }
            
            .range-control-input {
                min-width: 50px;
                padding: 0.375rem;
                font-size: 0.8rem;
            }
            
            /* Для очень маленьких экранов */
            .building-address {
                font-size: 0.85rem;
                margin: 0 6px;
            }
            
            .building-hide {
                width: 20px;
                height: 20px;
                font-size: 1.3rem;
            }
            
            /* Кнопка отмены на очень маленьких экранах */
            .mobile-undo-button {
                top: 8px;
                right: 8px !important;
                left: auto !important;
                width: 28px;
                height: 28px;
                font-size: 16px;
            }
            
            /* Стили для балунов меток на очень маленьких экранах */
            .marker-balloon,
            .markers-control-panel,
            .markers-full-list {
                max-width: 280px;
                min-width: 250px;
            }
            
            .marker-balloon-header,
            .markers-control-header,
            .markers-list-header {
                padding: 10px 12px;
                padding-right: 40px;
            }
            
            .marker-balloon-close-btn,
            .markers-control-close-btn,
            .markers-list-close-btn {
                width: 26px;
                height: 26px;
                font-size: 16px;
                top: 6px;
                right: 6px;
            }
            
            .marker-balloon-content,
            .markers-control-content,
            .markers-list-content {
                padding: 12px;
            }
            
            .marker-action-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            /* Стили для заглушки на очень маленьких экранах */
            .landscape-title {
                font-size: 1.3rem;
            }
            
            .landscape-message {
                font-size: 0.9rem;
            }
            
            .landscape-icon {
                font-size: 2.5rem;
            }
            
            .landscape-button {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
            }
            
            .landscape-hint {
                font-size: 0.8rem;
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Добавляем заглушку для ландшафтного режима -->
    <div id="landscape-warning">
        <div class="landscape-icon">📱</div>
        <h1 class="landscape-title">Поверните устройство</h1>
        <p class="landscape-message">
            Для удобной работы с картой и списком объектов поверните устройство 
            в портретную ориентацию или увеличьте высоту окна браузера.
        </p>
        <button class="landscape-button" onclick="window.location.reload()">
            <span>🔄</span>
            <span>Обновить после поворота</span>
        </button>
        <div class="landscape-hint">
            Если вы используете компьютер, увеличьте высоту окна браузера 
            для продолжения работы с приложением.
        </div>
    </div>
	
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div>Загрузка карты...</div>
    </div>

    <div id="app-container">
        <!-- МОБИЛЬНАЯ ВЕРСИЯ -->
        <div id="compact-header">
            <div class="header-title">
                PR МАРКЕТ Рязань
                <div class="header-subtitle">Стенды у домофонов: <span id="total-in-base">0</span> в базе</div>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-label">Выбрано стендов</span>
                    <span class="stat-value" id="selected-stands">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Охват квартир</span>
                    <span class="stat-value" id="coverage-flats">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">В месяц</span>
                    <span class="stat-value" id="monthly-price">—</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">За квартиру</span>
                    <span class="stat-value" id="per-flat-price">—</span>
                </div>
            </div>
        </div>

        <div id="main-content">
            <div id="map-container"></div>

            <div id="mobile-panel">
                <div id="mobile-filters-tab" class="mobile-panel-inner" style="display: none;">
                    <div class="mobile-panel-header">
                        <button class="mobile-reset-button" id="mobile-reset-filters">↻ Сбросить фильтры</button>
                    </div>
                    <div class="mobile-panel-content">
                        <div class="filter-section">
                            <div class="filter-title">Статус</div>
                            <div class="filter-options" id="status-filter"></div>
                        </div>
                        <div class="filter-section">
                            <div class="filter-title">Район</div>
                            <div class="filter-options" id="district-filter"></div>
                        </div>
                        <div class="filter-section">
                            <div class="filter-title">Этажность</div>
                            <div class="range-row">
                                <!-- "От" контрол -->
                                <div class="range-control">
                                    <span class="range-control-label">От</span>
                                    <div class="range-control-input-wrapper">
                                        <button class="range-control-button minus" data-target="floors-min" type="button">-</button>
                                        <input type="number" class="range-control-input" id="floors-min" placeholder="Мин" min="1">
                                        <button class="range-control-button plus" data-target="floors-min" type="button">+</button>
                                    </div>
                                </div>
                                <!-- "До" контрол -->
                                <div class="range-control">
                                    <span class="range-control-label">До</span>
                                    <div class="range-control-input-wrapper">
                                        <button class="range-control-button minus" data-target="floors-max" type="button">-</button>
                                        <input type="number" class="range-control-input" id="floors-max" placeholder="Макс" min="1">
                                        <button class="range-control-button plus" data-target="floors-max" type="button">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-section">
                            <div class="filter-title">Квартир в подъезде</div>
                            <div class="range-row">
                                <!-- "От" контрол -->
                                <div class="range-control">
                                    <span class="range-control-label">От</span>
                                    <div class="range-control-input-wrapper">
                                        <button class="range-control-button minus" data-target="flats-min" type="button">-</button>
                                        <input type="number" class="range-control-input" id="flats-min" placeholder="Мин" min="1">
                                        <button class="range-control-button plus" data-target="flats-min" type="button">+</button>
                                    </div>
                                </div>
                                <!-- "До" контрол -->
                                <div class="range-control">
                                    <span class="range-control-label">До</span>
                                    <div class="range-control-input-wrapper">
                                        <button class="range-control-button minus" data-target="flats-max" type="button">-</button>
                                        <input type="number" class="range-control-input" id="flats-max" placeholder="Макс" min="1">
                                        <button class="range-control-button plus" data-target="flats-max" type="button">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="mobile-list-tab" class="mobile-panel-inner" style="display: none;">
                    <div class="percentage-selector">
                        <div class="percentage-header">
                            <div class="percentage-title">ПРОЦЕНТ ПОКАЗА 🏠</div>
                            <div class="percentage-controls">
                                <button class="percentage-button" id="mobile-percentage-decrease">-</button>
                                <span class="percentage-value-display" id="mobile-percentage-value">100%</span>
                                <button class="percentage-button" id="mobile-percentage-increase">+</button>
                            </div>
                        </div>
                        <div class="slider-container">
                            <input type="range" class="slider" id="mobile-percentage-slider" min="1" max="100" value="100">
                        </div>
                    </div>
                    
                    <div class="mobile-panel-content">
                        <div id="building-list"></div>
                        <button class="load-more" id="load-more">Показать еще</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="mobile-nav">
            <div class="nav-buttons">
                <button class="nav-button active" data-view="map">
                    <span class="nav-icon">🗺️</span>
                    <span>Карта</span>
                </button>
                <button class="nav-button" data-view="filters">
                    <span class="nav-icon">⚙️</span>
                    <span>Фильтры</span>
                </button>
                <button class="nav-button" data-view="list">
                    <span class="nav-icon">🛒</span>
                    <span>Список</span>
                </button>
                <button class="nav-button" id="mobile-report-button">
                    <span class="nav-icon">📄</span>
                    <span>Отчёт</span>
                </button>
            </div>
        </div>

        <!-- ДЕСКТОПНАЯ ВЕРСИЯ -->
        <div id="desktop-layout">
            <!-- Плавающая шапка для полноэкранного режима -->
            <div id="fullscreen-header">
                <div class="fullscreen-header-title">
                    <span>PR МАРКЕТ Рязань</span>
                    <button class="fullscreen-close-btn" id="fullscreen-close-btn">◀</button>
                </div>
                <div class="fullscreen-header-subtitle">
                    Стенды у домофонов: <span id="fullscreen-total-in-base">0</span> в базе
                </div>
                <div class="fullscreen-stats-grid">
                    <div class="fullscreen-stat-item">
                        <span class="fullscreen-stat-label">ВЫБРАНО СТЕНДОВ</span>
                        <span class="fullscreen-stat-value" id="fullscreen-selected-stands">0</span>
                    </div>
                    <div class="fullscreen-stat-item">
                        <span class="fullscreen-stat-label">ОХВАТ КВАРТИР</span>
                        <span class="fullscreen-stat-value" id="fullscreen-coverage-flats">0</span>
                    </div>
                    <div class="fullscreen-stat-item">
                        <span class="fullscreen-stat-label">СТОИМОСТЬ В МЕСЯЦ</span>
                        <span class="fullscreen-stat-value" id="fullscreen-monthly-price">—</span>
                    </div>
                    <div class="fullscreen-stat-item">
                        <span class="fullscreen-stat-label">В ПЕРЕСЧЁТЕ НА КВАРТИРУ</span>
                        <span class="fullscreen-stat-value" id="fullscreen-per-flat-price">—</span>
                    </div>
                </div>
            </div>
            
            <div id="desktop-sidebar">
                <div class="sidebar-header">
                    <!-- Кнопка в шапке -->
                    <button class="sidebar-fullscreen-btn" id="sidebar-fullscreen-btn" title="Развернуть на весь экран">◀</button>
                    
                    <div class="sidebar-title">
                        PR МАРКЕТ Рязань
                        <div class="sidebar-subtitle">Стенды у домофонов: <span id="desktop-total-in-base">0</span> в базе</div>
                    </div>
                    <div class="sidebar-stats">
                        <div class="sidebar-stat-item">
                            <span class="sidebar-stat-label">ВЫБРАНО СТЕНДОВ</span>
                            <span class="sidebar-stat-value" id="desktop-selected-stands">0</span>
                        </div>
                        <div class="sidebar-stat-item">
                            <span class="sidebar-stat-label">ОХВАТ КВАРТИР</span>
                            <span class="sidebar-stat-value" id="desktop-coverage-flats">0</span>
                        </div>
                        <div class="sidebar-stat-item">
                            <span class="sidebar-stat-label">СТОИМОСТЬ В МЕСЯЦ</span>
                            <span class="sidebar-stat-value" id="desktop-monthly-price">—</span>
                        </div>
                        <div class="sidebar-stat-item">
                            <span class="sidebar-stat-label">В ПЕРЕСЧЁТЕ НА КВАРТИРУ</span>
                            <span class="sidebar-stat-value" id="desktop-per-flat-price">—</span>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="filters">⚙️ Фильтры</button>
                    <button class="sidebar-tab" data-tab="list">🛒 Список</button>
                </div>
                
                <div class="sidebar-content">
                    <div class="tab-content active" id="desktop-filters-tab">
                        <div class="tab-content-inner">
                            <div class="filter-section">
                                <div class="filter-title">Статус</div>
                                <div class="filter-options" id="desktop-status-filter"></div>
                            </div>
                            <div class="filter-section">
                                <div class="filter-title">Район</div>
                                <div class="filter-options" id="desktop-district-filter"></div>
                            </div>
                            <div class="filter-section">
                                <div class="filter-title">Этажность</div>
                                <div class="range-row">
                                    <!-- "От" контрол -->
                                    <div class="range-control">
                                        <span class="range-control-label">От</span>
                                        <div class="range-control-input-wrapper">
                                            <button class="range-control-button minus" data-target="desktop-floors-min" type="button">-</button>
                                            <input type="number" class="range-control-input" id="desktop-floors-min" placeholder="Мин" min="1">
                                            <button class="range-control-button plus" data-target="desktop-floors-min" type="button">+</button>
                                        </div>
                                    </div>
                                    <!-- "До" контрол -->
                                    <div class="range-control">
                                        <span class="range-control-label">До</span>
                                        <div class="range-control-input-wrapper">
                                            <button class="range-control-button minus" data-target="desktop-floors-max" type="button">-</button>
                                            <input type="number" class="range-control-input" id="desktop-floors-max" placeholder="Макс" min="1">
                                            <button class="range-control-button plus" data-target="desktop-floors-max" type="button">+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="filter-section">
                                <div class="filter-title">Квартир в подъезде</div>
                                <div class="range-row">
                                    <!-- "От" контрол -->
                                    <div class="range-control">
                                        <span class="range-control-label">От</span>
                                        <div class="range-control-input-wrapper">
                                            <button class="range-control-button minus" data-target="desktop-flats-min" type="button">-</button>
                                            <input type="number" class="range-control-input" id="desktop-flats-min" placeholder="Мин" min="1">
                                            <button class="range-control-button plus" data-target="desktop-flats-min" type="button">+</button>
                                        </div>
                                    </div>
                                    <!-- "До" контрол -->
                                    <div class="range-control">
                                        <span class="range-control-label">До</span>
                                        <div class="range-control-input-wrapper">
                                            <button class="range-control-button minus" data-target="desktop-flats-max" type="button">-</button>
                                            <input type="number" class="range-control-input" id="desktop-flats-max" placeholder="Макс" min="1">
                                            <button class="range-control-button plus" data-target="desktop-flats-max" type="button">+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-footer">
                            <button class="reset-button" id="desktop-reset-filters">↻ Сбросить фильтры</button>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="desktop-list-tab">
                        <div class="percentage-selector">
                            <div class="percentage-header">
                                <div class="percentage-title">ПРОЦЕНТ ПОКАЗА 🏠</div>
                                <div class="percentage-controls">
                                    <button class="percentage-button" id="desktop-percentage-decrease">-</button>
                                    <span class="percentage-value-display" id="desktop-percentage-value">100%</span>
                                    <button class="percentage-button" id="desktop-percentage-increase">+</button>
                                </div>
                            </div>
                            <div class="slider-container">
                                <input type="range" class="slider" id="desktop-percentage-slider" min="1" max="100" value="100">
                            </div>
                        </div>
                        
                        <div class="tab-content-inner">
                            <div id="desktop-building-list"></div>
                            <button class="load-more" id="desktop-load-more">Показать еще</button>
                        </div>
                        <div class="tab-footer">
                            <button class="action-button" id="desktop-generate-report">📃 Сформировать отчёт</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="desktop-map-container"></div>
        </div>
    </div>

    <div class="notification-container" id="notification-container"></div>

    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>

    <script>
	
	    // ============================================================================
    // МОДУЛЬ ДЛЯ ЛАНДШАФТНОЙ ЗАГЛУШКИ
    // ============================================================================
    const LandscapeWarningModule = {
        init() {
            this.checkLandscapeWarning();
            window.addEventListener('resize', Utils.debounce(() => this.checkLandscapeWarning(), 250));
            window.addEventListener('orientationchange', () => {
                setTimeout(() => this.checkLandscapeWarning(), 300);
            });
        },
        
        checkLandscapeWarning() {
            const warning = document.getElementById('landscape-warning');
            if (!warning) return;
            
            const width = window.innerWidth;
            const height = window.innerHeight;
            const isMobile = width <= 768;
            
            // Показываем заглушку только на мобильных устройствах в ландшафтном режиме с маленькой высотой
            const shouldShowWarning = isMobile && height < 500 && width > height;
            
            if (shouldShowWarning) {
                warning.classList.add('active');
                // Блокируем скролл на странице
                document.body.style.overflow = 'hidden';
            } else {
                warning.classList.remove('active');
                // Восстанавливаем скролл
                document.body.style.overflow = '';
            }
        },
        
        // Добавляем кнопку для принудительного скрытия заглушки (на случай, если пользователь понимает, что делает)
        addForceContinueButton() {
            const warning = document.getElementById('landscape-warning');
            if (!warning) return;
            
            const continueButton = document.createElement('button');
            continueButton.className = 'landscape-button';
            continueButton.style.marginTop = '0.5rem';
            continueButton.style.background = 'rgba(255, 255, 255, 0.1)';
            continueButton.innerHTML = '<span>⚠️</span><span>Продолжить в ландшафтном режиме</span>';
            
            continueButton.addEventListener('click', () => {
                warning.classList.remove('active');
                document.body.style.overflow = '';
                Utils.showNotification('Вы продолжили в ландшафтном режиме. Некоторые функции могут быть ограничены.', 'info');
            });
            
            const hint = warning.querySelector('.landscape-hint');
            if (hint) {
                hint.parentNode.insertBefore(continueButton, hint.nextSibling);
            }
        }
    };
	
    // ============================================================================
    // КОНФИГУРАЦИЯ И ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
    // ============================================================================
    const CONFIG = {
        GOOGLE_SHEETS: {
            SHEET_ID: "1jZsHbNXVmvNRjmh_p1pLFl3G3oLgD0sFas8L4EDexiI",
            SHEET_NAME: "Filter"
        },
        
        MAP: {
            CENTER: [54.6416, 39.7126],
            ZOOM: 11
        },
        
        PRICING_RULES: {
            MIN_STANDS: 100,
            TIERS: [
                { from: 100, to: 299, price: 160 },
                { from: 300, to: 499, price: 140 },
                { from: 500, to: Infinity, price: 120 }
            ]
        }
    };

    // Глобальные переменные
    let map = null;
    let objectManager = null;
    let allBuildings = [];
    let filteredBuildings = [];
    let displayedBuildings = [];
    let hiddenBuildings = new Set();
    let activeFilters = {
        status: new Set(),
        district: new Set(),
        floors: { min: null, max: null },
        flatsPerEntrance: { min: null, max: null }
    };
    let currentPercentage = 100;
    let listLimit = 50;
    let isMobile = window.innerWidth <= 768;
    let currentView = 'map';
    let currentDesktopTab = 'filters';
    let isGeneratingReport = false;
    let currentNotification = null;
    let appInitialized = false;
    let availableValues = {
        floors: [],
        flatsPerEntrance: []
    };
    let isFullscreen = false;
    let dragData = null;

    // ============================================================================
    // УТИЛИТАРНЫЕ ФУНКЦИИ
    // ============================================================================
    const Utils = {
        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        },

        formatNumber(num) {
            if (num === null || num === undefined) return '—';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        },

        formatPrice(amount) {
            if (amount === null || amount === undefined) return '—';
            if (Number.isInteger(amount)) {
                return `${Utils.formatNumber(amount)} ₽`;
            }
            return `${amount.toFixed(2)} ₽`;
        },

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },

        showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            if (!container) return;
            
            if (currentNotification) {
                currentNotification.remove();
                currentNotification = null;
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let icon = 'ℹ️';
            if (type === 'success') icon = '✅';
            if (type === 'error') icon = '❌';
            
            notification.innerHTML = `
                <div class="notification-icon">${icon}</div>
                <div class="notification-content">${message}</div>
            `;
            
            container.appendChild(notification);
            currentNotification = notification;
            
            setTimeout(() => {
                if (notification.parentNode === container) {
                    notification.remove();
                    currentNotification = null;
                }
            }, 3000);
        },

        setMobileView(view) {
            if (!isMobile) return;
            
            if (currentView === view && view !== 'map') {
                view = 'map';
            }
            
            currentView = view;
            
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
                if (button.dataset.view === view) {
                    button.classList.add('active');
                }
            });
            
            const mapContainer = document.getElementById('map-container');
            const mobilePanel = document.getElementById('mobile-panel');
            const filtersTab = document.getElementById('mobile-filters-tab');
            const listTab = document.getElementById('mobile-list-tab');
            
            switch(view) {
                case 'map':
                    mapContainer.style.display = 'block';
                    mobilePanel.style.display = 'none';
                    if (map) {
                        setTimeout(() => map.container.fitToViewport(), 100);
                    }
                    break;
                    
                case 'filters':
                    mapContainer.style.display = 'none';
                    mobilePanel.style.display = 'flex';
                    filtersTab.classList.add('active');
                    listTab.classList.remove('active');
                    filtersTab.style.display = 'flex';
                    listTab.style.display = 'none';
                    break;
                    
                case 'list':
                    mapContainer.style.display = 'none';
                    mobilePanel.style.display = 'flex';
                    filtersTab.classList.remove('active');
                    listTab.classList.add('active');
                    filtersTab.style.display = 'none';
                    listTab.style.display = 'flex';
                    break;
            }
        },

        setDesktopTab(tab) {
            currentDesktopTab = tab;
            
            document.querySelectorAll('.sidebar-tab').forEach(tabEl => {
                tabEl.classList.remove('active');
                if (tabEl.dataset.tab === tab) {
                    tabEl.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`desktop-${tab}-tab`).classList.add('active');
        },

        calculateAvailableHeight() {
            const header = document.getElementById('compact-header');
            const nav = document.getElementById('mobile-nav');
            
            if (!header || !nav) return '100%';
            
            const headerHeight = header.offsetHeight;
            const navHeight = nav.offsetHeight;
            
            return `calc(100% - ${headerHeight + navHeight}px)`;
        },

        updateMainContentHeight() {
            if (!isMobile) return;
            
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                mainContent.style.height = this.calculateAvailableHeight();
            }
        },
        
        shortenDistrictName(district) {
            if (!district) return '';
            const match = district.match(/^([^(]+)/);
            return match ? match[0].trim() : district;
        },
        
        getNearestValue(value, valuesArray, direction = 0) {
            if (!valuesArray || valuesArray.length === 0) return value;
            
            let nearest = valuesArray[0];
            let minDiff = Math.abs(value - nearest);
            
            for (const val of valuesArray) {
                const diff = Math.abs(value - val);
                if (diff < minDiff) {
                    minDiff = diff;
                    nearest = val;
                }
            }
            
            if (direction > 0) {
                const greaterValues = valuesArray.filter(v => v > value);
                return greaterValues.length > 0 ? Math.min(...greaterValues) : nearest;
            } else if (direction < 0) {
                const lesserValues = valuesArray.filter(v => v < value);
                return lesserValues.length > 0 ? Math.max(...lesserValues) : nearest;
            }
            
            return nearest;
        }
    };

    // ============================================================================
    // МОДУЛЬ 1: ЗАГРУЗКА ДАННЫХ
    // ============================================================================
    const DataModule = {
        async loadData() {
            return new Promise((resolve, reject) => {
                const { SHEET_ID, SHEET_NAME } = CONFIG.GOOGLE_SHEETS;
                const callbackName = `handleSheetData_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:${callbackName}&sheet=${SHEET_NAME}`;
                
                window[callbackName] = function(response) {
                    try {
                        delete window[callbackName];
                        document.getElementById('jsonp-script')?.remove();
                        
                        const data = this.parseGoogleSheetsResponse(response);
                        
                        Utils.showNotification(`Загружено зданий: ${data.length}`, 'success');
                        
                        resolve(data);
                    } catch (error) {
                        console.error('Ошибка обработки данных:', error);
                        Utils.showNotification('Ошибка обработки данных', 'error');
                        reject(error);
                    }
                }.bind(this);

                const script = document.createElement('script');
                script.id = 'jsonp-script';
                script.src = url;
                script.onerror = () => {
                    script.remove();
                    Utils.showNotification('Ошибка загрузки данных', 'error');
                    reject(new Error('Ошибка загрузки данных'));
                };
                
                document.head.appendChild(script);
            });
        },

        parseGoogleSheetsResponse(response) {
            try {
                const data = response;
                const rows = data.table.rows || [];
                const buildings = [];
                
                const floorsSet = new Set();
                const flatsPerEntranceSet = new Set();
                
                rows.forEach((row, index) => {
                    const cells = row.c;
                    
                    const latStr = cells[1]?.v;
                    const lngStr = cells[2]?.v;
                    
                    const lat = latStr ? parseFloat(latStr.toString().replace(',', '.')) : 0;
                    const lng = lngStr ? parseFloat(lngStr.toString().replace(',', '.')) : 0;
                    
                    const building = {
                        originalIndex: index,
                        address: cells[0]?.v || '',
                        lat: lat,
                        lng: lng,
                        status: cells[3]?.v || '',
                        district: cells[4]?.v || '',
                        entrances: parseInt(cells[5]?.v) || 0,
                        floors: parseInt(cells[6]?.v) || 0,
                        flats: parseInt(cells[7]?.v) || 0,
                        flatsPerEntrance: parseInt(cells[8]?.v) || 0
                    };
                    
                    if (building.lat && building.lng && building.address) {
                        buildings.push(building);
                        
                        if (building.floors > 0) floorsSet.add(building.floors);
                        if (building.flatsPerEntrance > 0) flatsPerEntranceSet.add(building.flatsPerEntrance);
                    }
                });
                
                availableValues.floors = Array.from(floorsSet).sort((a, b) => a - b);
                availableValues.flatsPerEntrance = Array.from(flatsPerEntranceSet).sort((a, b) => a - b);
                
                return buildings;
                
            } catch (error) {
                console.error('Ошибка парсинга:', error);
                throw error;
            }
        }
    };

    // ============================================================================
    // МОДУЛЬ 2: КАРТА
    // ============================================================================
    const MapModule = {
        markerModeActive: false,
        newMarkerPlacemark: null,
        currentClickHandler: null,
        currentEscHandler: null,
        userMarkers: [],
        userMarkersCollection: null,
        
        initUserMarkers: function() {
            if (!map) return;
            
            this.userMarkersCollection = new ymaps.GeoObjectCollection(null, {
                preset: 'islands#redStretchyIcon',
                draggable: true,
                balloonOffset: [0, -40],
                zIndex: 2000,
                clusterize: false,
                cursor: 'pointer'
            });
            
            map.geoObjects.add(this.userMarkersCollection);
            this.loadUserMarkers();
            this.bringUserMarkersToFront();
        },

        loadUserMarkers: function() {
            try {
                const savedMarkers = localStorage.getItem('pr-market-user-markers');
                if (savedMarkers) {
                    this.userMarkers = JSON.parse(savedMarkers);
                    this.renderUserMarkers();
                }
            } catch (e) {
                console.error('Ошибка загрузки меток:', e);
                this.userMarkers = [];
            }
        },
        
        saveUserMarkers: function() {
            try {
                localStorage.setItem('pr-market-user-markers', JSON.stringify(this.userMarkers));
            } catch (e) {
                console.error('Ошибка сохранения меток:', e);
            }
        },
        
        closeCurrentMarkerBalloon: function() {
            if (map && map.balloon && map.balloon.isOpen()) {
                map.balloon.close();
            }
        },

        renderUserMarkers: function() {
            if (!this.userMarkersCollection || !map) return;
            
            this.userMarkersCollection.removeAll();
            
            this.userMarkers.forEach((marker, index) => {
                const placemark = this.createPlacemark(marker, index);
                this.userMarkersCollection.add(placemark);
            });
            
            this.bringUserMarkersToFront();
        },

        createPlacemark: function(marker, index) {
            const iconText = marker.text ? 
                (marker.text.length > 6 ? marker.text.substring(0, 6) + '..' : marker.text) : 
                '★';
            
            const placemark = new ymaps.Placemark(
                [marker.lat, marker.lng],
                {
                    iconContent: iconText,
                    hintContent: `Метка: ${marker.text || 'Без названия'}`,
                    balloonContent: this.createMarkerBalloonContent(marker, index)
                },
                {
                    preset: "islands#redStretchyIcon",
                    draggable: true,
                    openBalloonOnClick: true,
                    hideIconOnBalloonOpen: false,
                    balloonOffset: [0, -40],
                    zIndex: 2000 + index,
                    cursor: 'pointer',
                    hasBalloon: true,
                    hasHint: true,
                    balloonAutoPan: true,
                    balloonPanelMaxMapArea: 0,
                    balloonCloseButton: false
                }
            );
            
            placemark.options.set({
                className: 'user-marker'
            });
            
            placemark.events.add('dragend', (e) => {
                const coords = placemark.geometry.getCoordinates();
                this.userMarkers[index] = {
                    ...this.userMarkers[index],
                    lat: coords[0],
                    lng: coords[1]
                };
                this.saveUserMarkers();
                Utils.showNotification('Метка перемещена', 'info');
            });
            
            placemark.events.add('balloonopen', () => {
                placemark.options.set('zIndex', 3000);
            });
            
            placemark.events.add('balloonclose', () => {
                placemark.options.set('zIndex', 2000 + index);
            });
            
            return placemark;
        },

        createMarkerBalloonContent: function(marker, index) {
            return `
                <div class="marker-balloon">
                    <div class="marker-balloon-header">
                        <span>Пользовательская метка</span>
                        <button class="marker-balloon-close-btn" title="Закрыть" onclick="MapModule.closeCurrentMarkerBalloon()">×</button>
                    </div>
                    <div class="marker-balloon-content">
                        <div class="marker-info">
                            <div><strong>Текст:</strong> ${Utils.escapeHtml(marker.text || 'Не указан')}</div>
                            <div><strong>Координаты:</strong> ${marker.lat.toFixed(6)}, ${marker.lng.toFixed(6)}</div>
                            <div><strong>Дата создания:</strong> ${new Date(marker.createdAt).toLocaleString()}</div>
                        </div>
                        <div class="marker-actions">
                            <button class="marker-action-btn edit-btn" onclick="MapModule.editMarker(${index})">
                                ✏️ Редактировать
                            </button>
                            <button class="marker-action-btn delete-btn" onclick="MapModule.deleteMarker(${index})">
                                🗑️ Удалить метку
                            </button>
                        </div>
                    </div>
                </div>
            `;
        },

        editMarker: function(index) {
            const marker = this.userMarkers[index];
            const newText = prompt('Введите новый текст для метки:', marker.text || '');
            
            if (newText !== null) {
                this.userMarkers[index] = {
                    ...marker,
                    text: newText
                };
                this.saveUserMarkers();
                this.renderUserMarkers();
                Utils.showNotification('Метка обновлена', 'success');
                this.closeCurrentMarkerBalloon();
            }
        },
        
        deleteMarker: function(index) {
            if (confirm('Удалить эту метку?')) {
                this.userMarkers.splice(index, 1);
                this.saveUserMarkers();
                this.renderUserMarkers();
                this.closeCurrentMarkerBalloon();
                Utils.showNotification('Метка удалена', 'success');
            }
        },
        
        deleteAllMarkers: function() {
            if (this.userMarkers.length === 0) {
                Utils.showNotification('Нет меток для удаления', 'info');
                return;
            }
            
            if (confirm(`Удалить все метки (${this.userMarkers.length})?`)) {
                this.userMarkers = [];
                this.saveUserMarkers();
                this.renderUserMarkers();
                Utils.showNotification('Все метки удалены', 'success');
            }
        },
        
        enterAddMarkerMode: function() {
            if (this.markerModeActive) return;

            // Очистка старых обработчиков
            if (this.currentClickHandler) {
                map.events.remove('click', this.currentClickHandler);
                this.currentClickHandler = null;
            }
            if (this.currentEscHandler) {
                document.removeEventListener('keydown', this.currentEscHandler);
                this.currentEscHandler = null;
            }

            this.markerModeActive = true;
            Utils.showNotification('Кликните на карту, чтобы добавить метку. ESC для отмены.', 'info');

            const mapContainerId = isMobile ? 'map-container' : 'desktop-map-container';
            const mapContainer = document.getElementById(mapContainerId);
            
            if (!mapContainer || !map) {
                this.exitAddMarkerMode();
                return;
            }

            setTimeout(() => {
                const allMapElements = mapContainer.querySelectorAll('*');
                allMapElements.forEach(el => {
                    el.style.cursor = 'crosshair';
                });
                mapContainer.style.cursor = 'crosshair';
                document.body.classList.add('map-crosshair-mode');
            }, 100);

            const clickHandler = (e) => {
                const coords = e.get('coords');
                this.createNewMarker(coords);
                this.exitAddMarkerMode();
            };
            
            this.currentClickHandler = clickHandler;
            map.events.add('click', clickHandler);

            const escHandler = (e) => {
                if (e.keyCode === 27) {
                    this.exitAddMarkerMode();
                    Utils.showNotification('Режим добавления метки отменен', 'info');
                }
            };
            document.addEventListener('keydown', escHandler);
            this.currentEscHandler = escHandler;
        },

        exitAddMarkerMode: function() {
            if (!this.markerModeActive) return;
            
            this.markerModeActive = false;
            
            const mapContainerId = isMobile ? 'map-container' : 'desktop-map-container';
            const mapContainer = document.getElementById(mapContainerId);
            if (mapContainer) {
                const allMapElements = mapContainer.querySelectorAll('*');
                allMapElements.forEach(el => {
                    el.style.cursor = '';
                });
                mapContainer.style.cursor = '';
                document.body.classList.remove('map-crosshair-mode');
            }
            
            if (this.currentClickHandler) {
                map.events.remove('click', this.currentClickHandler);
                this.currentClickHandler = null;
            }
            
            if (this.currentEscHandler) {
                document.removeEventListener('keydown', this.currentEscHandler);
                this.currentEscHandler = null;
            }
        },
        
        createNewMarker: function(coords) {
            const markerText = prompt('Введите текст для метки:', 'Новая метка');
            if (markerText === null) return;
            
            const newMarker = {
                id: Date.now(),
                lat: coords[0],
                lng: coords[1],
                text: markerText,
                createdAt: new Date().toISOString()
            };
            
            this.userMarkers.push(newMarker);
            this.saveUserMarkers();
            this.renderUserMarkers();
            
            setTimeout(() => {
                let lastPlacemark = null;
                let lastIndex = -1;
                
                this.userMarkersCollection.each((obj, index) => {
                    lastPlacemark = obj;
                    lastIndex = index;
                });
                
                if (lastPlacemark && lastIndex === this.userMarkers.length - 1) {
                    lastPlacemark.balloon.open({
                        closeButton: false
                    });
                }
            }, 300);
            
            Utils.showNotification(`Метка "${markerText}" добавлена`, 'success');
        },

        bringUserMarkersToFront: function() {
            if (!map || !this.userMarkersCollection) return;
            map.geoObjects.remove(this.userMarkersCollection);
            map.geoObjects.add(this.userMarkersCollection);
            map.container.fitToViewport();
        },

        showMarkersControlPanel: function() {
            const markerCount = this.userMarkers.length;
            
            const panelContent = `
                <div class="markers-control-panel">
                    <div class="markers-control-header">
                        <h3>📌 Управление метками</h3>
                        <button class="markers-control-close-btn" title="Закрыть" onclick="MapModule.closeCurrentMarkerBalloon()">×</button>
                    </div>
                    <div class="markers-control-stats">
                        <div class="marker-stat">
                            <span class="marker-stat-label">Всего меток:</span>
                            <span class="marker-stat-value">${markerCount}</span>
                        </div>
                        <div class="marker-stat">
                            <span class="marker-stat-label">Последняя:</span>
                            <span class="marker-stat-value">${markerCount > 0 ? 
                                new Date(this.userMarkers[markerCount-1].createdAt).toLocaleDateString() : 
                                '—'}</span>
                        </div>
                    </div>
                    <div class="markers-control-actions">
                        <button class="markers-control-btn add-btn" onclick="MapModule.enterAddMarkerMode()">
                            ➕ Добавить новую метку
                        </button>
                        <button class="markers-control-btn list-btn" onclick="MapModule.showMarkersList()">
                            📋 Список всех меток
                        </button>
                        ${markerCount > 0 ? `
                            <button class="markers-control-btn delete-all-btn" onclick="MapModule.deleteAllMarkers()">
                                🗑️ Удалить все метки
                            </button>
                        ` : ''}
                    </div>
                    ${markerCount > 0 ? `
                        <div class="markers-list-preview">
                            <h4>Последние метки:</h4>
                            <ul class="markers-preview-list">
                                ${this.userMarkers.slice(-3).reverse().map((marker, i) => `
                                    <li onclick="MapModule.focusOnMarker(${this.userMarkers.indexOf(marker)})">
                                        <span class="marker-preview-text">${Utils.escapeHtml(marker.text || 'Без названия')}</span>
                                        <span class="marker-preview-date">${new Date(marker.createdAt).toLocaleDateString()}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
            
            if (map.balloon && map.balloon.isOpen()) {
                map.balloon.close();
            }
            
            const center = map.getCenter();
            map.balloon.open(center, panelContent, {
                closeButton: false,
                autoPan: true,
                maxWidth: 350
            });
            
            setTimeout(() => {
                const closeBtn = document.querySelector('.markers-control-close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        map.balloon.close();
                    });
                }
            }, 50);
        },
        
        showMarkersList: function() {
            if (this.userMarkers.length === 0) {
                alert('Нет сохраненных меток');
                return;
            }
            
            const listContent = `
                <div class="markers-full-list">
                    <div class="markers-list-header">
                    <h3>📋 Все метки (${this.userMarkers.length})</h3>
                    <button class="markers-list-close-btn" title="Закрыть" onclick="MapModule.closeCurrentMarkerBalloon()">×</button>
                    </div>
                    <div class="markers-list-content">
                        <table class="markers-table">
                            <thead>
                                <tr>
                                    <th>Текст</th>
                                    <th>Координаты</th>
                                    <th>Дата</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.userMarkers.map((marker, index) => `
                                    <tr>
                                        <td>${Utils.escapeHtml(marker.text || '—')}</td>
                                        <td>${marker.lat.toFixed(4)}, ${marker.lng.toFixed(4)}</td>
                                        <td>${new Date(marker.createdAt).toLocaleDateString()}</td>
                                        <td>
                                            <button class="marker-action-small" onclick="MapModule.focusOnMarker(${index})">👁️</button>
                                            <button class="marker-action-small" onclick="MapModule.editMarker(${index})">✏️</button>
                                            <button class="marker-action-small" onclick="MapModule.deleteMarker(${index})">🗑️</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="markers-list-footer">
                        <button class="markers-control-btn" onclick="MapModule.deleteAllMarkers()">
                            🗑️ Удалить все метки
                        </button>
                    </div>
                </div>
            `;
            
            map.balloon.open(map.getCenter(), listContent, {
                closeButton: false,
                autoPan: true,
                maxWidth: 600,
                maxHeight: 400
            });
            
            setTimeout(() => {
                const closeBtn = document.querySelector('.markers-list-close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        map.balloon.close();
                    });
                }
            }, 50);
        },
        
        focusOnMarker: function(index) {
            const marker = this.userMarkers[index];
            if (!marker) return;
            
            map.setCenter([marker.lat, marker.lng], 17);
            
            if (map.balloon && map.balloon.isOpen()) {
                map.balloon.close();
            }
            
            setTimeout(() => {
                const placemarks = this.userMarkersCollection.getObjects();
                if (placemarks[index]) {
                    placemarks[index].balloon.open({
                        closeButton: false
                    });
                }
            }, 300);
        },
        
        async initMap() {
            if (map && map.destroy) {
                try {
                    map.destroy();
                } catch (e) {
                    console.log('Карта уже уничтожена');
                }
                map = null;
                objectManager = null;
                this.userMarkersCollection = null;
            }
            
            return new Promise((resolve, reject) => {
                ymaps.ready(() => {
                    try {
                        const mapContainerId = isMobile ? 'map-container' : 'desktop-map-container';
                        const container = document.getElementById(mapContainerId);
                        if (container) {
                            container.innerHTML = '';
                        }
                        
                        map = new ymaps.Map(mapContainerId, {
                            center: CONFIG.MAP.CENTER,
                            zoom: CONFIG.MAP.ZOOM,
                            controls: ['zoomControl', 'trafficControl']
                        });
                        
                        const ClusterBalloonLayout = ymaps.templateLayoutFactory.createClass(
                            '<div class="cluster-balloon">' +
                                '<div class="cluster-balloon__content"></div>' +
                            '</div>',
                            {
                                build: function() {
                                    ClusterBalloonLayout.superclass.build.call(this);
                                    
                                    const cluster = this.getData().object;
                                    const geoObjects = cluster.properties.geoObjects || [];
                                    const clusterPosition = cluster.geometry.coordinates;
                                    
                                    const sortedObjects = geoObjects.sort((a, b) => {
                                        if (a.properties.status === 'Свободно' && b.properties.status !== 'Свободно') return -1;
                                        if (a.properties.status !== 'Свободно' && b.properties.status === 'Свободно') return 1;
                                        return (a.properties.address || '').localeCompare(b.properties.address || '');
                                    });
                                    
                                    const maxRows = 4;
                                    const displayedObjects = sortedObjects.slice(0, maxRows);
                                    const hasMore = geoObjects.length > maxRows;
                                    const remainingCount = geoObjects.length - maxRows;
                                    
                                    let tableHtml = '';
                                    
                                    displayedObjects.forEach((obj) => {
                                        const address = obj.properties.address || '';
                                        const entrances = obj.properties.entrances || 0;
                                        const status = obj.properties.status || '';
                                        const statusClass = status === 'Свободно' ? 'free' : 'busy';
                                        
                                        tableHtml += `
                                            <tr>
                                                <td class="address-cell">
                                                    <span class="address-status ${statusClass}"></span>
                                                    <span class="address-text">${Utils.escapeHtml(address)}</span>
                                                </td>
                                                <td class="stands-cell">
                                                    ${entrances}
                                                </td>
                                            </tr>
                                        `;
                                    });
                                    
                                    if (hasMore) {
                                        tableHtml += `
                                            <tr>
                                                <td colspan="2" class="more-buildings">
                                                    ...и ещё зданий: ${remainingCount}
                                                </td>
                                            </tr>
                                        `;
                                    }
                                    
                                    const balloonHtml = `
                                        <div class="cluster-balloon-inner">
                                            <div class="cluster-header">
                                                <div class="cluster-title">
                                                    Кластер: ${geoObjects.length} 🏠
                                                </div>
                                                <button class="cluster-close-btn" title="Закрыть">×</button>
                                            </div>
                                            <div class="cluster-addresses">
                                                <table class="cluster-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Адрес</th>
                                                            <th>Стендов</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>${tableHtml}</tbody>
                                                </table>
                                            </div>
                                            <div class="cluster-footer">
                                                <button class="hide-cluster-btn" id="cluster-hide-button">
                                                    ✕ Скрыть кластер
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                    
                                    const container = this.getElement().querySelector('.cluster-balloon__content');
                                    if (container) {
                                        container.innerHTML = balloonHtml;
                                        
                                        const closeButton = container.querySelector('.cluster-close-btn');
                                        if (closeButton) {
                                            closeButton.addEventListener('click', (e) => {
                                                e.stopPropagation();
                                                e.preventDefault();
                                                const balloon = map.balloon;
                                                if (balloon && balloon.isOpen()) {
                                                    balloon.close();
                                                }
                                            });
                                        }
                                        
                                        const hideButton = container.querySelector('.hide-cluster-btn');
                                        if (hideButton) {
                                            hideButton.addEventListener('click', (e) => {
                                                e.stopPropagation();
                                                e.preventDefault();
                                                const ids = geoObjects.map(obj => obj.properties.originalIndex).join(',');
                                                handleHideCluster(ids);
                                                const balloon = map.balloon;
                                                if (balloon && balloon.isOpen()) {
                                                    balloon.close();
                                                }
                                                Utils.showNotification(`Скрыт кластер из ${geoObjects.length} объектов`, 'success');
                                            });
                                        }
                                    }
                                },
                                
                                clear: function() {
                                    ClusterBalloonLayout.superclass.clear.call(this);
                                }
                            }
                        );

                        objectManager = new ymaps.ObjectManager({
                            clusterize: true,
                            gridSize: 64,
                            clusterDisableClickZoom: true,
                            clusterBalloonContentLayout: ClusterBalloonLayout,
                            clusterBalloonPanelMaxMapArea: 0,
                            clusterBalloonAutoPan: true,
                            clusterBalloonOffset: [0, -20],
                            clusterBalloonShadow: false,
                            clusterBalloonMaxHeight: 500,
                            clusterBalloonMaxWidth: 400,
                            zIndex: 100
                        });
                        
                        objectManager.clusters.options.set({
                            preset: 'islands#invertedBlueClusterIcons',
                            clusterNumbers: [10, 30, 100],
                            balloonPane: 'balloon',
                            balloonPanelMaxMapArea: 0,
                            balloonOffset: [0, -20],
                            balloonShadow: false,
                            balloonAutoPan: true,
                            balloonAutoPanMargin: [80, 80, 80, 80],
                            balloonCloseButton: false,
                            zoomOnClick: false,
                            hideIconOnBalloonOpen: false,
                            zIndex: 100
                        });
                        
                        objectManager.objects.options.set({
                            preset: 'islands#circleIcon',
                            iconColor: '#FFFFFF',
                            balloonOffset: [0, -15],
                            zIndex: 100
                        });
                        
                        objectManager.objects.events.add('click', (e) => {
                            const objectId = e.get('objectId');
                            const object = objectManager.objects.getById(objectId);
                            if (object) {
                                const building = object.properties;
                                const statusClass = building.status === 'Свободно' ? 'status-free' : 'status-busy';
                                const shortDistrict = Utils.shortenDistrictName(building.district);
                                
                                const balloonContent = `
                                    <div class="single-balloon">
                                        <div class="single-balloon-header">
                                            <div class="single-balloon-title">
                                                <span class="status-indicator ${statusClass}" style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin: 0;"></span>
                                                <span>${Utils.escapeHtml(building.address)}</span>
                                            </div>
                                            <button class="single-balloon-close-btn" title="Закрыть">×</button>
                                        </div>
                                        <div class="single-balloon-content">
                                            <div class="single-balloon-stats">
                                                <div class="single-stat-item">
                                                    <div class="single-stat-label">РАЙОН</div>
                                                    <div class="single-stat-value">${Utils.escapeHtml(shortDistrict)}</div>
                                                </div>
                                                <div class="single-stat-item">
                                                    <div class="single-stat-label">СТЕНДОВ</div>
                                                    <div class="single-stat-value stands">${building.entrances}</div>
                                                </div>
                                                <div class="single-stat-item">
                                                    <div class="single-stat-label">КВАРТИР</div>
                                                    <div class="single-stat-value">${building.flats}</div>
                                                </div>
                                                <div class="single-stat-item">
                                                    <div class="single-stat-label">ЭТАЖЕЙ</div>
                                                    <div class="single-stat-value">${building.floors}</div>
                                                </div>
                                            </div>
                                            <button class="single-balloon-hide-btn" onclick="handleHideBuilding(${building.originalIndex})">
                                                ✕ Скрыть адрес
                                            </button>
                                        </div>
                                    </div>
                                `;
                                
                                const [lat, lng] = object.geometry.coordinates;
                                map.balloon.open([lat, lng], balloonContent, {
                                    closeButton: false,
                                    autoPan: true,
                                    autoPanMargin: [80, 80, 80, 80],
                                    offset: [0, -15]
                                });

                                setTimeout(() => {
                                    const closeBtn = document.querySelector('.single-balloon-close-btn');
                                    if (closeBtn) {
                                        closeBtn.addEventListener('click', (e) => {
                                            e.stopPropagation();
                                            e.preventDefault();
                                            map.balloon.close();
                                        });
                                    }
                                }, 50);
                            }
                        });
                        
                        objectManager.clusters.events.add('balloonopen', (e) => {
                            const cluster = e.get('target');
                            if (cluster && map) {
                                setTimeout(() => {
                                    map.container.fitToViewport();
                                }, 50);
                            }
                        });
                        
                        const markersControl = new ymaps.control.Button({
                            data: {
                                content: "📍 Метки",
                                title: "Управление пользовательскими метками"
                            },
                            options: {
                                selectOnClick: false,
                                maxWidth: 120,
                                float: 'right',
                                floatIndex: 200
                            }
                        });
                        
                        markersControl.events.add('press', () => {
                            this.showMarkersControlPanel();
                        });
                        
                        const addMarkerButton = new ymaps.control.Button({
                            data: {
                                content: "➕ Метка",
                                title: "Добавить метку на карту"
                            },
                            options: {
                                selectOnClick: false,
                                maxWidth: 100,
                                float: 'right',
                                floatIndex: 190,
                                right: 120
                            }
                        });
                        
                        addMarkerButton.events.add('press', () => {
                            MapModule.enterAddMarkerMode();
                        });
                        
                        map.controls.add(markersControl);
                        map.controls.add(addMarkerButton);
                        
                        map.geoObjects.add(objectManager);
                        
                        this.initUserMarkers();
                        
                        map.events.add('sizechange', () => {
                            if (map.balloon && map.balloon.isOpen()) {
                                map.container.fitToViewport();
                            }
                        });
                        
                        resolve(map);
                        
                    } catch (error) {
                        reject(error);
                    }
                });
            });
        },

        renderBuildings(buildings) {
            if (!objectManager) return;
            
            objectManager.removeAll();
            
            const features = buildings.map(building => {
                const lat = building.lat;
                const lng = building.lng;
                
                return {
                    id: building.originalIndex,
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [lat, lng]
                    },
                    properties: {
                        ...building
                    },
                    options: {
                        preset: building.status === 'Свободно' ? 
                            'islands#greenCircleIcon' : 'islands#redCircleIcon',
                        iconColor: building.status === 'Свободно' ? '#10b981' : '#ef4444',
                        balloonAutoPan: true,
                        balloonOffset: [0, -20],
                        zIndex: 100
                    }
                };
            });
            
            objectManager.add(features);
        }
    };

    // ============================================================================
    // МОДУЛЬ 3: ИСТОРИЯ ДЕЙСТВИЙ (UNDO)
    // ============================================================================
    const HistoryModule = {
        // Конфигурация
        MAX_HISTORY_SIZE: 20,
        MIN_ACTION_INTERVAL: 500,
        
        // Состояние
        history: [],
        currentIndex: -1,
        lastActionTime: 0,
        
        // Типы действий
        ACTION_TYPES: {
            FILTER_CHANGE: 'filter_change',
            HIDE_BUILDING: 'hide_building',
            HIDE_CLUSTER: 'hide_cluster',
            STATUS_FILTER: 'status_filter',
            DISTRICT_FILTER: 'district_filter',
            PERCENTAGE_CHANGE: 'percentage_change'
        },
        
        // Инициализация
        init() {
            this.saveInitialState();
            this.createUndoButton();
        },
        
        // Сохранение начального состояния
        saveInitialState() {
            const initialState = this.captureState('initial', this.ACTION_TYPES.FILTER_CHANGE);
            this.history = [initialState];
            this.currentIndex = 0;
            this.updateUndoButton();
        },
        
        // Захват текущего состояния
        captureState(description, type) {
            return {
                timestamp: Date.now(),
                description: description,
                type: type,
                data: {
                    filters: {
                        status: Array.from(activeFilters.status),
                        district: Array.from(activeFilters.district),
                        floors: {...activeFilters.floors},
                        flatsPerEntrance: {...activeFilters.flatsPerEntrance}
                    },
                    percentage: currentPercentage,
                    hiddenBuildings: Array.from(hiddenBuildings)
                }
            };
        },
        
        // Сохранение изменения фильтров
        saveFilterChange(description, filterType) {
            const now = Date.now();
            
            if (now - this.lastActionTime < this.MIN_ACTION_INTERVAL) {
                return;
            }
            
            this.lastActionTime = now;
            
            const state = this.captureState(description, filterType || this.ACTION_TYPES.FILTER_CHANGE);
            this.addToHistory(state);
        },
        
        // Сохранение скрытия здания
        saveHideBuilding(buildingId, buildingAddress) {
            const state = this.captureState(`Скрыт: ${buildingAddress}`, this.ACTION_TYPES.HIDE_BUILDING);
            this.addToHistory(state);
        },
        
        // Сохранение скрытия кластера
        saveHideCluster(buildingIds, count) {
            const state = this.captureState(`Скрыт кластер (${count} зданий)`, this.ACTION_TYPES.HIDE_CLUSTER);
            this.addToHistory(state);
        },
        
        // Добавление состояния в историю
        addToHistory(state) {
            if (this.currentIndex < this.history.length - 1) {
                this.history = this.history.slice(0, this.currentIndex + 1);
            }
            
            this.history.push(state);
            this.currentIndex++;
            
            if (this.history.length > this.MAX_HISTORY_SIZE) {
                this.history.shift();
                this.currentIndex--;
            }
            
            this.updateUndoButton();
        },
        
        // Отмена последнего действия
        undo() {
            if (this.currentIndex <= 0) {
                Utils.showNotification('Нет действий для отмены', 'info');
                return false;
            }
            
            const stateToUndo = this.history[this.currentIndex];
            const previousState = this.history[this.currentIndex - 1];
            
            this.restoreState(previousState, stateToUndo);
            
            this.currentIndex--;
            this.updateUndoButton();
            
            Utils.showNotification(`Отменено: ${stateToUndo.description}`, 'success');
            return true;
        },
        
        // Восстановление состояния
        restoreState(targetState, stateToUndo) {
            // Восстанавливаем фильтры
            if (targetState.data.filters) {
                activeFilters.status = new Set(targetState.data.filters.status);
                activeFilters.district = new Set(targetState.data.filters.district);
                activeFilters.floors = {...targetState.data.filters.floors};
                activeFilters.flatsPerEntrance = {...targetState.data.filters.flatsPerEntrance};
            }
            
            // Восстанавливаем процент
            if (targetState.data.percentage !== undefined) {
                currentPercentage = targetState.data.percentage;
            }
            
            // Восстанавливаем скрытые здания
            if (targetState.data.hiddenBuildings) {
                hiddenBuildings = new Set(targetState.data.hiddenBuildings);
            }
            
            // Обновляем UI
            this.updateUIFromState(targetState);
            
            // Применяем фильтры
            FilterModule.applyFilters();
        },
        
        // Обновление UI из состояния
        updateUIFromState(state) {
            // Обновляем чекбоксы фильтров
            this.updateFilterCheckboxes('status-filter', state.data.filters.status);
            this.updateFilterCheckboxes('desktop-status-filter', state.data.filters.status);
            this.updateFilterCheckboxes('district-filter', state.data.filters.district);
            this.updateFilterCheckboxes('desktop-district-filter', state.data.filters.district);
            
            // Обновляем поля ввода
            this.updateRangeInputs(state.data.filters.floors, state.data.filters.flatsPerEntrance);
            
            // Обновляем процент
            this.updatePercentage(state.data.percentage);
        },
        
        // Обновление чекбоксов фильтров
        updateFilterCheckboxes(containerId, filterValues) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = filterValues.includes(checkbox.value);
            });
        },
        
        // Обновление полей ввода диапазонов
        updateRangeInputs(floors, flats) {
            const ids = [
                ['floors-min', 'desktop-floors-min'],
                ['floors-max', 'desktop-floors-max'],
                ['flats-min', 'desktop-flats-min'],
                ['flats-max', 'desktop-flats-max']
            ];
            
            const values = [floors.min, floors.max, flats.min, flats.max];
            
            ids.forEach((idGroup, index) => {
                idGroup.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.value = values[index] || '';
                    }
                });
            });
        },
        
        // Обновление процента
        updatePercentage(percentage) {
            const elements = [
                { slider: 'mobile-percentage-slider', value: 'mobile-percentage-value' },
                { slider: 'desktop-percentage-slider', value: 'desktop-percentage-value' }
            ];
            
            elements.forEach(el => {
                const slider = document.getElementById(el.slider);
                const valueDisplay = document.getElementById(el.value);
                
                if (slider) slider.value = percentage;
                if (valueDisplay) valueDisplay.textContent = `${percentage}%`;
            });
        },
        
        // Создание кнопки отмены
        createUndoButton() {
            // Для мобильной версии
            const mobileHeader = document.getElementById('compact-header');
            if (mobileHeader) {
                const undoBtn = document.createElement('button');
                undoBtn.id = 'mobile-undo-btn';
                undoBtn.className = 'mobile-undo-button';
                undoBtn.innerHTML = '↶';
                undoBtn.title = 'Отменить последнее действие (Ctrl+Z)';
                undoBtn.style.cssText = `
                    position: absolute;
                    right: 10px;
                    top: 10px;
                    width: 36px;
                    height: 36px;
                `;
                
                undoBtn.addEventListener('click', () => this.undo());
                mobileHeader.appendChild(undoBtn);
            }
            
            // Для десктопной версии
            const desktopSidebar = document.getElementById('desktop-sidebar');
            if (desktopSidebar) {
                const undoBtn = document.createElement('button');
                undoBtn.id = 'desktop-undo-btn';
                undoBtn.className = 'desktop-undo-button';
                undoBtn.innerHTML = '↶';
                undoBtn.title = 'Отменить последнее действие (Ctrl+Z)';
                undoBtn.style.cssText = `
                    position: absolute;
                    top: 1.25rem;
                    right: 4.5rem;
                    width: 40px;
                    height: 40px;
                `;
                
                undoBtn.addEventListener('click', () => this.undo());
                desktopSidebar.querySelector('.sidebar-header').appendChild(undoBtn);
            }
            
            // Для полноэкранного режима
            const fullscreenHeader = document.getElementById('fullscreen-header');
            if (fullscreenHeader) {
                const undoBtn = document.createElement('button');
                undoBtn.id = 'fullscreen-undo-btn';
                undoBtn.className = 'fullscreen-undo-button';
                undoBtn.innerHTML = '↶';
                undoBtn.title = 'Отменить последнее действие (Ctrl+Z)';
                undoBtn.style.cssText = `
                    position: absolute;
                    top: 1rem;
                    right: 4rem;
                    width: 32px;
                    height: 32px;
                `;
                
                undoBtn.addEventListener('click', () => this.undo());
                fullscreenHeader.querySelector('.fullscreen-header-title').appendChild(undoBtn);
            }
        },
        
        // Обновление состояния кнопки отмены
        updateUndoButton() {
            const canUndo = this.currentIndex > 0;
            const buttons = [
                'mobile-undo-btn',
                'desktop-undo-btn',
                'fullscreen-undo-btn'
            ];
            
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = !canUndo;
                    btn.style.opacity = canUndo ? '1' : '0.5';
                    btn.style.cursor = canUndo ? 'pointer' : 'not-allowed';
                }
            });
        }
    };

    // ============================================================================
    // МОДУЛЬ 4: ФИЛЬТРЫ
    // ============================================================================
    const FilterModule = {
        initFilters(buildings) {
            this.populateFilter('status-filter', buildings, 'status');
            this.populateFilter('district-filter', buildings, 'district');
            this.populateFilter('desktop-status-filter', buildings, 'status');
            this.populateFilter('desktop-district-filter', buildings, 'district');
            
            this.setupRangeControls();
            this.setupEventListeners();
            this.updateRangePlaceholders();
        },

        populateFilter(containerId, buildings, type) {
            const items = [...new Set(buildings.map(b => b[type]).filter(Boolean))];
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            items.forEach(item => {
                const checkboxId = `checkbox-${containerId}-${item.replace(/\s+/g, '-')}`;
                const statusClass = item === 'Свободно' ? 'status-free' : 'status-busy';
                const statusHtml = type === 'status' 
                    ? `<span class="status-indicator ${statusClass}"></span>`
                    : '';
                
                const label = document.createElement('label');
                label.className = 'checkbox-item';
                label.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" value="${item}" checked>
                    ${statusHtml}
                    <span>${item}</span>
                `;
                container.appendChild(label);
                activeFilters[type].add(item);
            });
        },

        setupRangeControls() {
            document.querySelectorAll('.range-control-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetId = button.dataset.target;
                    const input = document.getElementById(targetId);
                    if (!input) return;
                    
                    const isPlus = button.classList.contains('plus');
                    const currentValue = input.value ? parseInt(input.value) : null;
                    const fieldType = targetId.includes('floors') ? 'floors' : 'flatsPerEntrance';
                    const values = availableValues[fieldType];
                    
                    let newValue;
                    if (currentValue === null || currentValue === '') {
                        newValue = isPlus ? 
                            (values.length > 0 ? values[0] : 1) : 
                            (values.length > 0 ? values[values.length - 1] : 1);
                    } else {
                        const currentIndex = values.indexOf(currentValue);
                        
                        if (currentIndex !== -1) {
                            const newIndex = isPlus ? 
                                Math.min(currentIndex + 1, values.length - 1) : 
                                Math.max(currentIndex - 1, 0);
                            newValue = values[newIndex];
                        } else {
                            newValue = Utils.getNearestValue(currentValue, values, isPlus ? 1 : -1);
                        }
                    }
                    
                    input.value = newValue;
                    this.updateFilterFromInput(input);
                    
                    button.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        button.style.transform = '';
                    }, 150);
                });
            });
            
            document.querySelectorAll('.range-control-input').forEach(input => {
                input.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    
                    const isPlus = e.deltaY < 0;
                    const fieldType = input.id.includes('floors') ? 'floors' : 'flatsPerEntrance';
                    const values = availableValues[fieldType];
                    
                    const currentValue = parseInt(input.value) || null;
                    let newValue;
                    
                    if (currentValue === null || currentValue === '') {
                        newValue = isPlus ? 
                            (values.length > 0 ? values[0] : 1) : 
                            (values.length > 0 ? values[values.length - 1] : 1);
                    } else {
                        const currentIndex = values.indexOf(currentValue);
                        
                        if (currentIndex !== -1) {
                            const newIndex = isPlus ? 
                                Math.min(currentIndex + 1, values.length - 1) : 
                                Math.max(currentIndex - 1, 0);
                            newValue = values[newIndex];
                        } else {
                            newValue = Utils.getNearestValue(currentValue, values, isPlus ? 1 : -1);
                        }
                    }
                    
                    input.value = newValue;
                    this.updateFilterFromInput(input);
                    
                    input.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.3)';
                    setTimeout(() => {
                        input.style.boxShadow = '';
                    }, 300);
                }, { passive: false });                
                
                input.addEventListener('input', Utils.debounce(() => {
                    this.updateFilterFromInput(input);
                }, 500));
                
                input.addEventListener('change', () => {
                    HistoryModule.saveFilterChange(
                        `Изменен диапазон: ${input.id}`,
                        HistoryModule.ACTION_TYPES.FILTER_CHANGE
                    );
                });
                
                input.addEventListener('blur', () => {
                    this.validateInputValue(input);
                });
            });
        },

        updateFilterFromInput(input) {
            const id = input.id;
            const value = input.value ? parseInt(input.value) : null;
            
            let filterType, minMax;
            if (id.includes('floors')) {
                filterType = 'floors';
                minMax = id.includes('min') ? 'min' : 'max';
            } else if (id.includes('flats')) {
                filterType = 'flatsPerEntrance';
                minMax = id.includes('min') ? 'min' : 'max';
            } else {
                return;
            }
            
            activeFilters[filterType][minMax] = value;
            
            const otherInputId = id.startsWith('desktop-') ? 
                id.replace('desktop-', '') : 
                `desktop-${id}`;
            const otherInput = document.getElementById(otherInputId);
            if (otherInput && otherInput.value !== input.value) {
                otherInput.value = input.value;
            }
            
            this.applyFiltersDebounced();
        },

        validateInputValue(input) {
            const id = input.id;
            const value = input.value ? parseInt(input.value) : null;
            
            if (value === null || value === '') return;
            
            const fieldType = id.includes('floors') ? 'floors' : 'flatsPerEntrance';
            const values = availableValues[fieldType];
            
            if (!values.includes(value)) {
                const nearest = Utils.getNearestValue(value, values);
                input.value = nearest;
                
                this.updateFilterFromInput(input);
                
                if (Math.abs(value - nearest) > 1) {
                    Utils.showNotification(`Значение ${value} не найдено. Установлено ${nearest}`, 'info');
                }
            }
            
            this.validateRangePair(id);
        },

        validateRangePair(changedInputId) {
            let minInput, maxInput;
            
            if (changedInputId.includes('floors')) {
                minInput = document.getElementById(changedInputId.includes('desktop-') ? 'desktop-floors-min' : 'floors-min');
                maxInput = document.getElementById(changedInputId.includes('desktop-') ? 'desktop-floors-max' : 'floors-max');
            } else if (changedInputId.includes('flats')) {
                minInput = document.getElementById(changedInputId.includes('desktop-') ? 'desktop-flats-min' : 'flats-min');
                maxInput = document.getElementById(changedInputId.includes('desktop-') ? 'desktop-flats-max' : 'flats-max');
            } else {
                return;
            }
            
            const minValue = minInput.value ? parseInt(minInput.value) : null;
            const maxValue = maxInput.value ? parseInt(maxInput.value) : null;
            
            if (minValue !== null && maxValue !== null && minValue > maxValue) {
                minInput.value = maxValue;
                maxInput.value = minValue;
                
                this.updateFilterFromInput(minInput);
                this.updateFilterFromInput(maxInput);
                
                Utils.showNotification('Минимальное значение не может быть больше максимального. Значения поменяны местами.', 'info');
            }
        },

        updateRangePlaceholders() {
            const floorsMin = availableValues.floors[0] || 1;
            const floorsMax = availableValues.floors[availableValues.floors.length - 1] || 1;
            const flatsMin = availableValues.flatsPerEntrance[0] || 1;
            const flatsMax = availableValues.flatsPerEntrance[availableValues.flatsPerEntrance.length - 1] || 1;
            
            document.getElementById('floors-min').placeholder = `${floorsMin}`;
            document.getElementById('floors-max').placeholder = `${floorsMax}`;
            document.getElementById('flats-min').placeholder = `${flatsMin}`;
            document.getElementById('flats-max').placeholder = `${flatsMax}`;
            document.getElementById('desktop-floors-min').placeholder = `${floorsMin}`;
            document.getElementById('desktop-floors-max').placeholder = `${floorsMax}`;
            document.getElementById('desktop-flats-min').placeholder = `${flatsMin}`;
            document.getElementById('desktop-flats-max').placeholder = `${flatsMax}`;
            
            const setMinMax = (input, min, max) => {
                if (input) {
                    input.min = min;
                    input.max = max;
                }
            };
            
            setMinMax(document.getElementById('floors-min'), floorsMin, floorsMax);
            setMinMax(document.getElementById('floors-max'), floorsMin, floorsMax);
            setMinMax(document.getElementById('flats-min'), flatsMin, flatsMax);
            setMinMax(document.getElementById('flats-max'), flatsMin, flatsMax);
            setMinMax(document.getElementById('desktop-floors-min'), floorsMin, floorsMax);
            setMinMax(document.getElementById('desktop-floors-max'), floorsMin, floorsMax);
            setMinMax(document.getElementById('desktop-flats-min'), flatsMin, flatsMax);
            setMinMax(document.getElementById('desktop-flats-max'), flatsMin, flatsMax);
        },

        setupEventListeners() {
            this.setupFilterListeners('status-filter', 'status');
            this.setupFilterListeners('district-filter', 'district');
            this.setupFilterListeners('desktop-status-filter', 'status');
            this.setupFilterListeners('desktop-district-filter', 'district');
            
            document.getElementById('desktop-reset-filters')?.addEventListener('click', () => {
                this.resetFilters();
            });
            
            document.getElementById('mobile-reset-filters')?.addEventListener('click', () => {
                this.resetFilters();
            });
        },

        setupFilterListeners(containerId, filterType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const value = e.target.value;
                    e.target.checked ? activeFilters[filterType].add(value) : activeFilters[filterType].delete(value);
                    this.syncCheckboxes(containerId, filterType, value, e.target.checked);
                    this.applyFiltersDebounced();
                    
                    HistoryModule.saveFilterChange(
                        `Изменен фильтр: ${filterType} = ${value}`,
                        filterType === 'status' ? 
                            HistoryModule.ACTION_TYPES.STATUS_FILTER : 
                            HistoryModule.ACTION_TYPES.DISTRICT_FILTER
                    );
                }
            });
        },

        syncCheckboxes(sourceContainerId, filterType, value, checked) {
            const targetContainerId = sourceContainerId.startsWith('desktop-') 
                ? sourceContainerId.replace('desktop-', '')
                : `desktop-${sourceContainerId}`;
            
            const checkbox = document.querySelector(`#${targetContainerId} input[value="${value}"]`);
            if (checkbox) {
                checkbox.checked = checked;
            }
        },

        applyFilters() {
            filteredBuildings = allBuildings.filter(building => {
                if (hiddenBuildings.has(building.originalIndex)) return false;
                if (activeFilters.status.size > 0 && !activeFilters.status.has(building.status)) return false;
                if (activeFilters.district.size > 0 && !activeFilters.district.has(building.district)) return false;
                if (activeFilters.floors.min !== null && building.floors < activeFilters.floors.min) return false;
                if (activeFilters.floors.max !== null && building.floors > activeFilters.floors.max) return false;
                if (activeFilters.flatsPerEntrance.min !== null && building.flatsPerEntrance < activeFilters.flatsPerEntrance.min) return false;
                if (activeFilters.flatsPerEntrance.max !== null && building.flatsPerEntrance > activeFilters.flatsPerEntrance.max) return false;
                return true;
            });
            
            displayedBuildings = this.selectByPercentage(filteredBuildings, currentPercentage);
            
            this.updateUI();
        },
        
        applyFiltersDebounced: Utils.debounce(function() {
            FilterModule.applyFilters();
        }, 300),

        selectByPercentage(items, percentage) {
            if (percentage >= 100) return [...items];
            if (percentage <= 0 || items.length === 0) return [];
            
            const n = items.length;
            const k = Math.round(n * percentage / 100);
            if (k >= n) return [...items];
            if (k <= 0) return [];
            
            const result = [];
            let step = n / k;
            let current = 0;
            
            for (let i = 0; i < k; i++) {
                const index = Math.floor(current);
                if (index < n) {
                    result.push(items[index]);
                }
                current += step;
            }
            
            return result;
        },

        updateUI() {
            MapModule.renderBuildings(displayedBuildings);
            ListModule.renderBuildingsList('building-list', displayedBuildings.slice(0, listLimit));
            ListModule.renderBuildingsList('desktop-building-list', displayedBuildings.slice(0, listLimit));
            this.updateStatistics();
        },

        updateStatistics() {
            const selectedCount = displayedBuildings.length;
            const totalInBase = allBuildings.reduce((sum, b) => sum + (b.entrances || 0), 0);
            const totalStands = displayedBuildings.reduce((sum, b) => sum + (b.entrances || 0), 0);
            const totalFlats = displayedBuildings.reduce((sum, b) => sum + (b.flats || 0), 0);
            
            let totalPrice = null;
            if (totalStands >= 100) {
                if (totalStands >= 100 && totalStands <= 299) {
                    totalPrice = totalStands * 160;
                } else if (totalStands >= 300 && totalStands <= 499) {
                    totalPrice = totalStands * 140;
                } else if (totalStands >= 500) {
                    totalPrice = totalStands * 120;
                }
            }
            
            const perFlatPrice = totalPrice && totalFlats > 0 ? totalPrice / totalFlats : null;
            
            document.getElementById('selected-stands').textContent = Utils.formatNumber(totalStands);
            document.getElementById('coverage-flats').textContent = Utils.formatNumber(totalFlats);
            document.getElementById('monthly-price').textContent = Utils.formatPrice(totalPrice);
            document.getElementById('per-flat-price').textContent = Utils.formatPrice(perFlatPrice);
            document.getElementById('total-in-base').textContent = Utils.formatNumber(totalInBase);
            
            document.getElementById('desktop-selected-stands').textContent = Utils.formatNumber(totalStands);
            document.getElementById('desktop-coverage-flats').textContent = Utils.formatNumber(totalFlats);
            document.getElementById('desktop-monthly-price').textContent = Utils.formatPrice(totalPrice);
            document.getElementById('desktop-per-flat-price').textContent = Utils.formatPrice(perFlatPrice);
            document.getElementById('desktop-total-in-base').textContent = Utils.formatNumber(totalInBase);
            
            document.getElementById('fullscreen-selected-stands').textContent = Utils.formatNumber(totalStands);
            document.getElementById('fullscreen-coverage-flats').textContent = Utils.formatNumber(totalFlats);
            document.getElementById('fullscreen-monthly-price').textContent = Utils.formatPrice(totalPrice);
            document.getElementById('fullscreen-per-flat-price').textContent = Utils.formatPrice(perFlatPrice);
            document.getElementById('fullscreen-total-in-base').textContent = Utils.formatNumber(totalInBase);
        },

        resetFilters() {
            hiddenBuildings.clear();
            
            activeFilters.status.clear();
            activeFilters.district.clear();
            
            document.querySelectorAll('#status-filter input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
                activeFilters.status.add(checkbox.value);
            });
            
            document.querySelectorAll('#district-filter input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
                activeFilters.district.add(checkbox.value);
            });
            
            activeFilters.floors.min = null;
            activeFilters.floors.max = null;
            activeFilters.flatsPerEntrance.min = null;
            activeFilters.flatsPerEntrance.max = null;
            
            document.querySelectorAll('.range-control-input').forEach(input => {
                input.value = '';
            });
            
            currentPercentage = 100;
            
            const mobileSlider = document.getElementById('mobile-percentage-slider');
            const mobileValue = document.getElementById('mobile-percentage-value');
            const desktopSlider = document.getElementById('desktop-percentage-slider');
            const desktopValue = document.getElementById('desktop-percentage-value');
            
            if (mobileSlider) mobileSlider.value = 100;
            if (mobileValue) mobileValue.textContent = '100%';
            if (desktopSlider) desktopSlider.value = 100;
            if (desktopValue) desktopValue.textContent = '100%';
            
            document.querySelectorAll('#desktop-status-filter input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            
            document.querySelectorAll('#desktop-district-filter input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            
            this.applyFiltersDebounced();
            Utils.showNotification('Все фильтры сброшены', 'success');
            
            HistoryModule.saveFilterChange('Сброс всех фильтров', HistoryModule.ACTION_TYPES.FILTER_CHANGE);
        }
    };

    // ============================================================================
    // МОДУЛЬ 5: ПРОЦЕНТНЫЙ ОТБОР
    // ============================================================================
    const PercentageModule = {
        initPercentageSelector() {
            this.setupPercentageControls(
                'desktop-percentage-slider',
                'desktop-percentage-value',
                'desktop-percentage-decrease',
                'desktop-percentage-increase'
            );
            
            this.setupPercentageControls(
                'mobile-percentage-slider',
                'mobile-percentage-value',
                'mobile-percentage-decrease',
                'mobile-percentage-increase'
            );
        },

        setupPercentageControls(sliderId, valueId, decreaseId, increaseId) {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(valueId);
            const decreaseBtn = document.getElementById(decreaseId);
            const increaseBtn = document.getElementById(increaseId);
            
            if (!slider || !valueDisplay) return;
            
            const updateSlider = Utils.debounce((value) => {
                currentPercentage = value;
                valueDisplay.textContent = `${value}%`;
                
                let targetSliderId, targetValueId;
                
                if (sliderId.includes('mobile')) {
                    targetSliderId = 'desktop-percentage-slider';
                    targetValueId = 'desktop-percentage-value';
                } else {
                    targetSliderId = 'mobile-percentage-slider';
                    targetValueId = 'mobile-percentage-value';
                }
                
                const targetSlider = document.getElementById(targetSliderId);
                const targetValueDisplay = document.getElementById(targetValueId);
                
                if (targetSlider) targetSlider.value = value;
                if (targetValueDisplay) targetValueDisplay.textContent = `${value}%`;
                
                FilterModule.applyFiltersDebounced();
                
                HistoryModule.saveFilterChange(
                    `Изменен процент: ${value}%`,
                    HistoryModule.ACTION_TYPES.PERCENTAGE_CHANGE
                );
            }, 300);
            
            slider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                valueDisplay.textContent = `${value}%`;
            });
            
            slider.addEventListener('change', (e) => {
                const value = parseInt(e.target.value);
                updateSlider(value);
            });
            
            slider.addEventListener('wheel', (e) => {
                e.preventDefault();
                const currentValue = parseInt(slider.value);
                const newValue = e.deltaY < 0 ? 
                    Math.min(100, currentValue + 1) : 
                    Math.max(1, currentValue - 1);
                
                slider.value = newValue;
                valueDisplay.textContent = `${newValue}%`;
                updateSlider(newValue);
            }, { passive: false });
            
            if (decreaseBtn) {
                decreaseBtn.addEventListener('click', () => {
                    const newValue = Math.max(1, currentPercentage - 1);
                    slider.value = newValue;
                    valueDisplay.textContent = `${newValue}%`;
                    updateSlider(newValue);
                });
            }
            
            if (increaseBtn) {
                increaseBtn.addEventListener('click', () => {
                    const newValue = Math.min(100, currentPercentage + 1);
                    slider.value = newValue;
                    valueDisplay.textContent = `${newValue}%`;
                    updateSlider(newValue);
                });
            }
        }
    };

    // ============================================================================
    // МОДУЛЬ 6: СПИСОК ОБЪЕКТОВ
    // ============================================================================
    const ListModule = {
        renderBuildingsList(containerId, buildings, append = false) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (!append) container.innerHTML = '';
            
            buildings.forEach(building => {
                const item = document.createElement('div');
                item.className = 'building-item';
                item.dataset.id = building.originalIndex;
                
                const shortDistrict = Utils.shortenDistrictName(building.district);
                const statusClass = building.status === 'Свободно' ? 'status-free' : 'status-busy';
                
                item.innerHTML = `
                    <div class="building-header">
                        <span class="building-status">
                            <span class="status-indicator ${statusClass}"></span>
                        </span>
                        <span class="building-address">${Utils.escapeHtml(building.address)}</span>
                        <button class="building-hide" onclick="handleHideBuilding(${building.originalIndex}, event)">×</button>
                    </div>
                    <div class="building-details">
                        <span>🏘️ ${Utils.escapeHtml(shortDistrict)}</span>
                        <span>📄 ${building.entrances} ${this.getStandsText(building.entrances)}</span>
                        <span>🚪 ${building.flats} кв.</span>
                    </div>
                `;
                
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('building-hide') || e.target.closest('.building-hide')) {
                        return;
                    }
                    
                    if (!map) return;
                    const lat = building.lat;
                    const lng = building.lng;
                    
                    const statusClass = building.status === 'Свободно' ? 'status-free' : 'status-busy';
                    const shortDistrict = Utils.shortenDistrictName(building.district);
                    
                    const balloonContent = `
                        <div class="single-balloon">
                            <div class="single-balloon-header">
                                <div class="single-balloon-title">
                                    <span class="status-indicator ${statusClass}"></span>
                                    <span>${Utils.escapeHtml(building.address)}</span>
                                </div>
                                <button class="single-balloon-close-btn" title="Закрыть">×</button>
                            </div>
                            <div class="single-balloon-content">
                                <div class="single-balloon-stats">
                                    <div class="single-stat-item">
                                        <div class="single-stat-label">РАЙОН</div>
                                        <div class="single-stat-value">${Utils.escapeHtml(shortDistrict)}</div>
                                    </div>
                                    <div class="single-stat-item">
                                        <div class="single-stat-label">СТЕНДОВ</div>
                                        <div class="single-stat-value stands">${building.entrances}</div>
                                    </div>
                                    <div class="single-stat-item">
                                        <div class="single-stat-label">КВАРТИР</div>
                                        <div class="single-stat-value">${building.flats}</div>
                                    </div>
                                    <div class="single-stat-item">
                                        <div class="single-stat-label">ЭТАЖЕЙ</div>
                                        <div class="single-stat-value">${building.floors}</div>
                                    </div>
                                </div>
                                <button class="single-balloon-hide-btn" onclick="handleHideBuilding(${building.originalIndex})">
                                    ✕ Скрыть адрес
                                </button>
                            </div>
                        </div>
                    `;
                    
                    map.setCenter([lat, lng], 17);
                    map.balloon.open([lat, lng], balloonContent, {
                        closeButton: false,
                        autoPan: true,
                        autoPanMargin: [80, 80, 80, 80],
                        offset: [0, -15]
                    });

                    setTimeout(() => {
                        const closeBtn = document.querySelector('.single-balloon-close-btn');
                        if (closeBtn) {
                            closeBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                e.preventDefault();
                                map.balloon.close();
                            });
                        }
                    }, 50);
                    
                    if (isMobile) {
                        Utils.setMobileView('map');
                    }
                });                
                container.appendChild(item);
            });
            
            this.updateLoadMoreButton(containerId);
        },

        getStandsText(count) {
            const lastDigit = count % 10;
            const lastTwoDigits = count % 100;
            
            if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
                return 'стендов';
            }
            
            if (lastDigit === 1) {
                return 'стенд';
            } else if (lastDigit >= 2 && lastDigit <= 4) {
                return 'стенда';
            } else {
                return 'стендов';
            }
        },

        updateLoadMoreButton(containerId) {
            const loadMoreBtnId = containerId.startsWith('desktop-') 
                ? 'desktop-load-more' 
                : 'load-more';
            const loadMoreBtn = document.getElementById(loadMoreBtnId);
            
            if (!loadMoreBtn) return;
            
            const container = document.getElementById(containerId);
            const currentCount = container ? container.children.length : 0;
            const hasMore = currentCount < displayedBuildings.length;
            
            loadMoreBtn.style.display = hasMore ? 'block' : 'none';
            loadMoreBtn.textContent = `Показать еще (${Math.min(20, displayedBuildings.length - currentCount)})`;
        },

        loadMoreBuildings(isDesktop = false) {
            const containerId = isDesktop ? 'desktop-building-list' : 'building-list';
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const currentCount = container.children.length;
            const nextBuildings = displayedBuildings.slice(currentCount, currentCount + 20);
            
            if (nextBuildings.length > 0) {
                this.renderBuildingsList(containerId, nextBuildings, true);
            }
        }
    };

    // ============================================================================
    // ГЛОБАЛЬНЫЕ ОБРАБОТЧИКИ
    // ============================================================================
    function handleHideBuilding(buildingId, event) {
        if (event) {
            event.stopPropagation();
        }
        
        const building = allBuildings.find(b => b.originalIndex === buildingId);
        if (building) {
            hiddenBuildings.add(buildingId);
            HistoryModule.saveHideBuilding(buildingId, building.address);
            FilterModule.applyFiltersDebounced();
            Utils.showNotification('Адрес скрыт', 'success');
            if (map && map.balloon && map.balloon.isOpen()) map.balloon.close();
        }
    }

    function handleHideCluster(buildingIds) {
        const ids = buildingIds.split(',').map(id => parseInt(id.trim()));
        ids.forEach(id => hiddenBuildings.add(id));
        HistoryModule.saveHideCluster(ids, ids.length);
        FilterModule.applyFiltersDebounced();
        if (map && map.balloon && map.balloon.isOpen()) map.balloon.close();
    }

    // ============================================================================
    // МОДУЛЬ 7: ФОРМИРОВАНИЕ ОТЧЁТА
    // ============================================================================
    const ReportModule = {
        async generateReport() {
            if (isGeneratingReport) return;
            isGeneratingReport = true;
            
            try {
                const now = new Date();
                const dateStr = now.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const selectedCount = displayedBuildings.length;
                const totalStands = displayedBuildings.reduce((sum, b) => sum + (b.entrances || 0), 0);
                const totalFlats = displayedBuildings.reduce((sum, b) => sum + (b.flats || 0), 0);
                
                let totalPrice = null;
                if (totalStands >= 100) {
                    if (totalStands >= 100 && totalStands <= 299) {
                        totalPrice = totalStands * 160;
                    } else if (totalStands >= 300 && totalStands <= 499) {
                        totalPrice = totalStands * 140;
                    } else if (totalStands >= 500) {
                        totalPrice = totalStands * 120;
                    }
                }
                
                let report = `ОТЧЁТ ПО СТЕНДАМ У ДОМОФОНОВ\n`;
                report += `Дата формирования: ${dateStr}\n`;
                report += `========================================\n\n`;
                
                report += `СТАТИСТИКА:\n`;
                report += `• Выбрано объектов: ${selectedCount}\n`;
                report += `• Всего стендов: ${totalStands}\n`;
                report += `• Всего квартир: ${totalFlats}\n`;
                
                if (totalStands >= 100) {
                    report += `• Стоимость в месяц: ${Utils.formatPrice(totalPrice)}\n`;
                    if (totalFlats > 0) {
                        report += `• Стоимость на квартиру: ${Utils.formatPrice(totalPrice / totalFlats)}\n`;
                    }
                } else {
                    report += `• Стоимость: требуется больше зданий для расчёта\n`;
                }
                
                report += `\nПАРАМЕТРЫ ФИЛЬТРАЦИИ:\n`;
                report += `• Статусы: ${Array.from(activeFilters.status).join(', ') || 'Все'}\n`;
                report += `• Районы: ${Array.from(activeFilters.district).join(', ') || 'Все'}\n`;
                report += `• Этажность: ${activeFilters.floors.min || 'мин'} - ${activeFilters.floors.max || 'макс'}\n`;
                report += `• Квартир в подъезде: ${activeFilters.flatsPerEntrance.min || 'мин'} - ${activeFilters.flatsPerEntrance.max || 'макс'}\n`;
                report += `• Процентный отбор: ${currentPercentage}%\n\n`;
                
                report += `СПИСОК АДРЕСОВ:\n`;
                displayedBuildings.forEach((building, index) => {
                    const shortDistrict = Utils.shortenDistrictName(building.district);
                    const statusSymbol = building.status === 'Свободно' ? '🟢' : '🔴';
                    report += `${index + 1}. ${statusSymbol} ${building.address} | ${shortDistrict} | ${building.status} | ${building.entrances} стендов | ${building.flats} кв.\n`;
                });
                
                report += `\nПРИМЕЧАНИЯ:\n`;
                report += `• Минимальное количество для расчета: 100 стендов\n`;
                report += `• Отчёт сформирован автоматически в приложении PR МАРКЕТ Рязань`;
                
                await this.copyToClipboard(report);
                Utils.showNotification('Отчёт скопирован в буфер обмена', 'success');
                
            } catch (error) {
                console.error('Ошибка формирования отчёта:', error);
                Utils.showNotification('Ошибка формирования отчёта', 'error');
            } finally {
                setTimeout(() => {
                    isGeneratingReport = false;
                }, 1000);
            }
        },

        async copyToClipboard(text) {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                    return;
                }
            } catch (error) {
                console.log('Clipboard API не доступен, используем fallback:', error);
            }
            
            return new Promise((resolve, reject) => {
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        resolve();
                    } else {
                        reject(new Error('Не удалось скопировать'));
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }
    };

    // ============================================================================
    // МОДУЛЬ 8: ПОЛНОЭКРАННЫЙ РЕЖИМ ДЛЯ ПК
    // ============================================================================
    const FullscreenModule = {
        init() {
            const sidebarBtn = document.getElementById('sidebar-fullscreen-btn');
            const fullscreenBtn = document.getElementById('fullscreen-close-btn');
            
            if (sidebarBtn) {
                sidebarBtn.addEventListener('click', () => {
                    this.toggleFullscreen();
                });
            }
            
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', () => {
                    this.toggleFullscreen();
                });
            }
            
            this.initDragAndDrop();
        },
        
        initDragAndDrop() {
            const fullscreenHeader = document.getElementById('fullscreen-header');
            if (!fullscreenHeader) return;
            
            fullscreenHeader.addEventListener('mousedown', this.startDrag.bind(this));
            document.addEventListener('mousemove', this.drag.bind(this));
            document.addEventListener('mouseup', this.stopDrag.bind(this));
            
            this.dragBound = this.drag.bind(this);
            this.stopDragBound = this.stopDrag.bind(this);
            
            fullscreenHeader.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                this.startDrag({
                    clientX: touch.clientX,
                    clientY: touch.clientY,
                    target: e.target
                });
                e.preventDefault();
            }, { passive: false });
            
            document.addEventListener('touchmove', (e) => {
                if (!dragData) return;
                const touch = e.touches[0];
                this.drag({
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                e.preventDefault();
            }, { passive: false });
            
            document.addEventListener('touchend', () => {
                this.stopDrag();
            });
        },
        
        startDrag(e) {
            const fullscreenHeader = document.getElementById('fullscreen-header');
            if (!fullscreenHeader || !isFullscreen || e.target.closest('.fullscreen-close-btn')) return;
            
            dragData = {
                element: fullscreenHeader,
                startX: e.clientX - fullscreenHeader.offsetLeft,
                startY: e.clientY - fullscreenHeader.offsetTop,
                offsetX: e.clientX,
                offsetY: e.clientY
            };
            
            fullscreenHeader.style.cursor = 'grabbing';
            fullscreenHeader.style.transition = 'none';
        },
        
        drag(e) {
            if (!dragData) return;
            
            const newX = e.clientX - dragData.startX;
            const newY = e.clientY - dragData.startY;
            
            const maxX = window.innerWidth - dragData.element.offsetWidth;
            const maxY = window.innerHeight - dragData.element.offsetHeight;
            
            dragData.element.style.left = Math.max(10, Math.min(newX, maxX - 10)) + 'px';
            dragData.element.style.top = Math.max(10, Math.min(newY, maxY - 10)) + 'px';
        },
        
        stopDrag() {
            if (!dragData) return;
            
            dragData.element.style.cursor = 'move';
            dragData.element.style.transition = 'all 0.3s';
            dragData = null;
        },
        
        toggleFullscreen() {
            const sidebar = document.getElementById('desktop-sidebar');
            const mapContainer = document.getElementById('desktop-map-container');
            const fullscreenHeader = document.getElementById('fullscreen-header');
            const sidebarBtn = document.getElementById('sidebar-fullscreen-btn');
            const fullscreenBtn = document.getElementById('fullscreen-close-btn');
            
            if (!isFullscreen) {
                isFullscreen = true;
                sidebar.classList.add('hidden');
                mapContainer.classList.add('fullscreen');
                fullscreenHeader.style.display = 'block';
                sidebarBtn.innerHTML = '▶';
                sidebarBtn.title = 'Вернуться к обычному виду';
                fullscreenBtn.innerHTML = '◀';
                
                Utils.showNotification('Включен полноэкранный режим', 'success');
            } else {
                isFullscreen = false;
                sidebar.classList.remove('hidden');
                mapContainer.classList.remove('fullscreen');
                fullscreenHeader.style.display = 'none';
                sidebarBtn.innerHTML = '◀';
                sidebarBtn.title = 'Развернуть на весь экран';
                
                Utils.showNotification('Обычный режим', 'info');
            }
            
            if (map) {
                setTimeout(() => {
                    map.container.fitToViewport();
                }, 100);
            }
        }
    };

    // ============================================================================
    // ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
    // ============================================================================
    async function initApp() {
        try {
			
			// Инициализируем заглушку ландшафтного режима
            LandscapeWarningModule.init();
            // Добавляем кнопку "Продолжить"
            setTimeout(() => LandscapeWarningModule.addForceContinueButton(), 1000);
			
            Utils.updateMainContentHeight();
            
            await MapModule.initMap();

            Utils.showNotification('Загрузка данных...', 'info');
            allBuildings = await DataModule.loadData();
            
            FilterModule.initFilters(allBuildings);
            PercentageModule.initPercentageSelector();
            
            HistoryModule.init();
            
            FilterModule.applyFilters();
            
            setupUIEvents();
            setupResponsive();
            
            if (!isMobile) {
                Utils.setDesktopTab('filters');
                FullscreenModule.init();
            }
            
            document.getElementById('loading-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loading-overlay').style.display = 'none';
            }, 300);
            
            appInitialized = true;
            
            Utils.showNotification('Приложение готово к работе', 'success');
        } catch (error) {
            console.error('Ошибка инициализации:', error);
            Utils.showNotification('Ошибка загрузки приложения', 'error');
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    function setupUIEvents() {
        document.querySelectorAll('.sidebar-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = tab.dataset.tab;
                Utils.setDesktopTab(tabName);
            });
        });
        
        document.querySelectorAll('.nav-button[data-view]').forEach(button => {
            button.addEventListener('click', () => {
                const view = button.dataset.view;
                Utils.setMobileView(view);
            });
        });
        
        const mobileReportBtn = document.getElementById('mobile-report-button');
        if (mobileReportBtn) {
            mobileReportBtn.addEventListener('click', () => {
                if (isGeneratingReport) return;
                ReportModule.generateReport();
            });
        }
        
        document.getElementById('load-more')?.addEventListener('click', () => {
            ListModule.loadMoreBuildings(false);
        });
        
        document.getElementById('desktop-load-more')?.addEventListener('click', () => {
            ListModule.loadMoreBuildings(true);
        });
        
        const desktopReportBtn = document.getElementById('desktop-generate-report');
        if (desktopReportBtn) {
            desktopReportBtn.addEventListener('click', () => {
                if (isGeneratingReport) return;
                ReportModule.generateReport();
            });
        }
        
        // Горячая клавиша Ctrl+Z для отмены
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                HistoryModule.undo();
            }
        });
    }

    async function updateResponsive() {
        const nowIsMobile = window.innerWidth <= 768;
        
        if (nowIsMobile !== isMobile) {
            let oldCenter, oldZoom;
            if (map) {
                oldCenter = map.getCenter();
                oldZoom = map.getZoom();
            }
            
            isMobile = nowIsMobile;
            
            await MapModule.initMap();
            
            if (oldCenter && oldZoom) {
                map.setCenter(oldCenter, oldZoom);
            }
            
            if (displayedBuildings.length > 0) {
                MapModule.renderBuildings(displayedBuildings);
            }
        }
        
        if (isMobile) {
            if (currentView !== 'map') {
                Utils.setMobileView('map');
            }
            Utils.updateMainContentHeight();
        } else {
            if (appInitialized) {
                Utils.setDesktopTab(currentDesktopTab);
                FullscreenModule.init();
            }
        }
        
        if (map) {
            setTimeout(() => map.container.fitToViewport(), 100);
        }
    }

    function setupResponsive() {
        const debouncedUpdate = Utils.debounce(updateResponsive, 250);
        
        window.addEventListener('resize', debouncedUpdate);
        window.addEventListener('orientationchange', () => {
            setTimeout(updateResponsive, 300);
        });
        
        window.addEventListener('load', () => {
            setTimeout(updateResponsive, 100);
        });
        
        updateResponsive();
    }

    document.addEventListener('DOMContentLoaded', initApp);
    
    // Экспорт функций в глобальную область
    window.MapModule = MapModule;
    window.Utils = Utils;
    window.FilterModule = FilterModule;
    window.handleHideBuilding = handleHideBuilding;
    window.handleHideCluster = handleHideCluster;
    </script>
</body>
</html>
