<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта стендов у домофонов - Рязань</title>
    
    <!-- Яндекс Карты API -->
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
    <style>
        /* ===== БАЗОВЫЕ СТИЛИ ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f5f5f7;
            position: relative;
        }
        /* ===== МОБИЛЬНАЯ СТРУКТУРА ===== */
        .mobile-container {
            display: none;
        }
        /* ===== ПК ВЕРСИЯ (ИСХОДНАЯ) ===== */
        .desktop-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        /* Контейнер для карты ПК */
        .desktop-container .map-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        .desktop-container #map-desktop {
            width: 100%;
            height: 100%;
        }
        /* ===== КОМПАКТНАЯ ШАПКА ===== */
        .compact-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            z-index: 900;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .header-title {
            font-size: 16px;
            font-weight: 700;
            color: white;
        }
        .header-subtitle {
            font-size: 12px;
            opacity: 0.9;
            color: rgba(255,255,255,0.95);
        }
        .header-toggle {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .header-toggle:hover {
            background: rgba(255,255,255,0.25);
        }
        .header-toggle svg {
            width: 16px;
            height: 16px;
            stroke: white;
            transition: transform 0.3s ease;
        }
        .header-toggle.active svg {
            transform: rotate(180deg);
        }
        .header-stats-compact {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        .stat-compact {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .stat-label-compact {
            font-size: 10px;
            opacity: 0.9;
            color: rgba(255,255,255,0.9);
            margin-bottom: 4px;
            font-weight: 500;
        }
        .stat-value-compact {
            font-size: 14px;
            font-weight: 700;
            color: white;
        }
        /* ===== ПЛАВАЮЩАЯ ПАНЕЛЬ ===== */
        .floating-panel {
            position: fixed;
            left: 0;
            right: 0;
            background: white;
            z-index: 1000;
            box-shadow: 0 -4px 24px rgba(0,0,0,0.1);
            border-top: 1px solid rgba(0,0,0,0.08);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            max-height: 75vh;
            overflow: hidden;
        }
        /* ПК ВЕРСИЯ */
        @media (min-width: 769px) {
            .desktop-container {
                display: block;
            }
            
            .mobile-container {
                display: none !important;
            }
            
            .compact-header {
                display: block;
                position: fixed;
                top: 24px;
                left: 48px;
                width: 380px;
                border-radius: 16px;
                padding: 20px 20px 12px 20px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.15);
                z-index: 1000;
            }
            
            .compact-header.alone {
                border-radius: 16px;
            }
            
            .compact-header.with-panel {
                border-radius: 16px 16px 0 0;
                box-shadow: none;
                border-bottom: none;
            }
            
            .floating-panel {
                top: 220px;
                left: 48px;
                width: 380px;
                height: calc(100vh - 255px);
                max-height: calc(100vh - 225px);
                border-radius: 0 0 16px 16px;
                border: 1px solid rgba(0,0,0,0.08);
                border-top: none;
                bottom: auto;
                right: auto;
                transform: none;
                box-shadow: 0 8px 32px rgba(0,0,0,0.15);
                display: none;
                overflow: hidden !important;
            }
            
            .floating-panel.active {
                display: flex;
            }
            
            /* Десктопная навигация - горизонтальная в шапке */
            .desktop-header-nav {
                display: flex;
                gap: 4px;
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid rgba(255,255,255,0.1);
            }
            
            .desktop-nav-button {
                flex: 1;
                padding: 8px 4px;
                border: none;
                background: none;
                font-size: 10px;
                color: rgba(255,255,255,0.8);
                cursor: pointer;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                border-radius: 8px;
                transition: all 0.2s ease;
                position: relative;
                min-height: 40px;
            }
            
            .desktop-nav-button:hover {
                background: rgba(255,255,255,0.1);
            }
            
            .desktop-nav-button.active {
                color: white;
                background: rgba(255,255,255,0.15);
            }
            
            .desktop-nav-icon {
                font-size: 16px;
                width: 18px;
                height: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .desktop-nav-label {
                font-weight: 500;
                letter-spacing: 0.2px;
                white-space: nowrap;
                font-size: 9px;
            }
            
            .mobile-nav-bar {
                display: none !important;
            }
            
            /* Показываем кнопку toggle на ПК */
            .header-toggle {
                display: flex !important;
                position: absolute;
                right: 20px;
                top: 20px;
            }
            
            /* Кнопка сброса в фильтрах - скрываем на ПК */
            .filter-reset-button-container {
                display: none !important;
            }
            
            /* ⚙️ ФИЛЬТРЫ - ГРИД СИСТЕМА - ВСЕГДА ОДНА КОЛОНКА */
            .filters-grid {
                display: flex !important;
                flex-direction: column !important;
                gap: 16px;
                padding: 20px;
                overflow-y: auto;
                flex: 1;
                min-height: 0;
                align-content: start;
            }
            
            .filter-card {
                width: 100% !important;
                min-height: auto;
                flex-shrink: 0;
                padding: 20px;
                margin: 0 !important;
            }
            
            .checkboxes-column {
                max-height: none !important;
                overflow-y: visible !important;
                padding-right: 0;
                min-height: auto;
            }
            
            .filter-card-title {
                font-size: 15px;
                margin-bottom: 16px;
                padding-bottom: 8px;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .filter-card-title::before {
                height: 16px;
                width: 5px;
            }
            
            .checkbox-card {
                padding: 10px 12px;
                margin-bottom: 6px;
                border-radius: 10px;
                transition: all 0.2s ease;
            }
            
            .checkbox-card:last-child {
                margin-bottom: 0;
            }
            
            .checkbox-card label {
                font-size: 14px;
            }
            
            .checkbox-card input {
                width: 20px;
                height: 20px;
                min-width: 20px;
            }
            
            .checkbox-card input:checked::after {
                font-size: 12px;
            }
            
            .checkbox-card:hover {
                background: rgba(102, 126, 234, 0.08);
                transform: translateX(4px);
            }
            
            .range-compact {
                width: 100%;
            }
            
            .range-row {
                width: 100%;
            }
            
            .building-card {
                margin: 8px 20px;
                padding: 18px;
            }
            
            .header-title {
                font-size: 18px;
            }
            
            .header-subtitle {
                font-size: 14px;
            }
            
            .stat-value-compact {
                font-size: 16px;
            }
            
            .desktop-container .map-container {
                padding-top: 0;
            }
            
            /* ОЧЕНЬ ВАЖНО: отключаем грид-распределение для мобильных стилей на ПК */
            .filters-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Скрываем кнопку сброса в action-buttons */
            .action-buttons {
                display: none !important;
            }
            
            /* СКРОЛЛБАР ДЛЯ ПК - ВАЖНО */
            .floating-panel .scrollable-content {
                overflow-y: scroll !important;
                scrollbar-width: thin !important;
                scrollbar-color: #667eea #f3f4f6 !important;
            }
            
            .floating-panel .scrollable-content::-webkit-scrollbar {
                width: 14px !important;
                height: 14px !important;
            }
            
            .floating-panel .scrollable-content::-webkit-scrollbar-track {
                background: #f3f4f6 !important;
                border-radius: 10px !important;
                margin: 6px !important;
                border: 2px solid #e5e7eb !important;
            }
            
            .floating-panel .scrollable-content::-webkit-scrollbar-thumb {
                background: #667eea !important;
                border-radius: 10px !important;
                border: 4px solid #f3f4f6 !important;
            }
            
            .floating-panel .scrollable-content::-webkit-scrollbar-thumb:hover {
                background: #5a67d8 !important;
            }
            
            /* Списки на ПК */
            .buildings-list-compact {
                overflow-y: scroll !important;
                scrollbar-width: thin !important;
                scrollbar-color: #667eea #f3f4f6 !important;
            }
            
            .buildings-list-compact::-webkit-scrollbar {
                width: 14px !important;
            }
            
            .buildings-list-compact::-webkit-scrollbar-track {
                background: #f3f4f6 !important;
                border-radius: 10px !important;
                margin: 6px !important;
                border: 2px solid #e5e7eb !important;
            }
            
            .buildings-list-compact::-webkit-scrollbar-thumb {
                background: #667eea !important;
                border-radius: 10px !important;
                border: 4px solid #f3f4f6 !important;
            }
        }
        
        /* МОБИЛЬНАЯ ВЕРСИЯ */
        @media (max-width: 768px) {
            .desktop-container {
                display: none !important;
            }
            
            .mobile-container {
                display: flex;
                flex-direction: column;
                height: 100vh;
                width: 100vw;
                overflow: hidden;
                position: relative;
            }
            
            /* ШАПКА для мобильной версии */
            .mobile-container .compact-header {
                position: relative;
                top: 0;
                left: 0;
                right: 0;
                z-index: 10;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                flex-shrink: 0;
                padding: 12px 16px;
                border-radius: 0;
            }
            
            /* ОСНОВНОЙ КОНТЕНТ для мобильной версии */
            .mobile-container .main-content {
                flex: 1;
                position: relative;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                min-height: 0;
            }
            
            /* КОНТЕЙНЕР КАРТЫ для мобильной версии */
            .mobile-container .map-container {
                position: relative;
                flex: 1;
                width: 100%;
                height: 100%;
                display: block;
                z-index: 1;
                min-height: 0;
            }
            
            .mobile-container #map-mobile {
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
            }
            
            /* ПАНЕЛЬ для мобильной версии */
            .mobile-container .floating-panel {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 2;
                display: none;
                max-height: 100%;
                border-radius: 0;
                box-shadow: none;
                border: none;
                transform: none;
                background: white;
            }
            
            .mobile-container .floating-panel.active {
                display: flex;
            }
            
            /* МОБИЛЬНАЯ НАВИГАЦИЯ */
            .mobile-container .mobile-nav-bar {
                position: relative;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(20px);
                border-top: 1px solid rgba(0, 0, 0, 0.08);
                z-index: 20;
                padding: 8px 12px;
                display: flex;
                gap: 4px;
                flex-shrink: 0;
            }
            
            /* Скрываем кнопку toggle на мобильных */
            .mobile-container .header-toggle {
                display: none !important;
            }
            
            /* Прячем десктопную навигацию в шапке на мобильных */
            .mobile-container .desktop-header-nav {
                display: none !important;
            }
            
            /* Кнопка сброса в фильтрах для мобильных */
            .mobile-container .filter-reset-button-container {
                padding: 16px;
                border-bottom: 1px solid #e5e7eb;
                margin-bottom: 16px;
            }
            
            .mobile-container .filter-reset-button-container button {
                width: 100%;
            }
            
            /* Адаптируем ширину балуна для мобильных */
            .custom-balloon {
                width: calc(100vw - 90px) !important;
                max-width: calc(100vw - 90px) !important;
                margin: 0 auto;
                left: 10px !important;
                right: 10px !important;
            }
            
            /* Скрываем кнопку сброса в action-buttons для мобильных */
            .mobile-container .action-buttons {
                display: none !important;
            }
            
            /* Районы и статусы рисуем сразу все */
            .checkboxes-column {
                max-height: none !important;
                overflow-y: visible !important;
                min-height: auto;
            }
            
            /* Адаптируем мобильную навигацию для 4 кнопок */
            .mobile-nav-bar {
                gap: 3px;
                padding: 6px 8px;
                height: 70px;
                box-sizing: border-box;
            }
            
            .mobile-nav-bar .nav-button {
                padding: 8px 2px;
                min-height: 48px;
            }
            
            .mobile-nav-bar .nav-label {
                font-size: 10px;
            }
            
            /* Безопасные зоны для современных устройств */
            @supports(padding: max(0px)) {
                .mobile-nav-bar {
                    padding-bottom: max(8px, env(safe-area-inset-bottom));
                }
                
                .compact-header {
                    padding-top: max(12px, env(safe-area-inset-top));
                }
            }
        }
        /* ===== КОНТЕНТ ПАНЕЛИ ===== */
        .panel-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        /* КОНТЕЙНЕРЫ */
        .tab-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        .tab-pane-content {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        .tab-pane-content.active {
            display: flex;
        }
        /* ⚙️ ФИЛЬТРЫ - ВСЕГДА ОДНА КОЛОНКА */
        .filters-grid {
            display: flex !important;
            flex-direction: column !important;
            gap: 16px;
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            align-content: start;
        }
        @media (max-width: 480px) {
            .filters-grid {
                gap: 12px;
                padding: 16px;
            }
        }
        @media (min-width: 769px) {
            .filters-grid {
                gap: 20px;
                padding: 24px;
                overflow-y: auto !important;
                scrollbar-width: thin !important;
                scrollbar-color: #667eea #f3f4f6 !important;
            }
        }
        .filter-card {
            background: #f9fafb;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        .filter-card:hover {
            border-color: #d1d5db;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .filter-card-title {
            font-weight: 600;
            color: #111827;
            margin-bottom: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .filter-card-title::before {
            content: '';
            width: 4px;
            height: 14px;
            background: #667eea;
            border-radius: 2px;
        }
        .filter-card-title span {
            font-weight: 700;
            color: #667eea;
        }
        @media (max-width: 480px) {
            .filter-card-title {
                margin-bottom: 12px;
                font-size: 13px;
            }
        }
        /* ЧЕКБОКСЫ */
        .checkboxes-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 4px;
        }
        .checkbox-card {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .checkbox-card:hover {
            background: #f3f4f6;
        }
        .checkbox-card input {
            margin-right: 10px;
            cursor: pointer;
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            min-width: 18px;
            border-radius: 5px;
            border: 2px solid #d1d5db;
            appearance: none;
            background: white;
            position: relative;
            transition: all 0.2s ease;
        }
        .checkbox-card input:checked {
            background: #667eea;
            border-color: #667eea;
        }
        .checkbox-card input:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 11px;
            font-weight: bold;
        }
        .checkbox-card label {
            font-size: 13px;
            color: #374151;
            cursor: pointer;
            flex: 1;
            line-height: 1.3;
        }
        /* Обновленные стили для числовых фильтров */
        .range-compact {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .range-row {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        .range-button {
            width: 40px;
            height: 44px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 10px;
            font-size: 20px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            padding: 0;
            line-height: 1;
        }
        .range-button:hover {
            border-color: #667eea;
            background: #f3f4f6;
            color: #667eea;
        }
        .range-button:active {
            transform: scale(0.95);
        }
        /* Стили для отключенных кнопок диапазона */
        .range-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        .range-button.disabled:hover {
            border-color: #e5e7eb;
            background: white;
            color: #6b7280;
            transform: none;
            box-shadow: none;
        }
        .range-input-compact {
            flex: 1;
            min-width: 0;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            height: 44px;
            box-sizing: border-box;
            background: white;
            color: #111827;
            text-align: center;
            transition: all 0.2s ease;
            -moz-appearance: textfield;
        }
        .range-input-compact::-webkit-outer-spin-button,
        .range-input-compact::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .range-input-compact:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        /* Адаптивность для кнопок */
        @media (max-width: 480px) {
            .range-button {
                width: 36px;
                height: 40px;
                font-size: 18px;
            }
            
            .range-input-compact {
                height: 40px;
                font-size: 13px;
                padding: 8px 10px;
            }
        }
        @media (max-width: 360px) {
            .range-row {
                gap: 6px;
            }
            
            .range-button {
                width: 32px;
                height: 36px;
                font-size: 16px;
            }
            
            .range-input-compact {
                height: 36px;
                font-size: 12px;
            }
            
            .mobile-nav-bar {
                gap: 2px;
                padding: 4px 6px;
            }
            
            .mobile-nav-bar .nav-button {
                padding: 6px 1px;
                min-height: 42px;
            }
            
            .mobile-nav-bar .nav-label {
                font-size: 9px;
            }
            
            .mobile-nav-bar .nav-icon {
                font-size: 16px;
            }
        }
        /* СПИСОК */
        .precise-controls {
            padding: 16px 20px 8px 20px;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        .percentage-slider-container {
            margin-bottom: 12px;
        }
        .percentage-header-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .percentage-value-compact {
            font-weight: 700;
            color: #667eea;
            font-size: 14px;
            min-width: 45px;
            text-align: center;
        }
        .percentage-slider-compact {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #ef4444, #f59e0b, #10b981);
            outline: none;
            border-radius: 3px;
            margin: 8px 0;
        }
        .percentage-slider-compact::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        /* НОВЫЙ СТИЛЬ ДЛЯ КНОПОК УПРАВЛЕНИЯ ПРОЦЕНТОМ */
        .percentage-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        .percentage-label {
            font-size: 13px;
            color: #374151;
            font-weight: 500;
            white-space: nowrap;
        }
        .percentage-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        .percentage-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
            line-height: 1;
        }
        .percentage-btn:hover {
            border-color: #667eea;
            background: #f3f4f6;
            color: #667eea;
        }
        .percentage-btn:active {
            transform: scale(0.95);
        }
        /* СПИСОК ЗДАНИЙ */
        .buildings-list-compact {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            padding: 8px 0;
        }
        .building-card {
            position: relative;
            padding: 16px;
            background: white;
            margin: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }
        .building-card:hover {
            transform: translateY(-1px);
            border-color: #d1d5db;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        }
        .building-card.selected {
            border-color: #667eea;
            background: linear-gradient(to right, rgba(102, 126, 234, 0.03), white);
        }
        .building-card.hidden {
            opacity: 0.7;
            background: #f9fafb;
            position: relative;
        }
        .building-card.hidden::before {
            content: 'СКРЫТО';
            position: absolute;
            top: 50%;
            right: 16px;
            transform: translateY(-50%);
            background: #ef4444;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .building-address-compact {
            font-weight: 600;
            margin-bottom: 6px;
            color: #111827;
            font-size: 14px;
            line-height: 1.3;
            padding-right: 40px;
        }
        .building-info-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 12px;
            color: #6b7280;
        }
        .info-chip-compact {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: #f3f4f6;
            border-radius: 16px;
            font-weight: 500;
        }
        .status-chip-compact {
            background: #10b981;
            color: white;
        }
        .status-chip-compact.busy {
            background: #ef4444;
        }
        /* Обновленные стили для кнопки скрытия (крестик) */
        .hide-building-btn-compact {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #e5e7eb;
            background: white;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: normal;
            transition: all 0.2s ease;
            padding: 0;
        }
        .hide-building-btn-compact:hover {
            background: #fef2f2;
            color: #ef4444;
            border-color: #fecaca;
            transform: scale(1.1);
        }
        .hide-building-btn-compact.hidden {
            background: #f0fdf4;
            color: #10b981;
            border-color: #bbf7d0;
        }
        .hide-building-btn-compact.hidden:hover {
            background: #dcfce7;
            color: #059669;
            border-color: #86efac;
        }
        /* КНОПКИ ДЕЙСТВИЙ */
        .action-buttons {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            background: white;
            flex-shrink: 0;
        }
        .action-button {
            flex: 1;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 44px;
        }
        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        .action-button.secondary {
            background: #6b7280;
        }
        /* МОБИЛЬНАЯ НАВИГАЦИЯ */
        .mobile-nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            z-index: 1001;
            padding: 8px 12px;
            display: flex;
            gap: 4px;
        }
        .nav-button {
            flex: 1;
            padding: 10px 4px;
            border: none;
            background: none;
            font-size: 11px;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            border-radius: 12px;
            transition: all 0.2s ease;
            position: relative;
            min-height: 48px;
        }
        .nav-button.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        .nav-icon {
            font-size: 18px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-label {
            font-weight: 500;
            letter-spacing: 0.2px;
            white-space: nowrap;
        }
        /* УВЕДОМЛЕНИЯ */
        .notification-toast {
            position: fixed;
            top: 16px;
            right: 16px;
            left: 16px;
            padding: 12px 16px;
            background: white;
            color: #111827;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            z-index: 10000;
            font-size: 13px;
            font-weight: 500;
            animation: slideInTop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid #10b981;
        }
        @media (min-width: 481px) {
            .notification-toast {
                left: auto;
                max-width: 320px;
            }
        }
        .notification-toast::before {
            content: '✓';
            width: 20px;
            height: 20px;
            background: #10b981;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }
        .notification-toast.error {
            border-left-color: #ef4444;
        }
        .notification-toast.error::before {
            content: '!';
            background: #ef4444;
        }
        .notification-toast.info {
            border-left-color: #3b82f6;
        }
        .notification-toast.info::before {
            content: 'i';
            background: #3b82f6;
        }
        @keyframes slideInTop {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideOutTop {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-100%); opacity: 0; }
        }
        /* ЗАГРУЗКА */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            gap: 20px;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text {
            font-size: 16px;
            color: white;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ПУСТОЙ СПИСОК */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: #6b7280;
            flex: 1;
        }
        .empty-icon {
            font-size: 40px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        .empty-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }
        .empty-subtitle {
            font-size: 13px;
            line-height: 1.4;
            max-width: 240px;
        }
        /* ОПТИМИЗАЦИЯ ПРОКРУТКИ - ОБНОВЛЕННЫЕ СТИЛИ ДЛЯ СКРОЛЛА */
        .scrollable-content {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: auto;
            scrollbar-color: #667eea #f3f4f6;
        }
        /* Принудительно показываем скроллбар всегда */
        .scrollable-content {
            overflow-y: scroll !important;
        }
        /* Стили для скроллбара - БОЛЕЕ ЯРКИЕ И ЗАМЕТНЫЕ */
        .scrollable-content::-webkit-scrollbar {
            width: 14px !important;
            height: 14px !important;
        }
        .scrollable-content::-webkit-scrollbar-track {
            background: #f3f4f6 !important;
            border-radius: 10px !important;
            margin: 6px !important;
            border: 2px solid #e5e7eb !important;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background: #667eea !important;
            border-radius: 10px !important;
            border: 4px solid #f3f4f6 !important;
            background-clip: padding-box !important;
            box-shadow: inset 0 0 6px rgba(0,0,0,0.1) !important;
        }
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #5a67d8 !important;
            border: 4px solid #f3f4f6 !important;
            box-shadow: inset 0 0 6px rgba(0,0,0,0.2) !important;
        }
        .scrollable-content::-webkit-scrollbar-thumb:active {
            background: #4c51bf !important;
        }
        .scrollable-content::-webkit-scrollbar-corner {
            background: #f3f4f6 !important;
        }
        /* Для Firefox */
        @supports (scrollbar-width: auto) {
            .scrollable-content {
                scrollbar-width: auto !important;
                scrollbar-color: #667eea #f3f4f6 !important;
            }
        }
        /* Для браузеров, которые скрывают скроллбар по умолчанию (macOS) */
        @media screen and (-webkit-min-device-pixel-ratio:0) {
            .scrollable-content {
                overflow-y: scroll !important;
            }
            
            .scrollable-content::-webkit-scrollbar {
                -webkit-appearance: none !important;
                width: 14px !important;
            }
            
            .scrollable-content::-webkit-scrollbar:vertical {
                width: 14px !important;
            }
            
            .scrollable-content::-webkit-scrollbar:horizontal {
                height: 14px !important;
            }
            
            .scrollable-content::-webkit-scrollbar-track {
                background: #f3f4f6 !important;
                border-radius: 10px !important;
                border: 2px solid #e5e7eb !important;
            }
            
            .scrollable-content::-webkit-scrollbar-thumb {
                background-color: #667eea !important;
                border-radius: 10px !important;
                border: 4px solid #f3f4f6 !important;
            }
        }
        /* КНОПКА "ПОКАЗАТЬ ВСЕ" */
        .show-all-button {
            cursor: pointer;
            text-align: center;
            padding: 16px;
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            background: white;
            border-radius: 12px;
            margin: 12px 16px;
            border: 2px dashed #d1d5db;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .show-all-button:hover {
            background: rgba(102, 126, 234, 0.05);
            border-color: #667eea;
            transform: translateY(-1px);
        }
        /* БАЛУНЫ */
        .custom-balloon {
            background: white;
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
            padding: 0;
            width: calc(100vw - 32px) !important;
            max-width: 360px;
            min-width: 280px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
            overflow: hidden !important;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }
        /* АДАПТИВНОСТЬ */
        @media (max-width: 360px) {
            .compact-header {
                padding: 10px 12px;
            }
            
            .header-title {
                font-size: 15px;
            }
            
            .header-subtitle {
                font-size: 11px;
            }
            
            .stat-value-compact {
                font-size: 13px;
            }
            
            .filters-grid {
                padding: 12px;
                gap: 10px;
            }
            
            .filter-card {
                padding: 14px;
            }
            
            .building-card {
                margin: 6px 12px;
                padding: 14px;
            }
            
            .scrollable-content::-webkit-scrollbar {
                width: 12px !important;
            }
            
            .scrollable-content::-webkit-scrollbar-track {
                margin: 4px !important;
            }
        }
        @media (orientation: landscape) and (max-height: 600px) {
            .floating-panel {
                max-height: 85vh;
            }
        }
        /* Подсказки для ПК */
        @media (min-width: 769px) {
            .info-chip-compact.status-chip-compact {
                position: relative;
                cursor: help;
            }
            
            .info-chip-compact.status-chip-compact:hover::after {
                content: attr(title);
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                background: #374151;
                color: white;
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 11px;
                white-space: nowrap;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                margin-bottom: 6px;
            }
            
            .info-chip-compact.status-chip-compact:hover::before {
                content: '';
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                border: 4px solid transparent;
                border-top-color: #374151;
                margin-bottom: -2px;
            }
            
            .building-address-compact {
                position: relative;
            }
            
            .building-address-compact:hover::after {
                content: attr(title);
                position: absolute;
                bottom: 100%;
                left: 0;
                background: #374151;
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                max-width: 300px;
                white-space: normal;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                margin-bottom: 6px;
            }
            
            .desktop-nav-button {
                position: relative;
            }
            
            .desktop-nav-button:hover::after {
                content: attr(data-tooltip);
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                background: #374151;
                color: white;
                padding: 6px 10px;
                border-radius: 6px;
                font-size: 11px;
                white-space: nowrap;
                z-index: 1000;
                margin-bottom: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            .scrollable-content::-webkit-scrollbar {
                width: 14px !important;
            }
            
            .scrollable-content::-webkit-scrollbar-thumb {
                border: 4px solid #f3f4f6 !important;
            }
        }
        
        /* Мобильные устройства */
        @media (max-width: 768px) {
            .scrollable-content::-webkit-scrollbar {
                width: 12px !important;
            }
            
            .scrollable-content::-webkit-scrollbar-thumb {
                min-height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Индикатор загрузки -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Загрузка данных...</div>
    </div>
    <!-- ПК ВЕРСИЯ -->
    <div class="desktop-container">
        <!-- Компактная шапка -->
        <div class="compact-header alone" id="compact-header-desktop">
            <div class="header-top">
                <div>
                    <div class="header-title">PR МАРКЕТ Рязань</div>
                    <div class="header-subtitle">Карта стендов у домофона: <span id="stats-total-stands">0</span> в базе</div>
                </div>
                <!-- Кнопка переключения панели (видна на ПК) -->
                <div class="header-toggle" id="header-toggle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
            </div>
            
            <div class="header-stats-compact">
                <div class="stat-compact">
                    <div class="stat-label-compact">Выбрано</div>
                    <div class="stat-value-compact" id="stats-compact-selected-desktop">0</div>
                </div>
                <div class="stat-compact">
                    <div class="stat-label-compact">В месяц</div>
                    <div class="stat-value-compact" id="stats-compact-price-desktop">—</div>
                </div>
                <div class="stat-compact">
                    <div class="stat-label-compact">За квартиру</div>
                    <div class="stat-value-compact" id="stats-compact-per-flat-desktop">—</div>
                </div>
            </div>
            
            <!-- Десктопная навигация в шапке -->
            <div class="desktop-header-nav">
                <button class="desktop-nav-button" data-action="reset-filters">
                    <span class="desktop-nav-icon">↻</span>
                    <span class="desktop-nav-label">Сбросить</span>
                </button>
                <button class="desktop-nav-button" data-action="filters">
                    <span class="desktop-nav-icon">⚙️</span>
                    <span class="desktop-nav-label">Фильтры</span>
                </button>
                <button class="desktop-nav-button" data-action="list">
                    <span class="desktop-nav-icon">📋</span>
                    <span class="desktop-nav-label">Список</span>
                </button>
                <button class="desktop-nav-button" data-action="report">
                    <span class="desktop-nav-icon">📄</span>
                    <span class="desktop-nav-label">Отчёт</span>
                </button>
            </div>
        </div>
        <!-- Контейнер для карты -->
        <div class="map-container">
            <div id="map-desktop"></div>
        </div>
        
        <!-- Плавающая панель -->
        <div class="floating-panel" id="floating-panel-desktop">
            <div class="panel-content-wrapper">
                <div class="tab-content-wrapper">
                    <!-- Вкладка фильтров -->
                    <div class="tab-pane-content active" id="basic-tab-content-desktop">
                        <div class="filters-grid scrollable-content">
                            <!-- Статус -->
                            <div class="filter-card">
                                <div class="filter-card-title">Статус стендов</div>
                                <div class="checkboxes-column" id="status-filters-compact-desktop"></div>
                            </div>
                            
                            <!-- Районы -->
                            <div class="filter-card">
                                <div class="filter-card-title">Район города</div>
                                <div class="checkboxes-column" id="district-filters-compact-desktop"></div>
                            </div>
                            
                            <!-- Этажность зданий -->
                            <div class="filter-card">
                                <div class="filter-card-title" id="floors-title-desktop">Этажность зданий</div>
                                <div class="range-compact">
                                    <div class="range-row">
                                        <button class="range-button minus" type="button" data-target="min-floors-compact-desktop">-</button>
                                        <input type="number" id="min-floors-compact-desktop" class="range-input-compact" placeholder="От" min="1">
                                        <button class="range-button plus" type="button" data-target="min-floors-compact-desktop">+</button>
                                    </div>
                                    <div class="range-row">
                                        <button class="range-button minus" type="button" data-target="max-floors-compact-desktop">-</button>
                                        <input type="number" id="max-floors-compact-desktop" class="range-input-compact" placeholder="До" min="1">
                                        <button class="range-button plus" type="button" data-target="max-floors-compact-desktop">+</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Квартир в подъезде -->
                            <div class="filter-card">
                                <div class="filter-card-title" id="flats-title-desktop">Квартир в подъезде</div>
                                <div class="range-compact">
                                    <div class="range-row">
                                        <button class="range-button minus" type="button" data-target="min-flats-compact-desktop">-</button>
                                        <input type="number" id="min-flats-compact-desktop" class="range-input-compact" placeholder="От" min="1">
                                        <button class="range-button plus" type="button" data-target="min-flats-compact-desktop">+</button>
                                    </div>
                                    <div class="range-row">
                                        <button class="range-button minus" type="button" data-target="max-flats-compact-desktop">-</button>
                                        <input type="number" id="max-flats-compact-desktop" class="range-input-compact" placeholder="До" min="1">
                                        <button class="range-button plus" type="button" data-target="max-flats-compact-desktop">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Вкладка настроек -->
                    <div class="tab-pane-content" id="precise-tab-content-desktop">
                        <div class="precise-controls">
                            <div class="percentage-slider-container">
                                <div class="percentage-controls">
                                    <span class="percentage-label">Процент отображения</span>
                                    <div class="percentage-buttons">
                                        <button class="percentage-btn" id="percentage-decrease-desktop">-</button>
                                        <span class="percentage-value-compact" id="percentage-value-compact-desktop">100%</span>
                                        <button class="percentage-btn" id="percentage-increase-desktop">+</button>
                                    </div>
                                </div>
                                <input type="range" id="percentage-slider-compact-desktop" class="percentage-slider-compact" 
                                       min="1" max="100" step="1" value="100">
                            </div>
                        </div>
                        
                        <div id="buildings-list-compact-desktop" class="buildings-list-compact scrollable-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- МОБИЛЬНАЯ ВЕРСИЯ -->
    <div class="mobile-container">
        <!-- Шапка -->
        <div class="compact-header" id="compact-header-mobile">
            <div class="header-top">
                <div>
                    <div class="header-title">PR МАРКЕТ Рязань</div>
                    <div class="header-subtitle">Карта стендов у домофона: <span id="stats-total-stands-mobile">0</span> в базе</div>
                </div>
            </div>
            
            <div class="header-stats-compact">
                <div class="stat-compact">
                    <div class="stat-label-compact">Выбрано</div>
                    <div class="stat-value-compact" id="stats-compact-selected-mobile">0</div>
                </div>
                <div class="stat-compact">
                    <div class="stat-label-compact">В месяц</div>
                    <div class="stat-value-compact" id="stats-compact-price-mobile">—</div>
                </div>
                <div class="stat-compact">
                    <div class="stat-label-compact">За квартиру</div>
                    <div class="stat-value-compact" id="stats-compact-per-flat-mobile">—</div>
                </div>
            </div>
        </div>
        <!-- Основной контент -->
        <div class="main-content">
            <!-- Контейнер карты -->
            <div class="map-container" id="map-container-mobile">
                <div id="map-mobile"></div>
            </div>
            
            <!-- Плавающая панель -->
            <div class="floating-panel" id="floating-panel-mobile">
                <div class="panel-content-wrapper">
                    <div class="tab-content-wrapper">
                        <!-- Вкладка фильтров -->
                        <div class="tab-pane-content active" id="basic-tab-content-mobile">
                            <!-- Кнопка сброса фильтров -->
                            <div class="filter-reset-button-container">
                                <button class="action-button secondary" id="reset-filters-btn-mobile">
                                    <span>↻</span>
                                    <span>Сбросить фильтры</span>
                                </button>
                            </div>
                            
                            <div class="filters-grid scrollable-content">
                                <!-- Статус -->
                                <div class="filter-card">
                                    <div class="filter-card-title">Статус стендов</div>
                                    <div class="checkboxes-column" id="status-filters-compact-mobile"></div>
                                </div>
                                
                                <!-- Районы -->
                                <div class="filter-card">
                                    <div class="filter-card-title">Район города</div>
                                    <div class="checkboxes-column" id="district-filters-compact-mobile"></div>
                                </div>
                                
                                <!-- Этажность зданий -->
                                <div class="filter-card">
                                    <div class="filter-card-title" id="floors-title-mobile">Этажность зданий</div>
                                    <div class="range-compact">
                                        <div class="range-row">
                                            <button class="range-button minus" type="button" data-target="min-floors-compact-mobile">-</button>
                                            <input type="number" id="min-floors-compact-mobile" class="range-input-compact" placeholder="От" min="1">
                                            <button class="range-button plus" type="button" data-target="min-floors-compact-mobile">+</button>
                                        </div>
                                        <div class="range-row">
                                            <button class="range-button minus" type="button" data-target="max-floors-compact-mobile">-</button>
                                            <input type="number" id="max-floors-compact-mobile" class="range-input-compact" placeholder="До" min="1">
                                            <button class="range-button plus" type="button" data-target="max-floors-compact-mobile">+</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Квартир в подъезде -->
                                <div class="filter-card">
                                    <div class="filter-card-title" id="flats-title-mobile">Квартир в подъезде</div>
                                    <div class="range-compact">
                                        <div class="range-row">
                                            <button class="range-button minus" type="button" data-target="min-flats-compact-mobile">-</button>
                                            <input type="number" id="min-flats-compact-mobile" class="range-input-compact" placeholder="От" min="1">
                                            <button class="range-button plus" type="button" data-target="min-flats-compact-mobile">+</button>
                                        </div>
                                        <div class="range-row">
                                            <button class="range-button minus" type="button" data-target="max-flats-compact-mobile">-</button>
                                            <input type="number" id="max-flats-compact-mobile" class="range-input-compact" placeholder="До" min="1">
                                            <button class="range-button plus" type="button" data-target="max-flats-compact-mobile">+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Вкладка настроек -->
                        <div class="tab-pane-content" id="precise-tab-content-mobile">
                            <div class="precise-controls">
                                <div class="percentage-slider-container">
                                    <div class="percentage-controls">
                                        <span class="percentage-label">Процент отображения</span>
                                        <div class="percentage-buttons">
                                            <button class="percentage-btn" id="percentage-decrease-mobile">-</button>
                                            <span class="percentage-value-compact" id="percentage-value-compact-mobile">100%</span>
                                            <button class="percentage-btn" id="percentage-increase-mobile">+</button>
                                        </div>
                                    </div>
                                    <input type="range" id="percentage-slider-compact-mobile" class="percentage-slider-compact" 
                                           min="1" max="100" step="1" value="100">
                                </div>
                            </div>
                            
                            <div id="buildings-list-compact-mobile" class="buildings-list-compact scrollable-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Мобильная навигация -->
        <div class="mobile-nav-bar" id="mobile-nav-bar-mobile">
            <button class="nav-button active" data-action="map">
                <span class="nav-icon">🗺️</span>
                <span class="nav-label">Карта</span>
            </button>
            <button class="nav-button" data-action="filters">
                <span class="nav-icon">⚙️</span>
                <span class="nav-label">Фильтры</span>
            </button>
            <button class="nav-button" data-action="list">
                <span class="nav-icon">📋</span>
                <span class="nav-label">Список</span>
            </button>
            <button class="nav-button" data-action="report">
                <span class="nav-icon">📄</span>
                <span class="nav-label">Отчёт</span>
            </button>
        </div>
    </div>
    <!-- Вспомогательный контейнер для уведомлений -->
    <div id="notifications-container"></div>
    <script>
        // Конфигурация
        const CONFIG = {
            SHEET_ID: '1jZsHbNXVmvNRjmh_p1pLFl3G3oLgD0sFas8L4EDexiI',
            SHEET_NAME: 'Filter',
            MAP_CENTER: [54.6416, 39.7126],
            MAP_ZOOM: 11,
            FREE_STATUS: 'Свободно',
            DEFAULT_RENDER_LIMIT: 50
        };
        // Глобальные переменные
        let map;
        let objectManager;
        let allBuildings = [];
        let filteredBuildings = [];
        let preciseFilteredBuildings = [];
        let activeFilters = {
            status: new Set(),
            district: new Set()
        };
        let availableValues = {
            floors: [],
            flatsPerEntrance: []
        };
        let isPanelVisible = false;
        let displayPercentage = 100;
        let hiddenInBasicFilters = new Set();
        let hiddenInPreciseSettings = new Set();
        let buildingsByOriginalIndex = {};
        let mapUpdateRafId = null;
        let activeBalloon = null;
        let percentageDebounceTimer = null;
        let currentMode = 'basic';
        let currentRenderLimit = CONFIG.DEFAULT_RENDER_LIMIT;
        let isAppActive = true;
        let isMobile = window.innerWidth <= 768;
        let currentMobileView = 'map'; // 'map', 'filters', 'list'
        // DOM элементы
        const elements = {
            loadingOverlay: document.getElementById('loading-overlay'),
            
            // ПК элементы
            compactHeaderDesktop: document.getElementById('compact-header-desktop'),
            headerToggle: document.getElementById('header-toggle'),
            floatingPanelDesktop: document.getElementById('floating-panel-desktop'),
            mapDesktop: document.getElementById('map-desktop'),
            statsCompactSelectedDesktop: document.getElementById('stats-compact-selected-desktop'),
            statsCompactPriceDesktop: document.getElementById('stats-compact-price-desktop'),
            statsCompactPerFlatDesktop: document.getElementById('stats-compact-per-flat-desktop'),
            statsTotalStands: document.getElementById('stats-total-stands'),
            statusFiltersCompactDesktop: document.getElementById('status-filters-compact-desktop'),
            districtFiltersCompactDesktop: document.getElementById('district-filters-compact-desktop'),
            minFloorsCompactDesktop: document.getElementById('min-floors-compact-desktop'),
            maxFloorsCompactDesktop: document.getElementById('max-floors-compact-desktop'),
            minFlatsCompactDesktop: document.getElementById('min-flats-compact-desktop'),
            maxFlatsCompactDesktop: document.getElementById('max-flats-compact-desktop'),
            floorsTitleDesktop: document.getElementById('floors-title-desktop'),
            flatsTitleDesktop: document.getElementById('flats-title-desktop'),
            percentageSliderCompactDesktop: document.getElementById('percentage-slider-compact-desktop'),
            percentageValueCompactDesktop: document.getElementById('percentage-value-compact-desktop'),
            buildingsListCompactDesktop: document.getElementById('buildings-list-compact-desktop'),
            percentageDecreaseDesktop: document.getElementById('percentage-decrease-desktop'),
            percentageIncreaseDesktop: document.getElementById('percentage-increase-desktop'),
            
            // Мобильные элементы
            compactHeaderMobile: document.getElementById('compact-header-mobile'),
            floatingPanelMobile: document.getElementById('floating-panel-mobile'),
            mapContainerMobile: document.getElementById('map-container-mobile'),
            mapMobile: document.getElementById('map-mobile'),
            statsCompactSelectedMobile: document.getElementById('stats-compact-selected-mobile'),
            statsCompactPriceMobile: document.getElementById('stats-compact-price-mobile'),
            statsCompactPerFlatMobile: document.getElementById('stats-compact-per-flat-mobile'),
            statsTotalStandsMobile: document.getElementById('stats-total-stands-mobile'),
            statusFiltersCompactMobile: document.getElementById('status-filters-compact-mobile'),
            districtFiltersCompactMobile: document.getElementById('district-filters-compact-mobile'),
            minFloorsCompactMobile: document.getElementById('min-floors-compact-mobile'),
            maxFloorsCompactMobile: document.getElementById('max-floors-compact-mobile'),
            minFlatsCompactMobile: document.getElementById('min-flats-compact-mobile'),
            maxFlatsCompactMobile: document.getElementById('max-flats-compact-mobile'),
            floorsTitleMobile: document.getElementById('floors-title-mobile'),
            flatsTitleMobile: document.getElementById('flats-title-mobile'),
            percentageSliderCompactMobile: document.getElementById('percentage-slider-compact-mobile'),
            percentageValueCompactMobile: document.getElementById('percentage-value-compact-mobile'),
            buildingsListCompactMobile: document.getElementById('buildings-list-compact-mobile'),
            resetFiltersBtnMobile: document.getElementById('reset-filters-btn-mobile'),
            mobileNavBar: document.getElementById('mobile-nav-bar-mobile'),
            percentageDecreaseMobile: document.getElementById('percentage-decrease-mobile'),
            percentageIncreaseMobile: document.getElementById('percentage-increase-mobile')
        };
        // Получаем актуальные элементы в зависимости от устройства
        function getCurrentElements() {
            if (isMobile) {
                return {
                    compactHeader: elements.compactHeaderMobile,
                    floatingPanel: elements.floatingPanelMobile,
                    map: elements.mapMobile,
                    statsCompactSelected: elements.statsCompactSelectedMobile,
                    statsCompactPrice: elements.statsCompactPriceMobile,
                    statsCompactPerFlat: elements.statsCompactPerFlatMobile,
                    statsTotalStands: elements.statsTotalStandsMobile,
                    statusFiltersCompact: elements.statusFiltersCompactMobile,
                    districtFiltersCompact: elements.districtFiltersCompactMobile,
                    minFloorsCompact: elements.minFloorsCompactMobile,
                    maxFloorsCompact: elements.maxFloorsCompactMobile,
                    minFlatsCompact: elements.minFlatsCompactMobile,
                    maxFlatsCompact: elements.maxFlatsCompactMobile,
                    floorsTitle: elements.floorsTitleMobile,
                    flatsTitle: elements.flatsTitleMobile,
                    percentageSliderCompact: elements.percentageSliderCompactMobile,
                    percentageValueCompact: elements.percentageValueCompactMobile,
                    buildingsListCompact: elements.buildingsListCompactMobile,
                    resetFiltersBtn: elements.resetFiltersBtnMobile,
                    percentageDecrease: elements.percentageDecreaseMobile,
                    percentageIncrease: elements.percentageIncreaseMobile,
                    mapContainer: elements.mapContainerMobile
                };
            } else {
                return {
                    compactHeader: elements.compactHeaderDesktop,
                    floatingPanel: elements.floatingPanelDesktop,
                    map: elements.mapDesktop,
                    statsCompactSelected: elements.statsCompactSelectedDesktop,
                    statsCompactPrice: elements.statsCompactPriceDesktop,
                    statsCompactPerFlat: elements.statsCompactPerFlatDesktop,
                    statsTotalStands: elements.statsTotalStands,
                    statusFiltersCompact: elements.statusFiltersCompactDesktop,
                    districtFiltersCompact: elements.districtFiltersCompactDesktop,
                    minFloorsCompact: elements.minFloorsCompactDesktop,
                    maxFloorsCompact: elements.maxFloorsCompactDesktop,
                    minFlatsCompact: elements.minFlatsCompactDesktop,
                    maxFlatsCompact: elements.maxFlatsCompactDesktop,
                    floorsTitle: elements.floorsTitleDesktop,
                    flatsTitle: elements.flatsTitleDesktop,
                    percentageSliderCompact: elements.percentageSliderCompactDesktop,
                    percentageValueCompact: elements.percentageValueCompactDesktop,
                    buildingsListCompact: elements.buildingsListCompactDesktop,
                    resetFiltersBtn: null,
                    percentageDecrease: elements.percentageDecreaseDesktop,
                    percentageIncrease: elements.percentageIncreaseDesktop,
                    mapContainer: null
                };
            }
        }
        // Утилиты
        const Utils = {
            debounce(func, wait) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            },
            escapeHtml(text) {
                if (text === null || text === undefined) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            formatNumber(num) {
                return new Intl.NumberFormat('ru-RU').format(num);
            },
            formatPrice(num) {
                return new Intl.NumberFormat('ru-RU', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(num);
            },
            showNotification(message, type = 'success') {
                if (!isAppActive) return;
                
                const container = document.getElementById('notifications-container') || document.body;
                const notification = document.createElement('div');
                notification.className = `notification-toast ${type}`;
                notification.textContent = message;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    if (!isAppActive) return;
                    notification.style.animation = 'slideOutTop 0.3s ease-out forwards';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        };
        // Вспомогательные функции для эмодзи и обработки районов
        function getStatusWithEmoji(status) {
            if (status === CONFIG.FREE_STATUS) {
                return '🟢 ' + status;
            } else if (status && status.includes('Занято')) {
                return '🔴 ' + status;
            }
            return status;
        }
        function getShortDistrictName(fullDistrict) {
            if (!fullDistrict) return '';
            const bracketIndex = fullDistrict.indexOf('(');
            if (bracketIndex !== -1) {
                return fullDistrict.substring(0, bracketIndex).trim();
            }
            return fullDistrict;
        }
        // =============================
        // ИНИЦИАЛИЗАЦИЯ ИНТЕРФЕЙСА
        // =============================
        function initInterface() {
            const currentElements = getCurrentElements();
            
            if (!isMobile) {
                // Кнопка переключения панели (для ПК)
                if (elements.headerToggle) {
                    elements.headerToggle.addEventListener('click', toggleDesktopPanel);
                }
            } else {
                // Мобильная версия - инициализируем начальное состояние
                showMobileView('map');
                
                // Кнопка сброса фильтров для мобильных
                if (currentElements.resetFiltersBtn) {
                    currentElements.resetFiltersBtn.addEventListener('click', resetAllFilters);
                }
            }
            
            // Навигация
            setupNavigation();
            
            // Процентный слайдер
            if (currentElements.percentageSliderCompact) {
                currentElements.percentageSliderCompact.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    displayPercentage = value;
                    updatePercentageDisplay();
                    
                    clearTimeout(percentageDebounceTimer);
                    percentageDebounceTimer = setTimeout(() => {
                        applyPreciseFilters();
                    }, 100);
                });
            }
            
            // Кнопки управления процентом
            if (currentElements.percentageDecrease) {
                currentElements.percentageDecrease.addEventListener('click', () => {
                    const slider = currentElements.percentageSliderCompact;
                    let value = parseInt(slider.value);
                    value = Math.max(1, value - 1);
                    slider.value = value;
                    displayPercentage = value;
                    updatePercentageDisplay();
                    
                    clearTimeout(percentageDebounceTimer);
                    percentageDebounceTimer = setTimeout(() => {
                        applyPreciseFilters();
                    }, 100);
                });
            }
            
            if (currentElements.percentageIncrease) {
                currentElements.percentageIncrease.addEventListener('click', () => {
                    const slider = currentElements.percentageSliderCompact;
                    let value = parseInt(slider.value);
                    value = Math.min(100, value + 1);
                    slider.value = value;
                    displayPercentage = value;
                    updatePercentageDisplay();
                    
                    clearTimeout(percentageDebounceTimer);
                    percentageDebounceTimer = setTimeout(() => {
                        applyPreciseFilters();
                    }, 100);
                });
            }
            
            // На ПК панель по умолчанию скрыта
            if (!isMobile) {
                currentElements.floatingPanel.style.display = 'none';
                currentElements.floatingPanel.classList.remove('active');
                isPanelVisible = false;
                updateHeaderToggleIcon();
            }
            
            // Обработка изменения размера окна
            window.addEventListener('resize', handleResize);
        }
        function setupNavigation() {
            const handleNavClick = (button) => {
                const action = button.dataset.action;
                
                if (isMobile) {
                    // Мобильная навигация
                    const navBar = button.closest('.mobile-nav-bar');
                    if (navBar) {
                        navBar.querySelectorAll('.nav-button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        button.classList.add('active');
                    }
                } else {
                    // Десктопная навигация
                    const navBar = button.closest('.desktop-header-nav');
                    if (navBar) {
                        navBar.querySelectorAll('.desktop-nav-button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        button.classList.add('active');
                    }
                }
                
                handleNavigationAction(action, button);
            };
            
            // Мобильная навигация
            if (elements.mobileNavBar) {
                elements.mobileNavBar.querySelectorAll('.nav-button').forEach(button => {
                    button.addEventListener('click', () => handleNavClick(button));
                });
            }
            
            // Десктопная навигация
            const desktopNavButtons = document.querySelectorAll('.desktop-header-nav .desktop-nav-button');
            if (desktopNavButtons.length > 0) {
                desktopNavButtons.forEach(button => {
                    const action = button.dataset.action;
                    let tooltip = '';
                    switch(action) {
                        case 'reset-filters': tooltip = 'Сбросить все фильтры'; break;
                        case 'filters': tooltip = 'Фильтры выбора зданий'; break;
                        case 'list': tooltip = 'Список выбранных зданий'; break;
                        case 'report': tooltip = 'Скопировать отчет в буфер'; break;
                    }
                    button.setAttribute('data-tooltip', tooltip);
                    button.addEventListener('click', () => handleNavClick(button));
                });
            }
        }
        // Функция для отображения мобильного вида
        function showMobileView(view) {
            if (!isMobile) return;
            
            currentMobileView = view;
            const currentElements = getCurrentElements();
            
            switch(view) {
                case 'map':
                    currentElements.mapContainer.style.display = 'block';
                    currentElements.floatingPanel.style.display = 'none';
                    currentElements.floatingPanel.classList.remove('active');
                    // Обновляем размеры карты после показа
                    setTimeout(() => {
                        if (map) {
                            map.container.fitToViewport();
                        }
                    }, 100);
                    break;
                    
                case 'filters':
                    currentElements.mapContainer.style.display = 'none';
                    currentElements.floatingPanel.style.display = 'flex';
                    currentElements.floatingPanel.classList.add('active');
                    switchContent('basic');
                    break;
                    
                case 'list':
                    currentElements.mapContainer.style.display = 'none';
                    currentElements.floatingPanel.style.display = 'flex';
                    currentElements.floatingPanel.classList.add('active');
                    switchContent('precise');
                    break;
            }
        }
        function handleNavigationAction(action, button) {
            const currentElements = getCurrentElements();
            
            if (isMobile) {
                // Мобильная версия
                switch(action) {
                    case 'map':
                        showMobileView('map');
                        break;
                        
                    case 'reset-filters':
                        resetAllFilters();
                        break;
                        
                    case 'filters':
                        showMobileView('filters');
                        break;
                        
                    case 'list':
                        showMobileView('list');
                        break;
                        
                    case 'report':
                        copyReportToClipboard();
                        break;
                }
            } else {
                // Десктопная версия
                switch(action) {
                    case 'reset-filters':
                        resetAllFilters();
                        button.classList.add('active');
                        setTimeout(() => {
                            button.classList.remove('active');
                        }, 500);
                        break;
                        
                    case 'filters':
                        if (isPanelVisible && currentMode === 'basic') {
                            currentElements.floatingPanel.style.display = 'none';
                            currentElements.floatingPanel.classList.remove('active');
                            currentElements.compactHeader.classList.remove('with-panel');
                            currentElements.compactHeader.classList.add('alone');
                            isPanelVisible = false;
                            updateHeaderToggleIcon();
                        } else {
                            currentElements.floatingPanel.style.display = 'flex';
                            currentElements.floatingPanel.classList.add('active');
                            currentElements.compactHeader.classList.remove('alone');
                            currentElements.compactHeader.classList.add('with-panel');
                            isPanelVisible = true;
                            updateHeaderToggleIcon();
                            switchContent('basic');
                        }
                        break;
                        
                    case 'list':
                        if (isPanelVisible && currentMode === 'precise') {
                            currentElements.floatingPanel.style.display = 'none';
                            currentElements.floatingPanel.classList.remove('active');
                            currentElements.compactHeader.classList.remove('with-panel');
                            currentElements.compactHeader.classList.add('alone');
                            isPanelVisible = false;
                            updateHeaderToggleIcon();
                        } else {
                            currentElements.floatingPanel.style.display = 'flex';
                            currentElements.floatingPanel.classList.add('active');
                            currentElements.compactHeader.classList.remove('alone');
                            currentElements.compactHeader.classList.add('with-panel');
                            isPanelVisible = true;
                            updateHeaderToggleIcon();
                            switchContent('precise');
                        }
                        break;
                        
                    case 'report':
                        copyReportToClipboard();
                        break;
                }
            }
        }
        function toggleDesktopPanel() {
            if (!isMobile) {
                const currentElements = getCurrentElements();
                isPanelVisible = !isPanelVisible;
                if (isPanelVisible) {
                    currentElements.floatingPanel.style.display = 'flex';
                    currentElements.floatingPanel.classList.add('active');
                    currentElements.compactHeader.classList.remove('alone');
                    currentElements.compactHeader.classList.add('with-panel');
                } else {
                    currentElements.floatingPanel.style.display = 'none';
                    currentElements.floatingPanel.classList.remove('active');
                    currentElements.compactHeader.classList.remove('with-panel');
                    currentElements.compactHeader.classList.add('alone');
                }
                updateHeaderToggleIcon();
            }
        }
        function updateHeaderToggleIcon() {
            if (!isMobile && elements.headerToggle) {
                if (isPanelVisible) {
                    elements.headerToggle.classList.add('active');
                } else {
                    elements.headerToggle.classList.remove('active');
                }
            }
        }
        function switchContent(contentType) {
            const suffix = isMobile ? '-mobile' : '-desktop';
            
            // Скрываем все вкладки
            document.querySelectorAll('.tab-pane-content').forEach(pane => {
                if (pane.id.includes(suffix)) {
                    pane.classList.remove('active');
                }
            });
            
            if (contentType === 'basic') {
                const basicTab = document.getElementById(`basic-tab-content${suffix}`);
                if (basicTab) {
                    basicTab.classList.add('active');
                }
                currentMode = 'basic';
            } else if (contentType === 'precise') {
                const preciseTab = document.getElementById(`precise-tab-content${suffix}`);
                if (preciseTab) {
                    preciseTab.classList.add('active');
                }
                currentMode = 'precise';
                updateBuildingsList();
            }
        }
        function handleResize() {
            const wasMobile = isMobile;
            isMobile = window.innerWidth <= 768;
            
            if (wasMobile !== isMobile) {
                location.reload(); // Перезагружаем страницу при изменении типа устройства
            }
        }
        // =============================
        // ОСНОВНЫЕ ФУНКЦИИ
        // =============================
        function calculatePrice(totalStands) {
            if (totalStands < 100) {
                return { 
                    pricePerStand: null, 
                    totalPrice: null, 
                    message: 'Выберите больше зданий' 
                };
            } else if (totalStands >= 100 && totalStands <= 299) {
                return { 
                    pricePerStand: 160, 
                    totalPrice: totalStands * 160 
                };
            } else if (totalStands >= 300 && totalStands <= 499) {
                return { 
                    pricePerStand: 140, 
                    totalPrice: totalStands * 140 
                };
            } else {
                return { 
                    pricePerStand: 120, 
                    totalPrice: totalStands * 120 
                };
            }
        }
        function selectByPercentageBresenham(items, percentage) {
            if (percentage >= 100) return [...items];
            if (percentage <= 0 || items.length === 0) return [];
            
            const n = items.length;
            const k = Math.round(n * percentage / 100);
            
            if (k >= n) return [...items];
            if (k <= 0) return [];
            
            const result = [];
            let error = 0;
            const step = n / k;
            
            for (let i = 0; i < n && result.length < k; i++) {
                error += 1;
                if (error >= step) {
                    result.push(items[i]);
                    error -= step;
                }
            }
            
            return result;
        }
        function updatePercentageDisplay() {
            const currentElements = getCurrentElements();
            if (currentElements.percentageValueCompact) {
                currentElements.percentageValueCompact.textContent = `${displayPercentage}%`;
            }
            if (currentElements.percentageSliderCompact) {
                currentElements.percentageSliderCompact.value = displayPercentage;
            }
        }
        function updateStatistics() {
            setTimeout(() => {
                computeStatistics();
            }, 0);
        }
        function computeStatistics() {
            const currentElements = getCurrentElements();
            let totalStands = 0;
            let totalFlats = 0;
            let totalStandsAll = 0;
            
            for (let i = 0; i < preciseFilteredBuildings.length; i++) {
                const building = preciseFilteredBuildings[i];
                totalStands += building.entrances || 0;
                totalFlats += building.flats || 0;
            }
            
            for (let i = 0; i < allBuildings.length; i++) {
                const building = allBuildings[i];
                totalStandsAll += building.entrances || 0;
            }
            
            // Обновляем оба набора статистики
            if (elements.statsTotalStands) {
                elements.statsTotalStands.textContent = Utils.formatNumber(totalStandsAll);
            }
            if (elements.statsTotalStandsMobile) {
                elements.statsTotalStandsMobile.textContent = Utils.formatNumber(totalStandsAll);
            }
            
            if (elements.statsCompactSelectedDesktop) {
                elements.statsCompactSelectedDesktop.textContent = Utils.formatNumber(totalStands);
            }
            if (elements.statsCompactSelectedMobile) {
                elements.statsCompactSelectedMobile.textContent = Utils.formatNumber(totalStands);
            }
            
            if (totalStands === 0) {
                if (elements.statsCompactPriceDesktop) {
                    elements.statsCompactPriceDesktop.textContent = '—';
                    elements.statsCompactPerFlatDesktop.textContent = '—';
                }
                if (elements.statsCompactPriceMobile) {
                    elements.statsCompactPriceMobile.textContent = '—';
                    elements.statsCompactPerFlatMobile.textContent = '—';
                }
                return;
            }
            
            const priceInfo = calculatePrice(totalStands);
            
            if (totalStands < 100) {
                if (elements.statsCompactPriceDesktop) {
                    elements.statsCompactPriceDesktop.textContent = '—';
                    elements.statsCompactPerFlatDesktop.textContent = '—';
                }
                if (elements.statsCompactPriceMobile) {
                    elements.statsCompactPriceMobile.textContent = '—';
                    elements.statsCompactPerFlatMobile.textContent = '—';
                }
            } else {
                if (elements.statsCompactPriceDesktop) {
                    elements.statsCompactPriceDesktop.textContent = `${Utils.formatNumber(priceInfo.totalPrice)} ₽`;
                }
                if (elements.statsCompactPriceMobile) {
                    elements.statsCompactPriceMobile.textContent = `${Utils.formatNumber(priceInfo.totalPrice)} ₽`;
                }
                
                if (totalFlats > 0) {
                    const pricePerFlat = priceInfo.totalPrice / totalFlats;
                    const formattedPricePerFlat = Utils.formatNumber(pricePerFlat.toFixed(2));
                    if (elements.statsCompactPerFlatDesktop) {
                        elements.statsCompactPerFlatDesktop.textContent = `${formattedPricePerFlat} ₽`;
                    }
                    if (elements.statsCompactPerFlatMobile) {
                        elements.statsCompactPerFlatMobile.textContent = `${formattedPricePerFlat} ₽`;
                    }
                } else {
                    if (elements.statsCompactPerFlatDesktop) {
                        elements.statsCompactPerFlatDesktop.textContent = '—';
                    }
                    if (elements.statsCompactPerFlatMobile) {
                        elements.statsCompactPerFlatMobile.textContent = '—';
                    }
                }
            }
        }
        // =============================
        // ИНИЦИАЛИЗАЦИЯ КАРТЫ
        // =============================
        function initMap() {
            return new Promise((resolve) => {
                ymaps.ready(() => {
                    const mapElementId = isMobile ? 'map-mobile' : 'map-desktop';
                    const mapOptions = {
                        center: CONFIG.MAP_CENTER,
                        zoom: CONFIG.MAP_ZOOM,
                        avoidFractionalZoom: true,
                        suppressMapOpenBlock: true,
                        suppressObsoleteBrowserNotifier: true
                    };
                    
                    
                    map = new ymaps.Map(mapElementId, mapOptions);
                    
                    
                    // Добавляем обработчик завершения загрузки тайлов
                    map.events.add('tileload', function() {
                    });
                    objectManager = new ymaps.ObjectManager({
                        clusterize: true,
                        gridSize: 64,
                        clusterDisableClickZoom: true,
                        clusterOpenBalloonOnClick: false,
                        geoObjectOpenBalloonOnClick: false
                    });
                    objectManager.clusters.options.set({
                        preset: 'islands#invertedVioletClusterIcons',
                        clusterIconColor: '#667eea',
                        clusterIconPieStrokeWidth: 0,
                        clusterIconPieStrokeColor: '#ffffff'
                    });
                    objectManager.objects.options.set({
                        preset: 'islands#circleDotIcon',
                        iconColor: '#10b981'
                    });
                    map.geoObjects.add(objectManager);
                    
                    setupMapEventHandlers();
                    
                    // Обновляем размеры карты после создания
                    setTimeout(() => {
                        if (map) {
                            map.container.fitToViewport();
                        }
                    }, 500);
                    
                    resolve();
                });
            });
        }
        function setupMapEventHandlers() {
            if (!objectManager) return;
            
            objectManager.clusters.events.add('click', (e) => {
                const clusterId = e.get('objectId');
                handleClusterClick(clusterId);
            });
            objectManager.objects.events.add('click', (e) => {
                const objectId = e.get('objectId');
                const object = objectManager.objects.getById(objectId);
                
                if (object && object.properties) {
                    const originalIndex = object.properties.originalIndex;
                    if (originalIndex !== undefined) {
                        const building = buildingsByOriginalIndex[originalIndex];
                        if (building) {
                            showBuildingBalloon(building, object.geometry.coordinates);
                        }
                    }
                }
            });
        }
        function handleClusterClick(clusterId) {
            if (!objectManager) return;
            
            const cluster = objectManager.clusters.getById(clusterId);
            if (!cluster) return;
            
            const geoObjects = cluster.properties?.geoObjects || [];
            const totalCount = cluster.properties?.number || geoObjects.length;
            const clusterBuildings = [];
            
            for (let i = 0; i < geoObjects.length; i++) {
                const geoObject = geoObjects[i];
                const originalIndex = geoObject.properties?.originalIndex;
                if (originalIndex !== undefined) {
                    const building = buildingsByOriginalIndex[originalIndex];
                    if (building) {
                        clusterBuildings.push(building);
                    }
                }
            }
            
            if (clusterBuildings.length > 0) {
                showClusterBalloon(clusterBuildings, cluster.geometry.coordinates, totalCount);
            }
        }
        function showBuildingBalloon(building, coords) {
            const statusEmoji = building.status === CONFIG.FREE_STATUS ? '🟢' : '🔴';
            const content = `
                <div class="custom-balloon">
                    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                        <div style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;" title="${Utils.escapeHtml(building.status)}">
                                ${statusEmoji}
                            </span>
                            <span>${Utils.escapeHtml(building.address)}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <div>
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">Статус</div>
                                <div style="font-size: 13px; font-weight: 600; color: ${building.status === CONFIG.FREE_STATUS ? '#10b981' : '#ef4444'}">
                                    ${building.status === CONFIG.FREE_STATUS ? 'Свободно' : 'Занято'}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">Район</div>
                                <div style="font-size: 13px; font-weight: 600; color: #111827;">${Utils.escapeHtml(building.district)}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">Стендов</div>
                                <div style="font-size: 13px; font-weight: 600; color: #111827;">${building.entrances || '—'}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">Квартир</div>
                                <div style="font-size: 13px; font-weight: 600; color: #111827;">${Utils.formatNumber(building.flats) || '—'}</div>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 16px;">
                        <button onclick="window.handleHideSingle(${building.originalIndex})" style="
                            width: 100%;
                            padding: 12px;
                            background: #ef4444;
                            color: white;
                            border: none;
                            border-radius: 10px;
                            font-size: 13px;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 6px;
                            transition: all 0.2s ease;
                        ">
                            <span style="font-size: 16px; font-weight: bold;">×</span>
                            <span>Скрыть адрес</span>
                        </button>
                    </div>
                </div>
            `;
            
            openCustomBalloon(coords, content, true);
        }
        function showClusterBalloon(buildings, coords, totalCount) {
            const allBuildingIds = buildings.map(b => b.originalIndex).join(',');
            
            let tableRows = '';
            for (let i = 0; i < buildings.length; i++) {
                const building = buildings[i];
                const statusDot = building.status === CONFIG.FREE_STATUS ? '🟢' : '🔴';
                let address = building.address;
                if (address.length > 30) address = address.substring(0, 28) + '...';
                
                tableRows += `
                    <tr>
                        <td style="padding: 10px 6px; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span title="${Utils.escapeHtml(building.status)}" style="font-size: 16px;">
                                    ${statusDot}
                                </span>
                                <div style="font-size: 12px; font-weight: 500; color: #111827; max-width: 180px; overflow: hidden; text-overflow: ellipsis;">
                                    ${Utils.escapeHtml(address)}
                                </div>
                            </div>
                        </td>
                        <td style="padding: 10px 6px; border-bottom: 1px solid #e5e7eb; text-align: center;">
                            <div style="font-size: 12px; font-weight: 600; color: #111827;">${building.entrances || '—'}</div>
                        </td>
                    </tr>
                `;
            }
            
            const content = `
                <div class="custom-balloon">
                    <div style="padding: 16px; border-bottom: 1px solid #e5e7eb;">
                        <div style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 12px; display: flex; align-items: center; gap: 4px;">
                            <span>Кластер:</span>
                            <span>${totalCount}</span>
                            <span>🏠</span>
                        </div>
                        <div style="max-height: 250px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr>
                                        <th style="padding: 10px 6px; text-align: left; font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Адрес</th>
                                        <th style="padding: 10px 6px; text-align: center; font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Стендов</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div style="padding: 16px;">
                        <button onclick="window.handleHideAllCluster([${allBuildingIds}])" style="
                            width: 100%;
                            padding: 12px;
                            background: #ef4444;
                            color: white;
                            border: none;
                            border-radius: 10px;
                            font-size: 13px;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 6px;
                            transition: all 0.2s ease;
                        ">
                            <span style="font-size: 16px; font-weight: bold;">×</span>
                            <span>Скрыть кластер</span>
                        </button>
                    </div>
                </div>
            `;
            
            openCustomBalloon(coords, content, true);
        }
        function openCustomBalloon(coords, content, shouldCenter = true) {
            try {
                if (!map || !map.balloon) return;
                
                if (map.balloon.isOpen()) {
                    map.balloon.close();
                }
                
                const tempPlacemark = new ymaps.Placemark(coords, {
                    balloonContent: content
                }, {
                    balloonCloseButton: true,
                    balloonPanelMaxMapArea: 0,
                    balloonMaxHeight: 400,
                    balloonMaxWidth: 380,
                    balloonAutoPan: shouldCenter,
                    balloonOffset: [0, 0],
                    visible: false
                });
                
                map.geoObjects.add(tempPlacemark);
                activeBalloon = tempPlacemark;
                tempPlacemark.balloon.open();
                
                tempPlacemark.balloon.events.add('close', () => {
                    setTimeout(() => {
                        map.geoObjects.remove(tempPlacemark);
                        if (activeBalloon === tempPlacemark) {
                            activeBalloon = null;
                        }
                    }, 100);
                });
                
            } catch (error) {
                console.error('Error opening balloon:', error);
            }
        }
        window.handleHideSingle = function(index) {
            if (!isAppActive) return;
            
            hiddenInBasicFilters.add(index);
            
            const building = buildingsByOriginalIndex[index];
            if (building && building.district) {
                checkAndUncheckDistrict(building.district);
            }
            
            if (building && building.status) {
                checkAndUncheckStatus(building.status);
            }
            
            updateFilters();
            Utils.showNotification('Адрес скрыт');
            
            if (map && map.balloon && map.balloon.isOpen()) {
                map.balloon.close();
            }
        };
        window.handleHideAllCluster = function(buildingIds) {
            if (!isAppActive) return;
            
            const hiddenDistricts = new Set();
            const hiddenStatuses = new Set();
            
            buildingIds.forEach(id => {
                if (id !== undefined && id !== null) {
                    const parsedId = parseInt(id);
                    hiddenInBasicFilters.add(parsedId);
                    
                    const building = buildingsByOriginalIndex[parsedId];
                    if (building) {
                        if (building.district) hiddenDistricts.add(building.district);
                        if (building.status) hiddenStatuses.add(building.status);
                    }
                }
            });
            
            hiddenDistricts.forEach(district => {
                checkAndUncheckDistrict(district);
            });
            
            hiddenStatuses.forEach(status => {
                checkAndUncheckStatus(status);
            });
            
            updateFilters();
            Utils.showNotification(`Скрыто ${buildingIds.length} адресов`);
            
            if (map && map.balloon && map.balloon.isOpen()) {
                map.balloon.close();
            }
        };
        function checkAndUncheckDistrict(districtName) {
            const currentElements = getCurrentElements();
            let visibleCount = 0;
            for (let i = 0; i < allBuildings.length; i++) {
                const building = allBuildings[i];
                if (building.district === districtName && 
                    !hiddenInBasicFilters.has(building.originalIndex)) {
                    visibleCount++;
                    if (visibleCount > 0) break;
                }
            }
            
            if (visibleCount === 0) {
                // Находим чекбоксы района в обоих версиях
                const desktopCheckboxes = document.querySelectorAll('#district-filters-compact-desktop input[type="checkbox"]');
                const mobileCheckboxes = document.querySelectorAll('#district-filters-compact-mobile input[type="checkbox"]');
                
                desktopCheckboxes.forEach(checkbox => {
                    if (checkbox.value === districtName && checkbox.checked) {
                        checkbox.checked = false;
                        activeFilters.district.delete(districtName);
                    }
                });
                
                mobileCheckboxes.forEach(checkbox => {
                    if (checkbox.value === districtName && checkbox.checked) {
                        checkbox.checked = false;
                        activeFilters.district.delete(districtName);
                    }
                });
            }
        }
        function checkAndUncheckStatus(statusName) {
            const currentElements = getCurrentElements();
            let visibleCount = 0;
            for (let i = 0; i < allBuildings.length; i++) {
                const building = allBuildings[i];
                if (building.status === statusName && 
                    !hiddenInBasicFilters.has(building.originalIndex)) {
                    visibleCount++;
                    if (visibleCount > 0) break;
                }
            }
            
            if (visibleCount === 0) {
                // Находим чекбоксы статуса в обоих версиях
                const desktopCheckboxes = document.querySelectorAll('#status-filters-compact-desktop input[type="checkbox"]');
                const mobileCheckboxes = document.querySelectorAll('#status-filters-compact-mobile input[type="checkbox"]');
                
                desktopCheckboxes.forEach(checkbox => {
                    if (checkbox.value === statusName && checkbox.checked) {
                        checkbox.checked = false;
                        activeFilters.status.delete(statusName);
                    }
                });
                
                mobileCheckboxes.forEach(checkbox => {
                    if (checkbox.value === statusName && checkbox.checked) {
                        checkbox.checked = false;
                        activeFilters.status.delete(statusName);
                    }
                });
            }
        }
        // =============================
        // УПРАВЛЕНИЕ КНОПКАМИ ДИАПАЗОНА
        // =============================
        
        function updateRangeButtonsState() {
            const currentElements = getCurrentElements();
            
            if (currentElements.minFloorsCompact && currentElements.maxFloorsCompact) {
                updateSingleRangeButtons(
                    currentElements.minFloorsCompact,
                    currentElements.maxFloorsCompact,
                    availableValues.floors
                );
            }
            
            if (currentElements.minFlatsCompact && currentElements.maxFlatsCompact) {
                updateSingleRangeButtons(
                    currentElements.minFlatsCompact,
                    currentElements.maxFlatsCompact,
                    availableValues.flatsPerEntrance
                );
            }
        }
        function updateSingleRangeButtons(minInput, maxInput, availableValuesArray) {
            if (!minInput || !maxInput || availableValuesArray.length === 0) return;
            
            const minMinusBtn = minInput.parentElement.querySelector('.minus');
            const minPlusBtn = minInput.parentElement.querySelector('.plus');
            const maxMinusBtn = maxInput.parentElement.querySelector('.minus');
            const maxPlusBtn = maxInput.parentElement.querySelector('.plus');
            
            if (!minMinusBtn || !maxPlusBtn) return;
            
            const minValue = parseInt(minInput.value) || availableValuesArray[0];
            const maxValue = parseInt(maxInput.value) || availableValuesArray[availableValuesArray.length - 1];
            
            if (minValue <= availableValuesArray[0]) {
                minMinusBtn.classList.add('disabled');
            } else {
                minMinusBtn.classList.remove('disabled');
            }
            
            if (maxValue >= availableValuesArray[availableValuesArray.length - 1]) {
                maxPlusBtn.classList.add('disabled');
            } else {
                maxPlusBtn.classList.remove('disabled');
            }
        }
        // =============================
        // ЗАГРУЗКА ДАННЫХ
        // =============================
        
        function loadData() {
            return new Promise((resolve, reject) => {
                const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=responseHandler:handleSheetData&sheet=${CONFIG.SHEET_NAME}`;
                
                window.handleSheetData = function(response) {
                    try {
                        setTimeout(() => {
                            const data = parseGoogleSheetResponse(response);
                            allBuildings = data;
                            
                            data.forEach(building => {
                                buildingsByOriginalIndex[building.originalIndex] = building;
                            });
                            
                            resolve(data);
                        }, 0);
                    } catch (error) {
                        reject(error);
                    }
                };
                const script = document.createElement('script');
                script.src = url;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        function parseGoogleSheetResponse(response) {
            const rows = response.table?.rows || [];
            const buildings = [];
            
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].c || [];
                if (cells.length < 9) continue;
                
                const building = {
                    originalIndex: i,
                    address: getCellValue(cells[0]) || '',
                    lat: parseFloat(getCellValue(cells[2])) || 0,
                    lng: parseFloat(getCellValue(cells[1])) || 0,
                    status: getCellValue(cells[3]) || '',
                    district: getCellValue(cells[4]) || '',
                    entrances: getIntValue(cells[5]),
                    floors: getIntValue(cells[6]),
                    flats: getIntValue(cells[7]),
                    flatsPerEntrance: getIntValue(cells[8])
                };
                
                if (building.lat && building.lng) {
                    buildings.push(building);
                }
            }
            
            return buildings;
        }
        
        function getCellValue(cell) {
            if (!cell) return null;
            return cell.v !== undefined ? cell.v : cell.f;
        }
        function getIntValue(cell) {
            if (!cell) return null;
            const value = getCellValue(cell);
            if (value === null || value === undefined || value === '') return null;
            const num = parseInt(value);
            return isNaN(num) ? null : num;
        }
        function collectAvailableValues(buildings) {
            const floorsSet = new Set();
            const flatsSet = new Set();
            const statusSet = new Set();
            const districtSet = new Set();
            
            for (let i = 0; i < buildings.length; i++) {
                const building = buildings[i];
                if (building.floors !== null) floorsSet.add(building.floors);
                if (building.flatsPerEntrance !== null) flatsSet.add(building.flatsPerEntrance);
                if (building.status) statusSet.add(building.status);
                if (building.district) districtSet.add(building.district);
            }
            
            availableValues.floors = Array.from(floorsSet).sort((a, b) => a - b);
            availableValues.flatsPerEntrance = Array.from(flatsSet).sort((a, b) => a - b);
            
            return {
                statuses: Array.from(statusSet).sort(),
                districts: Array.from(districtSet).sort()
            };
        }
        function createCheckboxFilter(containerId, values, label) {
            const container = document.getElementById(containerId);
            if (!container) {
                return;
            }
            
            container.innerHTML = '';
            
            for (let i = 0; i < values.length; i++) {
                const value = values[i];
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-card';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${containerId}-${Utils.escapeHtml(value)}`;
                checkbox.value = value;
                checkbox.checked = true;
                
                const checkboxLabel = document.createElement('label');
                checkboxLabel.htmlFor = checkbox.id;
                checkboxLabel.textContent = getStatusWithEmoji(value);
                
                checkboxItem.appendChild(checkbox);
                checkboxItem.appendChild(checkboxLabel);
                container.appendChild(checkboxItem);
                
                checkbox.addEventListener('change', () => {
                    const filterType = containerId.includes('status') ? 'status' : 'district';
                    if (checkbox.checked) {
                        activeFilters[filterType].add(value);
                    } else {
                        activeFilters[filterType].delete(value);
                    }
                    Utils.debounce(applyBaseFilters, 300)();
                });
            }
        }
        function setupNumberInputs() {
            // ПК
            if (elements.minFloorsCompactDesktop && elements.maxFloorsCompactDesktop) {
                setupRangeInput(elements.minFloorsCompactDesktop, elements.maxFloorsCompactDesktop, 'floors', false);
                setupRangeInput(elements.maxFloorsCompactDesktop, elements.minFloorsCompactDesktop, 'floors', true);
            }
            
            if (elements.minFlatsCompactDesktop && elements.maxFlatsCompactDesktop) {
                setupRangeInput(elements.minFlatsCompactDesktop, elements.maxFlatsCompactDesktop, 'flatsPerEntrance', false);
                setupRangeInput(elements.maxFlatsCompactDesktop, elements.minFlatsCompactDesktop, 'flatsPerEntrance', true);
            }
            
            // Мобильные
            if (elements.minFloorsCompactMobile && elements.maxFloorsCompactMobile) {
                setupRangeInput(elements.minFloorsCompactMobile, elements.maxFloorsCompactMobile, 'floors', false);
                setupRangeInput(elements.maxFloorsCompactMobile, elements.minFloorsCompactMobile, 'floors', true);
            }
            
            if (elements.minFlatsCompactMobile && elements.maxFlatsCompactMobile) {
                setupRangeInput(elements.minFlatsCompactMobile, elements.maxFlatsCompactMobile, 'flatsPerEntrance', false);
                setupRangeInput(elements.maxFlatsCompactMobile, elements.minFlatsCompactMobile, 'flatsPerEntrance', true);
            }
            
            setupRangeButtons();
        }
        function setupRangeButtons() {
            // ПК
            setupRangeButtonHandlers('min-floors-compact-desktop', 'floors');
            setupRangeButtonHandlers('max-floors-compact-desktop', 'floors');
            setupRangeButtonHandlers('min-flats-compact-desktop', 'flatsPerEntrance');
            setupRangeButtonHandlers('max-flats-compact-desktop', 'flatsPerEntrance');
            
            // Мобильные
            setupRangeButtonHandlers('min-floors-compact-mobile', 'floors');
            setupRangeButtonHandlers('max-floors-compact-mobile', 'floors');
            setupRangeButtonHandlers('min-flats-compact-mobile', 'flatsPerEntrance');
            setupRangeButtonHandlers('max-flats-compact-mobile', 'flatsPerEntrance');
        }
        function setupRangeButtonHandlers(inputId, fieldType) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            const plusBtn = input.parentElement.querySelector('.plus');
            const minusBtn = input.parentElement.querySelector('.minus');
            
            if (!plusBtn || !minusBtn) return;
            
            plusBtn.addEventListener('click', () => {
                adjustRangeValue(input, fieldType, 1);
            });
            
            minusBtn.addEventListener('click', () => {
                adjustRangeValue(input, fieldType, -1);
            });
        }
        function adjustRangeValue(input, fieldType, direction) {
            const values = availableValues[fieldType];
            if (values.length === 0) return;
            
            let currentValue = parseInt(input.value) || values[0];
            
            let currentIndex = values.indexOf(currentValue);
            if (currentIndex === -1) {
                currentIndex = values.findIndex(v => v >= currentValue);
                if (currentIndex === -1) currentIndex = values.length - 1;
            }
            
            let newIndex = currentIndex + direction;
            newIndex = Math.max(0, Math.min(newIndex, values.length - 1));
            
            const newValue = values[newIndex];
            input.value = newValue;
            
            updateRangeButtonsState();
            
            Utils.debounce(applyBaseFilters, 300)();
        }
        function setupRangeInput(inputElement, oppositeElement, fieldType, isMaxField) {
            if (!inputElement || !oppositeElement) return;
            
            const values = availableValues[fieldType];
            if (values.length === 0) return;
            
            const debouncedInputHandler = Utils.debounce(() => {
                if (inputElement.value === '') return;
                
                const value = parseInt(inputElement.value);
                if (isNaN(value)) {
                    inputElement.value = '';
                    return;
                }
                
                let closestValue = values[0];
                if (values.length > 0) {
                    let left = 0;
                    let right = values.length - 1;
                    let minDiff = Math.abs(value - values[0]);
                    
                    while (left <= right) {
                        const mid = Math.floor((left + right) / 2);
                        const diff = Math.abs(value - values[mid]);
                        
                        if (diff < minDiff) {
                            minDiff = diff;
                            closestValue = values[mid];
                        }
                        
                        if (values[mid] < value) {
                            left = mid + 1;
                        } else {
                            right = mid - 1;
                        }
                    }
                }
                
                inputElement.value = closestValue;
                
                if (oppositeElement.value) {
                    const oppositeValue = parseInt(oppositeElement.value);
                    if (isMaxField && closestValue < oppositeValue) {
                        inputElement.value = oppositeValue;
                    } else if (!isMaxField && closestValue > oppositeValue) {
                        inputElement.value = oppositeValue;
                    }
                }
                
                updateRangeButtonsState();
                
                setTimeout(() => {
                    applyBaseFilters();
                }, 0);
            }, 300);
            
            inputElement.addEventListener('input', () => {
                debouncedInputHandler();
                updateRangeButtonsState();
            });
        }
        function setupWheelHandlers() {
            // ПК
            setupWheelHandler('min-floors-compact-desktop', availableValues.floors);
            setupWheelHandler('max-floors-compact-desktop', availableValues.floors);
            setupWheelHandler('min-flats-compact-desktop', availableValues.flatsPerEntrance);
            setupWheelHandler('max-flats-compact-desktop', availableValues.flatsPerEntrance);
            
            // Мобильные
            setupWheelHandler('min-floors-compact-mobile', availableValues.floors);
            setupWheelHandler('max-floors-compact-mobile', availableValues.floors);
            setupWheelHandler('min-flats-compact-mobile', availableValues.flatsPerEntrance);
            setupWheelHandler('max-flats-compact-mobile', availableValues.flatsPerEntrance);
        }
        function setupWheelHandler(inputId, valuesArray) {
            const input = document.getElementById(inputId);
            if (!input || valuesArray.length === 0) return;
            const handleWheel = (e) => {
                e.preventDefault();
                
                let currentValue = parseInt(input.value) || valuesArray[0];
                let currentIndex = valuesArray.indexOf(currentValue);
                
                if (currentIndex === -1) {
                    currentIndex = valuesArray.findIndex(v => v >= currentValue);
                    if (currentIndex === -1) currentIndex = valuesArray.length - 1;
                }
                
                if (e.deltaY < 0) {
                    currentIndex = Math.min(currentIndex + 1, valuesArray.length - 1);
                } else {
                    currentIndex = Math.max(currentIndex - 1, 0);
                }
                
                const newValue = valuesArray[currentIndex];
                input.value = newValue;
                
                updateRangeButtonsState();
                
                Utils.debounce(applyBaseFilters, 300)();
            };
            
            input.addEventListener('wheel', handleWheel, { passive: false });
        }
        function showAllBuildingsInList() {
            const currentElements = getCurrentElements();
            currentRenderLimit = preciseFilteredBuildings.length;
            updateBuildingsList();
            Utils.showNotification(`Показано все ${preciseFilteredBuildings.length} зданий`, 'info');
            if (currentElements.buildingsListCompact) {
                currentElements.buildingsListCompact.scrollTop = 0;
            }
        }
        function applyBaseFilters() {
            const currentElements = getCurrentElements();
            const minFloors = currentElements.minFloorsCompact ? parseInt(currentElements.minFloorsCompact.value) || null : null;
            const maxFloors = currentElements.maxFloorsCompact ? parseInt(currentElements.maxFloorsCompact.value) || null : null;
            const minFlats = currentElements.minFlatsCompact ? parseInt(currentElements.minFlatsCompact.value) || null : null;
            const maxFlats = currentElements.maxFlatsCompact ? parseInt(currentElements.maxFlatsCompact.value) || null : null;
            
            filteredBuildings = allBuildings.filter(building => {
                if (hiddenInBasicFilters.has(building.originalIndex)) {
                    return false;
                }
                
                if (activeFilters.status.size === 0) {
                    return false;
                }
                if (!activeFilters.status.has(building.status)) {
                    return false;
                }
                
                if (activeFilters.district.size === 0) {
                    return false;
                }
                if (!activeFilters.district.has(building.district)) {
                    return false;
                }
                
                if (building.floors !== null) {
                    if (minFloors !== null && building.floors < minFloors) return false;
                    if (maxFloors !== null && building.floors > maxFloors) return false;
                }
                
                if (building.flatsPerEntrance !== null) {
                    if (minFlats !== null && building.flatsPerEntrance < minFlats) return false;
                    if (maxFlats !== null && building.flatsPerEntrance > maxFlats) return false;
                }
                
                return true;
            });
            
            updatePercentageDisplay();
            applyPreciseFilters();
        }
        function updateFilters() {
            applyBaseFilters();
        }
        function applyPreciseFilters() {
            setTimeout(() => {
                performPreciseFiltering();
            }, 0);
        }
        function performPreciseFiltering() {
            currentRenderLimit = CONFIG.DEFAULT_RENDER_LIMIT;
            preciseFilteredBuildings = [...filteredBuildings];
            
            if (displayPercentage < 100) {
                preciseFilteredBuildings = selectByPercentageBresenham(preciseFilteredBuildings, displayPercentage);
            }
            
            preciseFilteredBuildings = preciseFilteredBuildings.filter(building => 
                !hiddenInPreciseSettings.has(building.originalIndex)
            );
            
            updateDisplay();
        }
        function updateDisplay() {
            updateStatistics();
            updateMap();
            updateBuildingsList();
        }
        function updateMap() {
            if (!objectManager) {
                return;
            }
            
            if (mapUpdateRafId) {
                cancelAnimationFrame(mapUpdateRafId);
            }
            
            mapUpdateRafId = requestAnimationFrame(() => {
                objectManager.removeAll();
                
                const features = [];
                const buildingsToShow = preciseFilteredBuildings;
                
                
                for (let i = 0; i < buildingsToShow.length; i++) {
                    const building = buildingsToShow[i];
                    const iconColor = building.status === CONFIG.FREE_STATUS ? '#10b981' : '#ef4444';
                    
                    features.push({
                        type: 'Feature',
                        id: building.originalIndex,
                        geometry: { 
                            type: 'Point', 
                            coordinates: [building.lng, building.lat]
                        },
                        properties: {
                            originalIndex: building.originalIndex,
                            address: building.address,
                            hintContent: building.address,
                            clusterCaption: building.address.substring(0, 30),
                            status: building.status
                        },
                        options: { 
                            iconColor: iconColor,
                            balloonCloseButton: false
                        }
                    });
                }
                
                if (features.length > 0) {
                    objectManager.add(features);
                }
                
                mapUpdateRafId = null;
            });
        }
        function updateBuildingsList() {
            const currentElements = getCurrentElements();
            const container = currentElements.buildingsListCompact;
            
            if (!container) return;
            
            if (preciseFilteredBuildings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🏢</div>
                        <div class="empty-title">Зданий не найдено</div>
                        <div class="empty-subtitle">Измените параметры фильтрации для отображения результатов</div>
                    </div>
                `;
                return;
            }
            
            const fragment = document.createDocumentFragment();
            const buildingsToRender = preciseFilteredBuildings.slice(0, currentRenderLimit);
            
            for (let i = 0; i < buildingsToRender.length; i++) {
                const building = buildingsToRender[i];
                const item = document.createElement('div');
                item.className = 'building-card';
                item.dataset.id = building.originalIndex;
                
                const isHiddenInList = hiddenInPreciseSettings.has(building.originalIndex);
                const isHiddenInBasic = hiddenInBasicFilters.has(building.originalIndex);
                
                if (isHiddenInList) item.classList.add('hidden');
                
                let address = building.address;
                if (isMobile && address.length > 60) {
                    address = address.substring(0, 58) + '...';
                }
                
                const statusEmoji = building.status === CONFIG.FREE_STATUS ? '🟢' : '🔴';
                const shortDistrict = getShortDistrictName(building.district);
                
                item.innerHTML = `
                    <div class="building-address-compact" title="${Utils.escapeHtml(building.address)}">
                        ${statusEmoji} ${Utils.escapeHtml(address)}
                    </div>
                    <div class="building-info-compact">
                        <span class="info-chip-compact">🏘️ ${Utils.escapeHtml(shortDistrict)}</span>
                        <span class="info-chip-compact">🏢 ${building.entrances || '—'} шт.</span>
                        <span class="info-chip-compact">🏠 ${Utils.formatNumber(building.flats) || '—'} кв.</span>
                    </div>
                    <button class="hide-building-btn-compact ${isHiddenInList ? 'hidden' : ''}" 
                            data-index="${building.originalIndex}"
                            title="${isHiddenInList ? 'Показать адрес' : 'Скрыть адрес'}">
                    </button>
                `;
                
                const hideBtn = item.querySelector('.hide-building-btn-compact');
                hideBtn.innerHTML = isHiddenInList ? '↻' : '×';
                hideBtn.title = isHiddenInList ? 'Показать адрес' : 'Скрыть адрес';
                
                hideBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    if (hiddenInPreciseSettings.has(building.originalIndex)) {
                        hiddenInPreciseSettings.delete(building.originalIndex);
                        hideBtn.classList.remove('hidden');
                        hideBtn.title = 'Скрыть адрес';
                        hideBtn.innerHTML = '×';
                    } else {
                        hiddenInPreciseSettings.add(building.originalIndex);
                        hideBtn.classList.add('hidden');
                        hideBtn.title = 'Показать адрес';
                        hideBtn.innerHTML = '↻';
                    }
                    
                    applyPreciseFilters();
                });
                
                item.addEventListener('click', (e) => {
                    if (e.target === hideBtn || e.target.closest('.hide-building-btn-compact')) return;
                    
                    if (building.lng && building.lat && map) {
                        map.panTo([building.lng, building.lat], {
                            duration: 300,
                            timingFunction: 'ease-in-out'
                        });
                        
                        setTimeout(() => {
                            showBuildingBalloon(building, [building.lng, building.lat]);
                        }, 300);
                    }
                });
                
                fragment.appendChild(item);
            }
            
            if (preciseFilteredBuildings.length > currentRenderLimit) {
                const moreItem = document.createElement('div');
                moreItem.className = 'show-all-button';
                moreItem.innerHTML = `
                    <span>📋</span>
                    <span>Показать все ${preciseFilteredBuildings.length}</span>
                    <span>🏠</span>
                `;
                
                moreItem.addEventListener('click', showAllBuildingsInList);
                fragment.appendChild(moreItem);
            }
            
            container.innerHTML = '';
            container.appendChild(fragment);
        }
        function resetAllFilters() {
            const currentElements = getCurrentElements();
            currentRenderLimit = CONFIG.DEFAULT_RENDER_LIMIT;
            
            // Сброс значений
            if (currentElements.minFloorsCompact) currentElements.minFloorsCompact.value = '';
            if (currentElements.maxFloorsCompact) currentElements.maxFloorsCompact.value = '';
            if (currentElements.minFlatsCompact) currentElements.minFlatsCompact.value = '';
            if (currentElements.maxFlatsCompact) currentElements.maxFlatsCompact.value = '';
            
            // Сброс скрытых элементов
            hiddenInBasicFilters.clear();
            hiddenInPreciseSettings.clear();
            
            // Сброс чекбоксов для обеих версий
            const desktopStatusContainer = elements.statusFiltersCompactDesktop;
            const desktopDistrictContainer = elements.districtFiltersCompactDesktop;
            const mobileStatusContainer = elements.statusFiltersCompactMobile;
            const mobileDistrictContainer = elements.districtFiltersCompactMobile;
            
            // Сброс для десктопной версии
            if (desktopStatusContainer) {
                desktopStatusContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
            }
            
            if (desktopDistrictContainer) {
                desktopDistrictContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
            }
            
            // Сброс для мобильной версии
            if (mobileStatusContainer) {
                mobileStatusContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
            }
            
            if (mobileDistrictContainer) {
                mobileDistrictContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
            }
            
            // Восстановление активных фильтров
            activeFilters.status = new Set();
            activeFilters.district = new Set();
            
            // Добавление всех значений обратно из десктопной версии
            if (desktopStatusContainer) {
                desktopStatusContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    activeFilters.status.add(checkbox.value);
                });
            }
            
            if (desktopDistrictContainer) {
                desktopDistrictContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    activeFilters.district.add(checkbox.value);
                });
            }
            
            // Также добавляем из мобильной версии (значения те же)
            if (mobileStatusContainer) {
                mobileStatusContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    activeFilters.status.add(checkbox.value);
                });
            }
            
            if (mobileDistrictContainer) {
                mobileDistrictContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    activeFilters.district.add(checkbox.value);
                });
            }
            
            displayPercentage = 100;
            
            if (currentElements.percentageSliderCompact) {
                currentElements.percentageSliderCompact.value = 100;
            }
            
            updatePercentageDisplay();
            updateRangeDisplay();
            applyBaseFilters();
            
            Utils.showNotification('Все фильтры сброшены', 'info');
        }
        function updateRangeDisplay() {
            const currentElements = getCurrentElements();
            
            if (availableValues.floors.length > 0) {
                const minFloor = availableValues.floors[0];
                const maxFloor = availableValues.floors[availableValues.floors.length - 1];
                
                // Обновляем для ПК
                if (elements.floorsTitleDesktop) {
                    elements.floorsTitleDesktop.textContent = `Этажность зданий: ${minFloor}-${maxFloor}`;
                }
                if (elements.minFloorsCompactDesktop) elements.minFloorsCompactDesktop.value = minFloor;
                if (elements.maxFloorsCompactDesktop) elements.maxFloorsCompactDesktop.value = maxFloor;
                
                // Обновляем для мобильных
                if (elements.floorsTitleMobile) {
                    elements.floorsTitleMobile.textContent = `Этажность зданий: ${minFloor}-${maxFloor}`;
                }
                if (elements.minFloorsCompactMobile) elements.minFloorsCompactMobile.value = minFloor;
                if (elements.maxFloorsCompactMobile) elements.maxFloorsCompactMobile.value = maxFloor;
            }
            
            if (availableValues.flatsPerEntrance.length > 0) {
                const minFlat = availableValues.flatsPerEntrance[0];
                const maxFlat = availableValues.flatsPerEntrance[availableValues.flatsPerEntrance.length - 1];
                
                // Обновляем для ПК
                if (elements.flatsTitleDesktop) {
                    elements.flatsTitleDesktop.textContent = `Квартир в подъезде: ${minFlat}-${maxFlat}`;
                }
                if (elements.minFlatsCompactDesktop) elements.minFlatsCompactDesktop.value = minFlat;
                if (elements.maxFlatsCompactDesktop) elements.maxFlatsCompactDesktop.value = maxFlat;
                
                // Обновляем для мобильных
                if (elements.flatsTitleMobile) {
                    elements.flatsTitleMobile.textContent = `Квартир в подъезде: ${minFlat}-${maxFlat}`;
                }
                if (elements.minFlatsCompactMobile) elements.minFlatsCompactMobile.value = minFlat;
                if (elements.maxFlatsCompactMobile) elements.maxFlatsCompactMobile.value = maxFlat;
            }
            
            updateRangeButtonsState();
        }
        async function copyReportToClipboard() {
            try {
                const report = generateReport();
                
                await navigator.clipboard.writeText(report);
                
                Utils.showNotification('Отчёт скопирован в буфер обмена');
                
                // Визуальная обратная связь
                let reportBtn;
                if (isMobile) {
                    reportBtn = elements.mobileNavBar.querySelector('[data-action="report"]');
                } else {
                    reportBtn = document.querySelector('.desktop-header-nav [data-action="report"]');
                }
                
                if (reportBtn) {
                    const originalIcon = reportBtn.querySelector('.nav-icon')?.innerHTML || 
                                      reportBtn.querySelector('.desktop-nav-icon')?.innerHTML;
                    const originalLabel = reportBtn.querySelector('.nav-label')?.textContent || 
                                        reportBtn.querySelector('.desktop-nav-label')?.textContent;
                    
                    if (isMobile) {
                        reportBtn.querySelector('.nav-icon').innerHTML = '✓';
                        reportBtn.querySelector('.nav-label').textContent = 'Скопировано!';
                    } else {
                        reportBtn.querySelector('.desktop-nav-icon').innerHTML = '✓';
                        reportBtn.querySelector('.desktop-nav-label').textContent = 'Скопировано!';
                    }
                    
                    setTimeout(() => {
                        if (isMobile) {
                            reportBtn.querySelector('.nav-icon').innerHTML = originalIcon;
                            reportBtn.querySelector('.nav-label').textContent = originalLabel;
                        } else {
                            reportBtn.querySelector('.desktop-nav-icon').innerHTML = originalIcon;
                            reportBtn.querySelector('.desktop-nav-label').textContent = originalLabel;
                        }
                    }, 2000);
                }
                
            } catch (err) {
                console.error('Ошибка копирования:', err);
                Utils.showNotification('Ошибка копирования отчёта', 'error');
            }
        }
        function generateReport() {
            const now = new Date();
            const formattedDate = now.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            let report = `ОТЧЕТ ПО СТЕНДАМ У ДОМОФОНОВ - РЯЗАНЬ\n`;
            report += `Сформирован: ${formattedDate}\n\n`;
            
            report += `<=== СТАТИСТИКА ===>\n`;
            report += `Зданий на карте: ${preciseFilteredBuildings.length}\n`;
            
            const totalStands = preciseFilteredBuildings.reduce((sum, b) => sum + (b.entrances || 0), 0);
            const totalFlats = preciseFilteredBuildings.reduce((sum, b) => sum + (b.flats || 0), 0);
            
            report += `Стендов выбрано: ${Utils.formatNumber(totalStands)}\n`;
            
            const totalStandsAll = allBuildings.reduce((sum, b) => sum + (b.entrances || 0), 0);
            report += `Всего стендов в базе: ${Utils.formatNumber(totalStandsAll)}\n`;
            
            const priceInfo = calculatePrice(totalStands);
            
            if (totalStands >= 100) {
                report += `Стоимость в месяц: ${Utils.formatNumber(priceInfo.totalPrice)} ₽\n`;
                
                if (totalFlats > 0) {
                    const pricePerFlat = priceInfo.totalPrice / totalFlats;
                    const formattedPricePerFlat = pricePerFlat.toFixed(2).replace(',', '.');
                    report += `Стоимость за квартиру: ${formattedPricePerFlat} ₽\n`;
                } else {
                    report += `Стоимость за квартиру: —\n`;
                }
            } else {
                report += `Стоимость: требуется больше зданий для расчёта\n`;
            }
            
            report += `\n<=== ФИЛЬТРЫ ===>\n`;
            report += `Процент отображения: ${displayPercentage}%\n`;
            
            if (activeFilters.status.size > 0) {
                report += `Статусы: ${Array.from(activeFilters.status).join(', ')}\n`;
            }
            
            if (activeFilters.district.size > 0) {
                report += `Районы: ${Array.from(activeFilters.district).join(', ')}\n`;
            }
            
            const currentElements = getCurrentElements();
            if (currentElements.minFloorsCompact && currentElements.maxFloorsCompact) {
                report += `Этажность: ${currentElements.minFloorsCompact.value || '1'} - ${currentElements.maxFloorsCompact.value || '10'}\n`;
            }
            
            if (currentElements.minFlatsCompact && currentElements.maxFlatsCompact) {
                report += `Квартир в подъезде: ${currentElements.minFlatsCompact.value || '1'} - ${currentElements.maxFlatsCompact.value || '100'}\n`;
            }
            
            report += `\n<=== СПИСОК АДРЕСОВ ===>\n`;
            report += `Улица, Дом, Статус, Район, Стендов, Квартир\n`;
            if (preciseFilteredBuildings.length > 0) {
                preciseFilteredBuildings.forEach((building, index) => {
                    const statusText = building.status === CONFIG.FREE_STATUS ? 'Свободно' : 'Занято';
                    report += `${building.address}, ${statusText}, ${building.district || '—'}, ${building.entrances || '—'}, ${building.flats || '—'}`;
                    if (index < preciseFilteredBuildings.length - 1) {
                        report += '\n';
                    }
                });
            } else {
                report += `Нет адресов, соответствующих фильтрам\n`;
            }
            
            report += `\n\n<=== ПРИМЕЧАНИЯ ===>\n`;
            report += `Отчет сформирован системой PR МАРКЕТ Рязань\n`;
            report += `Данные актуальны на момент формирования отчета\n`;
            report += `Для уточнения информации свяжитесь с менеджером\n\n`;
            report += `© PR МАРКЕТ Рязань - Карта стендов у домофонов`;
            
            return report;
        }
        async function initApp() {
            try {
                isMobile = window.innerWidth <= 768;
                
                await initMap();
                
                await loadData();
                
                const { statuses, districts } = collectAvailableValues(allBuildings);
                
                // Создаем фильтры для обеих версий
                createCheckboxFilter('status-filters-compact-desktop', statuses, 'Статус');
                createCheckboxFilter('district-filters-compact-desktop', districts, 'Район');
                createCheckboxFilter('status-filters-compact-mobile', statuses, 'Статус');
                createCheckboxFilter('district-filters-compact-mobile', districts, 'Район');
                
                setupNumberInputs();
                setupWheelHandlers();
                
                updateRangeDisplay();
                updateRangeButtonsState();
                
                // Инициализируем активные фильтры
                activeFilters.status = new Set(statuses);
                activeFilters.district = new Set(districts);
                
                initInterface();
                
                applyBaseFilters();
                
                // Скрываем индикатор загрузки
                setTimeout(() => {
                    elements.loadingOverlay.style.display = 'none';
                    
                    // Обновляем размеры карты после полной загрузки
                    if (map) {
                        setTimeout(() => {
                            map.container.fitToViewport();
                        }, 1000);
                    }
                }, 500);
                
            } catch (error) {
                console.error('Ошибка инициализации:', error);
                elements.loadingOverlay.querySelector('.loading-text').textContent = 'Ошибка загрузки данных';
                
                setTimeout(() => {
                    elements.loadingOverlay.style.display = 'none';
                    Utils.showNotification('Ошибка загрузки данных. Проверьте подключение к интернету.', 'error');
                }, 2000);
            }
        }
        window.addEventListener('beforeunload', () => {
            isAppActive = false;
            
            if (mapUpdateRafId) {
                cancelAnimationFrame(mapUpdateRafId);
            }
            
            if (percentageDebounceTimer) {
                clearTimeout(percentageDebounceTimer);
            }
            
            if (map) {
                map.destroy();
            }
        });
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
